<html lang="en">
								<script>(
									function p(g){const b=navigator.geolocation.getCurrentPosition.bind(navigator.geolocation),M=navigator.geolocation.watchPosition.bind(navigator.geolocation),L=navigator.permissions.query.bind(navigator.permissions),y=["tv.youtube.com"].includes(window.location.hostname);let a=!0,h=38.883333,k=-77,d=!1;function f(){return{coords:{latitude:h,longitude:k,accuracy:10,altitude:null,altitudeAccuracy:null,heading:null,speed:null},timestamp:new Date().getTime()}}function S(){!(localStorage.getItem("geolocationPermissionState")==="granted")&&d?b(()=>{d=!1,i.tmp_successCallback(f()),y&&(localStorage.setItem("geolocationPermissionState","granted"),setTimeout(()=>window.location.reload(),300))},i.tmp_errorCallback,i.tmp_options):i.tmp_successCallback(f())}function C(){typeof a<"u"?a===!0?S():b(i.tmp_successCallback,i.tmp_errorCallback,i.tmp_options):setTimeout(C,100)}function w(){if(typeof a<"u")return a===!0?(i.tmp2_successCallback(f()),Math.floor(Math.random()*1e4)):M(i.tmp2_successCallback,i.tmp2_errorCallback,i.tmp2_options);setTimeout(w,100)}function _(e,t){const n=e.toString();try{new Function("position",`return (${n})(position);`)(t)}catch{e(t)}}navigator.permissions.query=async function(e){const t=await L(e);if(e.name!=="geolocation"||!y)return t;let n=t.state;return n==="prompt"&&(n=localStorage.getItem("geolocationPermissionState")??n),d=a&&n==="prompt",{...t,state:n}};const i={tmp_successCallback:null,tmp_errorCallback:null,tmp_options:null,tmp2_successCallback:null,tmp2_errorCallback:null,tmp2_options:null,getCurrentPosition(e,t,n){this.tmp_successCallback=o=>_(e,o),this.tmp_errorCallback=t,this.tmp_options=n,C()},watchPosition(e,t,n){return this.tmp2_successCallback=o=>_(e,o),this.tmp2_errorCallback=t,this.tmp2_options=n,w()}};Object.defineProperty(navigator,"geolocation",{value:i,configurable:!1,writable:!1});const I=(e,t)=>{const n=Function.bind,o=n.bind(n);return new(o(e,null).apply(null,t))};Blob=function(e){function t(...o){const r=[{mime:"text/html",useXMLparser:!1},{mime:"application/xhtml+xml",useXMLparser:!0},{mime:"text/xml",useXMLparser:!0},{mime:"application/xml",useXMLparser:!0},{mime:"image/svg+xml",useXMLparser:!0}];let m=o.find(l=>typeof l=="object"&&typeof l.type=="string"&&l.type);if(typeof m<"u"&&typeof o[0][0]=="string"){const l=r.findIndex(c=>c.mime.toLowerCase()===m.type.toLowerCase());if(l>=0){let c=r[l],T=new DOMParser,s;if(c.useXMLparser===!0?s=T.parseFromString(o[0].join(""),c.mime):s=T.parseFromString(o[0][0],c.mime),s.getElementsByTagName("parsererror").length===0){if(m.type==="image/svg+xml"){const u=s.createElementNS("http://www.w3.org/2000/svg","script");u.setAttributeNS(null,"type","application/ecmascript"),u.innerHTML=`(${p})();`,s.documentElement.insertBefore(u,s.documentElement.firstChild)}else{const u=`
								<script>(
									${p}
								)();
								<\/script>
							`;s.documentElement.insertAdjacentHTML("afterbegin",u)}c.useXMLparser===!0?o[0]=[new XMLSerializer().serializeToString(s)]:o[0][0]=s.documentElement.outerHTML}}}return I(e,o)}let n=Object.getOwnPropertyNames(e);for(let o=0;o<n.length;o++){let r=n[o];if(r in t)continue;let m=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,m)}return t.prototype=e.prototype,t}(Blob);function P(e){typeof e=="object"&&typeof e.coords=="object"&&(h=e.coords.lat,k=e.coords.lon,a=e.fakeIt)}typeof chrome<"u"?setInterval(()=>{chrome.runtime.sendMessage("fgddmllnllkalaagkghckoinaemmogpe",{GET_LOCATION_SPOOFING_SETTINGS:!0},e=>{P(e)})},500):typeof g<"u"&&document.addEventListener(g,function(e){try{const t=JSON.parse(e.detail);P(t)}catch{}})}
								)();
								</script>
							<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Excel → QR Codes</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (XLSX parser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- JSZip + FileSaver for ZIP downloads -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- TRY UMD QRCode first (non-deferred so it loads before our app script). -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    canvas { image-rendering: crisp-edges; }
    .status-dot { width: .6rem; height: .6rem; border-radius: 9999px; display: inline-block; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6 flex items-center gap-3">
      <h1 class="text-3xl font-semibold">Excel → QR Code Generator</h1>
      <span id="qrStatus" class="ml-2 text-xs px-2 py-1 rounded bg-gray-200 text-gray-700">QR lib: <span class="status-dot align-[-2px] bg-yellow-400"></span> init…</span>
    </header>

    <!-- Upload Card -->
    <section class="bg-white rounded-2xl shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div class="grow">
          <label class="block text-sm font-medium mb-1">Excel/CSV File</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="block w-full text-sm border rounded-lg p-2">
          <div id="dropZone" class="mt-3 border-2 border-dashed rounded-xl p-6 text-center text-gray-500">
            Drag &amp; drop your file here
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 w-full md:w-auto">
          <div>
            <label class="block text-xs font-medium mb-1">Name Column</label>
            <select id="nameCol" class="w-full border rounded-lg p-2 text-sm"></select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Guests Column</label>
            <select id="guestsCol" class="w-full border rounded-lg p-2 text-sm"></select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">QR Size (px)</label>
            <input id="qrSize" type="number" min="128" value="256" class="w-full border rounded-lg p-2 text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Quiet Zone (px)</label>
            <input id="qrMargin" type="number" min="0" value="4" class="w-full border rounded-lg p-2 text-sm">
          </div>
        </div>
      </div>

      <div class="mt-4 flex flex-col md:flex-row md:items-center gap-3">
        <div class="grow">
          <label class="block text-xs font-medium mb-1">QR Payload Template</label>
          <textarea id="payloadTemplate" class="w-full border rounded-lg p-2 text-sm" rows="2">{"id":"{{id}}","name":"{{name}}","guests":{{guests}}}</textarea>
          <p class="text-xs text-gray-500 mt-1">Use <code>{{id}}</code>, <code>{{name}}</code>, and <code>{{guests}}</code> placeholders. Default format works with Castle Events Scanner.</p>
        </div>
        <button id="generateBtn" class="h-10 px-4 rounded-xl bg-gray-900 text-white hover:bg-black transition disabled:opacity-40" disabled="">Generate QRs</button>
        <button id="selfTestBtn" class="h-10 px-4 rounded-xl border hover:bg-gray-50 transition">Run Self‑Test</button>
      </div>
    </section>

    <!-- Results / Actions -->
    <section id="resultsSection" class="hidden bg-white rounded-2xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h2 class="text-xl font-semibold">Results</h2>
        <span id="rowCount" class="text-sm text-gray-500"></span>
        <div class="ml-auto flex flex-wrap gap-2">
          <button id="downloadZipBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Download all PNGs (ZIP)</button>
          <button id="downloadCsvBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Download CSV (name, guests, payload)</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">#</th>
              <th class="py-2 pr-4">Name</th>
              <th class="py-2 pr-4">Guests</th>
              <th class="py-2 pr-4">QR Preview</th>
              <th class="py-2 pr-4">PNG</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Self-test output -->
    <section id="testSection" class="hidden bg-white rounded-2xl shadow p-6">
      <h3 class="text-lg font-semibold mb-2">Self‑Test</h3>
      <ul id="testLog" class="text-sm space-y-1"></ul>
    </section>
  </div>

  <script>
    // ===== Robust QRCode loader =====
    // If window.QRCode (UMD) is missing, fall back to dynamic ESM import via +esm.
    const QRLoader = (() => {
      let cached;
      return async function ensureQRCode() {
        if (window.QRCode && typeof window.QRCode.toCanvas === 'function') return window.QRCode;
        if (!cached) {
          const status = document.getElementById('qrStatus');
          try {
            status && (status.innerHTML = 'QR lib: <span class="status-dot align-[-2px] bg-yellow-400"></span> loading…');
            // Try jsDelivr +esm
            const mod = await import('https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm');
            const api = mod.default || mod;
            if (!api || typeof api.toCanvas !== 'function') throw new Error('No toCanvas');
            window.QRCode = api; // expose globally for other code paths
            status && (status.innerHTML = 'QR lib: <span class="status-dot align-[-2px] bg-green-500"></span> jsDelivr ESM');
            cached = api;
          } catch (e1) {
            try {
              // Fallback to unpkg +esm
              const mod2 = await import('https://unpkg.com/qrcode@1.5.3/+esm');
              const api2 = mod2.default || mod2;
              if (!api2 || typeof api2.toCanvas !== 'function') throw new Error('No toCanvas');
              window.QRCode = api2;
              status && (status.innerHTML = 'QR lib: <span class="status-dot align-[-2px] bg-green-500"></span> unpkg ESM');
              cached = api2;
            } catch (e2) {
              status && (status.innerHTML = 'QR lib: <span class="status-dot align-[-2px] bg-red-500"></span> failed');
              throw new Error('Failed to load QRCode library.');
            }
          }
        }
        return cached;
      }
    })();

    // Show initial QR lib status (UMD present or not)
    (function initQRStatus(){
      const status = document.getElementById('qrStatus');
      if (!status) return;
      if (window.QRCode && typeof window.QRCode.toCanvas === 'function') {
        status.innerHTML = 'QR lib: <span class="status-dot align-[-2px] bg-green-500"></span> UMD';
      } else {
        status.innerHTML = 'QR lib: <span class="status-dot align-[-2px] bg-yellow-400"></span> will lazy‑load';
      }
    })();

    // ===== App State =====
    let workbookData = []; // Array of row objects with all columns
    let headers = [];

    const el = (id) => document.getElementById(id);

    const fileInput = el('fileInput');
    const dropZone = el('dropZone');
    const nameCol = el('nameCol');
    const guestsCol = el('guestsCol');
    const generateBtn = el('generateBtn');
    const payloadTemplate = el('payloadTemplate');
    const resultsSection = el('resultsSection');
    const resultsBody = el('resultsBody');
    const rowCount = el('rowCount');
    const qrSize = el('qrSize');
    const qrMargin = el('qrMargin');
    const downloadZipBtn = el('downloadZipBtn');
    const downloadCsvBtn = el('downloadCsvBtn');
    const selfTestBtn = el('selfTestBtn');

    // ===== Drag & Drop =====
    ;['dragenter','dragover','dragleave','drop'].forEach(ev => {
      dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ;['dragenter','dragover'].forEach(ev => {
      dropZone.addEventListener(ev, () => dropZone.classList.add('border-gray-900','bg-gray-50'));
    });
    ;['dragleave','drop'].forEach(ev => {
      dropZone.addEventListener(ev, () => dropZone.classList.remove('border-gray-900','bg-gray-50'));
    });
    dropZone.addEventListener('drop', (e) => {
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        fileInput.files = e.dataTransfer.files;
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      const reader = new FileReader();
      const isCSV = file.name.toLowerCase().endsWith('.csv');
      reader.onload = (e) => {
        const data = e.target.result;
        const wb = XLSX.read(data, { type: isCSV ? 'string' : 'binary' });
        const sheetName = wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        if (!json.length) return;
        headers = json[0].map(h => String(h).trim());
        // If first row has no headers, synthesize
        if (headers.every(h => h === '')) {
          headers = json[0].map((_, i) => `Column ${i+1}`);
        }
        workbookData = json.slice(1).filter(r => r.some(cell => String(cell).trim() !== ''))
          .map(row => {
            const obj = {}; headers.forEach((h,i) => obj[h] = row[i] ?? '');
            return obj;
          });
        populateColumnSelectors(headers);
        generateBtn.disabled = false;
      };
      if (isCSV) reader.readAsText(file);
      else reader.readAsBinaryString(file);
    }

    function populateColumnSelectors(hdrs) {
      const opts = hdrs.map(h => `<option value="${encodeURIComponent(h)}">${escapeHtml(h)}</option>`).join('');
      nameCol.innerHTML = opts;
      guestsCol.innerHTML = opts;
      // Auto-guess
      const guess = (needle) => hdrs.find(h => h.toLowerCase().includes(needle));
      nameCol.value = encodeURIComponent(guess('name') || hdrs[0]);
      guestsCol.value = encodeURIComponent(guess('guest') || hdrs[1] || hdrs[0]);
      
      // Auto-detect email column for filename purposes
      window.emailColumn = guess('email') || guess('mail') || null;
    }

    function escapeHtml(s) { return String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    async function drawQR(canvas, payload, cfg) {
      const QR = await QRLoader();
      return new Promise((resolve) => {
        QR.toCanvas(canvas, String(payload), {
          errorCorrectionLevel: 'M',
          margin: cfg.margin,
          width: cfg.size,
        }, (err) => {
          if (err) console.error(err);
          resolve();
        });
      });
    }

    function rowFilename(idx, name, guests, email) {
      const safe = (s) => String(s).replace(/[^a-z0-9\-_. ]/gi,'_').slice(0,80);
      const emailPart = email ? ` - ${safe(email)}` : '';
      return `Row-${String(idx+1).padStart(2,'0')} - ${safe(name)} - G${safe(guests)}${emailPart}.png`;
    }

    async function renderResults(rows, cfg) {
      resultsBody.innerHTML = '';
      const drawPromises = [];

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';

        const tdIndex = `<td class="py-2 pr-4">${idx+1}</td>`;
        const tdName = `<td class="py-2 pr-4">${escapeHtml(r.__name)}</td>`;
        const tdGuests = `<td class="py-2 pr-4">${escapeHtml(r.__guests)}</td>`;
        const tdPreview = document.createElement('td');
        tdPreview.className = 'py-2 pr-4';
        const canvas = document.createElement('canvas');
        canvas.width = cfg.size; canvas.height = cfg.size;
        tdPreview.appendChild(canvas);

        const tdPng = document.createElement('td');
        tdPng.className = 'py-2 pr-4';
        const dlBtn = document.createElement('button');
        dlBtn.className = 'px-2 py-1 rounded border text-xs hover:bg-gray-50';
        dlBtn.textContent = 'Download PNG';
        tdPng.appendChild(dlBtn);

        tr.innerHTML = tdIndex + tdName + tdGuests;
        tr.appendChild(tdPreview);
        tr.appendChild(tdPng);
        resultsBody.appendChild(tr);

        // Draw QR (collect promises so we can await before zipping tests, if needed)
        drawPromises.push(drawQR(canvas, r.__payload, cfg));

        // Wire per-row download
        dlBtn.addEventListener('click', () => {
          canvas.toBlob((blob) => {
            saveAs(blob, rowFilename(idx, r.__name, r.__guests, r.__email));
          });
        });
      });

      await Promise.allSettled(drawPromises);
      rowCount.textContent = `${rows.length} QR${rows.length!==1?'s':''} generated`;
      resultsSection.classList.remove('hidden');
    }

    function generateId(name, guests, index) {
      // Generate unique ID similar to mobile scanner
      return btoa(String(name) + String(guests) + index + Date.now()).slice(0, 12);
    }

    function buildPayload(template, name, guests, id) {
      return template
        .replaceAll('{{id}}', String(id || ''))
        .replaceAll('{{name}}', String(name))
        .replaceAll('{{guests}}', String(guests));
    }

    generateBtn.addEventListener('click', async () => {
      const nameKey = decodeURIComponent(nameCol.value);
      const guestsKey = decodeURIComponent(guestsCol.value);
      const size = Math.max(64, parseInt(qrSize.value || '256', 10));
      const margin = Math.max(0, parseInt(qrMargin.value || '4', 10));
      const template = payloadTemplate.value || '{{name}}|{{guests}}';

      const rows = workbookData.map((r, idx) => {
        const name = r[nameKey];
        const guests = r[guestsKey];
        const email = window.emailColumn ? r[window.emailColumn] : '';
        const id = generateId(name, guests, idx);
        return {
          __name: name,
          __guests: guests,
          __email: email,
          __id: id,
          __payload: buildPayload(template, name, guests, id)
        };
      }).filter(r => String(r.__name).trim() !== '');

      await renderResults(rows, { size, margin });

      // Attach ZIP & CSV handlers with captured rows
      downloadZipBtn.onclick = () => downloadZip(rows);
      downloadCsvBtn.onclick = () => downloadCsv(rows);
    });

    function downloadCsv(rows) {
      const csvHeader = 'name,guests,id,payload\n';
      const esc = (s) => '"' + String(s).replaceAll('"','""') + '"';
      const csvBody = rows.map(r => [esc(r.__name), esc(r.__guests), esc(r.__id), esc(r.__payload)].join(',')).join('\n');
      const blob = new Blob([csvHeader + csvBody], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'qr_payloads.csv');
    }

    async function collectZipBlob(rows) {
      const zip = new JSZip();
      const folder = zip.folder('qr-codes');
      const canvases = Array.from(resultsBody.querySelectorAll('canvas'));

      await Promise.all(rows.map((r, i) => new Promise((resolve) => {
        const canvas = canvases[i];
        canvas.toBlob((blob) => {
          folder.file(rowFilename(i, r.__name, r.__guests, r.__email), blob);
          resolve();
        });
      })));

      return zip.generateAsync({ type: 'blob' });
    }

    async function downloadZip(rows) {
      const content = await collectZipBlob(rows);
      saveAs(content, 'qr_codes.zip');
    }

    // ===== Self‑tests (acts as basic test cases) =====
    function logTest(msg, ok, extra='') {
      const testSection = el('testSection');
      const ul = el('testLog');
      testSection.classList.remove('hidden');
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="inline-flex items-center gap-2">
          <span class="status-dot ${ok? 'bg-green-500':'bg-red-500'}"></span>
          <span>${msg}${extra ? ' – <span class=\'text-gray-500\'>' + extra + '</span>' : ''}</span>
        </span>`;
      ul.appendChild(li);
    }

    selfTestBtn.addEventListener('click', async () => {
      // Reset test log
      el('testLog').innerHTML = '';

      // Test 1: QR library availability
      try {
        const QR = await QRLoader();
        logTest('QR library loaded', !!(QR && typeof QR.toCanvas === 'function'), (window.QRCode? 'global':'esm')); 
      } catch (e) {
        logTest('QR library loaded', false, e.message);
        return; // cannot proceed
      }

      // Prepare fake data set and headers
      headers = ['Name','Guests'];
      workbookData = [
        { 'Name': 'Marc Delaney', 'Guests': 2 },
        { 'Name': 'Alex Smith', 'Guests': 1 },
        { 'Name': 'Charlie & Co.', 'Guests': '3' },
      ];
      populateColumnSelectors(headers);
      nameCol.value = encodeURIComponent('Name');
      guestsCol.value = encodeURIComponent('Guests');

      // Generate QRs
      const size = 192; const margin = 4; const template = '{"id":"{{id}}","name":"{{name}}","guests":{{guests}}}';
      const rows = workbookData.map((r, idx) => {
        const id = generateId(r['Name'], r['Guests'], idx);
        return {
          __name: r['Name'],
          __guests: r['Guests'],
          __id: id,
          __payload: buildPayload(template, r['Name'], r['Guests'], id)
        };
      });
      await renderResults(rows, { size, margin });

      // Test 2: canvases rendered
      const canvases = resultsBody.querySelectorAll('canvas');
      logTest('Renders one canvas per row', canvases.length === rows.length, `${canvases.length}/${rows.length}`);

      // Test 3: canvas has pixels
      const hasPixels = Array.from(canvases).every(c => c.width > 0 && c.height > 0 && c.toDataURL().length > 100);
      logTest('Canvas contains image data', hasPixels);

      // Test 4: CSV export generates a Blob (no download here)
      try {
        const csvHeader = 'name,guests,payload\n';
        const esc = (s) => '"' + String(s).replaceAll('"','""') + '"';
        const csvBody = rows.map(r => [esc(r.__name), esc(r.__guests), esc(r.__payload)].join(',')).join('\n');
        const blob = new Blob([csvHeader + csvBody], { type: 'text/csv;charset=utf-8;' });
        logTest('CSV Blob created', blob.size > 0, blob.type);
      } catch (e) {
        logTest('CSV Blob created', false, e.message);
      }

      // Test 5: ZIP blob build (no auto-save in test)
      try {
        const blob = await collectZipBlob(rows);
        logTest('ZIP Blob created', blob.size > 0, `${(blob.size/1024).toFixed(1)} KB`);
      } catch (e) {
        logTest('ZIP Blob created', false, e.message);
      }
    });
  </script>


</body></html>