<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist PDF Maker - Castle Fine Art</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- FONTS --- */
        @font-face {
            font-family: 'Acta W01 Bold Italic';
            src: url('fonts/Acta W01 Bold Italic.ttf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }
        @font-face {
            font-family: 'DIN LightAlternate';
            src: url('fonts/DIN LightAlternate.ttf') format('truetype');
            font-weight: 300;
        }

        /* --- RESET & VARIABLES --- */
        :root {
            --primary: #636568;
            --primary-dark: #4a4d50;
            --accent: #2c3e50;
            --bg: #f6f0e8;
            --white: #ffffff;
            --border: #e0e0e0;
            --danger: #ff4444;
            --success: #388e3c;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--primary);
            padding: 2rem;
            min-height: 100vh;
            padding-bottom: 100px; /* Space for sticky footer */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 3rem;
        }

        /* --- TYPOGRAPHY --- */
        h1 { text-align: center; font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem; }
        .subtitle { text-align: center; font-size: 1.1rem; color: #888; margin-bottom: 3rem; }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--bg);
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- FORMS --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        select, input[type="text"], textarea {
            width: 100%; padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--primary); }
        textarea { min-height: 100px; resize: vertical; }

        /* --- UPLOAD ZONE --- */
        .file-input-wrapper {
            position: relative;
            border: 3px dashed var(--border);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-wrapper.drag-over {
            border-color: var(--primary);
            background: #eef2f5;
            transform: scale(1.01);
        }

        .file-input-wrapper input[type="file"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        .upload-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }

        /* --- IMAGE GRID (SORTABLE) --- */
        #images-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .image-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: move; /* Indicates draggable */
        }

        .image-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .image-card input[type="text"] {
            font-size: 0.8rem;
            padding: 0.4rem;
        }

        .image-card .image-preview {
            max-height: 120px;
        }
        
        /* SortableJS Ghost State */
        .sortable-ghost { opacity: 0.4; background: #e0e0e0; border: 2px dashed var(--primary); }

        .image-preview {
            width: 100%; aspect-ratio: 1; object-fit: contain;
            border-radius: 4px; margin-bottom: 1rem;
            background: #f9f9f9;
        }

        .card-badge {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;
        }

        .remove-btn {
            width: 100%; padding: 0.5rem; margin-top: 0.5rem;
            background: var(--white); border: 1px solid var(--danger);
            color: var(--danger); border-radius: 4px; cursor: pointer;
            transition: 0.2s;
        }
        .remove-btn:hover { background: var(--danger); color: white; }

        /* --- ACTION BAR --- */
        .sticky-actions {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--white);
            padding: 1.5rem;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
        }

        .settings-group { display: flex; gap: 1rem; align-items: center; }
        .btn-group { display: flex; gap: 1rem; }

        .btn {
            padding: 0.8rem 1.5rem; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-secondary { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-secondary:hover { background: #f0f0f0; }

        .btn-email {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            position: relative;
            overflow: hidden;
        }
        .btn-email::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .btn-email:hover::before { left: 100%; }
        .btn-email:hover {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .btn-email:disabled {
            background: #444;
            border-color: #666;
            color: #888;
            cursor: not-allowed;
        }
        .btn-email:disabled::before { display: none; }

        /* --- PREVIEW MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            width: 90%; height: 90%; background: white;
            border-radius: 8px; position: relative; display: flex; flex-direction: column;
        }
        .modal-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; padding: 0; background: #525659; }
        iframe { width: 100%; height: 100%; border: none; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* --- VARIOUS MODE STYLES --- */
        .various-mode-container { border: 2px solid var(--primary); padding: 1.5rem; border-radius: 8px; background: #fffcf9; }
        .section-item {
            background: #f8f9fa; padding: 1rem; margin-bottom: 0.5rem;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--primary);
        }
        .section-item.editing {
            background: #fff8e6;
            border-left-color: #f0ad4e;
        }
        .section-item-buttons { display: flex; gap: 0.5rem; }
        .edit-btn {
            padding: 0.3rem 0.8rem;
            background: var(--white); border: 1px solid var(--primary);
            color: var(--primary); border-radius: 4px; cursor: pointer;
            transition: 0.2s; font-size: 0.85rem;
        }
        .edit-btn:hover { background: var(--primary); color: white; }
        .artist-name-input {
            padding: 0.3rem 0.5rem; border: 1px solid var(--border);
            border-radius: 4px; font-size: 0.9rem; margin-left: 0.5rem;
        }

        @media (max-width: 1024px) {
            #images-container { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .sticky-actions { flex-direction: column; gap: 1rem; }
            .btn-group { width: 100%; }
            .btn { flex: 1; }
            #images-container { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 480px) {
            #images-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Artist Catalog Maker</h1>
        <p class="subtitle">Generate professional, high-resolution PDFs</p>

        <div class="section">
            <h2 class="section-title">1. Catalog Details</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Mode Selection</label>
                    <select id="main-artist-select">
                        <option value="">-- Select Mode --</option>
                        <option value="various-artists">‚òÖ Various Artists (Compilation) ‚òÖ</option>
                        <option value="various-no-artist">‚òÖ Various Artists (No Artist - Free Form) ‚òÖ</option>
                        </select>
                </div>
                <div class="form-group">
                    <label>Client Name (Optional)</label>
                    <input type="text" id="client-name" placeholder="e.g., Marc Delaney">
                </div>
            </div>

            <div class="form-group">
                <label>Custom Cover Title (Optional)</label>
                <input type="text" id="custom-cover-title" placeholder="Leave blank to use artist name or 'Selected Works'">
                <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">Override the default cover page text with your own title.</p>
            </div>

            <div class="form-group">
                <label>Custom Final Message</label>
                <textarea id="custom-message" placeholder="Appears on a dedicated page before the final page..."></textarea>
            </div>
        </div>

        <div class="section" id="upload-section" style="display:none;">
            
            <div id="completed-sections-container" style="display:none; margin-bottom: 2rem;">
                <h3 class="section-title">Compilation Order</h3>
                <div id="sections-list"></div>
                <div class="empty-state" id="no-sections-msg" style="text-align:center; color:#999; padding:1rem;">No artist sections added yet.</div>
            </div>

            <div id="input-area-container">
                <h2 class="section-title" id="input-area-title">2. Upload Images</h2>

                <div class="form-group" id="sub-artist-group" style="display:none;">
                    <label style="background: var(--primary); color: white; display: inline-block; padding: 4px 8px; border-radius: 4px; margin-bottom: 10px;">Current Artist Section</label>
                    <select id="sub-artist-select">
                        <option value="">-- Select Artist --</option>
                        </select>
                </div>
                <div class="form-group" id="custom-artist-group" style="display:none;">
                    <label style="background: #f0ad4e; color: white; display: inline-block; padding: 4px 8px; border-radius: 4px; margin-bottom: 10px;">Artist Name (Optional)</label>
                    <input type="text" id="custom-artist-name" placeholder="Enter artist name or leave blank...">
                    <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">You can add images without an artist, or type an artist name for grouping.</p>
                </div>

                <div class="file-input-wrapper" id="drop-zone">
                    <input type="file" id="image-upload" multiple accept="image/*">
                    <div class="upload-icon">üìÅ</div>
                    <h3 style="margin-bottom: 0.5rem">Click or Drag Images Here</h3>
                    <p style="color: #888; font-size: 0.9rem;">Supports JPG, PNG (High Res recommended)</p>
                </div>

                <div id="images-container">
                    <div style="text-align: center; padding: 3rem; color: #ccc; font-style: italic;">
                        Images will appear here. Drag to reorder.
                    </div>
                </div>

                <button id="add-section-btn" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem; display:none;">
                    + Add This Artist Section
                </button>
            </div>
        </div>
    </div>

    <div class="sticky-actions">
        <div class="settings-group">
            <div class="form-group" style="margin-bottom: 0;">
                <label style="margin-bottom: 0.2rem; font-size: 0.7rem;">Quality</label>
                <select id="quality-select" style="padding: 0.4rem; font-size: 0.9rem; min-width: 150px;">
                    <option value="print">High (Print - 300dpi)</option>
                    <option value="web">Medium (Email/Web)</option>
                </select>
            </div>
            <div id="status-message" style="font-weight: 600; color: var(--primary);"></div>
        </div>
        <div class="btn-group">
            <button id="preview-btn" class="btn btn-secondary" disabled>üëÅ Preview PDF</button>
            <button id="generate-btn" class="btn btn-primary" disabled>‚¨á Download PDF</button>
            <button id="email-btn" class="btn btn-email" disabled>‚úâ Email via Outlook</button>
        </div>
    </div>

    <div id="preview-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>PDF Preview</h3>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const ARTIST_DATA = {
            'billy-connolly': { name: 'Billy Connolly', frontPage: 'front-pages/BCO-PDF-Front.jpg', bioFiles: ['bios/billy-connolly-page1-bio.jpg', 'bios/billy-connolly-page2-bio.jpg'] },
            'billy-schenck': { name: 'Billy Schenck', bioFiles: ['bios/billy-schenck-bio.jpg'] },
            'bisaillon-brothers': { name: 'Bisaillon Brothers', bioFiles: ['bios/bisaillon-brothers-page1-bio.jpg', 'bios/bisaillon-brothers-page2-bio.jpg'] },
            'bob-barker': { name: 'Bob Barker', bioFiles: ['bios/bob-barker-bio.jpg'] },
            'boy-george': { name: 'Boy George', frontPage: 'front-pages/BGE-PDF-Front.jpg', bioFiles: ['bios/boy-george-bio.jpg'] },
            'dan-lane': { name: 'Dan Lane', bioFiles: ['bios/dan-lane-bio.jpg'] },
            'disney-vintage': { name: 'Disney Vintage', bioFiles: [] },
            'dr-seuss': { name: 'Dr. Seuss', bioFiles: ['bios/dr-seuss-bio.jpg'] },
            'duncan-mcafee': { name: 'Duncan McAfee', bioFiles: ['bios/duncan-mcafee-bio.jpg'] },
            'eve-arnold': { name: 'Eve Arnold', bioFiles: ['bios/eve-arnold-bio.jpg'] },
            'gary-james-mcqueen': { name: 'Gary James McQueen', bioFiles: ['bios/gary-james-mcqueen-bio.jpg'] },
            'graceland-london': { name: 'Graceland London', bioFiles: ['bios/graceland-london-bio.jpg'] },
            'hanna-barbera': { name: 'Hanna-Barbera', bioFiles: [] },
            'james-francis-gill': { name: 'James Francis Gill', bioFiles: ['bios/james-francis-gill-page1-bio.jpg', 'bios/james-francis-gill-page2-bio.jpg'] },
            'james-mcqueen': { name: 'James McQueen', bioFiles: ['bios/james-mcqueen-page1-bio.jpg', 'bios/james-mcqueen-page2-bio.jpg'] },
            'john-myatt': { name: 'John Myatt', bioFiles: ['bios/john-myatt-page1-bio.jpg', 'bios/john-myatt-page2-bio.jpg'] },
            'jon-jones': { name: 'Jon Jones', bioFiles: ['bios/jon-jones-page1-bio.jpg', 'bios/jon-jones-page2-bio.jpg'] },
            'johnny-depp': { name: 'Johnny Depp', frontPage: 'front-pages/JDE-PDF-Front.jpg', bioFiles: ['bios/johnny-depp-bio.jpg'] },
            'joseph-jones': { name: 'Joseph Jones', bioFiles: ['bios/joseph-jones-bio.jpg'] },
            'lawrence-coulson': { name: 'Lawrence Coulson', bioFiles: ['bios/lawrence-coulson-page1-bio.jpg', 'bios/lawrence-coulson-page2-bio.jpg'] },
            'lorenzo-quinn': { name: 'Lorenzo Quinn', bioFiles: ['bios/lorenzo-quinn-bio.jpg'] },
            'marco-olivier': { name: 'Marco Olivier', bioFiles: [] },
            'marvel': { name: 'Marvel', bioFiles: ['bios/marvel-page1-bio.jpg', 'bios/marvel-page2-bio.jpg'] },
            'nic-joly': { name: 'Nic Joly', bioFiles: ['bios/nic-joly-page1-bio.jpg', 'bios/nic-joly-page2-bio.jpg'] },
            'nigel-humphries': { name: 'Nigel Humphries', bioFiles: ['bios/nigel-humphries-bio.jpg'] },
            'pascale-taurua': { name: 'Pascale Taurua', bioFiles: ['bios/pascale-taurua-bio.jpg'] },
            'paul-corfield': { name: 'Paul Corfield', bioFiles: ['bios/paul-corfield-page1-bio.jpg', 'bios/paul-corfield-page2-bio.jpg'] },
            'paul-kenton': { name: 'Paul Kenton', bioFiles: ['bios/paul-kenton-bio.jpg'] },
            'paulo-ferreira': { name: 'Paulo Ferreira', bioFiles: ['bios/paulo-ferreira-bio.jpg'] },
            'peter-smith': { name: 'Peter Smith', bioFiles: ['bios/peter-smith-bio.jpg'] },
            'raphael-mazzucco': { name: 'Raphael Mazzucco', bioFiles: ['bios/raphael-mazzucco-bio.jpg'] },
            'rich-simmons': { name: 'Rich Simmons', bioFiles: [] },
            'richard-hambleton': { name: 'Richard Hambleton', bioFiles: ['bios/richard-hambleton-page1-bio.jpg', 'bios/richard-hambleton-page2-bio.jpg'] },
            'richard-rowan': { name: 'Richard Rowan', bioFiles: ['bios/richard-rowan-page1-bio.jpg', 'bios/richard-rowan-page2-bio.jpg'] },
            'robert-bailey': { name: 'Robert Bailey', bioFiles: ['bios/robert-bailey-bio.jpg'] },
            'robert-oxley': { name: 'Robert Oxley', bioFiles: ['bios/robert-oxley-bio.jpg'] },
            'romero-britto': { name: 'Romero Britto', bioFiles: ['bios/romero-britto-bio.jpg'] },
            'ron-english': { name: 'Ron English', bioFiles: ['bios/ron-english-page1-bio.jpg', 'bios/ron-english-page2-bio.jpg'] },
            'ronnie-wood': { name: 'Ronnie Wood', bioFiles: ['bios/ronnie-wood-bio.jpg'] },
            'scarlett-raven': { name: 'Scarlett Raven', bioFiles: ['bios/scarlett-raven-bio.jpg'] },
            'shazia': { name: 'Shazia', bioFiles: ['bios/shazia-page1-bio.jpg', 'bios/shazia-page2-bio.jpg'] },
            'steve-winterburn': { name: 'Steve Winterburn', bioFiles: ['bios/steve-winterburn-page1-bio.jpg', 'bios/steve-winterburn-page2-bio.jpg'] },
            'whatshisname': { name: 'Whatshisname', bioFiles: ['bios/whatshisname-page1-bio.jpg', 'bios/whatshisname-page2-bio.jpg'] }
        };

        // --- STATE ---
        let appMode = 'single'; // 'single', 'various', 'various-no-artist'
        let selectedMainArtist = null;
        let selectedSubArtist = null;
        let uploadedImages = []; // Staging array
        let pdfSections = []; // Compilation array
        let sortableInstance = null;
        let editingSectionId = null; // Track which section is being edited

        // --- ELEMENTS ---
        const els = {
            mainSelect: document.getElementById('main-artist-select'),
            subSelect: document.getElementById('sub-artist-select'),
            subGroup: document.getElementById('sub-artist-group'),
            customArtistGroup: document.getElementById('custom-artist-group'),
            customArtistName: document.getElementById('custom-artist-name'),
            clientInput: document.getElementById('client-name'),
            customCoverTitle: document.getElementById('custom-cover-title'),
            msgInput: document.getElementById('custom-message'),
            uploadSection: document.getElementById('upload-section'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('image-upload'),
            imgContainer: document.getElementById('images-container'),
            sectionsList: document.getElementById('sections-list'),
            noSectionsMsg: document.getElementById('no-sections-msg'),
            completedContainer: document.getElementById('completed-sections-container'),
            inputArea: document.getElementById('input-area-container'),
            inputTitle: document.getElementById('input-area-title'),
            addSectionBtn: document.getElementById('add-section-btn'),
            generateBtn: document.getElementById('generate-btn'),
            previewBtn: document.getElementById('preview-btn'),
            emailBtn: document.getElementById('email-btn'),
            status: document.getElementById('status-message'),
            quality: document.getElementById('quality-select'),
            modal: document.getElementById('preview-modal'),
            iframe: document.getElementById('preview-frame')
        };

        // --- INIT ---
        function init() {
            // Populate Dropdowns
            const keys = Object.keys(ARTIST_DATA).sort();
            keys.forEach(key => {
                const opt1 = new Option(ARTIST_DATA[key].name, key);
                const opt2 = new Option(ARTIST_DATA[key].name, key);
                els.mainSelect.add(opt1);
                els.subSelect.add(opt2);
            });

            // Listeners
            els.mainSelect.addEventListener('change', handleModeChange);
            els.subSelect.addEventListener('change', (e) => {
                selectedSubArtist = e.target.value;
                updateUI();
            });
            
            // Upload & Drag Drop
            els.fileInput.addEventListener('change', handleFiles);
            setupDragDrop();

            // Actions
            els.addSectionBtn.addEventListener('click', addSection);
            els.generateBtn.addEventListener('click', () => runPDFProcess('download'));
            els.previewBtn.addEventListener('click', () => runPDFProcess('preview'));
            els.emailBtn.addEventListener('click', openEmailInOutlook);
            
            // Inputs
            window.removeImage = removeImage; // Global scope for onclick
            window.updateData = updateData;
        }

        // --- LOGIC ---

        function handleModeChange(e) {
            const val = e.target.value;

            // Reset Staging
            uploadedImages = [];
            editingSectionId = null;
            renderImages();

            if (val === 'various-artists') {
                appMode = 'various';
                selectedMainArtist = null;
                els.subGroup.style.display = 'block';
                els.customArtistGroup.style.display = 'none';
                els.completedContainer.style.display = 'block';
                els.addSectionBtn.style.display = 'block';
                els.addSectionBtn.textContent = '+ Add This Artist Section';
                els.inputArea.classList.add('various-mode-container');
                els.inputTitle.innerText = "2. Add Artist Section";
                els.uploadSection.style.display = 'block';
                // Reset sub
                els.subSelect.value = "";
                selectedSubArtist = null;
            } else if (val === 'various-no-artist') {
                appMode = 'various-no-artist';
                selectedMainArtist = null;
                els.subGroup.style.display = 'none';
                els.customArtistGroup.style.display = 'block';
                els.customArtistName.value = '';
                els.completedContainer.style.display = 'block';
                els.addSectionBtn.style.display = 'block';
                els.addSectionBtn.textContent = '+ Add Images to PDF';
                els.inputArea.classList.add('various-mode-container');
                els.inputTitle.innerText = "2. Add Images (Free Form)";
                els.uploadSection.style.display = 'block';
            } else if (val) {
                appMode = 'single';
                selectedMainArtist = val;
                els.subGroup.style.display = 'none';
                els.customArtistGroup.style.display = 'none';
                els.completedContainer.style.display = 'none';
                els.addSectionBtn.style.display = 'none';
                els.inputArea.classList.remove('various-mode-container');
                els.inputTitle.innerText = "2. Upload Images";
                els.uploadSection.style.display = 'block';
                // Clear previous compilation
                pdfSections = [];
                renderSections();
            } else {
                els.uploadSection.style.display = 'none';
            }
            updateUI();
        }

        function setupDragDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                els.dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            els.dropZone.addEventListener('dragover', () => els.dropZone.classList.add('drag-over'));
            els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.remove('drag-over'));
            els.dropZone.addEventListener('drop', (e) => {
                els.dropZone.classList.remove('drag-over');
                handleFiles({ target: { files: e.dataTransfer.files } });
            });
        }

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            
            let loaded = 0;
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        uploadedImages.push({
                            id: Date.now() + Math.random(),
                            src: evt.target.result,
                            title: '', medium: '', size: '', price: ''
                        });
                        loaded++;
                        if(loaded === files.length) {
                            renderImages();
                            updateUI();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
            els.fileInput.value = ''; // Reset
        }

        function renderImages() {
            if (uploadedImages.length === 0) {
                els.imgContainer.innerHTML = `<div style="text-align: center; padding: 3rem; color: #ccc; font-style: italic;">Images will appear here. Drag to reorder.</div>`;
                return;
            }

            els.imgContainer.innerHTML = uploadedImages.map((img, index) => `
                <div class="image-card" data-id="${img.id}">
                    <div class="card-badge">${index + 1}</div>
                    <img src="${img.src}" class="image-preview">
                    <input type="text" placeholder="Title" value="${img.title}" onchange="updateData('${img.id}', 'title', this.value)">
                    <input type="text" placeholder="Medium" value="${img.medium}" onchange="updateData('${img.id}', 'medium', this.value)" style="margin-top:0.5rem">
                    <div style="display:flex; gap:0.5rem; margin-top:0.5rem">
                        <input type="text" placeholder="Size" value="${img.size}" onchange="updateData('${img.id}', 'size', this.value)">
                        <input type="text" placeholder="Price" value="${img.price}" onchange="updateData('${img.id}', 'price', this.value)">
                    </div>
                    <button class="remove-btn" onclick="removeImage('${img.id}')">Remove</button>
                </div>
            `).join('');

            // Initialize Sortable
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(els.imgContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    // Reorder array based on DOM
                    const item = uploadedImages.splice(evt.oldIndex, 1)[0];
                    uploadedImages.splice(evt.newIndex, 0, item);
                    // Re-render to update index badges
                    renderImages(); 
                }
            });
        }

        function updateData(id, field, value) {
            const img = uploadedImages.find(i => i.id == id);
            if(img) img[field] = value;
        }

        function removeImage(id) {
            uploadedImages = uploadedImages.filter(i => i.id != id);
            renderImages();
            updateUI();
        }

        // --- COMPILATION LOGIC (VARIOUS MODE) ---
        function addSection() {
            if (!uploadedImages.length) return;

            if (appMode === 'various') {
                // Standard various artists mode - require artist selection
                if (!selectedSubArtist) return;

                if (editingSectionId) {
                    // Update existing section
                    const section = pdfSections.find(s => s.id === editingSectionId);
                    if (section) {
                        section.artistKey = selectedSubArtist;
                        section.artistName = ARTIST_DATA[selectedSubArtist].name;
                        section.images = [...uploadedImages];
                    }
                    editingSectionId = null;
                    els.addSectionBtn.textContent = '+ Add This Artist Section';
                } else {
                    // Add new section
                    pdfSections.push({
                        id: Date.now(),
                        artistKey: selectedSubArtist,
                        artistName: ARTIST_DATA[selectedSubArtist].name,
                        images: [...uploadedImages]
                    });
                }

                // Reset Staging
                uploadedImages = [];
                els.subSelect.value = "";
                selectedSubArtist = null;

            } else if (appMode === 'various-no-artist') {
                // Free form mode - artist is optional
                const customName = els.customArtistName.value.trim();

                if (editingSectionId) {
                    // Update existing section
                    const section = pdfSections.find(s => s.id === editingSectionId);
                    if (section) {
                        section.artistKey = null;
                        section.artistName = customName || null;
                        section.images = [...uploadedImages];
                    }
                    editingSectionId = null;
                    els.addSectionBtn.textContent = '+ Add Images to PDF';
                } else {
                    // Add new section
                    pdfSections.push({
                        id: Date.now(),
                        artistKey: null,
                        artistName: customName || null,
                        images: [...uploadedImages]
                    });
                }

                // Reset Staging
                uploadedImages = [];
                els.customArtistName.value = '';
            }

            renderImages();
            renderSections();
            updateUI();
        }

        function editSection(id) {
            const section = pdfSections.find(s => s.id === id);
            if (!section) return;

            // Load section data into staging area
            editingSectionId = id;
            uploadedImages = [...section.images];

            if (appMode === 'various') {
                els.subSelect.value = section.artistKey || '';
                selectedSubArtist = section.artistKey;
                els.addSectionBtn.textContent = '‚úì Save Changes';
            } else if (appMode === 'various-no-artist') {
                els.customArtistName.value = section.artistName || '';
                els.addSectionBtn.textContent = '‚úì Save Changes';
            }

            renderImages();
            renderSections();
            updateUI();

            // Scroll to upload area
            els.inputArea.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingSectionId = null;
            uploadedImages = [];

            if (appMode === 'various') {
                els.subSelect.value = '';
                selectedSubArtist = null;
                els.addSectionBtn.textContent = '+ Add This Artist Section';
            } else if (appMode === 'various-no-artist') {
                els.customArtistName.value = '';
                els.addSectionBtn.textContent = '+ Add Images to PDF';
            }

            renderImages();
            renderSections();
            updateUI();
        }

        function renderSections() {
            els.sectionsList.innerHTML = '';
            if (!pdfSections.length) {
                els.noSectionsMsg.style.display = 'block';
                return;
            }
            els.noSectionsMsg.style.display = 'none';

            pdfSections.forEach((section, idx) => {
                const div = document.createElement('div');
                div.className = 'section-item' + (editingSectionId === section.id ? ' editing' : '');

                const displayName = section.artistName || '(No Artist)';
                const isEditing = editingSectionId === section.id;

                div.innerHTML = `
                    <div><strong>${idx + 1}. ${displayName}</strong> <span style="color:#888">(${section.images.length} images)</span>${isEditing ? ' <span style="color:#f0ad4e; font-weight:bold;">[EDITING]</span>' : ''}</div>
                    <div class="section-item-buttons">
                        ${isEditing
                            ? `<button class="edit-btn" onclick="cancelEdit()">Cancel</button>`
                            : `<button class="edit-btn" onclick="editSection(${section.id})">Edit</button>`
                        }
                        <button class="remove-btn" style="width:auto; margin:0" onclick="removeSection(${section.id})">Delete</button>
                    </div>
                `;
                els.sectionsList.appendChild(div);
            });
        }

        window.removeSection = function(id) {
            // If we're editing this section, cancel the edit
            if (editingSectionId === id) {
                cancelEdit();
            }
            pdfSections = pdfSections.filter(s => s.id !== id);
            renderSections();
            updateUI();
        };

        window.editSection = editSection;
        window.cancelEdit = cancelEdit;

        function updateUI() {
            let ready = false;
            if (appMode === 'single') {
                ready = selectedMainArtist && uploadedImages.length > 0;
            } else if (appMode === 'various') {
                ready = pdfSections.length > 0;
                els.addSectionBtn.disabled = !(selectedSubArtist && uploadedImages.length > 0);
            } else if (appMode === 'various-no-artist') {
                ready = pdfSections.length > 0;
                // In no-artist mode, just need images (artist name is optional)
                els.addSectionBtn.disabled = uploadedImages.length === 0;
            }
            els.generateBtn.disabled = !ready;
            els.previewBtn.disabled = !ready;
            els.emailBtn.disabled = !ready;
        }

        // --- PDF GENERATION ENGINE ---
        async function runPDFProcess(action) {
            els.status.textContent = "‚è≥ Generating pages...";
            els.generateBtn.disabled = true;
            els.previewBtn.disabled = true;

            try {
                const pdf = await createPDF();
                
                if (action === 'download') {
                    let name = appMode === 'single' ? ARTIST_DATA[selectedMainArtist].name : "Various_Artists";
                    if(els.clientInput.value) name += `_For_${els.clientInput.value}`;
                    name = name.replace(/\s+/g, '_') + '.pdf';
                    pdf.save(name);
                    els.status.textContent = "‚úÖ Download Started";
                    els.status.style.color = "var(--success)";
                } else {
                    const blob = pdf.output('bloburl');
                    els.iframe.src = blob;
                    els.modal.style.display = 'flex';
                    els.status.textContent = "";
                }
            } catch (err) {
                console.error(err);
                els.status.textContent = "‚ùå Error: " + err.message;
                els.status.style.color = "var(--danger)";
            } finally {
                updateUI(); // Re-enable buttons
                setTimeout(() => els.status.textContent = "", 4000);
            }
        }

        async function createPDF() {
            const { jsPDF } = window.jspdf;
            const size = 8.27; // Square inches
            const pdf = new jsPDF({ unit: 'in', format: [size, size] });
            
            // Get Data to print
            const sections = appMode === 'single' 
                ? [{ artistKey: selectedMainArtist, images: uploadedImages }]
                : pdfSections;

            // Image Compression Settings
            const quality = els.quality.value === 'web' ? 0.6 : 0.95;

            // 1. Cover
            const customTitle = els.customCoverTitle.value.trim();
            const defaultCoverName = appMode === 'single' ? ARTIST_DATA[selectedMainArtist].name : "Selected Works";
            const coverName = customTitle || defaultCoverName;
            let coverImg = null;

            // Try to load custom cover if exists and no client name AND no custom title
            if (appMode === 'single' && !els.clientInput.value.trim() && !customTitle && ARTIST_DATA[selectedMainArtist].frontPage) {
                try { coverImg = await loadImageData(ARTIST_DATA[selectedMainArtist].frontPage, quality); } catch(e){}
            }
            // Else generate
            if (!coverImg) coverImg = await generateCoverCanvas(coverName, els.clientInput.value, quality);
            
            pdf.addImage(coverImg, 'JPEG', 0, 0, size, size);

            // 2. About Us
            try {
                const aboutImg = await loadImageData('aboutus.jpg', quality);
                pdf.addPage();
                pdf.addImage(aboutImg, 'JPEG', 0, 0, size, size);
            } catch(e) {} // Skip if missing

            // 3. Sections
            for (const section of sections) {
                const artist = section.artistKey ? ARTIST_DATA[section.artistKey] : null;

                // Bios (only if we have an artist with bio files)
                if (artist && artist.bioFiles) {
                    for (const bio of artist.bioFiles) {
                        try {
                            const bioImg = await loadImageData(bio, quality);
                            pdf.addPage();
                            pdf.addImage(bioImg, 'JPEG', 0, 0, size, size);
                        } catch(e){}
                    }
                }

                // Products
                for (const imgData of section.images) {
                    pdf.addPage();
                    // Background
                    pdf.setFillColor(246, 240, 232);
                    pdf.rect(0, 0, size, size, 'F');
                    
                    // Product Image logic
                    const imgObj = await loadImage(imgData.src);
                    const ratio = imgObj.width / imgObj.height;
                    let w, h;
                    const maxW = size * 0.6;
                    const maxH = size * 0.5;

                    if (ratio > 1) { w = maxW; h = maxW / ratio; }
                    else { h = maxH; w = maxH * ratio; }

                    const x = (size - w) / 2;
                    const y = 1.5;

                    // Shadow
                    pdf.setFillColor(0,0,0);
                    pdf.setGState(new pdf.GState({ opacity: 0.15 }));
                    pdf.rect(x + 0.05, y + 0.05, w, h, 'F');
                    pdf.setGState(new pdf.GState({ opacity: 1 }));

                    // Image
                    pdf.addImage(imgData.src, 'JPEG', x, y, w, h);
                    
                    // Border
                    pdf.setDrawColor(200,200,200);
                    pdf.setLineWidth(0.01);
                    pdf.rect(x, y, w, h, 'S');

                    // Text
                    pdf.setTextColor(99, 101, 104);
                    const textY = y + h + 0.5;
                    const spacing = 0.3;

                    pdf.setFont('helvetica', 'bolditalic');
                    pdf.setFontSize(22);
                    pdf.text(imgData.title || '', size/2, textY, { align: 'center' });

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(14);
                    pdf.text(imgData.medium || '', size/2, textY + spacing, { align: 'center' });
                    pdf.text(imgData.size || '', size/2, textY + (spacing*2), { align: 'center' });

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(18);
                    pdf.text(imgData.price || '', size/2, textY + (spacing*3), { align: 'center' });
                }
            }

            // 4. Custom Message
            if (els.msgInput.value.trim()) {
                const msgImg = await generateMessageCanvas(els.msgInput.value, quality);
                pdf.addPage();
                pdf.addImage(msgImg, 'JPEG', 0, 0, size, size);
            }

            // 5. Final Page
            try {
                const finalImg = await loadImageData('ywoa.jpg', quality);
                pdf.addPage();
                pdf.addImage(finalImg, 'JPEG', 0, 0, size, size);
            } catch(e){}

            return pdf;
        }

        // --- HELPERS ---
        function closeModal() { els.modal.style.display = 'none'; }
        
        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function loadImageData(url, quality) {
            // Helper to get DataURL with specific compression
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
                img.src = url;
            });
        }

        async function generateCoverCanvas(title, subtitle, quality) {
            const size = 1654; // High res
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            // Bg
            try {
                const tpl = await loadImage('front-pages/Front Template.jpg');
                ctx.drawImage(tpl, 0, 0, size, size);
            } catch(e) {
                ctx.fillStyle = "#636568"; ctx.fillRect(0,0,size,size);
            }

            ctx.fillStyle = '#f6f0e8';
            ctx.textAlign = 'center'; 
            ctx.textBaseline = 'middle';
            
            // Title (Fallback font if Acta not loaded)
            ctx.font = 'italic bold 168px "Acta W01 Bold Italic", Georgia, serif';
            
            const lines = title.split(' ');
            let y = size/2;
            if(subtitle) y -= 100;
            
            lines.forEach((line, i) => {
                // Simple centering adjustment for multiple lines
                const offset = (i - (lines.length-1)/2) * 180;
                ctx.fillText(line, size/2, y + offset);
            });

            if (subtitle) {
                ctx.font = '300 60px "DIN LightAlternate", Arial, sans-serif';
                ctx.fillText(`For ${subtitle}`, size/2, y + (lines.length * 90) + 120);
            }

            return canvas.toDataURL('image/jpeg', quality);
        }

        async function generateMessageCanvas(msg, quality) {
            const size = 1654;
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');

            try {
                const tpl = await loadImage('front-pages/Front Template.jpg');
                ctx.drawImage(tpl, 0, 0, size, size);
            } catch(e) {
                ctx.fillStyle = "#636568"; ctx.fillRect(0,0,size,size);
            }

            ctx.fillStyle = '#f6f0e8';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '300 60px "DIN LightAlternate", Arial, sans-serif';

            const lines = msg.split('\n');
            const lineHeight = 100;
            const startY = (size - (lines.length * lineHeight)) / 2;

            lines.forEach((line, i) => {
                ctx.fillText(line, size/2, startY + (i * lineHeight));
            });

            return canvas.toDataURL('image/jpeg', quality);
        }

        // --- EMAIL GENERATION ---
        function openEmailInOutlook() {
            const sections = appMode === 'single'
                ? [{ artistKey: selectedMainArtist, artistName: ARTIST_DATA[selectedMainArtist].name, images: uploadedImages }]
                : pdfSections;

            const clientName = els.clientInput.value.trim();
            const customTitle = els.customCoverTitle.value.trim();
            const customMessage = els.msgInput.value.trim();

            // Determine the main title
            let mainTitle = customTitle;
            if (!mainTitle) {
                mainTitle = appMode === 'single' ? ARTIST_DATA[selectedMainArtist].name : 'Selected Works';
            }

            // Build elegant HTML email
            const emailHTML = generateEmailHTML(sections, mainTitle, clientName, customMessage);

            // Create subject line
            let subject = `Castle Fine Art | ${mainTitle}`;
            if (clientName) subject += ` - Curated for ${clientName}`;

            // Open in Outlook
            // For better HTML support, we'll copy to clipboard and open mailto
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailHTML)}`;

            // Check if the content is too long for mailto (typically ~2000 chars limit)
            if (mailtoLink.length > 2000) {
                // Copy HTML to clipboard and show instructions
                copyEmailToClipboard(emailHTML, subject, sections, mainTitle, clientName, customMessage);
            } else {
                window.location.href = mailtoLink;
                els.status.textContent = "‚úâ Opening Outlook...";
                els.status.style.color = "var(--primary)";
                setTimeout(() => els.status.textContent = "", 3000);
            }
        }

        function generateEmailHTML(sections, mainTitle, clientName, customMessage) {
            const greeting = clientName ? `Dear ${clientName},` : 'Dear Collector,';

            // Build artwork sections
            let artworkHTML = '';
            sections.forEach((section, sectionIdx) => {
                const artistName = section.artistName || '';

                // Artist divider (only if we have an artist name and multiple sections)
                if (artistName && sections.length > 1) {
                    artworkHTML += `

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    ${artistName.toUpperCase()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;
                }

                section.images.forEach((img, idx) => {
                    const pieceNum = sections.length > 1
                        ? `${sectionIdx + 1}.${idx + 1}`
                        : `${idx + 1}`;

                    // Format price - add ¬£ if starts with a number
                    let formattedPrice = img.price || '';
                    if (formattedPrice && /^\d/.test(formattedPrice)) {
                        formattedPrice = '¬£' + formattedPrice;
                    }

                    artworkHTML += `
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚Ññ ${pieceNum}
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ
‚îÇ  "${img.title || 'Untitled'}"
‚îÇ                                         `;

                    if (artistName) {
                        artworkHTML += `
‚îÇ  by ${artistName}
‚îÇ                                         `;
                    }

                    if (img.medium) {
                        artworkHTML += `
‚îÇ  Medium: ${img.medium}                  `;
                    }

                    if (img.size) {
                        artworkHTML += `
‚îÇ  Dimensions: ${img.size}                `;
                    }

                    if (formattedPrice) {
                        artworkHTML += `
‚îÇ
‚îÇ  ‚òÖ ${formattedPrice}                    `;
                    }

                    artworkHTML += `
‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

`;
                });
            });

            // Calculate total pieces
            const totalPieces = sections.reduce((sum, s) => sum + s.images.length, 0);
            const artistCount = new Set(sections.map(s => s.artistName).filter(Boolean)).size;

            // Build the complete email
            let email = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                               ‚ïë
‚ïë                      C A S T L E                              ‚ïë
‚ïë                     FINE ART                                  ‚ïë
‚ïë                                                               ‚ïë
‚ïë              ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ú¶ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                ‚ïë
‚ïë                                                               ‚ïë
‚ïë                  ${mainTitle.toUpperCase().padStart(20 + mainTitle.length/2).padEnd(40)}
‚ïë                                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù


${greeting}

Thank you for your interest in Castle Fine Art. We are delighted to present this personally curated selection of exceptional artworks for your consideration.

This collection features ${totalPieces} distinguished piece${totalPieces !== 1 ? 's' : ''}${artistCount > 1 ? ` from ${artistCount} artists` : artistCount === 1 ? ` by ${sections[0].artistName}` : ''}, each representing the pinnacle of contemporary artistry.


‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    CURATED COLLECTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${artworkHTML}`;

            // Add custom message if provided
            if (customMessage) {
                email += `

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    A PERSONAL NOTE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${customMessage}

`;
            }

            // Footer
            email += `

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


We would be honoured to arrange a private viewing at your convenience,
where you can experience these remarkable works in person.

Please do not hesitate to contact us with any questions or to
discuss these pieces further.


With warm regards,



Your Art Consultant
Castle Fine Art

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Castle Fine Art | Exceptional Art for Exceptional Spaces
www.castlefineart.com
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

This email and any attachments are confidential and intended
solely for the use of the individual to whom it is addressed.
`;

            return email;
        }

        function copyEmailToClipboard(emailHTML, subject, sections, mainTitle, clientName, customMessage) {
            // Create a rich text version for clipboard
            const richHTML = `
<!DOCTYPE html>
<html>
<head>
<style>
body {
    font-family: 'Georgia', 'Times New Roman', serif;
    background: linear-gradient(135deg, #faf8f5 0%, #f5f0e8 100%);
    color: #2c2c2c;
    line-height: 1.8;
    padding: 40px;
    max-width: 700px;
    margin: 0 auto;
}
.header {
    text-align: center;
    padding: 50px 30px;
    background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    color: #f5f0e8;
    margin: -40px -40px 40px -40px;
    border-bottom: 4px solid #d4af37;
}
.header h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 28px;
    letter-spacing: 12px;
    margin: 0 0 5px 0;
    font-weight: 400;
}
.header h2 {
    font-size: 14px;
    letter-spacing: 6px;
    margin: 0 0 20px 0;
    font-weight: 300;
}
.header .divider {
    color: #d4af37;
    font-size: 18px;
    margin: 15px 0;
}
.header h3 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 22px;
    font-style: italic;
    font-weight: 400;
    margin: 0;
    color: #d4af37;
}
.greeting {
    font-size: 18px;
    margin-bottom: 25px;
}
.intro {
    font-size: 16px;
    color: #4a4a4a;
    margin-bottom: 35px;
    border-left: 3px solid #d4af37;
    padding-left: 20px;
}
.section-title {
    text-align: center;
    font-size: 14px;
    letter-spacing: 4px;
    color: #888;
    margin: 40px 0 30px 0;
    text-transform: uppercase;
}
.artwork {
    background: white;
    border: 1px solid #e8e4de;
    padding: 30px;
    margin-bottom: 25px;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
}
.artwork::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 4px; height: 100%;
    background: linear-gradient(180deg, #d4af37, #b8860b);
}
.artwork-number {
    position: absolute;
    top: 15px; right: 20px;
    font-size: 12px;
    color: #999;
    letter-spacing: 2px;
}
.artwork-image {
    background: #f9f9f9;
    padding: 20px;
    margin: -30px -30px 30px -30px;
    border-bottom: 1px solid #e8e4de;
}
.artwork-image img {
    display: block;
    margin: 0 auto;
}
.artwork-title {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 22px;
    font-style: italic;
    color: #1a1a2e;
    margin-bottom: 8px;
    text-align: center;
}
.artwork-artist {
    font-size: 14px;
    color: #666;
    letter-spacing: 1px;
    margin-bottom: 15px;
    text-align: center;
}
.artwork-details {
    font-size: 14px;
    color: #555;
    text-align: center;
}
.artwork-details span {
    display: inline-block;
    margin: 0 12px;
    padding: 5px 0;
}
.artwork-price {
    font-size: 20px;
    color: #1a1a2e;
    font-weight: 600;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    text-align: center;
}
.personal-note {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #f5f0e8;
    padding: 35px;
    margin: 40px 0;
    text-align: center;
    font-style: italic;
    line-height: 2;
}
.personal-note h4 {
    color: #d4af37;
    font-size: 12px;
    letter-spacing: 4px;
    margin-bottom: 20px;
    font-weight: 400;
}
.closing {
    margin-top: 40px;
    padding: 30px;
    background: #faf8f5;
    border: 1px solid #e8e4de;
    text-align: center;
}
.closing p {
    margin: 10px 0;
    color: #555;
}
.signature {
    margin-top: 25px;
    font-style: italic;
    color: #888;
}
.footer {
    text-align: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #d4af37;
    font-size: 12px;
    color: #888;
    letter-spacing: 1px;
}
.artist-divider {
    text-align: center;
    margin: 40px 0 30px 0;
    padding: 20px;
    background: #f5f0e8;
    border-top: 2px solid #d4af37;
    border-bottom: 2px solid #d4af37;
}
.artist-divider h4 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 18px;
    letter-spacing: 3px;
    margin: 0;
    color: #1a1a2e;
}
</style>
</head>
<body>
${generateRichEmailBody(sections, mainTitle, clientName, customMessage)}
</body>
</html>`;

            // Copy HTML to clipboard as rich text
            const blob = new Blob([richHTML], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({
                'text/html': blob,
                'text/plain': new Blob([emailHTML], { type: 'text/plain' })
            });

            navigator.clipboard.write([clipboardItem]).then(() => {
                showEmailInstructionsModal(subject, richHTML);
            }).catch(err => {
                // Fallback: try plain text
                navigator.clipboard.writeText(emailHTML).then(() => {
                    showEmailInstructionsModal(subject, richHTML);
                }).catch(() => {
                    showEmailInstructionsModal(subject, richHTML);
                });
            });
        }

        function generateRichEmailBody(sections, mainTitle, clientName, customMessage) {
            const greeting = clientName ? `Dear ${clientName},` : 'Dear Collector,';
            const totalPieces = sections.reduce((sum, s) => sum + s.images.length, 0);
            const artistCount = new Set(sections.map(s => s.artistName).filter(Boolean)).size;

            let artistsText = '';
            if (artistCount > 1) {
                artistsText = ` from ${artistCount} celebrated artists`;
            } else if (artistCount === 1 && sections[0].artistName) {
                artistsText = ` by ${sections[0].artistName}`;
            }

            let artworksHTML = '';
            let globalIdx = 1;

            sections.forEach((section, sectionIdx) => {
                // Add artist divider for multi-artist compilations
                if (section.artistName && sections.length > 1) {
                    artworksHTML += `
                    <div class="artist-divider">
                        <h4>${section.artistName.toUpperCase()}</h4>
                    </div>`;
                }

                section.images.forEach((img, idx) => {
                    const pieceNum = sections.length > 1
                        ? `${sectionIdx + 1}.${idx + 1}`
                        : `${globalIdx}`;

                    // Format price - add ¬£ if starts with a number
                    let formattedPrice = img.price || '';
                    if (formattedPrice && /^\d/.test(formattedPrice)) {
                        formattedPrice = '¬£' + formattedPrice;
                    }

                    artworksHTML += `
                    <div class="artwork">
                        <div class="artwork-number">‚Ññ ${pieceNum}</div>
                        <div class="artwork-image" style="text-align: center; margin-bottom: 30px;">
                            <img src="${img.src}" alt="${img.title || 'Artwork'}" style="max-width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #e8e4de; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        </div>
                        <div class="artwork-title">"${img.title || 'Untitled'}"</div>
                        ${section.artistName ? `<div class="artwork-artist">by ${section.artistName}</div>` : ''}
                        <div class="artwork-details">
                            ${img.medium ? `<span><strong>Medium:</strong> ${img.medium}</span>` : ''}
                            ${img.size ? `<span><strong>Dimensions:</strong> ${img.size}</span>` : ''}
                        </div>
                        ${formattedPrice ? `<div class="artwork-price">${formattedPrice}</div>` : ''}
                    </div>`;
                    globalIdx++;
                });
            });

            let personalNoteHTML = '';
            if (customMessage) {
                personalNoteHTML = `
                <div class="personal-note">
                    <h4>A PERSONAL NOTE</h4>
                    <p>${customMessage.replace(/\n/g, '<br>')}</p>
                </div>`;
            }

            return `
            <div class="header">
                <h1>CASTLE</h1>
                <h2>FINE ART</h2>
                <div class="divider">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ú¶ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                <h3>${mainTitle}</h3>
            </div>

            <p class="greeting">${greeting}</p>

            <p class="intro">
                Thank you for your interest in Castle Fine Art. We are delighted to present this personally
                curated selection of exceptional artworks for your consideration.<br><br>
                This collection features <strong>${totalPieces} distinguished piece${totalPieces !== 1 ? 's' : ''}</strong>${artistsText},
                each representing the pinnacle of contemporary artistry.
            </p>

            <div class="section-title">‚îÄ‚îÄ‚îÄ Curated Collection ‚îÄ‚îÄ‚îÄ</div>

            ${artworksHTML}

            ${personalNoteHTML}

            <div class="closing">
                <p>We would be honoured to arrange a <strong>private viewing</strong> at your convenience,</p>
                <p>where you can experience these remarkable works in person.</p>
                <p>Please do not hesitate to contact us with any questions.</p>
                <div class="signature">
                    <p>With warm regards,</p>
                    <p><strong>Your Art Consultant</strong></p>
                    <p>Castle Fine Art</p>
                </div>
            </div>

            <div class="footer">
                <p>CASTLE FINE ART | EXCEPTIONAL ART FOR EXCEPTIONAL SPACES</p>
                <p>www.castlefineart.com</p>
            </div>`;
        }

        function showEmailInstructionsModal(subject, content) {
            // Create modal for instructions
            const modal = document.createElement('div');
            modal.id = 'email-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.85); z-index: 2000;
                display: flex; justify-content: center; align-items: center;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    color: #f5f0e8;
                    padding: 50px;
                    border-radius: 12px;
                    max-width: 600px;
                    text-align: center;
                    box-shadow: 0 25px 80px rgba(0,0,0,0.5);
                    border: 2px solid #d4af37;
                    position: relative;
                ">
                    <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
                        background: linear-gradient(135deg, #d4af37, #b8860b);
                        color: #1a1a2e;
                        width: 60px; height: 60px;
                        border-radius: 50%;
                        display: flex; align-items: center; justify-content: center;
                        font-size: 28px;
                        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
                    ">‚úâ</div>

                    <h2 style="
                        font-family: Georgia, serif;
                        font-size: 24px;
                        margin: 20px 0 10px 0;
                        letter-spacing: 3px;
                    ">EMAIL READY</h2>

                    <p style="color: #d4af37; font-size: 14px; letter-spacing: 2px; margin-bottom: 30px;">
                        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ú¶ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    </p>

                    <p style="font-size: 16px; line-height: 1.8; margin-bottom: 15px; color: #ccc;">
                        Your beautifully formatted email with images has been copied.
                    </p>
                    <p style="font-size: 12px; color: #888; margin-bottom: 25px;">
                        Note: If images don't appear, Outlook may have blocked them.
                        You can attach the images separately if needed.
                    </p>

                    <div style="
                        background: rgba(255,255,255,0.05);
                        padding: 20px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 15px;
                    ">
                        <div style="text-align: left; flex: 1;">
                            <p style="font-size: 12px; color: #888; margin-bottom: 8px; letter-spacing: 1px;">SUBJECT LINE:</p>
                            <p style="font-size: 15px; color: #d4af37; font-style: italic; margin: 0;">${subject}</p>
                        </div>
                        <button id="copy-subject-btn" onclick="copySubjectToClipboard('${subject.replace(/'/g, "\\'")}', this)" style="
                            background: transparent;
                            border: 1px solid #666;
                            color: #ccc;
                            padding: 8px 16px;
                            border-radius: 4px;
                            font-size: 12px;
                            cursor: pointer;
                            white-space: nowrap;
                            transition: all 0.2s;
                        " onmouseover="this.style.borderColor='#d4af37'; this.style.color='#d4af37'"
                           onmouseout="if(!this.classList.contains('copied')){this.style.borderColor='#666'; this.style.color='#ccc'}">
                            Copy Subject
                        </button>
                    </div>

                    <div style="
                        background: rgba(212, 175, 55, 0.1);
                        border: 1px solid rgba(212, 175, 55, 0.3);
                        padding: 25px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        text-align: left;
                    ">
                        <p style="font-size: 13px; color: #d4af37; margin-bottom: 15px; letter-spacing: 1px;">
                            HOW TO USE:
                        </p>
                        <ol style="font-size: 14px; line-height: 2.2; color: #ccc; padding-left: 20px;">
                            <li>Open <strong>Outlook</strong> and create a new email</li>
                            <li>Paste the email body first <kbd style="background: #333; padding: 2px 8px; border-radius: 4px; font-family: monospace;">‚åòV</kbd></li>
                            <li>Click <strong>"Copy Subject"</strong> above, then paste into subject line</li>
                            <li>Add recipient and send!</li>
                        </ol>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="window.location.href='mailto:'" style="
                            background: transparent;
                            border: 2px solid #d4af37;
                            color: #d4af37;
                            padding: 12px 30px;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            letter-spacing: 1px;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='rgba(212,175,55,0.1)'"
                           onmouseout="this.style.background='transparent'">
                            Open Outlook
                        </button>
                        <button onclick="document.getElementById('email-modal').remove()" style="
                            background: linear-gradient(135deg, #d4af37, #b8860b);
                            border: none;
                            color: #1a1a2e;
                            padding: 12px 30px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            letter-spacing: 1px;
                            transition: all 0.3s;
                        " onmouseover="this.style.transform='translateY(-2px)'"
                           onmouseout="this.style.transform='translateY(0)'">
                            Done
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Update status
            els.status.textContent = "‚úâ Email copied to clipboard!";
            els.status.style.color = "#d4af37";
            setTimeout(() => els.status.textContent = "", 5000);
        }

        // Global function for copying subject
        window.copySubjectToClipboard = function(subject, btn) {
            navigator.clipboard.writeText(subject).then(() => {
                btn.textContent = '‚úì Copied!';
                btn.style.borderColor = '#4ade80';
                btn.style.color = '#4ade80';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Subject';
                    btn.style.borderColor = '#666';
                    btn.style.color = '#ccc';
                    btn.classList.remove('copied');
                }, 2000);
            });
        };

        // Run
        init();
    </script>
</body>
</html>
