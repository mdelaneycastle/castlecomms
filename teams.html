<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Teams/Groups - Castle Comms</title>
  
  <!-- Security Headers -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="stylesheet" href="style.css?v=20250813_din_font_update" />
  <style>
    .teams-container {
      max-width: 100%;
      width: 100%;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      backdrop-filter: blur(10px);
      min-height: 95vh;
      box-sizing: border-box;
    }

    .teams-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .teams-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 600;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .teams-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }

    .create-team-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e1e5e9;
    }

    .teams-list-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e1e5e9;
    }

    .section-header {
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e1e5e9;
    }

    .section-header h3 {
      margin: 0;
      color: #2c3e50;
      font-size: 1.3rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(98, 100, 167, 0.1);
    }

    .user-search-container {
      position: relative;
    }

    .user-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e1e5e9;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .user-suggestion {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f1f3f4;
      transition: background-color 0.2s;
    }

    .user-suggestion:last-child {
      border-bottom: none;
    }

    .user-suggestion:hover {
      background-color: #f8f9fa;
    }

    .team-members {
      margin-top: 1rem;
    }

    .team-member {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .team-member-info {
      display: flex;
      flex-direction: column;
    }

    .team-member-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .team-member-email {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .remove-member {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .remove-member:hover {
      background: #c82333;
    }

    .create-team-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }

    .create-team-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .create-team-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .cancel-btn {
      background: #6c757d !important;
      color: white !important;
      border: none !important;
      padding: 0.75rem 1.5rem !important;
      border-radius: 8px !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
      cursor: pointer !important;
      transition: all 0.3s !important;
      margin-right: 1rem !important;
      display: none !important;
    }

    .cancel-btn:hover {
      background: #5a6268 !important;
      transform: translateY(-2px) !important;
    }

    .teams-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .team-card {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }

    .team-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .team-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .team-name {
      font-weight: 600;
      color: #2c3e50;
      font-size: 1.1rem;
    }

    .team-actions {
      display: flex;
      gap: 0.5rem;
    }

    .edit-team-btn, .delete-team-btn {
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-team-btn {
      background: #007bff;
      color: white;
    }

    .edit-team-btn:hover {
      background: #0056b3;
    }

    .delete-team-btn {
      background: #dc3545;
      color: white;
    }

    .delete-team-btn:hover {
      background: #c82333;
    }

    .team-description {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }

    .team-members-count {
      font-size: 0.85rem;
      color: #495057;
      font-weight: 500;
    }

    .team-members-list {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .team-member-tag {
      background: #e9ecef;
      color: #495057;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    .no-teams {
      text-align: center;
      color: #6c757d;
      padding: 2rem;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #6c757d;
    }

    .error, .success {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
      .teams-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- Background Slideshow -->
<div class="background-slideshow" id="background-slideshow">
  <!-- Images will be injected by JavaScript -->
</div>
  
<header class="modern-header">
  <div class="header-content">
    <div class="header-left">
      <button id="menu-toggle" class="modern-hamburger" aria-label="Open menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="brand-logo">
        <span class="brand-initials">CC</span>
      </div>
      <div class="brand-text">
        <span class="brand-subtitle">CASTLE COMMS</span>
        <span class="brand-title">TEAMS/GROUPS</span>
      </div>
    </div>
    <div class="header-center">
      <div class="user-greeting">Hi <span class="user-name" id="user-name-display">Loading...</span></div>
    </div>
    <div class="header-right">
      <!-- Empty right section for balance -->
    </div>
  </div>
</header>

<div id="sidebar-container"></div>
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<main id="main">
  <div class="teams-container">
    <div class="teams-header">
      <h1>👥 Teams/Groups Management</h1>
    </div>
    
    <div class="teams-layout">
      <!-- Create Team Section -->
      <div class="create-team-section">
        <div class="section-header">
          <h3>🆕 Create New Team/Group</h3>
        </div>
        
        <div id="team-status"></div>
        
        <form id="create-team-form">
          <div class="form-group">
            <label for="team-name">Team/Group Name:</label>
            <input type="text" id="team-name" class="form-input" placeholder="Enter team/group name..." required maxlength="50">
          </div>
          
          <div class="form-group">
            <label for="team-description">Description:</label>
            <textarea id="team-description" class="form-textarea" placeholder="Describe what this team does..." rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label for="add-member">Add Team/Group Members:</label>
            <div class="user-search-container">
              <input type="text" id="add-member" class="form-input" placeholder="Start typing a name or email..." autocomplete="off">
              <div id="member-suggestions" class="user-suggestions"></div>
            </div>
          </div>
          
          <div class="team-members" id="team-members">
            <!-- Team members will be added here -->
          </div>
          
          <button type="submit" class="create-team-button" id="create-team-btn">Create Team/Group</button>
        </form>
      </div>
      
      <!-- Teams List Section -->
      <div class="teams-list-section">
        <div class="section-header">
          <h3>📋 All Teams/Groups</h3>
        </div>
        
        <div class="teams-list" id="teams-list">
          <div class="loading">Loading teams...</div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<script>
// Background handled by CSS - no JavaScript needed

// Global variables
let currentUser = null;
let db = null;
let allUsers = [];
let teamMembers = [];

// Initialize the page
async function initializeTeams() {
  if (!currentUser) return;
  
  db = firebase.firestore();
  await loadAllUsers();
  setupMemberSearch();
  setupTeamForm();
  loadTeams();
  
  // Create default COFT team if it doesn't exist
  await createDefaultCOFTTeam();
}

// Initialize teams when firebase auth is ready
firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) {
    console.log('User not authenticated, redirecting to login');
    window.location.href = 'index.html';
    return;
  }

  currentUser = user;
  console.log('User authenticated:', user.email);
  
  try {
    await initializeTeams();
    console.log('Teams page fully initialized');
  } catch (error) {
    console.error('Error initializing teams page:', error);
    const teamsList = document.getElementById('teams-list');
    if (teamsList) {
      teamsList.innerHTML = `
        <div class="error" style="text-align: center; padding: 40px; color: #d13438;">
          <h4>Initialization Error</h4>
          <p style="margin: 10px 0; color: #666;">${error.message}</p>
          <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #6264a7; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reload Page
          </button>
        </div>
      `;
    }
  }
});

// Load all users for team member selection (same as tickets page)
async function loadAllUsers() {
  try {
    // Try to get users from the listUsers function (if available from admin)
    if (typeof listUsers === 'function') {
      try {
        const users = await listUsers();
        allUsers = users.map(user => ({
          email: user.email,
          name: user.displayName || extractNameFromEmail(user.email),
          uid: user.uid
        }));
        console.log('Loaded users from admin function:', allUsers.length);
        return;
      } catch (error) {
        console.log('Admin function not available, using static list');
      }
    }

    // Fallback: Use same static list as tickets page
    allUsers = [
      { email: 'mdelaney@castlefineart.com', name: 'Marc Delaney' },
      { email: 'gturpin@washingtongreen.co.uk', name: 'Gary Turpin' },
      { email: 'icc@castlefineart.com', name: 'ICC' },
      { email: 'mailbox@castlefineart.com', name: 'Mailbox' },
      // COFT Team members (actual team from staff.html)
      { email: 'pchapman@washingtongreen.co.uk', name: 'Paul Chapman' },
      { email: 'jdurrant@washingtongreen.co.uk', name: 'Jenny Durrant' },
      { email: 'ghooper@castlegalleries.com', name: 'Gerald Hooper' },
      { email: 'klewis@castlefineart.com', name: 'Katie Lewis' },
      { email: 'tplatts@castlefineart.com', name: 'Tara Platts' },
      { email: 'pbeevor-reid@castlefineart.com', name: 'Phillippa Beevor-Reid' },
      { email: 'arush@castlefineart.com', name: 'Amelia Rush' },
      // Gallery locations
      { email: 'cheltenham@castlefineart.com', name: 'Cheltenham' },
      { email: 'derby@castlefineart.com', name: 'Derby' },
      { email: 'leamingtonspa@castlefineart.com', name: 'Leamington Spa' },
      { email: 'miltonkeynes@castlefineart.com', name: 'Milton Keynes' },
      { email: 'nottingham@castlefineart.com', name: 'Nottingham' },
      { email: 'stamford@castlefineart.com', name: 'Stamford' },
      { email: 'stratford@castlefineart.com', name: 'Stratford' },
      { email: 'chester@castlefineart.com', name: 'Chester' },
      { email: 'harrogate@castlefineart.com', name: 'Harrogate' },
      { email: 'leeds@castlefineart.com', name: 'Leeds' },
      { email: 'liverpool@castlefineart.com', name: 'Liverpool' },
      { email: 'manchester@castlefineart.com', name: 'Manchester' },
      { email: 'newcastle@castlefineart.com', name: 'Newcastle' },
      { email: 'meadowhall@castlefineart.com', name: 'Meadowhall' },
      { email: 'york@castlefineart.com', name: 'York' },
      { email: 'cgn@castlefineart.com', name: 'CGN' },
      { email: 'sms@castlefineart.com', name: 'SMS' },
      { email: 'scp@castlefineart.com', name: 'SCP' },
      { email: 'bath@castlefineart.com', name: 'Bath' },
      { email: 'brighton@castlefineart.com', name: 'Brighton' },
      { email: 'bristol@castlefineart.com', name: 'Bristol' },
      { email: 'cambridge@castlefineart.com', name: 'Cambridge' },
      { email: 'canterbury@castlefineart.com', name: 'Canterbury' },
      { email: 'exeter@castlefineart.com', name: 'Exeter' },
      { email: 'guildford@castlefineart.com', name: 'Guildford' },
      { email: 'bluewater@castlefineart.com', name: 'Bluewater' },
      { email: 'marlow@castlefineart.com', name: 'Marlow' },
      { email: 'norwich@castlefineart.com', name: 'Norwich' },
      { email: 'oxford@castlefineart.com', name: 'Oxford' },
      { email: 'reading@castlefineart.com', name: 'Reading' },
      { email: 'tunbridgewells@castlefineart.com', name: 'Tunbridge Wells' },
      { email: 'winchester@castlefineart.com', name: 'Winchester' },
      { email: 'windsor@castlefineart.com', name: 'Windsor' },
      { email: 'edinburgh@castlefineart.com', name: 'Edinburgh' },
      { email: 'glasgow@castlefineart.com', name: 'Glasgow' },
      { email: 'cardiff@castlefineart.com', name: 'Cardiff' }
    ];
  } catch (error) {
    console.error('Error loading users:', error);
  }
}

// Setup member search functionality
function setupMemberSearch() {
  const searchInput = document.getElementById('add-member');
  const suggestionsDiv = document.getElementById('member-suggestions');
  
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    if (query.length < 1) {
      suggestionsDiv.style.display = 'none';
      return;
    }
    
    const filteredUsers = allUsers.filter(user => 
      (user.name.toLowerCase().includes(query) || 
       user.email.toLowerCase().includes(query)) &&
      !teamMembers.find(member => member.email === user.email) // Don't show already added members
    );
    
    if (filteredUsers.length > 0) {
      suggestionsDiv.innerHTML = filteredUsers.map(user => 
        `<div class="user-suggestion" data-email="${user.email}" data-name="${user.name}">
          <strong>${user.name}</strong><br>
          <small>${user.email}</small>
        </div>`
      ).join('');
      suggestionsDiv.style.display = 'block';
    } else {
      suggestionsDiv.style.display = 'none';
    }
  });
  
  // Handle suggestion clicks
  suggestionsDiv.addEventListener('click', (e) => {
    const suggestion = e.target.closest('.user-suggestion');
    if (suggestion) {
      const email = suggestion.dataset.email;
      const name = suggestion.dataset.name;
      
      addTeamMember({ email, name });
      searchInput.value = '';
      suggestionsDiv.style.display = 'none';
    }
  });
  
  // Hide suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-search-container')) {
      suggestionsDiv.style.display = 'none';
    }
  });
}

// Add team member
function addTeamMember(user) {
  if (teamMembers.find(member => member.email === user.email)) {
    showStatus('User is already in the team/group.', 'error');
    return;
  }
  
  teamMembers.push(user);
  updateTeamMembersDisplay();
}

// Remove team member
function removeTeamMember(email) {
  teamMembers = teamMembers.filter(member => member.email !== email);
  updateTeamMembersDisplay();
}

// Update team members display
function updateTeamMembersDisplay() {
  const container = document.getElementById('team-members');
  
  if (teamMembers.length === 0) {
    container.innerHTML = '<p style="color: #6c757d; font-style: italic;">No team/group members added yet.</p>';
    return;
  }
  
  const memberItems = teamMembers.map(member => `
    <div class="team-member">
      <div class="team-member-info">
        <div class="team-member-name">${member.name}</div>
        <div class="team-member-email">${member.email}</div>
      </div>
      <button type="button" class="remove-member" onclick="removeTeamMember('${member.email}')">&times;</button>
    </div>
  `).join('');
  
  container.innerHTML = memberItems;
}

// Setup team creation form
function setupTeamForm() {
  const form = document.getElementById('create-team-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await createTeam();
  });
}

// Create new team
async function createTeam() {
  const name = document.getElementById('team-name').value.trim();
  const description = document.getElementById('team-description').value.trim();
  const createBtn = document.getElementById('create-team-btn');
  
  if (!name) {
    showStatus('Please enter a team/group name.', 'error');
    return;
  }
  
  if (teamMembers.length === 0) {
    showStatus('Please add at least one team/group member.', 'error');
    return;
  }
  
  createBtn.disabled = true;
  createBtn.textContent = 'Creating...';
  
  try {
    // Check if team name already exists
    const existingTeam = await db.collection('teams')
      .where('name', '==', name)
      .get();
    
    if (!existingTeam.empty) {
      showStatus('A team/group with this name already exists.', 'error');
      createBtn.disabled = false;
      createBtn.textContent = 'Create Team/Group';
      return;
    }
    
    // Get current user's display name
    const creatorName = await getUserDisplayName(currentUser);
    
    const teamData = {
      name: name,
      description: description || '',
      members: teamMembers,
      createdBy: {
        uid: currentUser.uid,
        email: currentUser.email,
        name: creatorName
      },
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('teams').add(teamData);
    
    // Reset form
    document.getElementById('create-team-form').reset();
    teamMembers = [];
    updateTeamMembersDisplay();
    
    showStatus('Team/Group created successfully!', 'success');
    
    // Reload teams list
    setTimeout(() => {
      loadTeams();
    }, 1000);
    
  } catch (error) {
    console.error('Error creating team:', error);
    showStatus('Failed to create team. Please try again.', 'error');
  }
  
  createBtn.disabled = false;
  createBtn.textContent = 'Create Team/Group';
}

// Load all teams
async function loadTeams() {
  const teamsList = document.getElementById('teams-list');
  
  if (!teamsList) {
    console.error('teams-list element not found');
    return;
  }
  
  // Show loading state
  teamsList.innerHTML = '<div class="loading">Loading teams...</div>';
  
  try {
    const teamsSnapshot = await db.collection('teams')
      .orderBy('createdAt', 'desc')
      .get();
    
    if (teamsSnapshot.empty) {
      teamsList.innerHTML = '<div class="no-teams">No teams/groups found. Create your first team/group!</div>';
      return;
    }
    
    const teams = teamsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    const teamItems = teams.map(team => {
      const memberNames = team.members.map(member => member.name);
      
      return `
        <div class="team-card">
          <div class="team-card-header">
            <div class="team-name">${team.name}</div>
            <div class="team-actions">
              <button class="edit-team-btn" onclick="editTeam('${team.id}')">Edit</button>
              <button class="delete-team-btn" onclick="deleteTeam('${team.id}')">Delete</button>
            </div>
          </div>
          <div class="team-description">${team.description || 'No description provided'}</div>
          <div class="team-members-count">${team.members.length} member${team.members.length !== 1 ? 's' : ''}</div>
          <div class="team-members-list">
            ${memberNames.map(name => `<span class="team-member-tag">${name}</span>`).join('')}
          </div>
        </div>
      `;
    }).join('');
    
    teamsList.innerHTML = teamItems;
    
  } catch (error) {
    console.error('Error loading teams:', error);
    teamsList.innerHTML = `
      <div class="error" style="text-align: center; padding: 40px; color: #d13438;">
        <h4>Failed to load teams</h4>
        <p style="margin: 10px 0; color: #666;">${error.message}</p>
        <button onclick="loadTeams()" style="margin-top: 15px; padding: 8px 16px; background: #6264a7; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Try Again
        </button>
      </div>
    `;
  }
}

// Create default COFT team
async function createDefaultCOFTTeam() {
  try {
    // Check if COFT team already exists
    const existingCOFT = await db.collection('teams')
      .where('name', '==', 'COFT')
      .get();
    
    if (!existingCOFT.empty) {
      console.log('COFT team already exists');
      return;
    }
    
    // Get current user's display name
    const creatorName = await getUserDisplayName(currentUser);
    
    // Create COFT team with Paul Chapman's actual team members from staff.html
    const coftMembers = [
      { email: 'pchapman@washingtongreen.co.uk', name: 'Paul Chapman' },
      { email: 'jdurrant@washingtongreen.co.uk', name: 'Jenny Durrant' },
      { email: 'ghooper@castlegalleries.com', name: 'Gerald Hooper' },
      { email: 'klewis@castlefineart.com', name: 'Katie Lewis' },
      { email: 'tplatts@castlefineart.com', name: 'Tara Platts' },
      { email: 'pbeevor-reid@castlefineart.com', name: 'Phillippa Beevor-Reid' },
      { email: 'arush@castlefineart.com', name: 'Amelia Rush' }
    ];
    
    const coftTeamData = {
      name: 'COFT',
      description: 'Client Order Fulfilment Team - Handles client orders, processing, and order-related inquiries',
      members: coftMembers,
      createdBy: {
        uid: currentUser.uid,
        email: currentUser.email,
        name: creatorName
      },
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('teams').add(coftTeamData);
    console.log('Created default COFT team');
    
  } catch (error) {
    console.error('Error creating default COFT team:', error);
  }
}

// Edit team
async function editTeam(teamId) {
  try {
    // Get the team data
    const teamDoc = await db.collection('teams').doc(teamId).get();
    if (!teamDoc.exists) {
      showStatus('Team not found.', 'error');
      return;
    }
    
    const teamData = teamDoc.data();
    
    // Populate the form with current team data
    document.getElementById('team-name').value = teamData.name;
    document.getElementById('team-description').value = teamData.description || '';
    
    // Set team members
    teamMembers = [...teamData.members];
    updateTeamMembersDisplay();
    
    // Change form title and button
    document.querySelector('.section-header h3').textContent = '✏️ Edit Team/Group';
    const createBtn = document.getElementById('create-team-btn');
    createBtn.textContent = 'Update Team';
    createBtn.onclick = () => updateTeam(teamId);
    
    // Show cancel button
    let cancelBtn = document.getElementById('cancel-edit-btn');
    if (!cancelBtn) {
      cancelBtn = document.createElement('button');
      cancelBtn.id = 'cancel-edit-btn';
      cancelBtn.type = 'button';
      cancelBtn.className = 'form-btn cancel-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = cancelEdit;
      createBtn.parentNode.insertBefore(cancelBtn, createBtn);
    }
    cancelBtn.style.display = 'inline-block';
    
    // Scroll to form
    document.getElementById('create-team-form').scrollIntoView({ behavior: 'smooth' });
    
  } catch (error) {
    console.error('Error loading team for edit:', error);
    showStatus('Failed to load team data.', 'error');
  }
}

// Update team
async function updateTeam(teamId) {
  const name = document.getElementById('team-name').value.trim();
  const description = document.getElementById('team-description').value.trim();
  const updateBtn = document.getElementById('create-team-btn');
  
  if (!name) {
    showStatus('Please enter a team/group name.', 'error');
    return;
  }
  
  if (teamMembers.length === 0) {
    showStatus('Please add at least one team/group member.', 'error');
    return;
  }
  
  updateBtn.disabled = true;
  updateBtn.textContent = 'Updating...';
  
  try {
    // Check if new name conflicts with existing teams (exclude current team)
    const existingTeam = await db.collection('teams')
      .where('name', '==', name)
      .get();
      
    // Check if any of the found teams is a different team (not the one we're editing)
    const hasConflict = existingTeam.docs.some(doc => doc.id !== teamId);
    if (hasConflict) {
      showStatus('A team with that name already exists.', 'error');
      updateBtn.disabled = false;
      updateBtn.textContent = 'Update Team/Group';
      return;
    }
    
    const teamData = {
      name: name,
      description: description,
      members: teamMembers,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('teams').doc(teamId).update(teamData);
    
    showStatus('Team/Group updated successfully!', 'success');
    
    // Reset form
    cancelEdit();
    
    // Reload teams list
    setTimeout(() => {
      loadTeams();
    }, 1000);
    
  } catch (error) {
    console.error('Error updating team:', error);
    showStatus('Failed to update team. Please try again.', 'error');
  }
  
  updateBtn.disabled = false;
  updateBtn.textContent = 'Update Team/Group';
}

// Cancel edit mode
function cancelEdit() {
  // Reset form
  document.getElementById('create-team-form').reset();
  teamMembers = [];
  updateTeamMembersDisplay();
  
  // Reset form title and button
  document.querySelector('.section-header h3').textContent = '🆕 Create New Team/Group';
  const createBtn = document.getElementById('create-team-btn');
  createBtn.textContent = 'Create Team/Group';
  createBtn.onclick = createTeam;
  
  // Hide cancel button
  const cancelBtn = document.getElementById('cancel-edit-btn');
  if (cancelBtn) {
    cancelBtn.style.display = 'none';
  }
  
  showStatus('Edit cancelled.', 'info');
}

// Delete team
async function deleteTeam(teamId) {
  if (!confirm('Are you sure you want to delete this team/group? This action cannot be undone.')) {
    return;
  }
  
  try {
    await db.collection('teams').doc(teamId).delete();
    showStatus('Team/Group deleted successfully.', 'success');
    setTimeout(() => {
      loadTeams();
    }, 1000);
  } catch (error) {
    console.error('Error deleting team:', error);
    showStatus('Failed to delete team/group. Please try again.', 'error');
  }
}

// Show status message
function showStatus(message, type) {
  const statusDiv = document.getElementById('team-status');
  statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
  
  if (type === 'success') {
    setTimeout(() => {
      statusDiv.innerHTML = '';
    }, 3000);
  }
}

// Get user display name from Firebase Realtime Database
async function getUserDisplayName(user) {
  try {
    if (!user || !window.db) {
      return extractNameFromEmail(user?.email || '');
    }

    const userRef = window.db.ref(`users/${user.uid}`);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val();

    if (userData && userData.name) {
      return userData.name;
    }

    // Fallback to Firebase Auth displayName
    if (user.displayName) {
      return user.displayName;
    }

    // Final fallback to email extraction
    return extractNameFromEmail(user.email || '');
  } catch (error) {
    console.error('Error getting user display name:', error);
    return extractNameFromEmail(user?.email || '');
  }
}

// Extract name from email
function extractNameFromEmail(email) {
  if (!email) return 'User';
  
  const emailName = email.split('@')[0];
  return emailName
    .replace(/[._-]/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}
</script>

<!-- Site scripts -->
<script src="script.js"></script>

<!-- Notification system -->
<script src="notifications.js"></script>

</body>
</html>