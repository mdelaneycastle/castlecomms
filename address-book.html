<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Address Book - Castle Comms</title>
  <link rel="icon" type="image/png" href="icon.png">
  
  <!-- Security Headers -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="stylesheet" href="style.css?v=20250813_din_font_update" />
  <style>
    :root {
      --bg: var(--primary-color);
      --panel: #F0EDE9;
      --accent: var(--secondary-color);
      --accent-2: var(--tertiary-color);
      --text: var(--text-dark);
      --muted: var(--text-muted);
      --danger: #dc3545;
      --card-w: 520px;
      --card-h: 280px;
      --card-background: #e5ddcb;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font-primary);
      color: var(--text);
      background: var(--body-background);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      padding-top: 0;
    }

    .page-header {
      padding: 8px 20px 0;
      display: flex; 
      align-items: center; 
      justify-content: space-between;
    }
    .page-header h1 { 
      margin: 0; 
      font-size: clamp(18px, 2.4vw, 28px); 
      letter-spacing: 0.3px; 
      color: var(--secondary-color);
      font-family: var(--font-primary);
    }
    .credits { 
      color: var(--muted); 
      font-size: 12px; 
    }

    .app {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px 10px;
      height: 800px;
    }

    /* Left panel: form */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow-medium);
    }

    .panel h2 { 
      margin: 4px 0 14px; 
      font-size: 16px; 
      color: var(--muted); 
      font-weight: 600; 
    }

    form { display: grid; gap: 10px; }
    label { 
      font-size: 13px; 
      color: var(--muted); 
      display: block; 
      margin-bottom: 6px; 
    }
    input[type="text"], input[type="email"], input[type="tel"] {
      width: 100%;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text);
      padding: 12px 12px;
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }
    input:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(69, 73, 78, 0.15); 
    }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
    button {
      appearance: none; border: 0; cursor: pointer; border-radius: 10px;
      padding: 10px 14px; font-weight: 600;
      background: var(--accent); color: var(--surface-color);
      box-shadow: var(--shadow-light);
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    button:hover { 
      transform: translateY(-1px); 
      box-shadow: var(--shadow-medium); 
    }
    button.secondary { 
      background: var(--card-background); 
      color: var(--text); 
      box-shadow: none; 
    }
    button.danger { 
      background: var(--danger); 
      color: var(--surface-color); 
    }

    .tiny { font-size: 12px; color: var(--muted); margin-left: 4px; }

    .search { margin-top: 12px; display: grid; gap: 8px; }

    /* Controls and Search */
    .controls-bottom {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .add-contact-btn {
      background: #d8d1c5;
      color: var(--text);
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      box-shadow: var(--shadow-light);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    
    .add-contact-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }
    
    .search-top {
      margin-bottom: 20px;
      text-align: center;
      max-width: 400px;
    }
    
    .search-top label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    
    .search-top input {
      width: 100%;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .search-top input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(69, 73, 78, 0.15);
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background: var(--panel);
      margin: 5% auto;
      padding: 0;
      border-radius: 16px;
      width: min(480px, 90%);
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-heavy);
      position: relative;
      border: 1px solid var(--border-color);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: var(--secondary-color);
    }
    
    .close {
      color: var(--muted);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: var(--text);
    }
    
    .modal form {
      padding: 20px 24px 24px;
    }

    /* Modal Form Styling (matching tickets modal) */
    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.75rem;
      color: #2c3e50;
      font-weight: 600;
      font-size: 1rem;
      line-height: 1.4;
    }

    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      background: white;
      color: #2c3e50;
      transition: border-color 0.3s, box-shadow 0.3s;
      outline: none;
    }

    .form-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .full-width {
      width: 100%;
    }

    /* Right: Rolodex */
    .stage-wrap { 
      position: relative; 
      min-height: 0; 
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .rolodex {
      position: relative;
      height: min(80vh, 800px);
      min-height: 380px;
      perspective: 1200px;
      display: grid;
      place-items: center;
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    /* Spindle */
    .spindle {
      position: absolute; width: 18px; height: 74%; left: 50%; top: 13%; transform: translateX(-50%);
      background: linear-gradient(90deg, var(--accent-2), var(--accent), var(--accent-2));
      border: 1px solid var(--border-color);
      border-radius: 20px;
      box-shadow: var(--shadow-subtle);
    }

    /* Side knobs */
    .knob { 
      position: absolute; width: 120px; height: 120px; border-radius: 50%; 
      top: 50%; transform: translateY(-50%);
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      box-shadow: var(--shadow-heavy);
      display: grid; place-items: center; color: var(--text); font-weight: 700;
      user-select: none;
      cursor: pointer;
      z-index: 10;
    }
    .knob.left { left: -60px; }
    .knob.right { right: -60px; }
    .knob button { 
      background: transparent; 
      color: var(--text); 
      border: none;
      box-shadow: none; 
      padding: 8px; 
      font-size: 24px; 
      cursor: pointer;
      border-radius: 50%;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .knob:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: var(--shadow-heavy);
    }

    /* Cards ring */
    .ring {
      position: relative;
      width: var(--card-w);
      height: var(--card-h);
      transform-style: preserve-3d;
      transition: transform 500ms cubic-bezier(.2,.7,.2,1);
    }

    .card {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: var(--card-w);
      height: var(--card-h);
      margin: auto;
      background: url("businesstemplate.jpg") center/contain no-repeat, #e5ddcb;
      border: 1px solid #A89B8C;
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
      padding: 50px 40px 50px 40px;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      display: grid; 
      grid-template-rows: 1fr auto auto auto auto 1fr;
      gap: 6px;
      transition: transform 450ms cubic-bezier(.2,.7,.2,1), opacity 300ms ease; 
      will-change: transform, opacity;
      opacity: 1;
    }

    .card.hidden { opacity: 0; pointer-events: none; }

    .card::before {
      /* Subtle overlay for text readability */
      content: "";
      position: absolute; 
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(240, 237, 233, 0.1);
      border-radius: 14px;
    }

    .card .tag {
      position: relative;
      align-self: start;
      color: #666;
      font-weight: 600; 
      font-size: 14px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 2;
      background: none;
      padding: 0;
      border-radius: 0;
    }

    .card h3 { 
      margin: 0; 
      font-size: 36px; 
      color: #555; 
      font-style: italic;
      font-weight: 400;
      line-height: 1.1;
      z-index: 2;
      position: relative;
      text-align: left;
    }
    .card .tag {
      color: #666;
      font-weight: 600; 
      font-size: 12px; 
      text-transform: uppercase;
      letter-spacing: 0.8px;
      z-index: 2;
      position: relative;
      margin-bottom: 4px;
    }
    .card .company { 
      color: #777; 
      font-size: 14px; 
      font-weight: 400;
      z-index: 2;
      position: relative;
      margin-bottom: 8px;
    }
    .meta { 
      color: #666; 
      font-size: 12px; 
      line-height: 1.3;
      z-index: 2;
      position: relative;
    }
    .meta.contact-info {
      background: none;
      border-radius: 0;
      padding: 0;
      border-left: none;
    }
    .meta .phone, .meta .email {
      margin-bottom: 2px;
    }

    .card .footer { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 10px; 
    }
    .badge { font-size: 12px; color: var(--muted); }

    .pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; 
      border-radius: 999px;
      background: var(--card-background); border: 1px solid var(--border-color);
      font-size: 12px; color: var(--text);
    }
    .pill a { color: var(--accent); text-decoration: none; }

    .empty { color: var(--muted); font-size: 14px; text-align: center; }

    .controls { 
      position: absolute; bottom: 12px; left: 50%; 
      transform: translateX(-50%); display: flex; gap: 10px; 
    }
    .circle-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--card-background); color: var(--text);
      display: grid; place-items: center; border: 1px solid var(--border-color);
      cursor: pointer; user-select: none; font-weight: 800;
      transition: transform 120ms ease, background 120ms ease;
    }
    .circle-btn:hover { 
      transform: translateY(-1px); 
      background: var(--accent-color); 
    }

    .index { 
      position: absolute; top: 10px; left: 50%; 
      transform: translateX(-50%); color: var(--muted); 
      font-size: 12px; letter-spacing: 0.4px; 
    }


    .page-footer { 
      padding: 4px 20px 16px; 
      color: var(--muted); 
      font-size: 12px; 
    }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .rolodex { height: 68vh; }
      .knob.left { left: -40px; }
      .knob.right { right: -40px; }
      :root { --card-w: 92vw; }
    }
  </style>
</head>
<body>

<div id="header-container"></div>
<div id="sidebar-container"></div>
<div class="sidebar-overlay" id="sidebar-overlay"></div>


  <main class="app">
    <section class="stage-wrap">
      <div class="search-top">
        <label for="q">Quick find</label>
        <input id="q" type="text" placeholder="Search by name, email, phone or department... (Esc to clear)" />
      </div>
      
      <div class="rolodex" aria-live="polite">
        <div class="index" id="cursorIndex">0 / 0</div>
        <div class="spindle" aria-hidden="true"></div>
        <div class="knob left" title="Previous">
          <button type="button" id="prev" aria-label="Previous card">◀</button>
        </div>
        <div class="knob right" title="Next">
          <button type="button" id="next" aria-label="Next card">▶</button>
        </div>
        <div class="ring" id="ring"></div>
        <div class="controls">
          <div class="circle-btn" id="jumpA" title="Jump to A">A</div>
          <div class="circle-btn" id="jumpB" title="Jump to B">B</div>
          <div class="circle-btn" id="jumpG" title="Jump to G">G</div>
          <div class="circle-btn" id="jumpL" title="Jump to L">L</div>
          <div class="circle-btn" id="jumpM" title="Jump to M">M</div>
          <div class="circle-btn" id="jumpS" title="Jump to S">S</div>
          <div class="circle-btn" id="jumpW" title="Jump to W">W</div>
          <div class="circle-btn" id="jumpZ" title="Jump to Z">Z</div>
        </div>
      </div>
      
      <div class="controls-bottom">
        <button id="addContactBtn" class="add-contact-btn">+ Add Contact</button>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="contactModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add a contact</h2>
        <span class="close" id="closeModal">&times;</span>
      </div>
      <form id="contactForm" class="modal-form">
        <div class="form-group">
          <label for="name" class="form-label">Full name</label>
          <input id="name" name="name" type="text" class="form-input full-width" placeholder="John Smith" required />
        </div>
        
        <div class="form-group">
          <label for="email" class="form-label">Email <span class="tiny">(optional)</span></label>
          <input id="email" name="email" type="email" class="form-input full-width" placeholder="john@castlefineart.com" />
        </div>
        
        <div class="form-group">
          <label for="phone" class="form-label">Phone <span class="tiny">(optional)</span></label>
          <input id="phone" name="phone" type="tel" class="form-input full-width" placeholder="01216550060" />
        </div>
        
        <div class="form-group">
          <label for="label" class="form-label">Department <span class="tiny">(e.g. COFT)</span></label>
          <input id="label" name="label" type="text" class="form-input full-width" placeholder="Department" />
        </div>
        
        <div class="actions">
          <button type="submit">Add to Address Book</button>
          <button class="danger" id="clearAll" type="button" title="Clear all contacts">Clear All</button>
        </div>
      </form>
    </div>
  </div>


  <template id="cardTemplate">
    <article class="card" role="group" aria-roledescription="Address card">
      <div></div>
      <h3 class="name"></h3>
      <div class="tag"></div>
      <div class="company">Castle Fine Art</div>
      <div class="meta contact-info">
        <div class="phone"></div>
        <div class="email"></div>
      </div>
    </article>
  </template>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script src="firebase-init.js"></script>
  <script src="shared-components.js"></script>
  <script src="script.js"></script>

  <script>
    (function(){
      const ring = document.getElementById('ring');
      const form = document.getElementById('contactForm');
      const q = document.getElementById('q');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const cursorIndexLabel = document.getElementById('cursorIndex');
      const tpl = document.getElementById('cardTemplate');
      const jumpA = document.getElementById('jumpA');
      const jumpB = document.getElementById('jumpB');
      const jumpG = document.getElementById('jumpG');
      const jumpL = document.getElementById('jumpL');
      const jumpM = document.getElementById('jumpM');
      const jumpS = document.getElementById('jumpS');
      const jumpW = document.getElementById('jumpW');
      const jumpZ = document.getElementById('jumpZ');

      const STORAGE_KEY = 'castleAddressBook_v1';
      const STATE = { contacts: [], filtered: [], cursor: 0, angle: 0, radius: 360 / Math.max(1, 8) };

      const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE.contacts));
      const load = () => {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return []; }
      };

      const fmtDate = ts => new Date(ts).toLocaleString();
      const initials = name => (name||'').split(/\s+/).filter(Boolean).map(s => s[0]).slice(0,3).join('').toUpperCase();

      // Actual Castle Staff Data from Spitfire Staff Page
      const castleStaff = [
        {name: 'Gary Turpin', email: 'gturpin@washingtongreen.co.uk', label: 'Head of Operations', phone: '01216550060'},
        {name: 'Matt King', email: 'mking@castlefineart.com', label: 'Head Of Inventory', phone: '01216550060'},
        {name: 'Martin Sumner', email: 'msumner@washingtongreen.co.uk', label: 'Head Of Stock Control', phone: '01216550060'},
        {name: 'Raksha Hercombe', email: 'rhercombe@washingtongreen.co.uk', label: 'Halcyon Support Manager', phone: '01216550060'},
        {name: 'Alexandra Bradley', email: 'abradley@washingtongreen.co.uk', label: 'Originals Admin', phone: '01216550060'},
        {name: 'Paul Chapman', email: 'pchapman@washingtongreen.co.uk', label: 'Order Processing', phone: '01216550060'},
        {name: 'Jenny Durrant', email: 'jdurrant@washingtongreen.co.uk', label: 'Client Order Fulfilment Supervisor', phone: '01216550060'},
        {name: 'Gerald Hooper', email: 'ghooper@castlegalleries.com', label: 'Senior Client Order Fulfilment Coordinator', phone: '01216550060'},
        {name: 'Katie Lewis', email: 'klewis@castlefineart.com', label: 'Client Order Fulfilment Administration Coordinator', phone: '01216550060'},
        {name: 'Tara Platts', email: 'tplatts@castlefineart.com', label: 'Client Order Fulfilment Coordinator', phone: '01216550060'},
        {name: 'Phillippa Beevor-Reid', email: 'pbeevor-reid@castlefineart.com', label: 'Client Order Fulfilment Coordinator', phone: '01216550060'},
        {name: 'Amelia Rush', email: 'arush@castlefineart.com', label: 'Client Order Fulfilment Coordinator', phone: '01216550060'},
        {name: 'Stuart Whitehouse', email: 'swhitehouse@washingtongreen.co.uk', label: 'Logistics Manager', phone: '01216550060'},
        {name: 'Nathan Smethurst', email: 'nsmethurst@castlefineart.com', label: 'Shipping Supervisor', phone: '01216550060'},
        {name: 'Olly Clark', email: 'oclark@washingtongreen.co.uk', label: 'Packing Supervisor', phone: '01216550060'},
        {name: 'Zara Chaudhry', email: 'zchaudhry@washingtongren.co.uk', label: 'Logistics Admin Assistant', phone: '01216550060'},
        {name: 'Martin Harrison', email: 'mharrison@washingtongreen.co.uk', label: 'Head of Manufacturing and QC', phone: '01216550060'},
        {name: 'Gary Day', email: 'gday@washingtongreen.co.uk', label: 'Framing Production Manager', phone: '01216550060'},
        {name: 'Tom Harrison', email: 'tharrison@castlefineart.com', label: 'Senior Mounting Operative', phone: '01216550060'},
        {name: 'Chrissy Hall', email: 'chall@washingtongreen.co.uk', label: 'Quality Control Supervisor', phone: '01216550060'},
        {name: 'Kerry Hinks', email: 'khinks@washingtongreen.co.uk', label: 'Stock Admin Manager', phone: '01216550060'},
        {name: 'Adam Hercombe', email: 'ahercombe@washingtongreen.co.uk', label: 'Warehouse Stock Manager', phone: '01216550060'}
      ];

      function createCard(contact){
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.name').textContent = contact.name || 'Unnamed';
        node.querySelector('.email').textContent = contact.email || '';
        node.querySelector('.phone').textContent = contact.phone || '';
        node.querySelector('.tag').textContent = (contact.label || tagFor(contact.name));
        return node;
      }

      function tagFor(name){
        const n = (name||'').trim();
        if(!n) return 'General';
        const c = n[0].toUpperCase();
        if(c < 'A' || c > 'Z') return '#';
        return c;
      }

      function sortContacts(list){
        return list.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      }

      function render(){
        ring.innerHTML = '';
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        if(!list.length){
          const div = document.createElement('div');
          div.className = 'empty';
          div.textContent = 'Your address book is empty. Add a contact or load Castle staff.';
          ring.appendChild(div);
          cursorIndexLabel.textContent = '0 / 0';
          return;
        }

        const N = list.length;
        const step = 360 / N;
        ring.style.transform = `rotateX(0deg) rotateY(${STATE.angle}deg)`;

        list.forEach((c, i)=>{
          const el = createCard(c);
          const ang = i * step;
          el.style.transform = `rotateY(${ang}deg) translateZ(380px)`;
          el.dataset.index = i;
          ring.appendChild(el);
        });

        STATE.cursor = Math.max(0, Math.min(STATE.cursor, N-1));
        STATE.angle = -STATE.cursor * step;
        ring.style.transform = `rotateX(0deg) rotateY(${STATE.angle}deg)`;
        cursorIndexLabel.textContent = `${STATE.cursor+1} / ${N}`;
        applyLine();
        showDetail();
      }

      function setCursor(idx){
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        if(!list.length) return;
        const N = list.length;
        STATE.cursor = (idx + N) % N;
        const step = 360 / N;
        STATE.angle = -STATE.cursor * step;
        ring.style.transform = `rotateX(0deg) rotateY(${STATE.angle}deg)`;
        cursorIndexLabel.textContent = `${STATE.cursor+1} / ${N}`;
        applyLine();
        showDetail();
      }

      function next(){ setCursor(STATE.cursor + 1); }
      function prev(){ setCursor(STATE.cursor - 1); }

      function addContact(data){
        const contact = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
          name: (data.name||'').trim(),
          email: (data.email||'').trim(),
          phone: (data.phone||'').trim(),
          label: (data.label||'').trim(),
          createdAt: Date.now()
        };
        STATE.contacts.push(contact);
        STATE.contacts = sortContacts(STATE.contacts);
        save();
        applyFilter(q.value);
        const idx = (STATE.filtered.length ? STATE.filtered : STATE.contacts).findIndex(c => c.id === contact.id);
        if(idx >= 0) setCursor(idx);
      }

      function applyFilter(text){
        const t = (text||'').toLowerCase().trim();
        if(!t){ STATE.filtered = []; render(); return; }
        STATE.filtered = STATE.contacts.filter(c=> [c.name,c.email,c.phone,c.label].join(' ').toLowerCase().includes(t));
        STATE.cursor = 0;
        render();
      }

      function loadCastleStaff(){
        // Clear existing and load staff
        STATE.contacts = [];
        castleStaff.forEach(staff => {
          const contact = {
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
            name: staff.name,
            email: staff.email,
            phone: staff.phone,
            label: staff.label,
            createdAt: Date.now()
          };
          STATE.contacts.push(contact);
        });
        STATE.contacts = sortContacts(STATE.contacts);
        save();
        applyFilter(q.value);
        setCursor(0);
      }

      // Modal functionality
      const modal = document.getElementById('contactModal');
      const addContactBtn = document.getElementById('addContactBtn');
      const closeModal = document.getElementById('closeModal');
      
      addContactBtn.addEventListener('click', () => {
        modal.style.display = 'block';
        document.getElementById('name').focus();
      });
      
      closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
      });
      
      window.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Init
      STATE.contacts = sortContacts(load());
      
      // Auto-load castle staff if no contacts exist
      if (STATE.contacts.length === 0) {
        loadCastleStaff();
      } else {
        render();
      }

      // Events
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const name = fd.get('name');
        const email = fd.get('email');
        const phone = fd.get('phone');
        const label = fd.get('label');
        if(!String(name).trim()) { alert('Please enter a name.'); return; }
        addContact({name, email, phone, label});
        form.reset();
        modal.style.display = 'none';
      });

      document.getElementById('clearAll').addEventListener('click', ()=>{
        if(confirm('Clear ALL contacts from this browser?')){
          STATE.contacts = [];
          STATE.filtered = [];
          save();
          render();
        }
      });


      prevBtn.addEventListener('click', prev);
      nextBtn.addEventListener('click', next);
      q.addEventListener('input', e=> applyFilter(e.target.value));
      q.addEventListener('keydown', e=>{ if(e.key==='Escape'){ q.value=''; applyFilter(''); }});

      jumpA.addEventListener('click', ()=> jumpToLetter('A'));
      jumpB.addEventListener('click', ()=> jumpToLetter('B'));
      jumpG.addEventListener('click', ()=> jumpToLetter('G'));
      jumpL.addEventListener('click', ()=> jumpToLetter('L'));
      jumpM.addEventListener('click', ()=> jumpToLetter('M'));
      jumpS.addEventListener('click', ()=> jumpToLetter('S'));
      jumpW.addEventListener('click', ()=> jumpToLetter('W'));
      jumpZ.addEventListener('click', ()=> jumpToLetter('Z'));

      function jumpToLetter(letter){
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        const idx = list.findIndex(c => (c.name||'').toUpperCase().startsWith(letter));
        if(idx >= 0) setCursor(idx);
      }

      function showDetail(){
        // Detail functionality removed - this function now does nothing
        return;
      }

      function relIndex(i, c, N){
        let d = i - c;
        if(d > N/2) d -= N;
        if(d < -N/2) d += N;
        return d;
      }

      function applyLine(){
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        const cards = Array.from(ring.querySelectorAll('.card'));
        const N = list.length;
        if(!N || !cards.length) return;
        const spread = 110;
        const maxSide = 4;
        ring.style.transform = 'translateZ(0)';
        cards.forEach((el, i)=>{
          const d = relIndex(i, STATE.cursor, N);
          const a = Math.abs(d);
          const tx = d * spread;
          const tz = -(50 + Math.min(300, a * 60));
          const ry = d * -10;
          const sc = 1 - Math.min(0.6, a * 0.06);
          const hidden = a > maxSide;
          el.style.transform = 'translateX(' + tx + 'px) translateZ(' + tz + 'px) rotateY(' + ry + 'deg) scale(' + sc + ')';
          el.style.opacity = hidden ? 0 : (1 - a * 0.05);
          el.style.pointerEvents = hidden ? 'none' : 'auto';
          el.style.zIndex = String(100 - a);
        });
      }

      // Keyboard navigation
      window.addEventListener('keydown', (e)=>{
        if(['ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
        if(e.key === 'ArrowLeft') prev();
        if(e.key === 'ArrowRight') next();
      });

      // Wheel navigation
      let wheelAccum = 0;
      ring.addEventListener('wheel', (e)=>{
        wheelAccum += e.deltaY + e.deltaX * 1.2;
        if(Math.abs(wheelAccum) > 50){
          if(wheelAccum > 0) next(); else prev();
          wheelAccum = 0;
        }
        e.preventDefault();
      }, { passive:false });

      // Click a card to focus it
      ring.addEventListener('click', (e)=>{
        const card = e.target.closest('.card');
        if(!card) return;
        const idx = Number(card.dataset.index || 0);
        setCursor(idx);
      });
    })();
  </script>

<!-- Contact Chatbot -->
<style>
  /* Chatbot styles */
  .cc-launcher {
    position: fixed; 
    right: 20px; 
    bottom: 20px; 
    z-index: 999999;
    border: none; 
    border-radius: 25px; 
    cursor: pointer;
    background: #45494e;
    color: #ffffff;
    box-shadow: 0 24px 60px rgba(22,25,28,0.16);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 600;
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .cc-launcher:hover { 
    transform: translateY(-2px); 
    filter: brightness(1.05); 
  }
  .cc-launcher-icon {
    font-size: 20px;
  }

  /* Widget panel */
  .cc-widget {
    position: fixed; 
    right: 20px; 
    bottom: 90px; 
    z-index: 999999; 
    display: none;
    width: 380px; 
    max-height: 74vh; 
    background: #ffffff;
    border: 1px solid rgba(69,73,78,0.15); 
    border-radius: 16px;
    box-shadow: 0 24px 60px rgba(22,25,28,0.16); 
    overflow: hidden; 
    flex-direction: column;
  }
  .cc-widget.open { 
    display: flex; 
  }

  .cc-header {
    background: linear-gradient(180deg, #d8d1c5, #ece7de);
    padding: 12px 16px; 
    border-bottom: 1px solid rgba(69,73,78,0.12);
    display: flex; 
    align-items: center; 
    gap: 10px; 
    color: #2b2f33;
  }
  .cc-mark {
    width: 36px; 
    height: 36px; 
    border-radius: 10px;
    background: #45494e;
    display: grid; 
    place-items: center; 
    color: #ffffff; 
    font-weight: 700;
    box-shadow: 0 4px 14px rgba(69,73,78,.25);
  }
  .cc-header h3 { 
    margin: 0; 
    font-size: 15px; 
    line-height: 1.2; 
    font-weight: 700; 
  }
  .cc-header small { 
    display: block; 
    color: #72777d; 
    font-weight: 500; 
  }
  .cc-close { 
    margin-left: auto; 
    border: none; 
    background: transparent; 
    color: #363a3f; 
    cursor: pointer; 
    width: 34px; 
    height: 34px; 
    border-radius: 8px; 
  }
  .cc-close:hover { 
    background: rgba(69,73,78,0.08); 
  }

  .cc-messages { 
    flex: 1; 
    overflow-y: auto; 
    padding: 14px 14px 0 14px; 
    background: linear-gradient(180deg, rgba(216,209,197,0.16), rgba(216,209,197,0));
  }

  .cc-bubble { 
    max-width: 82%; 
    margin: 10px 0; 
    padding: 10px 12px; 
    border-radius: 12px; 
    line-height: 1.45; 
    font-size: 14px; 
  }
  .cc-bubble.user { 
    margin-left: auto; 
    color: #ffffff; 
    background: #45494e; 
    border-top-right-radius: 6px; 
  }
  .cc-bubble.bot { 
    margin-right: auto; 
    background: #f6f4f1; 
    border: 1px solid rgba(69,73,78,0.12); 
    border-top-left-radius: 6px; 
  }

  .cc-typing { 
    display: none; 
    text-align: center; 
    padding: 8px 0 4px; 
  }
  .cc-dot { 
    width: 8px; 
    height: 8px; 
    display: inline-block; 
    border-radius: 50%; 
    background: #c1b9ad; 
    margin: 0 2px; 
    animation: ccDot 1.4s infinite; 
    opacity: .9; 
  }
  .cc-dot:nth-child(2) { animation-delay: .2s; }
  .cc-dot:nth-child(3) { animation-delay: .4s; }
  @keyframes ccDot { 
    0%, 60%, 100% { transform: translateY(0); } 
    30% { transform: translateY(-6px); } 
  }

  .cc-input-area { 
    padding: 12px; 
    border-top: 1px solid rgba(69,73,78,0.12); 
    background: #faf9f7; 
  }
  .cc-row { 
    display: flex; 
    gap: 8px; 
  }
  .cc-input { 
    flex: 1; 
    border: 1px solid rgba(69,73,78,0.25); 
    background: #fff; 
    color: #2b2f33; 
    border-radius: 12px; 
    padding: 10px 12px; 
    outline: none; 
    font-size: 14px; 
  }
  .cc-input:focus { 
    box-shadow: 0 0 0 3px rgba(69,73,78,0.18); 
    border-color: #45494e; 
  }
  .cc-send { 
    background: #45494e; 
    color: #fff; 
    border: none; 
    padding: 0 14px; 
    border-radius: 10px; 
    cursor: pointer; 
    font-weight: 600; 
  }
  .cc-send:hover { 
    filter: brightness(1.05); 
  }

  .cc-suggestions { 
    padding: 8px 0 0; 
    display: flex; 
    gap: 6px; 
    flex-wrap: wrap; 
  }
  .cc-chip { 
    font-size: 12px; 
    padding: 6px 10px; 
    background: #f1efeb; 
    border: 1px solid rgba(69,73,78,0.14); 
    color: #4a4f54; 
    border-radius: 999px; 
    cursor: pointer; 
  }
  .cc-chip:hover { 
    background: #ebe7e0; 
  }

  /* Contact cards */
  .cc-card { 
    background: #fff; 
    border: 1px solid rgba(69,73,78,0.12); 
    border-radius: 12px; 
    padding: 10px; 
    margin-top: 10px; 
  }
  .cc-team { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
    font-weight: 700; 
    color: #2b2f33; 
  }
  .cc-tag { 
    margin-left: auto; 
    font-size: 12px; 
    padding: 2px 8px; 
    border-radius: 999px; 
    background: #f3f2ef; 
    border: 1px solid rgba(69,73,78,0.12); 
    color: #4a4f54; 
  }
  .cc-emails { 
    margin-top: 8px; 
  }
  .cc-email { 
    display: inline-block; 
    font-size: 12px; 
    margin: 4px 6px 0 0; 
    padding: 6px 10px; 
    border-radius: 999px; 
    background: #f6f4f1; 
    border: 1px solid rgba(69,73,78,0.12); 
    text-decoration: none; 
    color: #2b2f33; 
  }
  .cc-email:hover { 
    background: #d8d1c5; 
  }
  .cc-keywords { 
    margin-top: 8px; 
    font-size: 12px; 
    color: #5b6066; 
  }
  .cc-k { 
    background: rgba(216,209,197,.55); 
    color: #1f2327; 
    padding: 0 4px; 
    border-radius: 4px; 
    font-weight: 700; 
  }
  .cc-phone {
    margin-top: 6px; 
    font-size: 13px; 
    color: #4a4f54;
  }
  .cc-phone a {
    color: #2b2f33; 
    text-decoration: underline;
  }

  /* Match borders */
  .match-high { border-left: 4px solid #2f3438; }
  .match-medium { border-left: 4px solid #7f858b; }
  .match-low { border-left: 4px solid #c9c3b8; }

  @media (max-width: 480px) {
    .cc-widget { 
      right: 10px; 
      left: 10px; 
      width: auto; 
    }
    .cc-launcher {
      right: 10px;
    }
  }
</style>

<!-- Launcher Button -->
<button class="cc-launcher" id="cc-launcher" aria-label="Open contact helper" title="Contact Finder">
  <span class="cc-launcher-icon">💬</span>
  <span>Who do I contact?</span>
</button>

<!-- Chatbot Widget -->
<section class="cc-widget" id="cc-widget" aria-live="polite" aria-label="Contact Finder chatbot">
  <header class="cc-header">
    <div class="cc-mark">CC</div>
    <div>
      <h3>Who do I contact?</h3>
      <small>Describe your issue and I'll route you</small>
    </div>
    <button class="cc-close" id="cc-close" title="Close" aria-label="Close">✕</button>
  </header>

  <div class="cc-messages" id="cc-messages"></div>
  <div class="cc-typing" id="cc-typing">
    <span class="cc-dot"></span>
    <span class="cc-dot"></span>
    <span class="cc-dot"></span>
  </div>

  <div class="cc-input-area">
    <div class="cc-row">
      <input id="cc-input" class="cc-input" placeholder="e.g. I need to cancel my order" autocomplete="off" />
      <button id="cc-send" class="cc-send">Send</button>
    </div>
    <div class="cc-suggestions" id="cc-suggestions"></div>
  </div>
</section>

<script>
// Contact Chatbot functionality
(function() {
  let teamContacts = [];

  // Load team contacts from JSON
  async function loadTeamContacts() {
    try {
      const response = await fetch('team_contacts.json');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      teamContacts = await response.json();
      console.log('Team contacts loaded:', teamContacts.length, 'teams');
    } catch (error) {
      console.error('Failed to load team contacts:', error);
      addBot('Sorry, I\'m having trouble loading the team directory. Please try again later or contact Client Services directly.');
    }
  }

  // Matching utilities
  function levenshteinDistance(str1, str2) {
    const len1 = str1.length, len2 = str2.length;
    const dp = Array.from({ length: len2 + 1 }, (_, i) => [i]);
    for (let j = 0; j <= len1; j++) dp[0][j] = j;
    for (let i = 1; i <= len2; i++) {
      for (let j = 1; j <= len1; j++) {
        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
          dp[i][j] = dp[i-1][j-1];
        } else {
          dp[i][j] = Math.min(dp[i-1][j-1] + 1, dp[i][j-1] + 1, dp[i-1][j] + 1);
        }
      }
    }
    return dp[len2][len1];
  }

  function isFuzzyMatch(a, b, max = 2) {
    if (a.length < 4 || b.length < 4) return false;
    if (Math.abs(a.length - b.length) > max) return false;
    return levenshteinDistance(a.toLowerCase(), b.toLowerCase()) <= max;
  }

  function findMatchingTeams(query) {
    if (!query.trim() || teamContacts.length === 0) return [];
    
    const queryWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const matches = [];

    teamContacts.forEach(team => {
      let score = 0;
      const matchedKeywords = [];
      let hasExact = false;
      let hasFuzzy = false;

      // Exact matches
      team.keywords.forEach(kw => {
        const kwWords = kw.toLowerCase().split(/\s+/);
        queryWords.forEach(qw => {
          kwWords.forEach(kwd => {
            if (qw === kwd) {
              score += 100;
              hasExact = true;
              if (!matchedKeywords.includes(kw)) matchedKeywords.push(kw);
            }
          });
        });
      });

      // Fuzzy matches if no exact matches
      if (!hasExact) {
        team.keywords.forEach(kw => {
          const kwWords = kw.toLowerCase().split(/\s+/);
          queryWords.forEach(qw => {
            kwWords.forEach(kwd => {
              if (isFuzzyMatch(qw, kwd)) {
                score += 80;
                hasFuzzy = true;
                if (!matchedKeywords.includes(kw)) {
                  matchedKeywords.push(`${kw} (did you mean "${kwd}")`);
                }
              }
            });
          });
        });
      }

      // Partial matches if no exact or fuzzy matches
      if (!hasExact && !hasFuzzy) {
        team.keywords.forEach(kw => {
          const kwLower = kw.toLowerCase();
          if (query.toLowerCase().includes(kwLower)) {
            score += 50;
            if (!matchedKeywords.includes(kw)) matchedKeywords.push(kw);
            return;
          }
          queryWords.forEach(qw => {
            kwLower.split(/\s+/).forEach(kwd => {
              if (qw.includes(kwd) || kwd.includes(qw)) {
                score += 5;
                if (!matchedKeywords.includes(kw)) matchedKeywords.push(kw);
              }
            });
          });
        });
      }

      if (score > 0) {
        matches.push({ ...team, score, matchedKeywords });
      }
    });

    return matches.sort((a, b) => b.score - a.score);
  }

  // UI elements
  const widget = document.getElementById('cc-widget');
  const launcher = document.getElementById('cc-launcher');
  const closer = document.getElementById('cc-close');
  const messages = document.getElementById('cc-messages');
  const typing = document.getElementById('cc-typing');
  const input = document.getElementById('cc-input');
  const sendBtn = document.getElementById('cc-send');
  const suggestions = document.getElementById('cc-suggestions');

  const chips = [
    'cancel my order', 'damaged artwork', 'order tracking',
    'artist event', 'stock availability', 'installation help',
    'lost shipment', 'returns'
  ];

  function mountChips() {
    suggestions.innerHTML = chips.map(c => 
      `<button class="cc-chip" data-q="${c.replace(/"/g, '&quot;')}">${c}</button>`
    ).join('');
    
    suggestions.querySelectorAll('.cc-chip').forEach(el => {
      el.addEventListener('click', () => {
        input.value = el.dataset.q;
        submitQuery();
      });
    });
  }

  function addBot(html) {
    const b = document.createElement('div');
    b.className = 'cc-bubble bot';
    b.innerHTML = html;
    messages.appendChild(b);
    messages.scrollTop = messages.scrollHeight;
  }

  function addUser(text) {
    const b = document.createElement('div');
    b.className = 'cc-bubble user';
    b.textContent = text;
    messages.appendChild(b);
    messages.scrollTop = messages.scrollHeight;
  }

  function renderCards(matches, query) {
    if (!matches.length) {
      addBot(`No specific team found for "${escapeHtml(query)}".<br/>Try different keywords or contact <strong>Client Services</strong> for general help.`);
      return;
    }

    const html = matches.map((m) => {
      const level = m.score >= 100 ? 'high' : m.score >= 50 ? 'medium' : 'low';
      const pct = Math.min(Math.round((m.score / 100) * 100), 100);
      const emailTags = m.emails.map(e => 
        `<a class="cc-email" href="mailto:${e}?subject=${encodeURIComponent('Who do I contact? - ' + query)}">${e}</a>`
      ).join('');
      const kws = m.matchedKeywords.map(k => `<span class="cc-k">${escapeHtml(k)}</span>`).join(', ');
      const phone = m.phone ? `<div class="cc-phone">📞 <a href="tel:${m.phone}">${m.phone}</a></div>` : '';
      
      return `<div class="cc-card match-${level}">
        <div class="cc-team">💼 ${escapeHtml(m.team)} <span class="cc-tag">${pct}% match</span></div>
        ${phone}
        <div class="cc-emails">${emailTags}</div>
        <div class="cc-keywords">Matched: ${kws}</div>
      </div>`;
    }).join('');

    addBot(html);
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));
  }

  function submitQuery() {
    const q = input.value.trim();
    if (!q) return;
    
    addUser(q);
    input.value = '';
    typing.style.display = 'block';
    
    setTimeout(() => {
      const matches = findMatchingTeams(q);
      typing.style.display = 'none';
      renderCards(matches, q);
    }, 480);
  }

  // Event listeners
  launcher.addEventListener('click', () => {
    widget.classList.add('open');
    input.focus();
    if (!messages.dataset.seeded) {
      seedIntro();
      messages.dataset.seeded = '1';
    }
  });

  closer.addEventListener('click', () => {
    widget.classList.remove('open');
  });

  sendBtn.addEventListener('click', submitQuery);

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') submitQuery();
  });

  function seedIntro() {
    addBot('Hi! 👋 Tell me what you need help with and I\'ll suggest the best team. Try typing something like <em>"I need to cancel my order"</em> or pick a suggestion below.');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    await loadTeamContacts();
    mountChips();
  });
})();
</script>
</body>
</html>

