<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Address Book - Castle Comms</title>
  <link rel="icon" type="image/png" href="icon.png">
  
  <!-- Security Headers -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="stylesheet" href="style.css?v=20250823_business_card_fix" />
  <style>
    :root {
      --bg: var(--primary-color);
      --panel: #F0EDE9;
      --accent: var(--secondary-color);
      --accent-2: var(--tertiary-color);
      --text: var(--text-dark);
      --muted: var(--text-muted);
      --danger: #dc3545;
      --card-w: 520px;
      --card-h: 280px;
      --card-background: #e5ddcb;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font-primary);
      color: var(--text);
      background: var(--primary-color);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      padding-top: 0;
    }

    .page-header {
      padding: 8px 20px 0;
      display: flex; 
      align-items: center; 
      justify-content: space-between;
    }
    .page-header h1 { 
      margin: 0; 
      font-size: clamp(18px, 2.4vw, 28px); 
      letter-spacing: 0.3px; 
      color: var(--secondary-color);
      font-family: var(--font-primary);
    }
    .credits { 
      color: var(--muted); 
      font-size: 12px; 
    }

    .app {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px 10px;
      height: 800px;
    }

    /* Left panel: form */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow-medium);
    }

    .panel h2 { 
      margin: 4px 0 14px; 
      font-size: 16px; 
      color: var(--muted); 
      font-weight: 600; 
    }

    form { display: grid; gap: 10px; }
    label { 
      font-size: 13px; 
      color: var(--muted); 
      display: block; 
      margin-bottom: 6px; 
    }
    input[type="text"], input[type="email"], input[type="tel"] {
      width: 100%;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text);
      padding: 12px 12px;
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }
    input:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(69, 73, 78, 0.15); 
    }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
    button {
      appearance: none; border: 0; cursor: pointer; border-radius: 10px;
      padding: 10px 14px; font-weight: 600;
      background: var(--accent); color: var(--surface-color);
      box-shadow: var(--shadow-light);
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    button:hover { 
      transform: translateY(-1px); 
      box-shadow: var(--shadow-medium); 
    }
    button.secondary { 
      background: var(--card-background); 
      color: var(--text); 
      box-shadow: none; 
    }
    button.danger { 
      background: var(--danger); 
      color: var(--surface-color); 
    }

    .tiny { font-size: 12px; color: var(--muted); margin-left: 4px; }

    .search { margin-top: 12px; display: grid; gap: 8px; }

    
    .search-top {
      margin-bottom: 20px;
      margin-top: 30px;
      text-align: center;
      max-width: 400px;
    }
    
    .search-top label {
      display: block;
      margin-bottom: 8px;
      font-size: 18px;
      color: var(--muted);
      font-weight: 600;
    }
    
    .search-top input {
      width: 100%;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .search-top input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(69, 73, 78, 0.15);
    }
    


    /* Right: Rolodex */
    .stage-wrap { 
      position: relative; 
      min-height: 0; 
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .rolodex {
      position: relative;
      height: min(80vh, 800px);
      min-height: 380px;
      perspective: 1200px;
      display: grid;
      place-items: center;
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }


    /* Side knobs */
    .knob { 
      position: absolute; width: 120px; height: 120px; border-radius: 50%; 
      top: 50%; transform: translateY(-50%);
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      box-shadow: var(--shadow-heavy);
      display: grid; place-items: center; color: var(--text); font-weight: 700;
      user-select: none;
      cursor: pointer;
      z-index: 10;
    }
    .knob.left { left: -60px; }
    .knob.right { right: -60px; }
    .knob button { 
      background: transparent; 
      color: var(--text); 
      border: none;
      box-shadow: none; 
      padding: 8px; 
      font-size: 24px; 
      cursor: pointer;
      border-radius: 50%;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .knob:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: var(--shadow-heavy);
    }

    /* Cards ring */
    .ring {
      position: relative;
      width: var(--card-w);
      height: var(--card-h);
      transform-style: preserve-3d;
      transition: transform 500ms cubic-bezier(.2,.7,.2,1);
    }

    .card {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: var(--card-w);
      height: var(--card-h);
      margin: auto;
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
      transform-style: preserve-3d;
      transition: transform 450ms cubic-bezier(.2,.7,.2,1), opacity 300ms ease; 
      will-change: transform, opacity;
      opacity: 1;
      cursor: pointer;
    }

    .card.hidden { opacity: 0; pointer-events: none; }

    /* Card flip animation styles */
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
      transition: transform 0.6s ease-in-out;
      -webkit-transition: -webkit-transform 0.6s ease-in-out;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      border-radius: 8px;
      display: grid;
      grid-template-rows: 1fr auto auto auto auto 1fr;
      gap: 6px;
      padding: 50px 40px 50px 40px;
    }

    .card-front {
      background: url("businesstemplate.jpg") center/contain no-repeat, #e5ddcb;
    }

    .card-back {
      background: url("businesstemplate.jpg") center/contain no-repeat, #e5ddcb;
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
    }

    .card.flipped .card-inner {
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
    }

    .card.flipped {
      z-index: 100;
    }

    /* Front side styling */
    .job-title {
      color: #666;
      font-weight: 600;
      font-size: 18px;
      text-align: left;
      z-index: 2;
      position: relative;
    }

    .team {
      color: #888;
      font-weight: 500;
      font-size: 16px;
      text-align: left;
      margin-bottom: 8px;
      z-index: 2;
      position: relative;
    }

    .office-phone, .personal-email {
      font-size: 16px;
      color: #555;
      font-weight: 500;
      line-height: 1.4;
      z-index: 2;
      position: relative;
      text-align: left;
    }

    /* Back side styling */
    .back-contact-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 18px;
      color: #666;
      font-weight: 600;
      text-align: left;
    }

    .team-email, .mobile-phone {
      line-height: 1.4;
      z-index: 2;
      position: relative;
    }

    .team-email {
      font-size: 16px;
      word-break: break-word;
    }

    .back-spacer {
      height: 20px;
    }

    .card::before {
      /* Subtle overlay for text readability */
      content: "";
      position: absolute; 
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(240, 237, 233, 0.1);
      border-radius: 14px;
    }

    .card .tag {
      position: relative;
      align-self: start;
      color: #666;
      font-weight: 600; 
      font-size: 14px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 2;
      background: none;
      padding: 0;
      border-radius: 0;
    }

    .card h3 { 
      margin: 0; 
      font-size: 36px; 
      color: #555; 
      font-style: italic;
      font-weight: 400;
      line-height: 1.1;
      z-index: 2;
      position: relative;
      text-align: left;
    }
    .card .tag {
      color: #666;
      font-weight: 600; 
      font-size: 12px; 
      text-transform: uppercase;
      letter-spacing: 0.8px;
      z-index: 2;
      position: relative;
      margin-bottom: 4px;
    }
    .card .company { 
      color: #777; 
      font-size: 14px; 
      font-weight: 400;
      z-index: 2;
      position: relative;
      margin-bottom: 8px;
    }
    .meta { 
      color: #666; 
      font-size: 12px; 
      line-height: 1.3;
      z-index: 2;
      position: relative;
    }
    .meta.contact-info {
      background: none;
      border-radius: 0;
      padding: 0;
      border-left: none;
    }
    .meta .phone, .meta .email, .meta .office-phone, .meta .personal-email {
      margin-bottom: 2px;
    }

    .card .footer { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 10px; 
    }
    .badge { font-size: 12px; color: var(--muted); }

    .pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; 
      border-radius: 999px;
      background: var(--card-background); border: 1px solid var(--border-color);
      font-size: 12px; color: var(--text);
    }
    .pill a { color: var(--accent); text-decoration: none; }

    .empty { color: var(--muted); font-size: 14px; text-align: center; }


    .index { 
      position: absolute; top: 10px; left: 50%; 
      transform: translateX(-50%); color: var(--muted); 
      font-size: 12px; letter-spacing: 0.4px; 
    }


    .page-footer { 
      padding: 4px 20px 16px; 
      color: var(--muted); 
      font-size: 12px; 
    }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .rolodex { height: 68vh; }
      .knob.left { left: -40px; }
      .knob.right { right: -40px; }
      :root { --card-w: 92vw; }
    }
  </style>
</head>
<body>



  <main class="app">
    <section class="stage-wrap">
      <div class="search-top">
        <label for="q">Quick Find</label>
        <input id="q" type="text" placeholder="Search by name, email, phone or department... (Esc to clear)" />
      </div>
      
      <div class="rolodex" aria-live="polite">
        <div class="index" id="cursorIndex">0 / 0</div>
        <div class="knob left" title="Previous">
          <button type="button" id="prev" aria-label="Previous card">‚óÄ</button>
        </div>
        <div class="knob right" title="Next">
          <button type="button" id="next" aria-label="Next card">‚ñ∂</button>
        </div>
        <div class="ring" id="ring"></div>
      </div>
      
    </section>
  </main>



  <template id="cardTemplate">
    <article class="card" role="group" aria-roledescription="Address card">
      <div class="card-inner">
        <div class="card-front">
          <div></div>
          <h3 class="name"></h3>
          <div class="job-title"></div>
          <div class="team"></div>
          <div class="meta contact-info">
            <div class="office-phone"></div>
            <div class="personal-email"></div>
          </div>
        </div>
        <div class="card-back">
          <div></div>
          <div class="back-spacer"></div>
          <div class="back-spacer"></div>
          <div class="company">Castle Fine Art</div>
          <div class="back-contact-info">
            <div class="team-email"></div>
            <div class="mobile-phone"></div>
          </div>
        </div>
      </div>
    </article>
  </template>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script src="firebase-init.js"></script>
  <script src="script.js?v=20250823_business_card_fix"></script>

  <script>
    console.log('üìñ Address book script starting...');
    (function(){
      const ring = document.getElementById('ring');
      const q = document.getElementById('q');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const cursorIndexLabel = document.getElementById('cursorIndex');
      const tpl = document.getElementById('cardTemplate');

      const STORAGE_KEY = 'castleAddressBook_v2';
      const STATE = { contacts: [], filtered: [], cursor: 0, angle: 0, radius: 360 / Math.max(1, 8) };

      const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE.contacts));
      const load = () => {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return []; }
      };

      const fmtDate = ts => new Date(ts).toLocaleString();
      const initials = name => (name||'').split(/\s+/).filter(Boolean).map(s => s[0]).slice(0,3).join('').toUpperCase();

      // Load business cards from JSON file
      async function loadBusinessCardsJSON() {
        console.log('üîÑ Loading businesscards.json...');
        try {
          const response = await fetch('businesscards.json');
          console.log('üì° Fetch response status:', response.status, response.statusText);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const businessCards = await response.json();
          console.log('‚úÖ Successfully loaded businesscards.json');
          console.log('üìä Number of business cards loaded:', businessCards.length);
          console.log('üìã First business card sample:', businessCards[0]);
          console.log('üìã All business card names:', businessCards.map(card => card.Name));
          
          return businessCards;
        } catch (error) {
          console.error('‚ùå Error loading business cards:', error);
          return [];
        }
      }

      function createCard(contact){
        const node = tpl.content.firstElementChild.cloneNode(true);
        
        // Populate front side
        node.querySelector('.name').textContent = contact.name || 'Unnamed';
        node.querySelector('.job-title').textContent = contact.jobTitle || '';
        node.querySelector('.team').textContent = contact.team || '';
        node.querySelector('.office-phone').textContent = contact.officePhone || '';
        node.querySelector('.personal-email').textContent = contact.personalEmail || '';
        
        // Populate back side
        node.querySelector('.team-email').textContent = contact.teamEmail || '';
        
        // Format mobile phone with prefix, handle N/A values
        let mobileText = '';
        if (contact.mobilePhone && contact.mobilePhone !== 'N/A' && contact.mobilePhone.trim() !== '') {
          mobileText = `Mobile No: ${contact.mobilePhone}`;
        }
        node.querySelector('.mobile-phone').textContent = mobileText;
        
        return node;
      }

      function tagFor(name){
        const n = (name||'').trim();
        if(!n) return 'General';
        const c = n[0].toUpperCase();
        if(c < 'A' || c > 'Z') return '#';
        return c;
      }

      function sortContacts(list){
        return list.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      }

      function render(){
        ring.innerHTML = '';
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        if(!list.length){
          const div = document.createElement('div');
          div.className = 'empty';
          div.textContent = 'Your address book is empty. Add a contact or load Castle staff.';
          ring.appendChild(div);
          cursorIndexLabel.textContent = '0 / 0';
          return;
        }

        const N = list.length;
        const step = 360 / N;
        ring.style.transform = `rotateX(0deg) rotateY(${STATE.angle}deg)`;

        list.forEach((c, i)=>{
          const el = createCard(c);
          const ang = i * step;
          el.style.transform = `rotateY(${ang}deg) translateZ(380px)`;
          el.dataset.index = i;
          ring.appendChild(el);
        });

        STATE.cursor = Math.max(0, Math.min(STATE.cursor, N-1));
        STATE.angle = -STATE.cursor * step;
        ring.style.transform = `rotateX(0deg) rotateY(${STATE.angle}deg)`;
        cursorIndexLabel.textContent = `${STATE.cursor+1} / ${N}`;
        applyLine();
        showDetail();
      }

      function setCursor(idx){
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        if(!list.length) return;
        const N = list.length;
        STATE.cursor = (idx + N) % N;
        const step = 360 / N;
        STATE.angle = -STATE.cursor * step;
        ring.style.transform = `rotateX(0deg) rotateY(${STATE.angle}deg)`;
        cursorIndexLabel.textContent = `${STATE.cursor+1} / ${N}`;
        applyLine();
        showDetail();
      }

      function next(){ setCursor(STATE.cursor + 1); }
      function prev(){ setCursor(STATE.cursor - 1); }


      function applyFilter(text){
        const t = (text||'').toLowerCase().trim();
        if(!t){ STATE.filtered = []; render(); return; }
        STATE.filtered = STATE.contacts.filter(c=> [c.name,c.email,c.phone,c.label].join(' ').toLowerCase().includes(t));
        STATE.cursor = 0;
        render();
      }

      async function loadCastleStaff(){
        console.log('üè¢ loadCastleStaff() called - loading staff data...');
        // Clear existing and load staff from JSON
        STATE.contacts = [];
        const businessCards = await loadBusinessCardsJSON();
        
        if (businessCards.length === 0) {
          console.warn('‚ö†Ô∏è No business cards loaded - check if businesscards.json exists and is accessible');
          return;
        }
        
        businessCards.forEach(card => {
          // Create combined office phone with extension
          let officePhone = card["Telephone No"] || "";
          const ext = card["Ext"] || "";
          if (officePhone && ext && ext !== "N/A") {
            // Remove "(Internal)" and extract just the number
            const cleanExt = ext.replace("(Internal)", "").trim();
            officePhone = `${officePhone} (${cleanExt})`;
          }
          
          const contact = {
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
            name: card["Name"] || "",
            jobTitle: card["Job Title"] && card["Job Title"] !== "N/A" ? card["Job Title"] : "",
            team: card["Team"] && card["Team"] !== "N/A" ? card["Team"] : "",
            officePhone: officePhone,
            personalEmail: card["Email Address"] && card["Email Address"] !== "N/A" ? card["Email Address"] : "",
            mobilePhone: card["Mobile No"] && card["Mobile No"] !== "N/A" ? card["Mobile No"] : "",
            teamEmail: card["Team Email Address"] && card["Team Email Address"] !== "N/A" ? card["Team Email Address"] : "",
            // Keep these for search/compatibility
            email: card["Email Address"] && card["Email Address"] !== "N/A" ? card["Email Address"] : "",
            phone: officePhone || (card["Mobile No"] && card["Mobile No"] !== "N/A" ? card["Mobile No"] : ""),
            label: card["Job Title"] && card["Job Title"] !== "N/A" ? card["Job Title"] : "",
            createdAt: Date.now()
          };
          STATE.contacts.push(contact);
        });
        
        STATE.contacts = sortContacts(STATE.contacts);
        console.log('üìù Processed contacts count:', STATE.contacts.length);
        console.log('üìã Sample processed contact:', STATE.contacts[0]);
        console.log('‚úÖ Staff loading complete - contacts saved to localStorage');
        
        save();
        applyFilter(q.value);
        setCursor(0);
      }


      // Init
      console.log('üöÄ Initializing address book...');
      STATE.contacts = sortContacts(load());
      console.log('üì¶ Loaded from localStorage:', STATE.contacts.length, 'contacts');
      
      // Auto-load castle staff if no contacts exist
      if (STATE.contacts.length === 0) {
        console.log('üì• No existing contacts - triggering loadCastleStaff()');
        loadCastleStaff().catch(error => {
          console.error('‚ùå Failed to load castle staff:', error);
          render(); // Still render even if loading fails
        });
      } else {
        console.log('‚úÖ Using existing contacts from localStorage');
        render();
      }

      // Events


      prevBtn.addEventListener('click', prev);
      nextBtn.addEventListener('click', next);
      q.addEventListener('input', e=> applyFilter(e.target.value));
      q.addEventListener('keydown', e=>{ if(e.key==='Escape'){ q.value=''; applyFilter(''); }});



      function showDetail(){
        // Detail functionality removed - this function now does nothing
        return;
      }

      function relIndex(i, c, N){
        let d = i - c;
        if(d > N/2) d -= N;
        if(d < -N/2) d += N;
        return d;
      }

      function applyLine(){
        const list = STATE.filtered.length ? STATE.filtered : STATE.contacts;
        const cards = Array.from(ring.querySelectorAll('.card'));
        const N = list.length;
        if(!N || !cards.length) return;
        const spread = 110;
        const maxSide = 4;
        ring.style.transform = 'translateZ(0)';
        cards.forEach((el, i)=>{
          const d = relIndex(i, STATE.cursor, N);
          const a = Math.abs(d);
          const tx = d * spread;
          const tz = -(50 + Math.min(300, a * 60));
          const ry = d * -10;
          const sc = 1 - Math.min(0.6, a * 0.06);
          const hidden = a > maxSide;
          el.style.transform = 'translateX(' + tx + 'px) translateZ(' + tz + 'px) rotateY(' + ry + 'deg) scale(' + sc + ')';
          el.style.opacity = hidden ? 0 : (1 - a * 0.05);
          el.style.pointerEvents = hidden ? 'none' : 'auto';
          el.style.zIndex = String(100 - a);
        });
      }

      // Keyboard navigation
      window.addEventListener('keydown', (e)=>{
        if(['ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
        if(e.key === 'ArrowLeft') prev();
        if(e.key === 'ArrowRight') next();
      });

      // Wheel navigation
      let wheelAccum = 0;
      ring.addEventListener('wheel', (e)=>{
        wheelAccum += e.deltaY + e.deltaX * 1.2;
        if(Math.abs(wheelAccum) > 50){
          if(wheelAccum > 0) next(); else prev();
          wheelAccum = 0;
        }
        e.preventDefault();
      }, { passive:false });

      // Click a card to focus it or flip it - Safari compatible version
      ring.addEventListener('click', (e)=>{
        e.preventDefault(); // Prevent default Safari behavior
        e.stopPropagation(); // Stop event bubbling issues in Safari
        
        // More robust card detection for Safari
        let card = null;
        let target = e.target;
        
        // Traverse up the DOM tree to find the card element
        while (target && target !== ring) {
          if (target.classList && target.classList.contains('card')) {
            card = target;
            break;
          }
          target = target.parentElement;
        }
        
        if(!card) return;
        
        const idx = Number(card.dataset.index || 0);
        
        // If this card is already focused, flip it
        if(STATE.cursor === idx) {
          // Force Safari to trigger reflow before animation
          card.offsetHeight;
          card.classList.toggle('flipped');
          return;
        }
        
        // Otherwise, focus the card and remove flip from all cards
        const allCards = ring.querySelectorAll('.card');
        allCards.forEach(c => {
          // Force Safari reflow for each card
          c.offsetHeight;
          c.classList.remove('flipped');
        });
        setCursor(idx);
      });
    })();
  </script>


</body>
</html>


