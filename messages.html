<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Chat - Castle Comms</title>
  
  <!-- Security Headers -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <link rel="stylesheet" href="style.css?v=20250731" />
  <style>
    /* Teams-style Chat Interface */
    .chat-container {
      display: flex;
      height: calc(100vh - 80px);
      width: 100%;
      max-width: 100%;
      margin: 0;
      background: #f8f9fa;
      box-sizing: border-box;
    }

    /* Left Chat Panel */
    .chat-sidebar {
      width: 320px;
      min-width: 280px;
      background: #ffffff;
      border-right: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e5e5;
      background: #ffffff;
    }

    .chat-sidebar-title {
      font-size: 18px;
      font-weight: 600;
      color: #323130;
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-search {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
      background: #faf9f8;
      transition: all 0.2s;
    }

    .chat-search:focus {
      outline: none;
      border-color: #6264a7;
      background: #ffffff;
    }

    .new-chat-button {
      background: #6264a7;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 12px;
      width: 100%;
    }

    .new-chat-button:hover {
      background: #585a96;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .chat-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-item:hover {
      background: #f8f9fa;
    }

    .chat-item.active {
      background: #e6f2ff;
      border-left-color: #6264a7;
    }

    .chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #6264a7;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .chat-item-content {
      flex: 1;
      min-width: 0;
    }

    .chat-item-name {
      font-size: 14px;
      font-weight: 600;
      color: #323130;
      margin: 0 0 4px 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-item-preview {
      font-size: 12px;
      color: #605e5c;
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-item-time {
      font-size: 11px;
      color: #8a8886;
      flex-shrink: 0;
    }

    /* Main Chat Area */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #ffffff;
    }

    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e5e5;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-header-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #6264a7;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }

    .chat-header-details h2 {
      font-size: 16px;
      font-weight: 600;
      color: #323130;
      margin: 0 0 2px 0;
    }

    .chat-header-details p {
      font-size: 12px;
      color: #605e5c;
      margin: 0;
    }

    .chat-actions {
      display: flex;
      gap: 8px;
    }

    .chat-action-btn {
      background: none;
      border: 1px solid #e5e5e5;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #323130;
    }

    .chat-action-btn:hover {
      background: #f8f9fa;
      border-color: #d1d1d1;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-group.own {
      align-items: flex-end;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-header.own {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #6264a7;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message-sender {
      font-size: 12px;
      font-weight: 600;
      color: #323130;
    }

    .message-time {
      font-size: 11px;
      color: #8a8886;
    }

    .message-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 8px;
      background: #f8f9fa;
      color: #323130;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      margin-left: 36px;
    }

    .message-group.own .message-bubble {
      background: #6264a7;
      color: white;
      margin-left: 0;
      margin-right: 36px;
    }

    /* Chat Input Area */
    .chat-input-area {
      padding: 16px 24px;
      border-top: 1px solid #e5e5e5;
      background: #ffffff;
    }

    .chat-input-container {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      max-width: 100%;
    }

    .chat-input {
      flex: 1;
      min-height: 40px;
      max-height: 120px;
      padding: 8px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      background: #faf9f8;
      transition: all 0.2s;
    }

    .chat-input:focus {
      outline: none;
      border-color: #6264a7;
      background: #ffffff;
    }

    .send-button {
      background: #6264a7;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      height: 40px;
    }

    .send-button:hover:not(:disabled) {
      background: #585a96;
    }

    .send-button:disabled {
      background: #c8c6c4;
      cursor: not-allowed;
    }

    /* Empty State */
    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #605e5c;
      padding: 40px;
    }

    .chat-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .chat-empty h3 {
      font-size: 18px;
      margin: 0 0 8px 0;
      color: #323130;
    }

    .chat-empty p {
      font-size: 14px;
      margin: 0;
      max-width: 300px;
    }

    /* New Chat Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e5e5;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #323130;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #605e5c;
      padding: 4px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #323130;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
      background: #faf9f8;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #6264a7;
      background: #ffffff;
    }

    .user-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e5e5;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .user-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f8f9fa;
      font-size: 14px;
    }

    .user-suggestion:hover {
      background-color: #f8f9fa;
    }

    .selected-users {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .selected-user-tag {
      background: #e6f2ff;
      color: #6264a7;
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .remove-user {
      background: none;
      border: none;
      color: #6264a7;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e5e5;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e5e5e5;
      background: white;
      color: #323130;
    }

    .btn-primary {
      background: #6264a7;
      color: white;
      border-color: #6264a7;
    }

    .btn-primary:hover:not(:disabled) {
      background: #585a96;
      border-color: #585a96;
    }

    .btn:hover {
      background: #f8f9fa;
    }

    .btn:disabled {
      background: #c8c6c4;
      color: #a19f9d;
      cursor: not-allowed;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .chat-container {
        height: calc(100vh - 60px);
      }
      
      .chat-sidebar {
        width: 280px;
        min-width: 260px;
        position: fixed;
        left: -280px;
        top: 60px;
        height: calc(100vh - 60px);
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }
      
      .chat-sidebar.open {
        left: 0;
      }
      
      .chat-main {
        width: 100%;
      }
      
      .mobile-chat-toggle {
        display: block;
        background: none;
        border: none;
        font-size: 18px;
        color: #323130;
        cursor: pointer;
        margin-right: 12px;
      }
      
      .chat-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        display: none;
      }
      
      .chat-overlay.show {
        display: block;
      }
    }

    @media (min-width: 769px) {
      .mobile-chat-toggle {
        display: none;
      }
    }
  </style>
</head>
<body>

<!-- Background Slideshow -->
<div class="background-slideshow" id="background-slideshow">
  <!-- Images will be injected by JavaScript -->
</div>
  
<header>
  <button id="menu-toggle" class="hamburger">&#9776;</button>
  <h1>Castle Comms</h1>
</header>

<div id="notification-bell" class="notification-bell hidden">
  🔔 <span id="notification-count" class="count-badge">0</span>
</div>

<div id="sidebar-container"></div>

<main id="main" style="padding: 0; margin: 0; max-width: 100%;">
  <div class="chat-container">
    <!-- Chat Sidebar -->
    <div class="chat-sidebar" id="chat-sidebar">
      <div class="chat-sidebar-header">
        <h2 class="chat-sidebar-title">
          💬 Chat
        </h2>
        <input type="text" class="chat-search" id="chat-search" placeholder="Search chats...">
        <button class="new-chat-button" id="new-chat-btn">+ New Chat</button>
      </div>
      
      <div class="chat-list" id="chat-list">
        <div class="chat-empty" style="padding: 40px 20px;">
          <div class="chat-empty-icon">💬</div>
          <p>No chats yet. Start a new conversation!</p>
        </div>
      </div>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="chat-overlay" id="chat-overlay"></div>
    
    <!-- Main Chat Area -->
    <div class="chat-main" id="chat-main">
      <div class="chat-empty">
        <div class="chat-empty-icon">💬</div>
        <h3>Welcome to Castle Comms Chat</h3>
        <p>Select a chat from the sidebar or start a new conversation to get started.</p>
      </div>
    </div>
  </div>
</main>

<!-- New Chat Modal -->
<div class="modal" id="new-chat-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Start New Chat</h3>
      <button class="modal-close" onclick="closeNewChatModal()">&times;</button>
    </div>
    
    <form id="new-chat-form">
      <div class="form-group">
        <label class="form-label" for="chat-name-input">Chat Name</label>
        <input type="text" class="form-input" id="chat-name-input" placeholder="Enter chat name...">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="user-search-input">Add People</label>
        <div style="position: relative;">
          <input type="text" class="form-input" id="user-search-input" placeholder="Start typing a name or email..." autocomplete="off">
          <div class="user-suggestions" id="user-suggestions"></div>
        </div>
        <div class="selected-users" id="selected-users"></div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeNewChatModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" id="create-chat-btn" disabled>Create Chat</button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<!-- Teams-style Chat Logic -->
<script>
let db;
let currentUser;
let allUsers = [];
let selectedUsers = [];
let currentChat = null;
let chatListeners = [];

document.addEventListener('DOMContentLoaded', function() {
  // Check authentication first
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.log('User not authenticated, redirecting to login');
      window.location.href = 'index.html';
      return;
    }

    currentUser = user;
    
    // Initialize Firebase Firestore
    if (firebase.apps.length > 0) {
      db = firebase.firestore();
      await initializeChat();
    } else {
      console.error('Firebase not initialized');
    }
  });
});

// Initialize chat system
async function initializeChat() {
  try {
    await loadAllUsers();
    setupEventListeners();
    loadChats();
    console.log('Chat system initialized successfully');
  } catch (error) {
    console.error('Error initializing chat system:', error);
  }
}

// Load all users for autocomplete
async function loadAllUsers() {
  try {
    // Use static list of accounts we created
    allUsers = [
      { email: 'mdelaney@castlefineart.com', name: 'Marc Delaney' },
      { email: 'gturpin@washingtongreen.co.uk', name: 'Gary Turpin' },
      { email: 'icc@castlefineart.com', name: 'ICC' },
      { email: 'mailbox@castlefineart.com', name: 'Mailbox' },
      { email: 'cheltenham@castlefineart.com', name: 'Cheltenham' },
      { email: 'derby@castlefineart.com', name: 'Derby' },
      { email: 'leamingtonspa@castlefineart.com', name: 'Leamington Spa' },
      { email: 'miltonkeynes@castlefineart.com', name: 'Milton Keynes' },
      { email: 'nottingham@castlefineart.com', name: 'Nottingham' },
      { email: 'stamford@castlefineart.com', name: 'Stamford' },
      { email: 'stratford@castlefineart.com', name: 'Stratford' },
      { email: 'chester@castlefineart.com', name: 'Chester' },
      { email: 'harrogate@castlefineart.com', name: 'Harrogate' },
      { email: 'leeds@castlefineart.com', name: 'Leeds' },
      { email: 'liverpool@castlefineart.com', name: 'Liverpool' },
      { email: 'manchester@castlefineart.com', name: 'Manchester' },
      { email: 'newcastle@castlefineart.com', name: 'Newcastle' },
      { email: 'meadowhall@castlefineart.com', name: 'Meadowhall' },
      { email: 'york@castlefineart.com', name: 'York' },
      { email: 'cgn@castlefineart.com', name: 'CGN' },
      { email: 'sms@castlefineart.com', name: 'SMS' },
      { email: 'scp@castlefineart.com', name: 'SCP' },
      { email: 'bath@castlefineart.com', name: 'Bath' },
      { email: 'brighton@castlefineart.com', name: 'Brighton' },
      { email: 'bristol@castlefineart.com', name: 'Bristol' },
      { email: 'cambridge@castlefineart.com', name: 'Cambridge' },
      { email: 'canterbury@castlefineart.com', name: 'Canterbury' },
      { email: 'exeter@castlefineart.com', name: 'Exeter' },
      { email: 'guildford@castlefineart.com', name: 'Guildford' },
      { email: 'bluewater@castlefineart.com', name: 'Bluewater' },
      { email: 'marlow@castlefineart.com', name: 'Marlow' },
      { email: 'norwich@castlefineart.com', name: 'Norwich' },
      { email: 'oxford@castlefineart.com', name: 'Oxford' },
      { email: 'reading@castlefineart.com', name: 'Reading' },
      { email: 'tunbridgewells@castlefineart.com', name: 'Tunbridge Wells' },
      { email: 'winchester@castlefineart.com', name: 'Winchester' },
      { email: 'windsor@castlefineart.com', name: 'Windsor' },
      { email: 'edinburgh@castlefineart.com', name: 'Edinburgh' },
      { email: 'glasgow@castlefineart.com', name: 'Glasgow' },
      { email: 'cardiff@castlefineart.com', name: 'Cardiff' }
    ].filter(user => user.email !== currentUser.email); // Remove current user from list
  } catch (error) {
    console.error('Error loading users:', error);
  }
}

// Setup event listeners
function setupEventListeners() {
  // New chat button
  document.getElementById('new-chat-btn').addEventListener('click', openNewChatModal);
  
  // New chat form
  document.getElementById('new-chat-form').addEventListener('submit', createNewChat);
  
  // User search in modal
  setupUserSearch();
  
  // Chat name input
  document.getElementById('chat-name-input').addEventListener('input', validateNewChatForm);
  
  // Mobile toggle
  const overlay = document.getElementById('chat-overlay');
  if (overlay) {
    overlay.addEventListener('click', closeMobileSidebar);
  }
  
  // Chat search
  const chatSearch = document.getElementById('chat-search');
  if (chatSearch) {
    chatSearch.addEventListener('input', filterChats);
  }
}

// Setup user search functionality
function setupUserSearch() {
  const searchInput = document.getElementById('user-search-input');
  const suggestionsDiv = document.getElementById('user-suggestions');
  
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    if (query.length < 1) {
      suggestionsDiv.style.display = 'none';
      return;
    }
    
    const filteredUsers = allUsers.filter(user => 
      (user.name.toLowerCase().includes(query) || 
       user.email.toLowerCase().includes(query)) &&
      !selectedUsers.find(selected => selected.email === user.email)
    );
    
    if (filteredUsers.length > 0) {
      suggestionsDiv.innerHTML = filteredUsers.map(user => 
        `<div class="user-suggestion" data-email="${user.email}" data-name="${user.name}">
          <strong>${user.name}</strong><br>
          <small style="color: #8a8886;">${user.email}</small>
        </div>`
      ).join('');
      suggestionsDiv.style.display = 'block';
    } else {
      suggestionsDiv.style.display = 'none';
    }
  });
  
  // Handle suggestion clicks
  suggestionsDiv.addEventListener('click', (e) => {
    const suggestion = e.target.closest('.user-suggestion');
    if (suggestion) {
      const email = suggestion.dataset.email;
      const name = suggestion.dataset.name;
      
      addSelectedUser({ email, name });
      searchInput.value = '';
      suggestionsDiv.style.display = 'none';
    }
  });
  
  // Hide suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.form-group')) {
      suggestionsDiv.style.display = 'none';
    }
  });
}

// Add user to selected users
function addSelectedUser(user) {
  if (!selectedUsers.find(selected => selected.email === user.email)) {
    selectedUsers.push(user);
    updateSelectedUsersDisplay();
    validateNewChatForm();
  }
}

// Remove user from selected users
function removeSelectedUser(email) {
  selectedUsers = selectedUsers.filter(user => user.email !== email);
  updateSelectedUsersDisplay();
  validateNewChatForm();
}

// Update selected users display
function updateSelectedUsersDisplay() {
  const container = document.getElementById('selected-users');
  container.innerHTML = selectedUsers.map(user => 
    `<div class="selected-user-tag">
      ${user.name}
      <button type="button" class="remove-user" onclick="removeSelectedUser('${user.email}')">&times;</button>
    </div>`
  ).join('');
}

// Validate new chat form
function validateNewChatForm() {
  const chatName = document.getElementById('chat-name-input').value.trim();
  const createBtn = document.getElementById('create-chat-btn');
  
  createBtn.disabled = !chatName || selectedUsers.length === 0;
}

// Open new chat modal
function openNewChatModal() {
  selectedUsers = [];
  updateSelectedUsersDisplay();
  document.getElementById('chat-name-input').value = '';
  document.getElementById('user-search-input').value = '';
  document.getElementById('new-chat-modal').classList.add('show');
  validateNewChatForm();
}

// Close new chat modal
function closeNewChatModal() {
  document.getElementById('new-chat-modal').classList.remove('show');
  selectedUsers = [];
  updateSelectedUsersDisplay();
}

// Create new chat
async function createNewChat(e) {
  e.preventDefault();
  
  const chatName = document.getElementById('chat-name-input').value.trim();
  const createBtn = document.getElementById('create-chat-btn');
  
  if (!chatName || selectedUsers.length === 0) {
    return;
  }
  
  createBtn.disabled = true;
  createBtn.textContent = 'Creating...';
  
  try {
    const participants = [...selectedUsers.map(u => u.email), currentUser.email];
    const currentUserName = await getUserDisplayName(currentUser);
    
    const chatData = {
      name: chatName,
      participants: participants,
      createdBy: currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastMessage: `${currentUserName} created the chat`,
      lastMessageSender: currentUserName
    };
    
    const chatRef = await db.collection('chats').add(chatData);
    
    // Send initial system message
    await db.collection('chat-messages').add({
      chatId: chatRef.id,
      senderEmail: 'system',
      senderName: 'System',
      message: `${currentUserName} created this chat with ${selectedUsers.map(u => u.name).join(', ')}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      type: 'system'
    });
    
    closeNewChatModal();
    loadChats();
    
    // Select the new chat
    setTimeout(() => {
      selectChat(chatRef.id);
    }, 1000);
    
  } catch (error) {
    console.error('Error creating chat:', error);
    alert('Failed to create chat. Please try again.');
  }
  
  createBtn.disabled = false;
  createBtn.textContent = 'Create Chat';
}

// Load chats for current user
async function loadChats() {
  try {
    // Clean up existing listeners
    chatListeners.forEach(unsubscribe => unsubscribe());
    chatListeners = [];
    
    // Listen for real-time updates
    const unsubscribe = db.collection('chats')
      .where('participants', 'array-contains', currentUser.email)
      .orderBy('lastMessageAt', 'desc')
      .onSnapshot((snapshot) => {
        displayChats(snapshot.docs);
      });
    
    chatListeners.push(unsubscribe);
    
  } catch (error) {
    console.error('Error loading chats:', error);
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = '<div class="chat-empty" style="padding: 40px 20px;"><p style="color: #d13438;">Failed to load chats</p></div>';
  }
}

// Display chats in sidebar
function displayChats(chatDocs) {
  const chatList = document.getElementById('chat-list');
  
  if (chatDocs.length === 0) {
    chatList.innerHTML = `
      <div class="chat-empty" style="padding: 40px 20px;">
        <div class="chat-empty-icon">💬</div>
        <p>No chats yet. Start a new conversation!</p>
      </div>
    `;
    return;
  }
  
  const chatItems = chatDocs.map(doc => {
    const data = doc.data();
    const isActive = currentChat && currentChat.id === doc.id;
    
    // Generate avatar initials
    const initials = data.name ? data.name.substring(0, 2).toUpperCase() : '💬';
    
    return `
      <div class="chat-item ${isActive ? 'active' : ''}" onclick="selectChat('${doc.id}')">
        <div class="chat-avatar">${initials}</div>
        <div class="chat-item-content">
          <div class="chat-item-name">${data.name}</div>
          <div class="chat-item-preview">${data.lastMessage || 'No messages yet'}</div>
        </div>
        <div class="chat-item-time">${formatTimestamp(data.lastMessageAt)}</div>
      </div>
    `;
  }).join('');
  
  chatList.innerHTML = chatItems;
}

// Select and open a chat
async function selectChat(chatId) {
  try {
    const chatDoc = await db.collection('chats').doc(chatId).get();
    if (!chatDoc.exists) {
      console.error('Chat not found');
      return;
    }
    
    const chatData = chatDoc.data();
    currentChat = { id: chatId, ...chatData };
    
    // Update UI
    updateActiveChatInList(chatId);
    displayChatInterface();
    loadChatMessages(chatId);
    
  } catch (error) {
    console.error('Error selecting chat:', error);
  }
}

// Update active chat in sidebar list
function updateActiveChatInList(chatId) {
  const chatItems = document.querySelectorAll('.chat-item');
  chatItems.forEach(item => {
    item.classList.remove('active');
    if (item.getAttribute('onclick').includes(chatId)) {
      item.classList.add('active');
    }
  });
}

// Display chat interface
function displayChatInterface() {
  if (!currentChat) return;
  
  const chatMain = document.getElementById('chat-main');
  const initials = currentChat.name ? currentChat.name.substring(0, 2).toUpperCase() : '💬';
  const participantsText = `${currentChat.participants.length} participant${currentChat.participants.length !== 1 ? 's' : ''}`;
  
  chatMain.innerHTML = `
    <div class="chat-header">
      <button class="mobile-chat-toggle" onclick="openMobileSidebar()">☰</button>
      <div class="chat-header-info">
        <div class="chat-header-avatar">${initials}</div>
        <div class="chat-header-details">
          <h2>${currentChat.name}</h2>
          <p>${participantsText}</p>
        </div>
      </div>
      <div class="chat-actions">
        <button class="chat-action-btn" onclick="renameChatPrompt()">Rename</button>
        <button class="chat-action-btn" onclick="showChatInfo()">Info</button>
      </div>
    </div>
    
    <div class="chat-messages" id="chat-messages">
      <div style="text-align: center; padding: 20px; color: #8a8886;">
        Loading messages...
      </div>
    </div>
    
    <div class="chat-input-area">
      <div class="chat-input-container">
        <textarea class="chat-input" id="message-input" placeholder="Type a message..." rows="1"></textarea>
        <button class="send-button" id="send-message-btn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  `;
  
  // Setup message input auto-resize
  const messageInput = document.getElementById('message-input');
  messageInput.addEventListener('input', autoResizeTextarea);
  messageInput.addEventListener('keydown', handleMessageInputKeydown);
}

// Auto-resize textarea
function autoResizeTextarea(e) {
  const textarea = e.target;
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Handle Enter key in message input
function handleMessageInputKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// Load and display chat messages
async function loadChatMessages(chatId) {
  try {
    // Clean up existing message listeners
    if (window.messageListener) {
      window.messageListener();
    }
    
    // Listen for real-time message updates
    window.messageListener = db.collection('chat-messages')
      .where('chatId', '==', chatId)
      .orderBy('timestamp', 'asc')
      .onSnapshot((snapshot) => {
        displayMessages(snapshot.docs);
      });
    
  } catch (error) {
    console.error('Error loading messages:', error);
    document.getElementById('chat-messages').innerHTML = `
      <div style="text-align: center; padding: 20px; color: #d13438;">
        Failed to load messages
      </div>
    `;
  }
}

// Display messages in chat
function displayMessages(messageDocs) {
  const messagesContainer = document.getElementById('chat-messages');
  if (!messagesContainer) return;
  
  if (messageDocs.length === 0) {
    messagesContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #8a8886;">
        <div style="font-size: 24px; margin-bottom: 8px;">👋</div>
        <p>No messages yet. Start the conversation!</p>
      </div>
    `;
    return;
  }
  
  // Group messages by sender and time
  const messageGroups = [];
  let currentGroup = null;
  
  messageDocs.forEach(doc => {
    const data = doc.data();
    const isOwn = data.senderEmail === currentUser.email;
    const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
    
    // Start new group if sender changed or time gap > 5 minutes
    if (!currentGroup || 
        currentGroup.senderEmail !== data.senderEmail ||
        (timestamp - currentGroup.lastTimestamp) > 5 * 60 * 1000) {
      
      currentGroup = {
        senderEmail: data.senderEmail,
        senderName: data.senderName,
        isOwn: isOwn,
        isSystem: data.type === 'system',
        messages: [],
        lastTimestamp: timestamp
      };
      messageGroups.push(currentGroup);
    }
    
    currentGroup.messages.push({
      message: data.message,
      timestamp: timestamp
    });
    currentGroup.lastTimestamp = timestamp;
  });
  
  // Render message groups
  const messagesHTML = messageGroups.map(group => {
    const initials = group.senderName ? group.senderName.substring(0, 2).toUpperCase() : '?';
    const messagesHTML = group.messages.map(msg => 
      `<div class="message-bubble">${msg.message}</div>`
    ).join('');
    
    if (group.isSystem) {
      return `
        <div style="text-align: center; margin: 16px 0; color: #8a8886; font-size: 12px;">
          ${group.messages[0].message}
        </div>
      `;
    }
    
    return `
      <div class="message-group ${group.isOwn ? 'own' : ''}">
        <div class="message-header ${group.isOwn ? 'own' : ''}">
          <div class="message-avatar">${initials}</div>
          <div class="message-sender">${group.senderName}</div>
          <div class="message-time">${formatTimestamp(group.lastTimestamp)}</div>
        </div>
        ${messagesHTML}
      </div>
    `;
  }).join('');
  
  messagesContainer.innerHTML = messagesHTML;
  
  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Send message
async function sendMessage() {
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-message-btn');
  const message = messageInput.value.trim();
  
  if (!message || !currentChat) return;
  
  sendBtn.disabled = true;
  
  try {
    const currentUserName = await getUserDisplayName(currentUser);
    
    // Add message to chat-messages collection
    await db.collection('chat-messages').add({
      chatId: currentChat.id,
      senderEmail: currentUser.email,
      senderName: currentUserName,
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Update chat's last message
    await db.collection('chats').doc(currentChat.id).update({
      lastMessage: message.length > 50 ? message.substring(0, 47) + '...' : message,
      lastMessageSender: currentUserName,
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Clear input
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
  } catch (error) {
    console.error('Error sending message:', error);
    alert('Failed to send message. Please try again.');
  }
  
  sendBtn.disabled = false;
}

// Rename chat prompt
function renameChatPrompt() {
  if (!currentChat) return;
  
  const newName = prompt('Enter new chat name:', currentChat.name);
  if (newName && newName.trim() !== currentChat.name) {
    renameChat(newName.trim());
  }
}

// Rename chat
async function renameChat(newName) {
  try {
    await db.collection('chats').doc(currentChat.id).update({
      name: newName
    });
    
    currentChat.name = newName;
    displayChatInterface();
    
  } catch (error) {
    console.error('Error renaming chat:', error);
    alert('Failed to rename chat. Please try again.');
  }
}

// Show chat info
function showChatInfo() {
  if (!currentChat) return;
  
  const participantNames = currentChat.participants
    .map(email => {
      const user = allUsers.find(u => u.email === email);
      return user ? user.name : email;
    })
    .join(', ');
  
  alert(`Chat: ${currentChat.name}\nParticipants: ${participantNames}\nCreated: ${formatTimestamp(currentChat.createdAt)}`);
}

// Mobile sidebar functions
function openMobileSidebar() {
  document.getElementById('chat-sidebar').classList.add('open');
  document.getElementById('chat-overlay').classList.add('show');
}

function closeMobileSidebar() {
  document.getElementById('chat-sidebar').classList.remove('open');
  document.getElementById('chat-overlay').classList.remove('show');
}

// Filter chats
function filterChats(e) {
  const query = e.target.value.toLowerCase();
  const chatItems = document.querySelectorAll('.chat-item');
  
  chatItems.forEach(item => {
    const name = item.querySelector('.chat-item-name').textContent.toLowerCase();
    const preview = item.querySelector('.chat-item-preview').textContent.toLowerCase();
    
    if (name.includes(query) || preview.includes(query)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

// Get user display name
async function getUserDisplayName(user) {
  try {
    if (!user || !window.db) {
      return extractNameFromEmail(user?.email || '');
    }

    const userRef = window.db.ref(`users/${user.uid}`);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val();

    if (userData && userData.name) {
      return userData.name;
    }

    if (user.displayName) {
      return user.displayName;
    }

    return extractNameFromEmail(user.email || '');
  } catch (error) {
    console.error('Error getting user display name:', error);
    return extractNameFromEmail(user?.email || '');
  }
}

// Extract name from email
function extractNameFromEmail(email) {
  if (!email) return 'User';
  
  const emailName = email.split('@')[0];
  return emailName
    .replace(/[._-]/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// Format timestamp
function formatTimestamp(timestamp) {
  if (!timestamp) return '';
  
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'now';
  if (diffMins < 60) return `${diffMins}m`;
  if (diffHours < 24) return `${diffHours}h`;
  if (diffDays < 7) return `${diffDays}d`;
  
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

</script>

<!-- Site scripts -->
<script src="script.js"></script>
</body>
</html>