<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Data Chat - Castle Fine Art</title>
    <link rel="icon" type="image/png" href="icon.png">


    <style>
        @font-face {
            font-family: 'DIN Light Alternate';
            src: url('DIN LightAlternate.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DIN Light Alternate', 'DIN 2014', 'DIN', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #45494e;
        }

        .header {
            background: linear-gradient(135deg, #45494e 0%, #6a6e73 100%);
            color: #d8d1c5;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            margin: 0 12px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #45494e 0%, #6a6e73 100%);
            color: #d8d1c5;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #0f9d58 0%, #0a7142 100%);
            color: white;
        }

        .message-content {
            background: white;
            padding: 15px 18px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #45494e 0%, #6a6e73 100%);
            color: #d8d1c5;
        }

        .message.assistant .message-content {
            background: #f0f0f0;
            color: #45494e;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        .message.assistant .message-time {
            text-align: left;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: #f8f8f8;
            border-radius: 25px;
            padding: 8px 15px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: #45494e;
            box-shadow: 0 0 0 2px rgba(69, 73, 78, 0.1);
        }

        #messageInput {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            padding: 12px 15px;
            font-size: 16px;
            font-family: inherit;
            color: #45494e;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        #messageInput::placeholder {
            color: #999ea3;
        }

        .send-button {
            background: linear-gradient(135deg, #45494e 0%, #6a6e73 100%);
            color: #d8d1c5;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(69, 73, 78, 0.2);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            font-style: italic;
            color: #999ea3;
            animation: pulse 1.5s infinite;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f5f5f5;
            font-weight: 500;
            color: #45494e;
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .summary-card h4 {
            color: #45494e;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 500;
            color: #45494e;
        }

        .stat-label {
            font-size: 12px;
            color: #6a6e73;
            margin-top: 4px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #6a6e73;
        }

        .welcome-message h3 {
            margin-bottom: 15px;
            color: #45494e;
        }

        .sample-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .sample-question {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sample-question:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎨 Sales Data Chat Assistant</h1>
        <p class="subtitle">Ask questions about your sales data in natural language</p>
    </div>

    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="welcome-message">
                <h3>Welcome to Sales Data Chat!</h3>
                <p>I can help you analyze your sales data. Ask me questions about customers, sales totals, trends, or specific items.</p>
                <div class="sample-questions">
                    <div class="sample-question" onclick="askSampleQuestion(this)">Who spent the most money?</div>
                    <div class="sample-question" onclick="askSampleQuestion(this)">In June who spent over 5k?</div>
                    <div class="sample-question" onclick="askSampleQuestion(this)">Show me customers who spent under 1000</div>
                    <div class="sample-question" onclick="askSampleQuestion(this)">What are total sales for January 2025?</div>
                    <div class="sample-question" onclick="askSampleQuestion(this)">Top 5 customers in February</div>
                    <div class="sample-question" onclick="askSampleQuestion(this)">How much did we sell in June?</div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            Assistant is thinking...
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea id="messageInput" placeholder="Ask me about your sales data..." rows="1"></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let salesData = [];
        let isLoading = false;

        // Load sales data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadFullSalesData();

            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            // Send message on Enter (but not Shift+Enter)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        async function loadFullSalesData() {
            try {
                showStatus('Loading sales data...', 'loading');

                // Try to load from external JS file first
                const script = document.createElement('script');
                script.src = 'sales-data-embedded.js';
                script.onload = function() {
                    if (typeof loadEmbeddedSalesData === 'function') {
                        loadEmbeddedSalesData();
                        hideStatus();
                    } else {
                        fallbackToCSVLoad();
                    }
                };
                script.onerror = function() {
                    fallbackToCSVLoad();
                };
                document.head.appendChild(script);

            } catch (error) {
                console.error('Error loading sales data:', error);
                addMessage('assistant', 'Sorry, I encountered an error loading the sales data.');
                hideStatus();
            }
        }

        async function fallbackToCSVLoad() {
            try {
                // Fallback: try to load CSV directly
                const response = await fetch('Sales Data.csv');
                const csvText = await response.text();

                // Parse CSV data
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));

                salesData = lines.slice(1).filter(line => line.trim()).map(line => {
                    const values = parseCSVLine(line);
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] ? values[index].trim() : '';
                    });
                    return obj;
                }).filter(row => row.CustID); // Filter out empty rows

                // Process data
                salesData = salesData.map(row => ({
                    ...row,
                    SOTotal: parseFloat(row.SOTotal) || 0,
                    SODate: new Date(row.SODate)
                }));

                console.log(`Loaded ${salesData.length} sales records from CSV`);

                const totalSales = salesData.reduce((sum, row) => sum + row.SOTotal, 0);
                const validRecords = salesData.filter(row => row.SOTotal > 0).length;

                setTimeout(() => {
                    addMessage('assistant', `📊 <strong>Sales Data Loaded!</strong><br>
                    • Total Records: ${salesData.length.toLocaleString()}<br>
                    • Valid Sales: ${validRecords.toLocaleString()}<br>
                    • Total Value: £${Math.round(totalSales).toLocaleString()}<br><br>
                    Ask me anything about your sales data!`);
                }, 1000);

                hideStatus();

            } catch (error) {
                console.error('CSV fallback failed:', error);
                // Final fallback - load sample data
                loadSampleData();
            }
        }

        function loadSampleData() {
            addMessage('assistant', '⚠️ <strong>Unable to load full dataset.</strong><br>Loading sample data for demonstration. For full analysis, please ensure the Sales Data.csv file is accessible or run this from a web server.<br><br>Sample includes ~90 records for testing the interface.');

            // Keep the original sample data as final fallback
            const csvData = `CustID,FirstName,LastName,ItemCode,SOTotal,SODate
720042,Andrew & Karen,Tibbenham,BDY-SLE-POR-34651F,2650,01/06/2025
720044,Nasreen,Karim,BDY-SLE-POR-36661F,6450,01/06/2025
657400,Clare,Wilk,CON-SIG-XXX-13701,16000,01/06/2025`;

            const lines = csvData.split('\n');
            const headers = lines[0].split(',');
            salesData = lines.slice(1).filter(line => line.trim()).map(line => {
                const values = parseCSVLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim().replace(/^\uFEFF/, '')] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });

            hideStatus();
        }

        function showStatus(message, type) {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'block';
            }
        }

        function hideStatus() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"' && (i === 0 || line[i-1] === ',')) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes && (i === line.length - 1 || line[i+1] === ',')) {
                    inQuotes = false;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function askSampleQuestion(element) {
            const question = element.textContent;
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || isLoading) return;

            // Clear input and add user message
            messageInput.value = '';
            messageInput.style.height = 'auto';
            addMessage('user', message);

            // Show typing indicator
            showTypingIndicator();

            // Process the query
            setTimeout(() => {
                processQuery(message);
            }, 500);
        }

        function addMessage(sender, content, includeTime = true) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? '👤' : '🤖';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (typeof content === 'string') {
                contentDiv.innerHTML = content;
            } else {
                contentDiv.appendChild(content);
            }

            if (includeTime) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                contentDiv.appendChild(timeDiv);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            // Remove welcome message if it exists
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            isLoading = true;

            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
            isLoading = false;
        }

        function processQuery(query) {
            try {
                const response = analyzeQuery(query.toLowerCase());
                hideTypingIndicator();
                addMessage('assistant', response);
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', 'Sorry, I encountered an error processing your query. Please try rephrasing your question.');
            }
        }

        function analyzeQuery(query) {
            if (salesData.length === 0) {
                return 'Sales data is still loading. Please try again in a moment.';
            }

            // Parse numeric values and dates
            let processedData = salesData.map(row => ({
                ...row,
                SOTotal: parseFloat(row.SOTotal) || 0,
                SODate: new Date(row.SODate)
            })).filter(row => !isNaN(row.SOTotal));

            // Parse the query for filters and constraints
            const queryInfo = parseQuery(query);

            // Apply filters to data
            const filteredData = applyFilters(processedData, queryInfo);

            // Determine what type of response to generate
            return generateResponse(filteredData, queryInfo, query);
        }

        function parseQuery(query) {
            const info = {
                intent: 'general',
                dateFilter: null,
                amountFilter: null,
                customerFilter: null,
                itemFilter: null,
                limit: null,
                sortBy: 'total',
                operation: 'list'
            };

            const lowerQuery = query.toLowerCase();

            // Detect intent
            if (lowerQuery.includes('who') || lowerQuery.includes('which customer')) {
                info.intent = 'customers';
            } else if (lowerQuery.includes('what') || lowerQuery.includes('show me')) {
                info.intent = 'data';
            } else if (lowerQuery.includes('how much') || lowerQuery.includes('total')) {
                info.intent = 'totals';
            } else if (lowerQuery.includes('how many')) {
                info.intent = 'counts';
            }

            // Detect operation type
            if (lowerQuery.includes('spent most') || lowerQuery.includes('highest') || lowerQuery.includes('top')) {
                info.operation = 'top';
            } else if (lowerQuery.includes('spent over') || lowerQuery.includes('more than') || lowerQuery.includes('above')) {
                info.operation = 'above';
            } else if (lowerQuery.includes('spent under') || lowerQuery.includes('less than') || lowerQuery.includes('below')) {
                info.operation = 'below';
            }

            // Extract amounts
            const amountMatches = lowerQuery.match(/(\d+(?:,\d{3})*(?:\.\d{2})?)\s*(?:k|thousand)?/g);
            if (amountMatches) {
                let amount = parseFloat(amountMatches[0].replace(/,/g, ''));
                if (lowerQuery.includes('k') || lowerQuery.includes('thousand')) {
                    amount *= 1000;
                }

                if (lowerQuery.includes('over') || lowerQuery.includes('more than') || lowerQuery.includes('above')) {
                    info.amountFilter = { min: amount };
                } else if (lowerQuery.includes('under') || lowerQuery.includes('less than') || lowerQuery.includes('below')) {
                    info.amountFilter = { max: amount };
                } else {
                    info.amountFilter = { exact: amount };
                }
            }

            // Extract dates/months
            const months = ['january', 'february', 'march', 'april', 'may', 'june',
                          'july', 'august', 'september', 'october', 'november', 'december',
                          'jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

            for (let i = 0; i < months.length; i++) {
                if (lowerQuery.includes(months[i])) {
                    const monthIndex = i >= 12 ? i - 12 : i; // Handle short forms
                    info.dateFilter = { month: monthIndex };
                    break;
                }
            }

            // Extract year
            const yearMatch = lowerQuery.match(/\b(20\d{2})\b/);
            if (yearMatch) {
                if (!info.dateFilter) info.dateFilter = {};
                info.dateFilter.year = parseInt(yearMatch[1]);
            }

            // Extract limits
            const limitMatch = lowerQuery.match(/\b(top|first)\s+(\d+)\b/);
            if (limitMatch) {
                info.limit = parseInt(limitMatch[2]);
            }

            // Extract customer names
            const customerMatch = lowerQuery.match(/customer\s+([a-zA-Z\s]+?)(?:\s|$|who|what|spent)/);
            if (customerMatch) {
                info.customerFilter = customerMatch[1].trim();
            }

            return info;
        }

        function applyFilters(data, queryInfo) {
            let filtered = [...data];

            // Apply date filter
            if (queryInfo.dateFilter) {
                filtered = filtered.filter(row => {
                    const date = row.SODate;
                    if (queryInfo.dateFilter.month !== undefined && date.getMonth() !== queryInfo.dateFilter.month) {
                        return false;
                    }
                    if (queryInfo.dateFilter.year !== undefined && date.getFullYear() !== queryInfo.dateFilter.year) {
                        return false;
                    }
                    return true;
                });
            }

            // Apply amount filter
            if (queryInfo.amountFilter) {
                filtered = filtered.filter(row => {
                    if (queryInfo.amountFilter.min !== undefined && row.SOTotal <= queryInfo.amountFilter.min) {
                        return false;
                    }
                    if (queryInfo.amountFilter.max !== undefined && row.SOTotal >= queryInfo.amountFilter.max) {
                        return false;
                    }
                    if (queryInfo.amountFilter.exact !== undefined && row.SOTotal !== queryInfo.amountFilter.exact) {
                        return false;
                    }
                    return true;
                });
            }

            // Apply customer filter
            if (queryInfo.customerFilter) {
                filtered = filtered.filter(row => {
                    const customerName = `${row.FirstName} ${row.LastName}`.toLowerCase();
                    return customerName.includes(queryInfo.customerFilter.toLowerCase());
                });
            }

            return filtered;
        }

        function generateResponse(data, queryInfo, originalQuery) {
            if (data.length === 0) {
                return `No data found matching your criteria. ${getFilterSummary(queryInfo)}`;
            }

            switch (queryInfo.intent) {
                case 'customers':
                    return getCustomerAnalysis(data, queryInfo, originalQuery);
                case 'totals':
                    return getTotalAnalysis(data, queryInfo, originalQuery);
                case 'counts':
                    return getCountAnalysis(data, queryInfo, originalQuery);
                default:
                    return getFilteredDataSummary(data, queryInfo, originalQuery);
            }
        }

        function getCustomerAnalysis(data, queryInfo, originalQuery) {
            // Group by customer
            const customerTotals = {};
            data.forEach(row => {
                const customerName = `${row.FirstName} ${row.LastName}`.trim();
                if (!customerTotals[customerName]) {
                    customerTotals[customerName] = { total: 0, count: 0, custId: row.CustID, purchases: [] };
                }
                customerTotals[customerName].total += row.SOTotal;
                customerTotals[customerName].count += 1;
                customerTotals[customerName].purchases.push(row);
            });

            // Sort and limit
            const customers = Object.entries(customerTotals)
                .sort(([,a], [,b]) => b.total - a.total);

            const limit = queryInfo.limit || (queryInfo.operation === 'above' || queryInfo.operation === 'below' ? 20 : 10);
            const topCustomers = customers.slice(0, limit);

            let response = `<h4>${getResponseTitle(queryInfo, originalQuery)}</h4>`;
            response += getFilterSummary(queryInfo);

            const totalValue = topCustomers.reduce((sum, [, data]) => sum + data.total, 0);
            const totalOrders = topCustomers.reduce((sum, [, data]) => sum + data.count, 0);

            response += `<div class="summary-card">`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">${topCustomers.length}</div><div class="stat-label">Customers Found</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">£${totalValue.toLocaleString()}</div><div class="stat-label">Total Value</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${totalOrders}</div><div class="stat-label">Total Orders</div></div>`;
            if (totalOrders > 0) {
                response += `<div class="stat-item"><div class="stat-value">£${Math.round(totalValue/totalOrders).toLocaleString()}</div><div class="stat-label">Avg Order</div></div>`;
            }
            response += `</div></div>`;

            response += `<table class="data-table">`;
            response += `<thead><tr><th>Rank</th><th>Customer</th><th>Customer ID</th><th>Total Spent</th><th>Orders</th><th>Avg Order</th></tr></thead>`;
            response += `<tbody>`;

            topCustomers.forEach(([name, data], index) => {
                const avgOrder = Math.round(data.total / data.count);
                response += `<tr>`;
                response += `<td>${index + 1}</td>`;
                response += `<td><strong>${name}</strong></td>`;
                response += `<td>${data.custId}</td>`;
                response += `<td>£${data.total.toLocaleString()}</td>`;
                response += `<td>${data.count}</td>`;
                response += `<td>£${avgOrder.toLocaleString()}</td>`;
                response += `</tr>`;
            });

            response += `</tbody></table>`;
            return response;
        }

        function getTotalAnalysis(data, queryInfo, originalQuery) {
            const totalSales = data.reduce((sum, row) => sum + row.SOTotal, 0);
            const totalOrders = data.length;
            const uniqueCustomers = new Set(data.map(row => `${row.FirstName} ${row.LastName}`)).size;

            let response = `<h4>${getResponseTitle(queryInfo, originalQuery)}</h4>`;
            response += getFilterSummary(queryInfo);
            response += `<div class="summary-card">`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">£${totalSales.toLocaleString()}</div><div class="stat-label">Total Sales</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${totalOrders}</div><div class="stat-label">Total Orders</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${uniqueCustomers}</div><div class="stat-label">Customers</div></div>`;
            if (totalOrders > 0) {
                response += `<div class="stat-item"><div class="stat-value">£${Math.round(totalSales/totalOrders).toLocaleString()}</div><div class="stat-label">Avg Order</div></div>`;
            }
            response += `</div></div>`;

            return response;
        }

        function getCountAnalysis(data, queryInfo, originalQuery) {
            return getCustomerAnalysis(data, {...queryInfo, intent: 'customers'}, originalQuery);
        }

        function getFilteredDataSummary(data, queryInfo, originalQuery) {
            // Default to customer analysis for most queries
            return getCustomerAnalysis(data, queryInfo, originalQuery);
        }

        function getResponseTitle(queryInfo, originalQuery) {
            if (originalQuery.toLowerCase().includes('who spent most') || originalQuery.toLowerCase().includes('top')) {
                return '🏆 Top Spending Customers';
            } else if (queryInfo.amountFilter?.min) {
                return `💰 Customers Who Spent Over £${queryInfo.amountFilter.min.toLocaleString()}`;
            } else if (queryInfo.amountFilter?.max) {
                return `💰 Customers Who Spent Under £${queryInfo.amountFilter.max.toLocaleString()}`;
            } else if (queryInfo.dateFilter) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                 'July', 'August', 'September', 'October', 'November', 'December'];
                const month = queryInfo.dateFilter.month !== undefined ? monthNames[queryInfo.dateFilter.month] : '';
                const year = queryInfo.dateFilter.year || '';
                return `📅 Sales Data - ${month} ${year}`.trim();
            }
            return '📊 Sales Analysis Results';
        }

        function getFilterSummary(queryInfo) {
            let filters = [];

            if (queryInfo.dateFilter) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                 'July', 'August', 'September', 'October', 'November', 'December'];
                if (queryInfo.dateFilter.month !== undefined) {
                    filters.push(`Month: ${monthNames[queryInfo.dateFilter.month]}`);
                }
                if (queryInfo.dateFilter.year) {
                    filters.push(`Year: ${queryInfo.dateFilter.year}`);
                }
            }

            if (queryInfo.amountFilter) {
                if (queryInfo.amountFilter.min) {
                    filters.push(`Amount: Over £${queryInfo.amountFilter.min.toLocaleString()}`);
                }
                if (queryInfo.amountFilter.max) {
                    filters.push(`Amount: Under £${queryInfo.amountFilter.max.toLocaleString()}`);
                }
            }

            if (filters.length > 0) {
                return `<div class="summary-card"><p><strong>Applied Filters:</strong> ${filters.join(', ')}</p></div>`;
            }
            return '';
        }

        function getTopCustomers(data, query) {
            const limit = extractNumber(query) || 10;

            // Group by customer
            const customerTotals = {};
            data.forEach(row => {
                const customerName = `${row.FirstName} ${row.LastName}`.trim();
                if (!customerTotals[customerName]) {
                    customerTotals[customerName] = { total: 0, count: 0, custId: row.CustID };
                }
                customerTotals[customerName].total += row.SOTotal;
                customerTotals[customerName].count += 1;
            });

            // Sort by total and take top N
            const topCustomers = Object.entries(customerTotals)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, limit);

            let response = `<h4>Top ${limit} Customers by Sales Value</h4>`;

            // Create summary stats
            const totalValue = topCustomers.reduce((sum, [, data]) => sum + data.total, 0);
            const totalOrders = topCustomers.reduce((sum, [, data]) => sum + data.count, 0);

            response += `<div class="summary-card">`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">£${totalValue.toLocaleString()}</div><div class="stat-label">Total Value</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${totalOrders}</div><div class="stat-label">Total Orders</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">£${Math.round(totalValue/totalOrders).toLocaleString()}</div><div class="stat-label">Avg Order</div></div>`;
            response += `</div></div>`;

            // Create table
            response += `<table class="data-table">`;
            response += `<thead><tr><th>Rank</th><th>Customer</th><th>Customer ID</th><th>Total Sales</th><th>Orders</th><th>Avg Order</th></tr></thead>`;
            response += `<tbody>`;

            topCustomers.forEach(([name, data], index) => {
                const avgOrder = Math.round(data.total / data.count);
                response += `<tr>`;
                response += `<td>${index + 1}</td>`;
                response += `<td><strong>${name}</strong></td>`;
                response += `<td>${data.custId}</td>`;
                response += `<td>£${data.total.toLocaleString()}</td>`;
                response += `<td>${data.count}</td>`;
                response += `<td>£${avgOrder.toLocaleString()}</td>`;
                response += `</tr>`;
            });

            response += `</tbody></table>`;
            return response;
        }

        function getTotalSales(data, query) {
            let filteredData = data;
            let period = 'All Time';

            // Filter by period if mentioned
            if (query.includes('january') || query.includes('jan')) {
                filteredData = data.filter(row => row.SODate.getMonth() === 0);
                period = 'January 2025';
            }

            const totalSales = filteredData.reduce((sum, row) => sum + row.SOTotal, 0);
            const totalOrders = filteredData.length;
            const avgOrder = totalOrders > 0 ? totalSales / totalOrders : 0;
            const uniqueCustomers = new Set(filteredData.map(row => `${row.FirstName} ${row.LastName}`)).size;

            let response = `<h4>Sales Summary - ${period}</h4>`;
            response += `<div class="summary-card">`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">£${totalSales.toLocaleString()}</div><div class="stat-label">Total Sales</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${totalOrders}</div><div class="stat-label">Total Orders</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">£${Math.round(avgOrder).toLocaleString()}</div><div class="stat-label">Avg Order</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${uniqueCustomers}</div><div class="stat-label">Customers</div></div>`;
            response += `</div></div>`;

            return response;
        }

        function getMostExpensive(data) {
            const maxSale = Math.max(...data.map(row => row.SOTotal));
            const expensiveItems = data.filter(row => row.SOTotal === maxSale);

            let response = `<h4>Most Expensive Items (£${maxSale.toLocaleString()})</h4>`;
            response += `<table class="data-table">`;
            response += `<thead><tr><th>Customer</th><th>Item Code</th><th>Amount</th><th>Date</th></tr></thead>`;
            response += `<tbody>`;

            expensiveItems.forEach(row => {
                const customerName = `${row.FirstName} ${row.LastName}`.trim();
                response += `<tr>`;
                response += `<td><strong>${customerName}</strong></td>`;
                response += `<td>${row.ItemCode}</td>`;
                response += `<td>£${row.SOTotal.toLocaleString()}</td>`;
                response += `<td>${row.SODate.toLocaleDateString()}</td>`;
                response += `</tr>`;
            });

            response += `</tbody></table>`;
            return response;
        }

        function getSalesByItemCode(data) {
            // Group by item code
            const itemTotals = {};
            data.forEach(row => {
                if (!itemTotals[row.ItemCode]) {
                    itemTotals[row.ItemCode] = { total: 0, count: 0 };
                }
                itemTotals[row.ItemCode].total += row.SOTotal;
                itemTotals[row.ItemCode].count += 1;
            });

            // Sort by total and take top 15
            const topItems = Object.entries(itemTotals)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, 15);

            let response = `<h4>Top 15 Items by Sales Value</h4>`;

            const totalValue = topItems.reduce((sum, [, data]) => sum + data.total, 0);
            response += `<div class="summary-card">`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">${topItems.length}</div><div class="stat-label">Item Codes</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">£${totalValue.toLocaleString()}</div><div class="stat-label">Total Value</div></div>`;
            response += `</div></div>`;

            response += `<table class="data-table">`;
            response += `<thead><tr><th>Rank</th><th>Item Code</th><th>Total Sales</th><th>Qty Sold</th><th>Avg Price</th></tr></thead>`;
            response += `<tbody>`;

            topItems.forEach(([itemCode, data], index) => {
                const avgPrice = Math.round(data.total / data.count);
                response += `<tr>`;
                response += `<td>${index + 1}</td>`;
                response += `<td><strong>${itemCode}</strong></td>`;
                response += `<td>£${data.total.toLocaleString()}</td>`;
                response += `<td>${data.count}</td>`;
                response += `<td>£${avgPrice.toLocaleString()}</td>`;
                response += `</tr>`;
            });

            response += `</tbody></table>`;
            return response;
        }

        function getSalesForPeriod(data, query) {
            let filteredData = data;
            let period = 'All Time';

            if (query.includes('january') || query.includes('jan')) {
                filteredData = data.filter(row => row.SODate.getMonth() === 0);
                period = 'January 2025';
            }

            return getTotalSales(filteredData, period);
        }

        function getGeneralStats(data) {
            const totalSales = data.reduce((sum, row) => sum + row.SOTotal, 0);
            const totalOrders = data.length;
            const uniqueCustomers = new Set(data.map(row => `${row.FirstName} ${row.LastName}`)).size;
            const uniqueItems = new Set(data.map(row => row.ItemCode)).size;
            const avgOrder = totalOrders > 0 ? totalSales / totalOrders : 0;

            let response = `<h4>Sales Data Overview</h4>`;
            response += `<div class="summary-card">`;
            response += `<p>Here's a summary of your sales data. Ask me specific questions like:</p>`;
            response += `<ul style="margin: 10px 0; padding-left: 20px;">`;
            response += `<li>"Show me top 10 customers"</li>`;
            response += `<li>"What are total sales for January?"</li>`;
            response += `<li>"Which items sell the most?"</li>`;
            response += `</ul>`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">£${totalSales.toLocaleString()}</div><div class="stat-label">Total Sales</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${totalOrders}</div><div class="stat-label">Total Orders</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${uniqueCustomers}</div><div class="stat-label">Customers</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${uniqueItems}</div><div class="stat-label">Unique Items</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">£${Math.round(avgOrder).toLocaleString()}</div><div class="stat-label">Avg Order</div></div>`;
            response += `</div></div>`;

            return response;
        }

        function getTopSpender(data, query) {
            // Group by customer and calculate totals
            const customerTotals = {};
            data.forEach(row => {
                const customerName = `${row.FirstName} ${row.LastName}`.trim();
                if (!customerTotals[customerName]) {
                    customerTotals[customerName] = { total: 0, count: 0, custId: row.CustID };
                }
                customerTotals[customerName].total += row.SOTotal;
                customerTotals[customerName].count += 1;
            });

            // Find the top spender
            const topSpender = Object.entries(customerTotals)
                .sort(([,a], [,b]) => b.total - a.total)[0];

            if (!topSpender) {
                return 'No customer data found.';
            }

            const [name, customerData] = topSpender;

            let response = `<h4>🏆 Top Spending Customer</h4>`;
            response += `<div class="summary-card">`;
            response += `<p><strong>${name}</strong> is your highest spending customer.</p>`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">£${customerData.total.toLocaleString()}</div><div class="stat-label">Total Spent</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${customerData.count}</div><div class="stat-label">Items Purchased</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">£${Math.round(customerData.total/customerData.count).toLocaleString()}</div><div class="stat-label">Avg per Item</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${customerData.custId}</div><div class="stat-label">Customer ID</div></div>`;
            response += `</div></div>`;

            // Show their recent purchases
            const customerPurchases = data.filter(row =>
                `${row.FirstName} ${row.LastName}`.trim() === name
            ).sort((a, b) => b.SOTotal - a.SOTotal).slice(0, 10);

            if (customerPurchases.length > 0) {
                response += `<h4>Recent Purchases by ${name}</h4>`;
                response += `<table class="data-table">`;
                response += `<thead><tr><th>Item Code</th><th>Amount</th><th>Date</th></tr></thead>`;
                response += `<tbody>`;

                customerPurchases.forEach(purchase => {
                    response += `<tr>`;
                    response += `<td>${purchase.ItemCode}</td>`;
                    response += `<td>£${purchase.SOTotal.toLocaleString()}</td>`;
                    response += `<td>${purchase.SODate.toLocaleDateString()}</td>`;
                    response += `</tr>`;
                });

                response += `</tbody></table>`;
            }

            return response;
        }

        function getCustomerPurchaseCounts(data, query) {
            // Group by customer
            const customerTotals = {};
            data.forEach(row => {
                const customerName = `${row.FirstName} ${row.LastName}`.trim();
                if (!customerTotals[customerName]) {
                    customerTotals[customerName] = { total: 0, count: 0, custId: row.CustID };
                }
                customerTotals[customerName].total += row.SOTotal;
                customerTotals[customerName].count += 1;
            });

            // Sort by number of purchases
            const topBuyers = Object.entries(customerTotals)
                .sort(([,a], [,b]) => b.count - a.count)
                .slice(0, 15);

            let response = `<h4>Top Customers by Number of Purchases</h4>`;

            const totalPurchases = topBuyers.reduce((sum, [, data]) => sum + data.count, 0);
            response += `<div class="summary-card">`;
            response += `<div class="summary-stats">`;
            response += `<div class="stat-item"><div class="stat-value">${totalPurchases}</div><div class="stat-label">Total Purchases</div></div>`;
            response += `<div class="stat-item"><div class="stat-value">${topBuyers[0][1].count}</div><div class="stat-label">Most by One Customer</div></div>`;
            response += `</div></div>`;

            response += `<table class="data-table">`;
            response += `<thead><tr><th>Rank</th><th>Customer</th><th>Items Bought</th><th>Total Spent</th><th>Avg per Item</th></tr></thead>`;
            response += `<tbody>`;

            topBuyers.forEach(([name, data], index) => {
                const avgPerItem = Math.round(data.total / data.count);
                response += `<tr>`;
                response += `<td>${index + 1}</td>`;
                response += `<td><strong>${name}</strong></td>`;
                response += `<td>${data.count}</td>`;
                response += `<td>£${data.total.toLocaleString()}</td>`;
                response += `<td>£${avgPerItem.toLocaleString()}</td>`;
                response += `</tr>`;
            });

            response += `</tbody></table>`;
            return response;
        }

        function extractNumber(text) {
            const match = text.match(/\b(\d+)\b/);
            return match ? parseInt(match[1]) : null;
        }
    </script>
</body>
</html>