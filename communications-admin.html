<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Communications Admin - Castle Comms</title>
  
  <!-- Security Headers -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <link rel="stylesheet" href="style.css?v=20250731" />
  <!-- Rich Text Editor -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      backdrop-filter: blur(10px);
      min-height: 80vh;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .admin-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 600;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e1e5e9;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      color: #6c757d;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-button:hover {
      color: #5a67d8;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      margin-bottom: 2rem;
    }

    .form-section h3 {
      margin: 0 0 1.5rem 0;
      color: #2c3e50;
      font-size: 1.3rem;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.95rem;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      transition: all 0.3s;
      box-sizing: border-box;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .rich-editor {
      height: 300px;
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
    }

    .documents-manager {
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      background: #f8f9fa;
    }

    .document-list {
      margin-top: 1rem;
    }

    .document-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .document-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-document-button, .add-powerbi-button, .add-task-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-document-button:hover, .add-powerbi-button:hover, .add-task-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .remove-button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .remove-button:hover {
      background: #c82333;
    }

    .powerbi-manager {
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      background: #f8f9fa;
    }

    .powerbi-item {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .powerbi-item h4 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
    }

    .powerbi-preview {
      width: 100%;
      height: 200px;
      border: 1px solid #e1e5e9;
      border-radius: 4px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      margin-top: 0.5rem;
    }

    .tasks-manager {
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      background: #f8f9fa;
    }

    .task-item {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .task-item h4 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #f0f0f0;
    }

    .save-draft-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .save-draft-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .publish-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--shadow-light);
    }

    .publish-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .preview-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .preview-button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .communications-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .communication-summary {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      transition: all 0.3s;
    }

    .communication-summary:hover {
      box-shadow: var(--shadow-light);
      transform: translateY(-1px);
    }

    .communication-summary h3 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .communication-summary .meta {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .communication-summary .actions {
      display: flex;
      gap: 0.5rem;
    }

    .edit-button, .delete-button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .edit-button {
      background: #ffc107;
      color: #212529;
    }

    .edit-button:hover {
      background: #e0a800;
    }

    .delete-button {
      background: #dc3545;
      color: white;
    }

    .delete-button:hover {
      background: #c82333;
    }

    .status-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-badge.draft {
      background: #f8f9fa;
      color: #6c757d;
      border: 1px solid #e1e5e9;
    }

    .status-badge.published {
      background: #d4edda;
      color: #155724;
    }

    .error, .success {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
      .admin-container {
        margin: 1rem;
        padding: 1rem;
      }
      
      .admin-header h1 {
        font-size: 2rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .admin-tabs {
        flex-wrap: wrap;
      }

      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

<!-- Background Slideshow -->
<div class="background-slideshow" id="background-slideshow">
  <!-- Images will be injected by JavaScript -->
</div>
  
<header>
  <button id="menu-toggle" class="hamburger">&#9776;</button>
  <h1>Castle Comms</h1>
</header>

<div id="notification-bell" class="notification-bell hidden">
  🔔 <span id="notification-count" class="count-badge">0</span>
</div>

<div id="sidebar-container"></div>

<main id="main">
  <div class="admin-container">
    <div class="admin-header">
      <h1>📢 Communications Admin</h1>
    </div>
    
    <div class="admin-tabs">
      <button class="tab-button active" data-tab="create">Create Communication</button>
      <button class="tab-button" data-tab="manage">Manage Communications</button>
      <button class="tab-button" data-tab="analytics">Analytics</button>
    </div>
    
    <!-- Create Communication Tab -->
    <div class="tab-content active" id="create-tab">
      <form id="communication-form">
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="comm-title">Title *</label>
              <input type="text" id="comm-title" class="form-input" required maxlength="100">
            </div>
            <div class="form-group">
              <label for="comm-priority">Priority</label>
              <select id="comm-priority" class="form-select">
                <option value="normal">Normal</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label for="comm-summary">Summary</label>
              <textarea id="comm-summary" class="form-textarea" placeholder="Brief summary for the communications feed..." maxlength="300"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Content</h3>
          <div class="form-group">
            <label>Content *</label>
            <div id="rich-editor" class="rich-editor"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>📎 Documents (OneDrive)</h3>
          <div class="documents-manager">
            <p>Add documents from OneDrive that users can download</p>
            <button type="button" class="add-document-button" onclick="addDocument()">
              ➕ Add Document
            </button>
            <div id="documents-list" class="document-list"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>📊 PowerBI Integration</h3>
          <div class="powerbi-manager">
            <p>Add PowerBI reports or dashboards to embed or link</p>
            <button type="button" class="add-powerbi-button" onclick="addPowerBI()">
              ➕ Add PowerBI Content
            </button>
            <div id="powerbi-list"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>✓ Tasks</h3>
          <div class="tasks-manager">
            <p>Add tasks that users need to complete after reading this communication</p>
            <button type="button" class="add-task-button" onclick="addTask()">
              ➕ Add Task
            </button>
            <div id="tasks-list"></div>
          </div>
        </div>

        <div class="action-buttons">
          <button type="button" class="save-draft-button" onclick="saveDraft()">💾 Save Draft</button>
          <button type="button" class="preview-button" onclick="previewCommunication()">👁️ Preview</button>
          <button type="button" class="publish-button" onclick="publishCommunication()">🚀 Publish</button>
        </div>
      </form>
    </div>
    
    <!-- Manage Communications Tab -->
    <div class="tab-content" id="manage-tab">
      <div class="form-section">
        <h3>All Communications</h3>
        <div id="communications-list" class="communications-list">
          <div class="loading">Loading communications...</div>
        </div>
      </div>
    </div>
    
    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics-tab">
      <div class="form-section">
        <h3>📊 Communications Analytics</h3>
        <p>Analytics dashboard coming soon...</p>
        <div id="analytics-content">
          <div style="text-align: center; padding: 3rem; color: #6c757d;">
            📈 Analytics features will include:<br><br>
            • Read rates per communication<br>
            • Task completion statistics<br>
            • Document download tracking<br>
            • User engagement metrics<br>
            • PowerBI interaction data
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<!-- Integration utilities -->
<script src="onedrive-integration.js"></script>
<script src="powerbi-integration.js"></script>

<!-- Communications Admin Logic -->
<script>
let db;
let currentUser;
let quill;
let documents = [];
let powerbiItems = [];
let tasks = [];
let editingCommunicationId = null;

document.addEventListener('DOMContentLoaded', function() {
  // Check authentication first
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.log('User not authenticated, redirecting to login');
      window.location.href = 'index.html';
      return;
    }

    currentUser = user;
    
    // Check if user is admin (you may want to add this check)
    // For now, we'll assume access control is handled elsewhere
    
    // Initialize Firebase Firestore
    if (firebase.apps.length > 0) {
      db = firebase.firestore();
      initializeEditor();
      setupTabs();
      loadCommunications();
    } else {
      console.error('Firebase not initialized');
    }
  });
});

// Initialize rich text editor
function initializeEditor() {
  quill = new Quill('#rich-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'align': [] }],
        ['link', 'image'],
        ['clean']
      ]
    }
  });
}

// Setup tab functionality
function setupTabs() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.dataset.tab;
      
      // Update active tab button
      tabButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      // Update active tab content
      tabContents.forEach(content => content.classList.remove('active'));
      document.getElementById(`${targetTab}-tab`).classList.add('active');
      
      // Load data for specific tabs
      if (targetTab === 'manage') {
        loadCommunications();
      }
    });
  });
}

// Add document
function addDocument() {
  const name = prompt('Enter document name:');
  if (!name) return;
  
  const url = prompt('Enter OneDrive share URL:');
  if (!url) return;
  
  const document = {
    id: Date.now().toString(),
    name: name,
    url: url
  };
  
  documents.push(document);
  updateDocumentsList();
}

// Update documents list display
function updateDocumentsList() {
  const container = document.getElementById('documents-list');
  
  if (documents.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = documents.map(doc => `
    <div class="document-item">
      <div class="document-info">
        <span>📄</span>
        <span>${doc.name}</span>
      </div>
      <button type="button" class="remove-button" onclick="removeDocument('${doc.id}')">
        Remove
      </button>
    </div>
  `).join('');
}

// Remove document
function removeDocument(docId) {
  documents = documents.filter(doc => doc.id !== docId);
  updateDocumentsList();
}

// Add PowerBI content
function addPowerBI() {
  const name = prompt('Enter PowerBI content name:');
  if (!name) return;
  
  const type = confirm('Click OK for Embedded PowerBI, Cancel for Link only') ? 'embed' : 'link';
  
  let url;
  if (type === 'embed') {
    url = prompt('Enter PowerBI embed URL:');
  } else {
    url = prompt('Enter PowerBI share URL:');
  }
  
  if (!url) return;
  
  const powerbi = {
    id: Date.now().toString(),
    name: name,
    type: type,
    url: url
  };
  
  powerbiItems.push(powerbi);
  updatePowerBIList();
}

// Update PowerBI list display
function updatePowerBIList() {
  const container = document.getElementById('powerbi-list');
  
  if (powerbiItems.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = powerbiItems.map(item => `
    <div class="powerbi-item">
      <h4>${item.name}</h4>
      <p><strong>Type:</strong> ${item.type === 'embed' ? 'Embedded' : 'Link'}</p>
      <p><strong>URL:</strong> ${item.url}</p>
      <div class="powerbi-preview">
        ${item.type === 'embed' ? '📊 PowerBI Report Preview' : '🔗 PowerBI Link'}
      </div>
      <button type="button" class="remove-button" onclick="removePowerBI('${item.id}')">
        Remove
      </button>
    </div>
  `).join('');
}

// Remove PowerBI content
function removePowerBI(itemId) {
  powerbiItems = powerbiItems.filter(item => item.id !== itemId);
  updatePowerBIList();
}

// Add task
function addTask() {
  const text = prompt('Enter task description:');
  if (!text) return;
  
  const dueDate = prompt('Enter due date (YYYY-MM-DD) or leave empty:');
  
  const task = {
    id: Date.now().toString(),
    text: text,
    dueDate: dueDate || null
  };
  
  tasks.push(task);
  updateTasksList();
}

// Update tasks list display
function updateTasksList() {
  const container = document.getElementById('tasks-list');
  
  if (tasks.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = tasks.map(task => `
    <div class="task-item">
      <h4>Task</h4>
      <p><strong>Description:</strong> ${task.text}</p>
      ${task.dueDate ? `<p><strong>Due Date:</strong> ${task.dueDate}</p>` : ''}
      <button type="button" class="remove-button" onclick="removeTask('${task.id}')">
        Remove
      </button>
    </div>
  `).join('');
}

// Remove task
function removeTask(taskId) {
  tasks = tasks.filter(task => task.id !== taskId);
  updateTasksList();
}

// Save as draft
async function saveDraft() {
  await saveCommunication('draft');
}

// Publish communication
async function publishCommunication() {
  await saveCommunication('published');
}

// Save communication
async function saveCommunication(status) {
  const title = document.getElementById('comm-title').value.trim();
  const summary = document.getElementById('comm-summary').value.trim();
  const priority = document.getElementById('comm-priority').value;
  const content = quill.root.innerHTML;
  
  if (!title || !content) {
    alert('Please fill in the title and content.');
    return;
  }
  
  try {
    const communicationData = {
      title: title,
      summary: summary || content.replace(/<[^>]*>/g, '').substring(0, 200),
      content: content,
      urgent: priority === 'urgent',
      status: status,
      documents: documents.map(doc => ({
        name: doc.name,
        url: doc.url
      })),
      powerbi: powerbiItems.map(item => ({
        name: item.name,
        type: item.type,
        [item.type === 'embed' ? 'embedUrl' : 'linkUrl']: item.url
      })),
      tasks: tasks.map(task => ({
        text: task.text,
        dueDate: task.dueDate
      })),
      createdBy: {
        uid: currentUser.uid,
        email: currentUser.email,
        name: await getUserDisplayName(currentUser)
      },
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    let docRef;
    if (editingCommunicationId) {
      // Update existing communication
      docRef = db.collection('communications').doc(editingCommunicationId);
      await docRef.update(communicationData);
    } else {
      // Create new communication
      docRef = await db.collection('communications').add(communicationData);
    }
    
    showStatus(`Communication ${status} successfully!`, 'success');
    
    // Reset form if published
    if (status === 'published') {
      resetForm();
    }
    
    // Reload communications list
    loadCommunications();
    
  } catch (error) {
    console.error('Error saving communication:', error);
    showStatus('Failed to save communication. Please try again.', 'error');
  }
}

// Preview communication
function previewCommunication() {
  const title = document.getElementById('comm-title').value.trim();
  const content = quill.root.innerHTML;
  
  if (!title || !content) {
    alert('Please fill in the title and content to preview.');
    return;
  }
  
  // Open preview in new window
  const previewWindow = window.open('', '_blank', 'width=800,height=600');
  previewWindow.document.write(`
    <html>
      <head>
        <title>Preview: ${title}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 2rem; }
          h1 { color: #2c3e50; }
          .content { line-height: 1.6; }
        </style>
      </head>
      <body>
        <h1>${title}</h1>
        <div class="content">${content}</div>
      </body>
    </html>
  `);
}

// Load communications for management
async function loadCommunications() {
  const container = document.getElementById('communications-list');
  
  try {
    const communications = await db.collection('communications')
      .orderBy('createdAt', 'desc')
      .get();
    
    if (communications.empty) {
      container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No communications created yet.</div>';
      return;
    }
    
    const items = communications.docs.map(doc => {
      const data = doc.data();
      return `
        <div class="communication-summary">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <h3>${data.title}</h3>
            <span class="status-badge ${data.status}">${data.status}</span>
          </div>
          <div class="meta">
            Created: ${data.createdAt?.toDate?.()?.toLocaleDateString() || 'Just now'} | 
            Priority: ${data.urgent ? 'Urgent' : 'Normal'}
          </div>
          <p>${data.summary || data.content.replace(/<[^>]*>/g, '').substring(0, 150)}...</p>
          <div class="actions">
            <button class="edit-button" onclick="editCommunication('${doc.id}')">
              ✏️ Edit
            </button>
            <button class="delete-button" onclick="deleteCommunication('${doc.id}')">
              🗑️ Delete
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = items;
    
  } catch (error) {
    console.error('Error loading communications:', error);
    container.innerHTML = '<div class="error">Failed to load communications.</div>';
  }
}

// Edit communication
async function editCommunication(commId) {
  try {
    const doc = await db.collection('communications').doc(commId).get();
    if (!doc.exists) {
      alert('Communication not found.');
      return;
    }
    
    const data = doc.data();
    editingCommunicationId = commId;
    
    // Switch to create tab
    document.querySelector('.tab-button[data-tab="create"]').click();
    
    // Populate form
    document.getElementById('comm-title').value = data.title;
    document.getElementById('comm-summary').value = data.summary || '';
    document.getElementById('comm-priority').value = data.urgent ? 'urgent' : 'normal';
    quill.root.innerHTML = data.content;
    
    // Populate documents
    documents = (data.documents || []).map((doc, index) => ({
      id: index.toString(),
      name: doc.name,
      url: doc.url
    }));
    updateDocumentsList();
    
    // Populate PowerBI items
    powerbiItems = (data.powerbi || []).map((item, index) => ({
      id: index.toString(),
      name: item.name,
      type: item.embedUrl ? 'embed' : 'link',
      url: item.embedUrl || item.linkUrl
    }));
    updatePowerBIList();
    
    // Populate tasks
    tasks = (data.tasks || []).map((task, index) => ({
      id: index.toString(),
      text: task.text,
      dueDate: task.dueDate
    }));
    updateTasksList();
    
  } catch (error) {
    console.error('Error loading communication:', error);
    alert('Failed to load communication for editing.');
  }
}

// Delete communication
async function deleteCommunication(commId) {
  if (!confirm('Are you sure you want to delete this communication?')) {
    return;
  }
  
  try {
    await db.collection('communications').doc(commId).delete();
    showStatus('Communication deleted successfully!', 'success');
    loadCommunications();
  } catch (error) {
    console.error('Error deleting communication:', error);
    showStatus('Failed to delete communication.', 'error');
  }
}

// Reset form
function resetForm() {
  document.getElementById('comm-title').value = '';
  document.getElementById('comm-summary').value = '';
  document.getElementById('comm-priority').value = 'normal';
  quill.root.innerHTML = '';
  documents = [];
  powerbiItems = [];
  tasks = [];
  editingCommunicationId = null;
  updateDocumentsList();
  updatePowerBIList();
  updateTasksList();
}

// Show status message
function showStatus(message, type) {
  const statusDiv = document.createElement('div');
  statusDiv.className = type;
  statusDiv.textContent = message;
  
  const container = document.querySelector('.admin-container');
  container.insertBefore(statusDiv, container.firstChild);
  
  setTimeout(() => {
    statusDiv.remove();
  }, 5000);
}

// Get user display name
async function getUserDisplayName(user) {
  try {
    if (!user || !window.db) {
      return extractNameFromEmail(user?.email || '');
    }

    const userRef = window.db.ref(`users/${user.uid}`);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val();

    if (userData && userData.name) {
      return userData.name;
    }

    return extractNameFromEmail(user.email || '');
  } catch (error) {
    console.error('Error getting user display name:', error);
    return extractNameFromEmail(user?.email || '');
  }
}

// Extract name from email
function extractNameFromEmail(email) {
  if (!email) return 'User';
  
  const emailName = email.split('@')[0];
  return emailName
    .replace(/[._-]/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}
</script>

<!-- Site scripts -->
<script src="script.js"></script>
</body>
</html>