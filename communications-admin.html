<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Communications Admin - Castle Comms</title>
  
  <!-- Security Headers -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <link rel="stylesheet" href="style.css?v=20250731" />
  <!-- Rich Text Editor -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  
  <!-- Chart.js for Analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      backdrop-filter: blur(10px);
      min-height: 80vh;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .admin-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 600;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e1e5e9;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      color: #6c757d;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-button:hover {
      color: #5a67d8;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      margin-bottom: 2rem;
    }

    .form-section h3 {
      margin: 0 0 1.5rem 0;
      color: #2c3e50;
      font-size: 1.3rem;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.95rem;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      transition: all 0.3s;
      box-sizing: border-box;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .rich-editor {
      height: 300px;
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
    }

    .documents-manager {
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      background: #f8f9fa;
    }

    .document-list {
      margin-top: 1rem;
    }

    .document-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .document-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-document-button, .add-powerbi-button, .add-task-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-document-button:hover, .add-powerbi-button:hover, .add-task-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .remove-button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .remove-button:hover {
      background: #c82333;
    }

    .powerbi-manager {
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      background: #f8f9fa;
    }

    .powerbi-item {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .powerbi-item h4 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
    }

    .powerbi-preview {
      width: 100%;
      height: 200px;
      border: 1px solid #e1e5e9;
      border-radius: 4px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      margin-top: 0.5rem;
    }

    .tasks-manager {
      border: 2px dashed #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      background: #f8f9fa;
    }

    .task-item {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .task-item h4 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #f0f0f0;
    }

    .save-draft-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .save-draft-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .publish-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--shadow-light);
    }

    .publish-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .preview-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .preview-button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .communications-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .communication-summary {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      transition: all 0.3s;
    }

    .communication-summary:hover {
      box-shadow: var(--shadow-light);
      transform: translateY(-1px);
    }

    .communication-summary h3 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .communication-summary .meta {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .communication-summary .actions {
      display: flex;
      gap: 0.5rem;
    }

    .edit-button, .delete-button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .edit-button {
      background: #ffc107;
      color: #212529;
    }

    .edit-button:hover {
      background: #e0a800;
    }

    .delete-button {
      background: #dc3545;
      color: white;
    }

    .delete-button:hover {
      background: #c82333;
    }

    /* Analytics Dashboard Styles */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .analytics-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      padding: 1.5rem;
      transition: all 0.3s;
    }

    .analytics-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    .analytics-card h4 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .metric-label {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .metric-change {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
    }

    .metric-change.positive {
      background: #d4edda;
      color: #155724;
    }

    .metric-change.negative {
      background: #f8d7da;
      color: #721c24;
    }

    .metric-change.neutral {
      background: #e2e3e5;
      color: #6c757d;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 1rem;
    }

    .chart-container.large {
      height: 400px;
    }

    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .analytics-table th,
    .analytics-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e1e5e9;
    }

    .analytics-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    .analytics-table tr:hover {
      background: #f8f9fa;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e1e5e9;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .loading-analytics {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }

    .analytics-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      align-items: center;
    }

    .date-range-picker {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .date-range-picker input {
      padding: 0.5rem;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .refresh-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .refresh-button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }

    .status-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-badge.draft {
      background: #f8f9fa;
      color: #6c757d;
      border: 1px solid #e1e5e9;
    }

    .status-badge.published {
      background: #d4edda;
      color: #155724;
    }

    /* Read Status Tracking Styles */
    .read-status-section {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e1e5e9;
    }

    .read-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .read-stat {
      text-align: center;
      padding: 0.5rem;
      background: white;
      border-radius: 6px;
      border: 1px solid #e1e5e9;
    }

    .read-stat-number {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .read-stat-label {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 0.2rem;
    }

    .read-stat.read .read-stat-number {
      color: #28a745;
    }

    .read-stat.unread .read-stat-number {
      color: #dc3545;
    }

    .users-read-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .user-read-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: white;
      border-radius: 6px;
      border: 1px solid #e1e5e9;
      font-size: 0.9rem;
    }

    .user-read-item.read {
      border-left: 3px solid #28a745;
      background: rgba(40, 167, 69, 0.05);
    }

    .user-read-item.unread {
      border-left: 3px solid #dc3545;
      background: rgba(220, 53, 69, 0.05);
    }

    .user-read-icon {
      margin-right: 0.5rem;
      font-size: 1rem;
    }

    .user-read-info {
      flex: 1;
    }

    .user-read-name {
      font-weight: 500;
      color: #2c3e50;
    }

    .user-read-email {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .user-read-time {
      font-size: 0.8rem;
      color: #6c757d;
      font-style: italic;
    }

    .toggle-read-status {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.3rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .toggle-read-status:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .bulk-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e1e5e9;
    }

    .bulk-action-button {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .bulk-action-button:hover {
      background: #e9ecef;
    }

    .bulk-action-button.primary {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    .bulk-action-button.primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }

    /* Email Notification Styles */
    .email-notification-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #2c3e50;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .email-template-preview {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .email-template-preview h4 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
      font-size: 1.1rem;
    }

    .email-preview-content {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #e1e5e9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .email-field {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .email-field strong {
      color: #495057;
      min-width: 60px;
      display: inline-block;
    }

    .email-body-preview {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 4px;
      border-left: 3px solid #667eea;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #495057;
    }

    .email-body-preview a {
      color: #667eea;
      text-decoration: none;
    }

    .email-body-preview a:hover {
      text-decoration: underline;
    }

    #preview-subject {
      color: #667eea;
      font-weight: 600;
    }

    .email-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-left: 1rem;
      padding-left: 1rem;
      border-left: 2px solid #e1e5e9;
    }

    .preview-recipients-button {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
      align-self: flex-start;
    }

    .preview-recipients-button:hover {
      background: #e9ecef;
    }

    .recipients-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .recipients-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-heavy);
    }

    .recipients-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .recipient-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e1e5e9;
      font-size: 0.9rem;
    }

    .close-modal {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      float: right;
      margin-top: 1rem;
    }

    .error, .success {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
      .admin-container {
        margin: 1rem;
        padding: 1rem;
      }
      
      .admin-header h1 {
        font-size: 2rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .admin-tabs {
        flex-wrap: wrap;
      }

      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

<!-- Background Slideshow -->
<div class="background-slideshow" id="background-slideshow">
  <!-- Images will be injected by JavaScript -->
</div>
  
<header>
  <button id="menu-toggle" class="hamburger">&#9776;</button>
  <h1>Castle Comms</h1>
</header>

<div id="notification-bell" class="notification-bell hidden">
  🔔 <span id="notification-count" class="count-badge">0</span>
</div>

<div id="sidebar-container"></div>

<main id="main">
  <div class="admin-container">
    <div class="admin-header">
      <h1>📢 Communications Admin</h1>
    </div>
    
    <div class="admin-tabs">
      <button class="tab-button active" data-tab="create">Create Communication</button>
      <button class="tab-button" data-tab="manage">Manage Communications</button>
      <button class="tab-button" data-tab="analytics">Analytics</button>
    </div>
    
    <!-- Create Communication Tab -->
    <div class="tab-content active" id="create-tab">
      <form id="communication-form">
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="comm-title">Title *</label>
              <input type="text" id="comm-title" class="form-input" required maxlength="100">
            </div>
            <div class="form-group">
              <label for="comm-priority">Priority</label>
              <select id="comm-priority" class="form-select">
                <option value="normal">Normal</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label for="comm-summary">Summary</label>
              <textarea id="comm-summary" class="form-textarea" placeholder="Brief summary for the communications feed..." maxlength="300"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Content</h3>
          <div class="form-group">
            <label>Content *</label>
            <div id="rich-editor" class="rich-editor"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>📎 Documents (OneDrive)</h3>
          <div class="documents-manager">
            <p>Add documents from OneDrive that users can download</p>
            <button type="button" class="add-document-button" onclick="addDocument()">
              ➕ Add Document
            </button>
            <div id="documents-list" class="document-list"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>📊 PowerBI Integration</h3>
          <div class="powerbi-manager">
            <p>Add PowerBI reports or dashboards to embed or link</p>
            <button type="button" class="add-powerbi-button" onclick="addPowerBI()">
              ➕ Add PowerBI Content
            </button>
            <div id="powerbi-list"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>✓ Tasks</h3>
          <div class="tasks-manager">
            <p>Add tasks that users need to complete after reading this communication</p>
            <button type="button" class="add-task-button" onclick="addTask()">
              ➕ Add Task
            </button>
            <div id="tasks-list"></div>
          </div>
        </div>

        <div class="form-section">
          <h3>📧 Email Notifications</h3>
          <div class="email-notification-options">
            <label class="checkbox-container">
              <input type="checkbox" id="send-email-notification" checked>
              <span class="checkmark"></span>
              Send email notification to all users when published
            </label>
            <div class="email-options" id="email-options">
              <label class="checkbox-container">
                <input type="checkbox" id="urgent-only-notification">
                <span class="checkmark"></span>
                Only notify for urgent communications
              </label>
              <button type="button" class="preview-recipients-button" onclick="previewEmailRecipients()">
                👥 Preview Recipients
              </button>
            </div>
            <div class="email-template-preview" id="email-template-preview">
              <h4>📧 Email Preview</h4>
              <div class="email-preview-content">
                <div class="email-field"><strong>To:</strong> All Users (BCC)</div>
                <div class="email-field"><strong>Subject:</strong> <span id="preview-subject">New Communication: [Title will appear here]</span></div>
                <div class="email-field"><strong>Body:</strong></div>
                <div class="email-body-preview" id="preview-body">
                  A new communication has been posted: "[Title]"<br><br>
                  [Summary will appear here]<br><br>
                  Please visit the communications page to view the full details:<br>
                  <a href="#">View Communication</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button type="button" class="save-draft-button" onclick="saveDraft()">💾 Save Draft</button>
          <button type="button" class="preview-button" onclick="previewCommunication()">👁️ Preview</button>
          <button type="button" class="publish-button" onclick="publishCommunication()">🚀 Publish</button>
        </div>
      </form>
    </div>
    
    <!-- Manage Communications Tab -->
    <div class="tab-content" id="manage-tab">
      <div class="form-section">
        <h3>All Communications</h3>
        <div id="communications-list" class="communications-list">
          <div class="loading">Loading communications...</div>
        </div>
      </div>
    </div>
    
    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics-tab">
      <div class="form-section">
        <h3>📊 Communications Analytics</h3>
        
        <div class="analytics-filters">
          <div class="date-range-picker">
            <label>From:</label>
            <input type="date" id="analytics-start-date">
            <label>To:</label>
            <input type="date" id="analytics-end-date">
          </div>
          <button class="refresh-button" onclick="refreshAnalytics()">🔄 Refresh Data</button>
        </div>

        <div id="analytics-content">
          <div class="loading-analytics">Loading analytics data...</div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Recipients Preview Modal -->
<div class="recipients-modal" id="recipients-modal">
  <div class="recipients-modal-content">
    <h3>📧 Email Recipients Preview</h3>
    <p id="recipients-count">Loading recipients...</p>
    <div class="recipients-list" id="recipients-list">
      <!-- Recipients will be loaded here -->
    </div>
    <button class="close-modal" onclick="closeRecipientsModal()">Close</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<!-- Integration utilities -->
<script src="onedrive-integration.js"></script>
<script src="powerbi-integration.js"></script>

<!-- Communications Admin Logic -->
<script>
let db;
let currentUser;
let quill;
let documents = [];
let powerbiItems = [];
let tasks = [];
let editingCommunicationId = null;

document.addEventListener('DOMContentLoaded', function() {
  // Check authentication first
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.log('User not authenticated, redirecting to login');
      window.location.href = 'index.html';
      return;
    }

    currentUser = user;
    
    // Check if user is admin (you may want to add this check)
    // For now, we'll assume access control is handled elsewhere
    
    // Initialize Firebase Firestore
    if (firebase.apps.length > 0) {
      db = firebase.firestore();
      initializeEditor();
      setupTabs();
      loadCommunications();
    } else {
      console.error('Firebase not initialized');
    }
  });
});

// Initialize rich text editor
function initializeEditor() {
  quill = new Quill('#rich-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'align': [] }],
        ['link', 'image'],
        ['clean']
      ]
    }
  });
}

// Setup tab functionality
function setupTabs() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.dataset.tab;
      
      // Update active tab button
      tabButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      // Update active tab content
      tabContents.forEach(content => content.classList.remove('active'));
      document.getElementById(`${targetTab}-tab`).classList.add('active');
      
      // Load data for specific tabs
      if (targetTab === 'manage') {
        loadCommunications();
      } else if (targetTab === 'analytics') {
        loadAnalytics();
      }
    });
  });
  
  // Setup email preview updates
  setupEmailPreview();
}

// Setup email preview functionality
function setupEmailPreview() {
  const titleInput = document.getElementById('comm-title');
  const summaryInput = document.getElementById('comm-summary');
  
  if (titleInput && summaryInput) {
    titleInput.addEventListener('input', updateEmailPreview);
    summaryInput.addEventListener('input', updateEmailPreview);
    
    // Initial preview update
    updateEmailPreview();
  }
}

// Analytics Functions
let analyticsCharts = {};
let analyticsData = {};

// Load analytics dashboard
async function loadAnalytics() {
  const analyticsContent = document.getElementById('analytics-content');
  
  try {
    // Set default date range (last 30 days)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('analytics-start-date').value = startDate.toISOString().split('T')[0];
    document.getElementById('analytics-end-date').value = endDate.toISOString().split('T')[0];
    
    await refreshAnalytics();
  } catch (error) {
    console.error('Error loading analytics:', error);
    analyticsContent.innerHTML = '<div class="error">Failed to load analytics data.</div>';
  }
}

// Refresh analytics data
async function refreshAnalytics() {
  const analyticsContent = document.getElementById('analytics-content');
  analyticsContent.innerHTML = '<div class="loading-analytics">Loading analytics data...</div>';
  
  try {
    const startDate = new Date(document.getElementById('analytics-start-date').value);
    const endDate = new Date(document.getElementById('analytics-end-date').value);
    endDate.setHours(23, 59, 59, 999); // End of day
    
    // Fetch all analytics data
    const [
      communicationsData,
      readsData,
      tasksData
    ] = await Promise.all([
      getCommunicationsAnalytics(startDate, endDate),
      getReadsAnalytics(startDate, endDate),
      getTasksAnalytics(startDate, endDate)
    ]);
    
    analyticsData = {
      communications: communicationsData,
      reads: readsData,
      tasks: tasksData,
      dateRange: { startDate, endDate }
    };
    
    renderAnalyticsDashboard();
    
  } catch (error) {
    console.error('Error refreshing analytics:', error);
    analyticsContent.innerHTML = '<div class="error">Failed to refresh analytics data.</div>';
  }
}

// Get communications analytics
async function getCommunicationsAnalytics(startDate, endDate) {
  const snapshot = await db.collection('communications')
    .where('createdAt', '>=', startDate)
    .where('createdAt', '<=', endDate)
    .orderBy('createdAt', 'desc')
    .get();
  
  const communications = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: doc.data().createdAt?.toDate() || new Date()
  }));
  
  return {
    total: communications.length,
    published: communications.filter(c => c.status === 'published').length,
    drafts: communications.filter(c => c.status === 'draft').length,
    urgent: communications.filter(c => c.urgent).length,
    withDocuments: communications.filter(c => c.documents && c.documents.length > 0).length,
    withPowerBI: communications.filter(c => c.powerbi && c.powerbi.length > 0).length,
    withTasks: communications.filter(c => c.tasks && c.tasks.length > 0).length,
    communications: communications
  };
}

// Get reads analytics
async function getReadsAnalytics(startDate, endDate) {
  const snapshot = await db.collection('communication-reads')
    .where('readAt', '>=', startDate)
    .where('readAt', '<=', endDate)
    .get();
  
  const reads = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    readAt: doc.data().readAt?.toDate() || new Date()
  }));
  
  // Group by communication
  const readsByComm = {};
  reads.forEach(read => {
    if (!readsByComm[read.communicationId]) {
      readsByComm[read.communicationId] = [];
    }
    readsByComm[read.communicationId].push(read);
  });
  
  return {
    totalReads: reads.length,
    uniqueReaders: new Set(reads.map(r => r.userId)).size,
    readsByComm: readsByComm,
    reads: reads
  };
}

// Get tasks analytics
async function getTasksAnalytics(startDate, endDate) {
  const snapshot = await db.collection('communication-tasks')
    .where('completedAt', '>=', startDate)
    .where('completedAt', '<=', endDate)
    .get();
  
  const tasks = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    completedAt: doc.data().completedAt?.toDate() || new Date()
  }));
  
  // Group by communication
  const tasksByComm = {};
  tasks.forEach(task => {
    if (!tasksByComm[task.communicationId]) {
      tasksByComm[task.communicationId] = [];
    }
    tasksByComm[task.communicationId].push(task);
  });
  
  return {
    totalCompletions: tasks.length,
    uniqueUsers: new Set(tasks.map(t => t.userId)).size,
    tasksByComm: tasksByComm,
    tasks: tasks
  };
}

// Render analytics dashboard
function renderAnalyticsDashboard() {
  const analyticsContent = document.getElementById('analytics-content');
  
  const dashboardHTML = `
    <!-- Key Metrics -->
    <div class="analytics-grid">
      <div class="analytics-card">
        <h4>📢 Total Communications</h4>
        <div class="metric-value">${analyticsData.communications.total}</div>
        <div class="metric-label">Published: ${analyticsData.communications.published} | Drafts: ${analyticsData.communications.drafts}</div>
        <div class="metric-change ${analyticsData.communications.urgent > 0 ? 'negative' : 'neutral'}">
          ${analyticsData.communications.urgent} urgent communications
        </div>
      </div>
      
      <div class="analytics-card">
        <h4>👀 Total Reads</h4>
        <div class="metric-value">${analyticsData.reads.totalReads}</div>
        <div class="metric-label">Unique readers: ${analyticsData.reads.uniqueReaders}</div>
        <div class="metric-change neutral">
          Avg: ${analyticsData.communications.published > 0 ? Math.round(analyticsData.reads.totalReads / analyticsData.communications.published * 10) / 10 : 0} reads per communication
        </div>
      </div>
      
      <div class="analytics-card">
        <h4>✅ Task Completions</h4>
        <div class="metric-value">${analyticsData.tasks.totalCompletions}</div>
        <div class="metric-label">Unique users: ${analyticsData.tasks.uniqueUsers}</div>
        <div class="metric-change positive">
          ${analyticsData.communications.withTasks > 0 ? Math.round(analyticsData.tasks.totalCompletions / analyticsData.communications.withTasks * 10) / 10 : 0} avg completions per task communication
        </div>
      </div>
      
      <div class="analytics-card">
        <h4>📊 Content Types</h4>
        <div class="metric-value">${analyticsData.communications.withDocuments + analyticsData.communications.withPowerBI}</div>
        <div class="metric-label">Communications with attachments</div>
        <div class="metric-change neutral">
          📎 ${analyticsData.communications.withDocuments} docs | 📊 ${analyticsData.communications.withPowerBI} PowerBI
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="analytics-grid">
      <div class="analytics-card">
        <h4>📈 Communications Over Time</h4>
        <div class="chart-container">
          <canvas id="communications-timeline-chart"></canvas>
        </div>
      </div>
      
      <div class="analytics-card">
        <h4>📊 Content Distribution</h4>
        <div class="chart-container">
          <canvas id="content-distribution-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="analytics-grid">
      <div class="analytics-card">
        <h4>👀 Read Rates Over Time</h4>
        <div class="chart-container">
          <canvas id="read-rates-chart"></canvas>
        </div>
      </div>
      
      <div class="analytics-card">
        <h4>✅ Task Completion Rates</h4>
        <div class="chart-container">
          <canvas id="task-completion-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed Tables -->
    <div class="analytics-card" style="grid-column: 1 / -1;">
      <h4>📋 Communication Performance</h4>
      <table class="analytics-table">
        <thead>
          <tr>
            <th>Communication</th>
            <th>Published</th>
            <th>Reads</th>
            <th>Read Rate</th>
            <th>Tasks</th>
            <th>Task Completion</th>
            <th>Content</th>
          </tr>
        </thead>
        <tbody>
          ${renderCommunicationPerformanceTable()}
        </tbody>
      </table>
    </div>
  `;
  
  analyticsContent.innerHTML = dashboardHTML;
  
  // Render charts after DOM is updated
  setTimeout(() => {
    createTimelineChart();
    createContentDistributionChart();
    createReadRatesChart();
    createTaskCompletionChart();
  }, 100);
}

// Render communication performance table
function renderCommunicationPerformanceTable() {
  return analyticsData.communications.communications
    .filter(comm => comm.status === 'published')
    .map(comm => {
      const reads = analyticsData.reads.readsByComm[comm.id] || [];
      const tasks = analyticsData.tasks.tasksByComm[comm.id] || [];
      const totalUsers = new Set([...reads.map(r => r.userId), ...tasks.map(t => t.userId)]).size;
      const readRate = totalUsers > 0 ? Math.round(reads.length / totalUsers * 100 * 10) / 10 : 0;
      
      const contentBadges = [];
      if (comm.documents && comm.documents.length > 0) contentBadges.push('📎 Docs');
      if (comm.powerbi && comm.powerbi.length > 0) contentBadges.push('📊 PowerBI');
      if (comm.tasks && comm.tasks.length > 0) contentBadges.push('✅ Tasks');
      
      return `
        <tr>
          <td>
            <strong>${comm.title}</strong>
            ${comm.urgent ? '<span style="color: #dc3545;">🚨</span>' : ''}
          </td>
          <td>${comm.createdAt.toLocaleDateString()}</td>
          <td>${reads.length}</td>
          <td>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${Math.min(readRate, 100)}%"></div>
            </div>
            ${readRate}%
          </td>
          <td>${comm.tasks ? comm.tasks.length : 0}</td>
          <td>${tasks.length}</td>
          <td>${contentBadges.join(' ')}</td>
        </tr>
      `;
    }).join('');
}

// Create timeline chart
function createTimelineChart() {
  const ctx = document.getElementById('communications-timeline-chart');
  if (!ctx) return;
  
  // Group communications by day
  const dailyData = {};
  analyticsData.communications.communications.forEach(comm => {
    const day = comm.createdAt.toISOString().split('T')[0];
    dailyData[day] = (dailyData[day] || 0) + 1;
  });
  
  const labels = Object.keys(dailyData).sort();
  const data = labels.map(label => dailyData[label]);
  
  if (analyticsCharts.timeline) analyticsCharts.timeline.destroy();
  
  analyticsCharts.timeline = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.map(date => new Date(date).toLocaleDateString()),
      datasets: [{
        label: 'Communications Published',
        data: data,
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

// Create content distribution chart
function createContentDistributionChart() {
  const ctx = document.getElementById('content-distribution-chart');
  if (!ctx) return;
  
  const data = [
    analyticsData.communications.withDocuments,
    analyticsData.communications.withPowerBI,
    analyticsData.communications.withTasks,
    analyticsData.communications.total - analyticsData.communications.withDocuments - analyticsData.communications.withPowerBI - analyticsData.communications.withTasks
  ];
  
  if (analyticsCharts.distribution) analyticsCharts.distribution.destroy();
  
  analyticsCharts.distribution = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['With Documents', 'With PowerBI', 'With Tasks', 'Text Only'],
      datasets: [{
        data: data,
        backgroundColor: [
          '#36a2eb',
          '#ff6384',
          '#4bc0c0',
          '#e1e5e9'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

// Create read rates chart
function createReadRatesChart() {
  const ctx = document.getElementById('read-rates-chart');
  if (!ctx) return;
  
  // Group reads by day
  const dailyReads = {};
  analyticsData.reads.reads.forEach(read => {
    const day = read.readAt.toISOString().split('T')[0];
    dailyReads[day] = (dailyReads[day] || 0) + 1;
  });
  
  const labels = Object.keys(dailyReads).sort();
  const data = labels.map(label => dailyReads[label]);
  
  if (analyticsCharts.reads) analyticsCharts.reads.destroy();
  
  analyticsCharts.reads = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels.map(date => new Date(date).toLocaleDateString()),
      datasets: [{
        label: 'Daily Reads',
        data: data,
        backgroundColor: '#28a745',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

// Create task completion chart
function createTaskCompletionChart() {
  const ctx = document.getElementById('task-completion-chart');
  if (!ctx) return;
  
  // Group task completions by day
  const dailyCompletions = {};
  analyticsData.tasks.tasks.forEach(task => {
    const day = task.completedAt.toISOString().split('T')[0];
    dailyCompletions[day] = (dailyCompletions[day] || 0) + 1;
  });
  
  const labels = Object.keys(dailyCompletions).sort();
  const data = labels.map(label => dailyCompletions[label]);
  
  if (analyticsCharts.tasks) analyticsCharts.tasks.destroy();
  
  analyticsCharts.tasks = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels.map(date => new Date(date).toLocaleDateString()),
      datasets: [{
        label: 'Task Completions',
        data: data,
        backgroundColor: '#ffc107',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

// Add document
function addDocument() {
  const name = prompt('Enter document name:');
  if (!name) return;
  
  const url = prompt('Enter OneDrive share URL:');
  if (!url) return;
  
  const document = {
    id: Date.now().toString(),
    name: name,
    url: url
  };
  
  documents.push(document);
  updateDocumentsList();
}

// Update documents list display
function updateDocumentsList() {
  const container = document.getElementById('documents-list');
  
  if (documents.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = documents.map(doc => `
    <div class="document-item">
      <div class="document-info">
        <span>📄</span>
        <span>${doc.name}</span>
      </div>
      <button type="button" class="remove-button" onclick="removeDocument('${doc.id}')">
        Remove
      </button>
    </div>
  `).join('');
}

// Remove document
function removeDocument(docId) {
  documents = documents.filter(doc => doc.id !== docId);
  updateDocumentsList();
}

// Add PowerBI content
function addPowerBI() {
  const name = prompt('Enter PowerBI content name:');
  if (!name) return;
  
  const type = confirm('Click OK for Embedded PowerBI, Cancel for Link only') ? 'embed' : 'link';
  
  let url;
  if (type === 'embed') {
    url = prompt('Enter PowerBI embed URL:');
  } else {
    url = prompt('Enter PowerBI share URL:');
  }
  
  if (!url) return;
  
  const powerbi = {
    id: Date.now().toString(),
    name: name,
    type: type,
    url: url
  };
  
  powerbiItems.push(powerbi);
  updatePowerBIList();
}

// Update PowerBI list display
function updatePowerBIList() {
  const container = document.getElementById('powerbi-list');
  
  if (powerbiItems.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = powerbiItems.map(item => `
    <div class="powerbi-item">
      <h4>${item.name}</h4>
      <p><strong>Type:</strong> ${item.type === 'embed' ? 'Embedded' : 'Link'}</p>
      <p><strong>URL:</strong> ${item.url}</p>
      <div class="powerbi-preview">
        ${item.type === 'embed' ? '📊 PowerBI Report Preview' : '🔗 PowerBI Link'}
      </div>
      <button type="button" class="remove-button" onclick="removePowerBI('${item.id}')">
        Remove
      </button>
    </div>
  `).join('');
}

// Remove PowerBI content
function removePowerBI(itemId) {
  powerbiItems = powerbiItems.filter(item => item.id !== itemId);
  updatePowerBIList();
}

// Add task
function addTask() {
  const text = prompt('Enter task description:');
  if (!text) return;
  
  const dueDate = prompt('Enter due date (YYYY-MM-DD) or leave empty:');
  
  const task = {
    id: Date.now().toString(),
    text: text,
    dueDate: dueDate || null
  };
  
  tasks.push(task);
  updateTasksList();
}

// Update tasks list display
function updateTasksList() {
  const container = document.getElementById('tasks-list');
  
  if (tasks.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = tasks.map(task => `
    <div class="task-item">
      <h4>Task</h4>
      <p><strong>Description:</strong> ${task.text}</p>
      ${task.dueDate ? `<p><strong>Due Date:</strong> ${task.dueDate}</p>` : ''}
      <button type="button" class="remove-button" onclick="removeTask('${task.id}')">
        Remove
      </button>
    </div>
  `).join('');
}

// Remove task
function removeTask(taskId) {
  tasks = tasks.filter(task => task.id !== taskId);
  updateTasksList();
}

// Save as draft
async function saveDraft() {
  await saveCommunication('draft');
}

// Publish communication
async function publishCommunication() {
  await saveCommunication('published');
}

// Email Notification Functions

// Update email preview in real-time
function updateEmailPreview() {
  const title = document.getElementById('comm-title').value.trim() || '[Title]';
  const summary = document.getElementById('comm-summary').value.trim() || '[Summary]';
  
  // Update subject preview
  document.getElementById('preview-subject').textContent = `New Communication: ${title}`;
  
  // Update body preview
  const currentUrl = window.location.origin + window.location.pathname.replace('communications-admin.html', 'communications.html');
  document.getElementById('preview-body').innerHTML = `
    A new communication has been posted: "<strong>${title}</strong>"<br><br>
    ${summary}<br><br>
    Please visit the communications page to view the full details:<br>
    <a href="${currentUrl}" target="_blank">View Communication →</a>
  `;
}

// Collect all user emails from the database
async function getAllUserEmails() {
  try {
    const realtimeDb = firebase.database();
    const usersSnapshot = await realtimeDb.ref('users').once('value');
    const usersData = usersSnapshot.val() || {};
    
    const emails = [];
    Object.keys(usersData).forEach(uid => {
      const userData = usersData[uid];
      let email = userData.email;
      
      // If no email, construct one from name
      if (!email && userData.name) {
        email = userData.name.toLowerCase().replace(/\s+/g, '.') + '@company.com';
      }
      
      if (email && email.includes('@')) {
        emails.push(email);
      }
    });
    
    return emails;
  } catch (error) {
    console.error('Error getting user emails:', error);
    return [];
  }
}

// Generate mailto link for communication notification
async function generateEmailNotification(title, summary) {
  try {
    const emails = await getAllUserEmails();
    
    if (emails.length === 0) {
      throw new Error('No user emails found');
    }
    
    const subject = `New Communication: ${title}`;
    const currentUrl = window.location.origin + window.location.pathname.replace('communications-admin.html', 'communications.html');
    
    const body = `A new communication has been posted: "${title}"

${summary}

Please visit the communications page to view the full details:
${currentUrl}

---
Castle Comms Communications System`;
    
    // Use BCC to protect user privacy
    const mailtoUrl = `mailto:?bcc=${encodeURIComponent(emails.join(','))}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    return {
      url: mailtoUrl,
      recipientCount: emails.length,
      recipients: emails
    };
  } catch (error) {
    console.error('Error generating email notification:', error);
    throw error;
  }
}

// Open email client with notification
async function sendEmailNotification(title, summary) {
  try {
    showStatus('Preparing email notification...', 'info');
    
    const emailData = await generateEmailNotification(title, summary);
    
    // Check URL length (browsers have limits)
    if (emailData.url.length > 2000) {
      // Fallback for very long URLs
      const shortBody = `New communication "${title}" has been posted. Please check the communications page.`;
      const fallbackUrl = `mailto:?bcc=${encodeURIComponent(emailData.recipients.join(','))}&subject=${encodeURIComponent(`New Communication: ${title}`)}&body=${encodeURIComponent(shortBody)}`;
      window.open(fallbackUrl, '_blank');
    } else {
      window.open(emailData.url, '_blank');
    }
    
    showStatus(`Email notification prepared for ${emailData.recipientCount} users`, 'success');
    return true;
  } catch (error) {
    console.error('Failed to send email notification:', error);
    showStatus('Failed to prepare email notification: ' + error.message, 'error');
    return false;
  }
}

// Preview email recipients
async function previewEmailRecipients() {
  try {
    const modal = document.getElementById('recipients-modal');
    const countEl = document.getElementById('recipients-count');
    const listEl = document.getElementById('recipients-list');
    
    // Show modal
    modal.style.display = 'flex';
    countEl.textContent = 'Loading recipients...';
    listEl.innerHTML = '';
    
    // Get user data
    const realtimeDb = firebase.database();
    const usersSnapshot = await realtimeDb.ref('users').once('value');
    const usersData = usersSnapshot.val() || {};
    
    const recipients = [];
    Object.keys(usersData).forEach(uid => {
      const userData = usersData[uid];
      let email = userData.email;
      
      // If no email, construct one from name
      if (!email && userData.name) {
        email = userData.name.toLowerCase().replace(/\s+/g, '.') + '@company.com';
      }
      
      if (email && email.includes('@')) {
        recipients.push({
          name: userData.name || userData.displayName || 'Unknown User',
          email: email
        });
      }
    });
    
    // Update modal content
    countEl.textContent = `${recipients.length} recipients will receive email notifications`;
    
    if (recipients.length === 0) {
      listEl.innerHTML = '<div style="text-align: center; color: #6c757d;">No email recipients found</div>';
    } else {
      listEl.innerHTML = recipients.map(recipient => `
        <div class="recipient-item">
          <span>📧</span>
          <div style="margin-left: 0.5rem;">
            <div style="font-weight: 500;">${recipient.name}</div>
            <div style="font-size: 0.8rem; color: #6c757d;">${recipient.email}</div>
          </div>
        </div>
      `).join('');
    }
    
  } catch (error) {
    console.error('Error loading recipients:', error);
    document.getElementById('recipients-count').textContent = 'Error loading recipients';
  }
}

// Close recipients modal
function closeRecipientsModal() {
  document.getElementById('recipients-modal').style.display = 'none';
}

// Close modal when clicking outside
window.addEventListener('click', (event) => {
  const modal = document.getElementById('recipients-modal');
  if (event.target === modal) {
    closeRecipientsModal();
  }
});

// Save communication
async function saveCommunication(status) {
  const title = document.getElementById('comm-title').value.trim();
  const summary = document.getElementById('comm-summary').value.trim();
  const priority = document.getElementById('comm-priority').value;
  const content = quill.root.innerHTML;
  
  if (!title || !content) {
    alert('Please fill in the title and content.');
    return;
  }
  
  try {
    const communicationData = {
      title: title,
      summary: summary || content.replace(/<[^>]*>/g, '').substring(0, 200),
      content: content,
      urgent: priority === 'urgent',
      status: status,
      documents: documents.map(doc => ({
        name: doc.name,
        url: doc.url
      })),
      powerbi: powerbiItems.map(item => ({
        name: item.name,
        type: item.type,
        [item.type === 'embed' ? 'embedUrl' : 'linkUrl']: item.url
      })),
      tasks: tasks.map(task => ({
        text: task.text,
        dueDate: task.dueDate
      })),
      createdBy: {
        uid: currentUser.uid,
        email: currentUser.email,
        name: await getUserDisplayName(currentUser)
      },
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    let docRef;
    if (editingCommunicationId) {
      // Update existing communication
      docRef = db.collection('communications').doc(editingCommunicationId);
      await docRef.update(communicationData);
    } else {
      // Create new communication
      docRef = await db.collection('communications').add(communicationData);
    }
    
    showStatus(`Communication ${status} successfully!`, 'success');
    
    // Send email notification if published and checkbox is checked
    if (status === 'published') {
      const sendEmailCheckbox = document.getElementById('send-email-notification');
      const urgentOnlyCheckbox = document.getElementById('urgent-only-notification');
      
      // Check if email should be sent
      let shouldSendEmail = sendEmailCheckbox && sendEmailCheckbox.checked;
      
      // If "urgent only" is checked, only send for urgent communications
      if (urgentOnlyCheckbox && urgentOnlyCheckbox.checked) {
        shouldSendEmail = shouldSendEmail && (priority === 'urgent');
      }
      
      if (shouldSendEmail) {
        // Small delay to let the success message show first
        setTimeout(async () => {
          await sendEmailNotification(title, summary || content.replace(/<[^>]*>/g, '').substring(0, 200));
        }, 500);
      }
      
      resetForm();
    }
    
    // Reload communications list
    loadCommunications();
    
  } catch (error) {
    console.error('Error saving communication:', error);
    showStatus('Failed to save communication. Please try again.', 'error');
  }
}

// Preview communication
function previewCommunication() {
  const title = document.getElementById('comm-title').value.trim();
  const content = quill.root.innerHTML;
  
  if (!title || !content) {
    alert('Please fill in the title and content to preview.');
    return;
  }
  
  // Open preview in new window
  const previewWindow = window.open('', '_blank', 'width=800,height=600');
  previewWindow.document.write(`
    <html>
      <head>
        <title>Preview: ${title}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 2rem; }
          h1 { color: #2c3e50; }
          .content { line-height: 1.6; }
        </style>
      </head>
      <body>
        <h1>${title}</h1>
        <div class="content">${content}</div>
      </body>
    </html>
  `);
}

// Load communications for management
async function loadCommunications() {
  const container = document.getElementById('communications-list');
  
  try {
    const communications = await db.collection('communications')
      .orderBy('createdAt', 'desc')
      .get();
    
    if (communications.empty) {
      container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No communications created yet.</div>';
      return;
    }
    
    // Get all users and read status for each communication
    const [allUsers, readStatusData] = await Promise.all([
      getAllUsers(),
      getAllReadStatus()
    ]);
    
    const items = await Promise.all(communications.docs.map(async (doc) => {
      const data = doc.data();
      const readStatus = await getReadStatusForCommunication(doc.id, allUsers);
      
      return `
        <div class="communication-summary">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <h3>${data.title}</h3>
            <span class="status-badge ${data.status}">${data.status}</span>
          </div>
          <div class="meta">
            Created: ${data.createdAt?.toDate?.()?.toLocaleDateString() || 'Just now'} | 
            Priority: ${data.urgent ? 'Urgent' : 'Normal'} |
            Read: ${readStatus.readCount}/${readStatus.totalUsers} users
          </div>
          <p>${data.summary || data.content.replace(/<[^>]*>/g, '').substring(0, 150)}...</p>
          <div class="actions">
            <button class="edit-button" onclick="editCommunication('${doc.id}')">
              ✏️ Edit
            </button>
            <button class="delete-button" onclick="deleteCommunication('${doc.id}')">
              🗑️ Delete
            </button>
            <button class="toggle-read-status" onclick="toggleReadStatusView('${doc.id}')">
              👥 View Read Status
            </button>
          </div>
          <div class="read-status-section" id="read-status-${doc.id}" style="display: none;">
            <h4>📊 Read Status Overview</h4>
            <div class="read-stats">
              <div class="read-stat read">
                <div class="read-stat-number">${readStatus.readCount}</div>
                <div class="read-stat-label">Read</div>
              </div>
              <div class="read-stat unread">
                <div class="read-stat-number">${readStatus.unreadCount}</div>
                <div class="read-stat-label">Unread</div>
              </div>
              <div class="read-stat">
                <div class="read-stat-number">${Math.round((readStatus.readCount / readStatus.totalUsers) * 100)}%</div>
                <div class="read-stat-label">Read Rate</div>
              </div>
            </div>
            <h5>👥 Individual Status</h5>
            <div class="users-read-list">
              ${readStatus.users.map(user => `
                <div class="user-read-item ${user.hasRead ? 'read' : 'unread'}">
                  <span class="user-read-icon">${user.hasRead ? '✅' : '❌'}</span>
                  <div class="user-read-info">
                    <div class="user-read-name">${user.displayName || user.email}</div>
                    <div class="user-read-email">${user.email}</div>
                    ${user.hasRead && user.readAt ? `<div class="user-read-time">Read: ${formatReadTime(user.readAt)}</div>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="bulk-actions">
              <button class="bulk-action-button" onclick="exportUnreadUsers('${doc.id}')">
                📧 Export Unread Users
              </button>
              <button class="bulk-action-button primary" onclick="sendFollowUpReminder('${doc.id}')">
                📢 Send Follow-up
              </button>
            </div>
          </div>
        </div>
      `;
    }));
    
    container.innerHTML = items.join('');
    
  } catch (error) {
    console.error('Error loading communications:', error);
    container.innerHTML = '<div class="error">Failed to load communications.</div>';
  }
}

// Edit communication
async function editCommunication(commId) {
  try {
    const doc = await db.collection('communications').doc(commId).get();
    if (!doc.exists) {
      alert('Communication not found.');
      return;
    }
    
    const data = doc.data();
    editingCommunicationId = commId;
    
    // Switch to create tab
    document.querySelector('.tab-button[data-tab="create"]').click();
    
    // Populate form
    document.getElementById('comm-title').value = data.title;
    document.getElementById('comm-summary').value = data.summary || '';
    document.getElementById('comm-priority').value = data.urgent ? 'urgent' : 'normal';
    quill.root.innerHTML = data.content;
    
    // Populate documents
    documents = (data.documents || []).map((doc, index) => ({
      id: index.toString(),
      name: doc.name,
      url: doc.url
    }));
    updateDocumentsList();
    
    // Populate PowerBI items
    powerbiItems = (data.powerbi || []).map((item, index) => ({
      id: index.toString(),
      name: item.name,
      type: item.embedUrl ? 'embed' : 'link',
      url: item.embedUrl || item.linkUrl
    }));
    updatePowerBIList();
    
    // Populate tasks
    tasks = (data.tasks || []).map((task, index) => ({
      id: index.toString(),
      text: task.text,
      dueDate: task.dueDate
    }));
    updateTasksList();
    
  } catch (error) {
    console.error('Error loading communication:', error);
    alert('Failed to load communication for editing.');
  }
}

// Read Status Tracking Functions

// Get all users from Firebase Realtime Database
async function getAllUsers() {
  try {
    // Use Firebase Realtime Database for users (matching the existing system)
    const realtimeDb = firebase.database();
    const usersSnapshot = await realtimeDb.ref('users').once('value');
    const usersData = usersSnapshot.val() || {};
    
    const users = Object.keys(usersData).map(uid => ({
      uid: uid,
      email: usersData[uid].email || (usersData[uid].name ? usersData[uid].name + '@company.com' : 'unknown@company.com'),
      displayName: usersData[uid].name || usersData[uid].displayName || usersData[uid].email || 'Unknown User'
    }));
    
    // If no users found, return empty array
    if (users.length === 0) {
      console.warn('No users found in Realtime Database users collection');
      return [];
    }
    
    return users;
  } catch (error) {
    console.error('Error getting all users:', error);
    return [];
  }
}

// Get all read status data
async function getAllReadStatus() {
  try {
    const readsSnapshot = await db.collection('communication-reads').get();
    const readStatus = {};
    
    readsSnapshot.docs.forEach(doc => {
      const data = doc.data();
      if (!readStatus[data.communicationId]) {
        readStatus[data.communicationId] = [];
      }
      readStatus[data.communicationId].push({
        userId: data.userId,
        userEmail: data.userEmail,
        readAt: data.readAt
      });
    });
    
    return readStatus;
  } catch (error) {
    console.error('Error getting read status data:', error);
    return {};
  }
}

// Get read status for a specific communication
async function getReadStatusForCommunication(commId, allUsers) {
  try {
    const readsSnapshot = await db.collection('communication-reads')
      .where('communicationId', '==', commId)
      .get();
    
    const readUsers = new Set();
    const readData = {};
    
    readsSnapshot.docs.forEach(doc => {
      const data = doc.data();
      readUsers.add(data.userId);
      readData[data.userId] = {
        readAt: data.readAt,
        userEmail: data.userEmail
      };
    });
    
    const users = allUsers.map(user => ({
      ...user,
      hasRead: readUsers.has(user.uid),
      readAt: readData[user.uid]?.readAt
    }));
    
    return {
      totalUsers: allUsers.length,
      readCount: readUsers.size,
      unreadCount: allUsers.length - readUsers.size,
      users: users
    };
  } catch (error) {
    console.error('Error getting read status for communication:', error);
    return {
      totalUsers: 0,
      readCount: 0,
      unreadCount: 0,
      users: []
    };
  }
}

// Toggle read status view
function toggleReadStatusView(commId) {
  const statusSection = document.getElementById(`read-status-${commId}`);
  if (statusSection.style.display === 'none') {
    statusSection.style.display = 'block';
  } else {
    statusSection.style.display = 'none';
  }
}

// Format read time
function formatReadTime(timestamp) {
  if (!timestamp) return 'Unknown';
  
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffHours < 1) return 'Just now';
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString();
}

// Export unread users to CSV
function exportUnreadUsers(commId) {
  const statusSection = document.getElementById(`read-status-${commId}`);
  const unreadItems = statusSection.querySelectorAll('.user-read-item.unread');
  
  if (unreadItems.length === 0) {
    alert('All users have read this communication!');
    return;
  }
  
  const csvContent = 'Name,Email\n' + 
    Array.from(unreadItems).map(item => {
      const name = item.querySelector('.user-read-name').textContent;
      const email = item.querySelector('.user-read-email').textContent;
      return `"${name}","${email}"`;
    }).join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `unread-users-${commId}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

// Send follow-up reminder (placeholder - would integrate with your notification system)
function sendFollowUpReminder(commId) {
  const statusSection = document.getElementById(`read-status-${commId}`);
  const unreadItems = statusSection.querySelectorAll('.user-read-item.unread');
  
  if (unreadItems.length === 0) {
    alert('All users have read this communication!');
    return;
  }
  
  const unreadUsers = Array.from(unreadItems).map(item => {
    return {
      name: item.querySelector('.user-read-name').textContent,
      email: item.querySelector('.user-read-email').textContent
    };
  });
  
  // This would integrate with your email/notification system
  console.log('Sending follow-up reminders to:', unreadUsers);
  
  // For now, show a summary
  const userList = unreadUsers.map(u => u.name).join(', ');
  if (confirm(`Send follow-up reminder to ${unreadUsers.length} users?\n\n${userList}`)) {
    alert('Follow-up reminders would be sent here. This would integrate with your notification system.');
  }
}

// Delete communication
async function deleteCommunication(commId) {
  if (!confirm('Are you sure you want to delete this communication?')) {
    return;
  }
  
  try {
    await db.collection('communications').doc(commId).delete();
    showStatus('Communication deleted successfully!', 'success');
    loadCommunications();
  } catch (error) {
    console.error('Error deleting communication:', error);
    showStatus('Failed to delete communication.', 'error');
  }
}

// Reset form
function resetForm() {
  document.getElementById('comm-title').value = '';
  document.getElementById('comm-summary').value = '';
  document.getElementById('comm-priority').value = 'normal';
  quill.root.innerHTML = '';
  documents = [];
  powerbiItems = [];
  tasks = [];
  editingCommunicationId = null;
  updateDocumentsList();
  updatePowerBIList();
  updateTasksList();
}

// Show status message
function showStatus(message, type) {
  const statusDiv = document.createElement('div');
  statusDiv.className = type;
  statusDiv.textContent = message;
  
  const container = document.querySelector('.admin-container');
  container.insertBefore(statusDiv, container.firstChild);
  
  setTimeout(() => {
    statusDiv.remove();
  }, 5000);
}

// Get user display name
async function getUserDisplayName(user) {
  try {
    if (!user || !window.db) {
      return extractNameFromEmail(user?.email || '');
    }

    const userRef = window.db.ref(`users/${user.uid}`);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val();

    if (userData && userData.name) {
      return userData.name;
    }

    return extractNameFromEmail(user.email || '');
  } catch (error) {
    console.error('Error getting user display name:', error);
    return extractNameFromEmail(user?.email || '');
  }
}

// Extract name from email
function extractNameFromEmail(email) {
  if (!email) return 'User';
  
  const emailName = email.split('@')[0];
  return emailName
    .replace(/[._-]/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}
</script>

<!-- Site scripts -->
<script src="script.js"></script>

<!-- Notification system -->
<script src="notifications.js"></script>
</body>
</html>