
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Castle Comms</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="style.css?v=20250813_din_font_update" />
  <style>
    /* Tab Navigation Styles */
    .tab-navigation {
      display: flex;
      justify-content: center;
      gap: 1rem;
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      margin-top: 0px;
      padding-top: 60px;
      padding-bottom: 0px;
      margin-bottom: 30px;
      padding-left: 2rem;
      padding-right: 2rem;
    }

    .tab-button {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #333;
      padding: 1rem 1.5rem;
      padding-top: calc(1rem + 2px);
      border-radius: 0 0 10px 10px;
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-width: 120px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }

    .tab-button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
    }

    .tab-button.active {
      background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      color: white;
      border-color: transparent;
      box-shadow: 0 -4px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }

    .tab-button.active:hover {
      background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
    }

    /* Tab Content Styles */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      margin-top: 30px;
    }

    /* Move existing content down to account for tabs */
    .modern-main {
      margin-top: 1rem;
      position: relative;
    }

    /* Removed action buttons - no longer needed */

    @media (max-width: 768px) {
      .tab-navigation {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0 1rem;
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        margin-top: -12px;
      }

      .tab-button {
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
        min-width: 100px;
      }

      .modern-main {
        margin-top: 1.5rem;
      }
    }

    /* Card Button Styles */
    .dashboard-card {
      position: relative;
    }

    .card-button-container {
      position: absolute;
      top: 1.2rem;
      right: 1rem;
    }

    .card-button {
      display: inline-block;
      padding: 0.5rem 0.75rem;
      background: #45494e;        /* main button color */
      color: #ffffff;             /* text color */
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 0.8rem;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);   /* subtle shadow */
    }

    .card-button:hover {
      background: #5a5f65;        /* lighter shade on hover */
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(69, 73, 78, 0.25);
      text-decoration: none;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25); /* stronger shadow on hover */
    }

    .card-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);   /* pressed look */
    }

    /* =====================
       MOBILE-FIRST DESIGN
    ====================== */
    @media (max-width: 768px) {
      /* Reset and base styles for mobile */
      *, *::before, *::after { 
        box-sizing: border-box; 
      }
      
      body { 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; 
        background: #f6f7f9; 
        color: #2c3e50; 
      }

      /* CSS Variables for mobile consistency */
      :root {
        --mobile-primary-color: #d8d1c5;
        --mobile-secondary-color: #45494e;
        --mobile-tertiary-color: #6a6e73;
        --mobile-accent-color: #c5bdb1;
        --mobile-text-dark: #2c3e50;
        --mobile-text-light: #6c757d;
        --mobile-card-bg: #ffffff;
        --mobile-radius: 14px;
        --mobile-shadow: 0 6px 20px rgba(0,0,0,.08);
        --mobile-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      /* Mobile Header Styles - Override desktop navigation completely */
      .tab-navigation {
        position: sticky !important;
        top: 60px !important; /* Account for mobile header */
        left: 0 !important;
        right: 0 !important;
        z-index: 45 !important;
        background: rgba(255,255,255,.9) !important;
        backdrop-filter: blur(12px) !important;
        border-bottom: 1px solid rgba(0,0,0,.06) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: flex-start !important;
        gap: .5rem !important;
        padding: .5rem 0 1rem 0 !important;
        margin: 0 !important;
        transform: none !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        white-space: nowrap !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: none !important;
        max-width: 100vw !important;
        width: 100% !important;
      }

      .tab-navigation::-webkit-scrollbar { 
        display: none !important; 
      }

      /* Add padding to the first and last buttons for better scrolling */
      .tab-navigation .tab-button:first-child {
        margin-left: 1rem !important;
      }
      
      .tab-navigation .tab-button:last-child {
        margin-right: 1rem !important;
      }

      /* Mobile Tab Button Styles */
      .tab-button {
        appearance: none !important;
        border: 1px solid rgba(0,0,0,.08) !important;
        background: #fff !important;
        color: var(--mobile-secondary-color) !important;
        padding: .55rem .9rem !important;
        border-radius: 999px !important;
        font-weight: 600 !important;
        font-size: .9rem !important;
        min-width: auto !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        transform: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
      }

      .tab-button.active {
        background: var(--mobile-secondary-color) !important;
        color: #fff !important;
        border-color: transparent !important;
        transform: none !important;
        box-shadow: none !important;
      }

      .tab-button:hover {
        background: rgba(255, 255, 255, 1) !important;
        transform: none !important;
        box-shadow: none !important;
      }

      .tab-button.active:hover {
        background: var(--mobile-secondary-color) !important;
      }

      /* Mobile Main Content */
      main.modern-main {
        max-width: 820px !important;
        margin: 0 auto !important;
        padding: 0 1rem 5rem !important;
        margin-top: 0 !important;
      }

      /* Mobile Section Styles */
      .tab-content {
        scroll-margin-top: 88px !important;
        margin-top: .75rem !important;
      }

      .section-title {
        display: flex !important;
        align-items: center !important;
        gap: .6rem !important;
        margin: .75rem 0 1rem !important;
        font-size: 1.25rem !important;
        color: var(--mobile-secondary-color) !important;
      }

      .section-title::after {
        content: 'Overview';
        font-size: .85rem;
        color: #fff;
        background: var(--mobile-gradient);
        padding: .2rem .55rem;
        border-radius: 6px;
      }

      /* Mobile Card Styles */
      .modern-card,
      .modern-glass-card,
      .glass-card,
      .card {
        background: var(--mobile-card-bg) !important;
        border-radius: var(--mobile-radius) !important;
        box-shadow: var(--mobile-shadow) !important;
        overflow: hidden !important;
        margin-bottom: .9rem !important;
        border: none !important;
      }

      .card-header,
      .modern-card-header {
        padding: 1rem 1rem .6rem !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: .75rem !important;
      }

      .card-header h3,
      .modern-card-header h3 {
        margin: 0 !important;
        font-size: 1.05rem !important;
        color: var(--mobile-text-dark) !important;
      }

      .card-body,
      .modern-card-body {
        padding: .75rem 1rem 1rem !important;
      }

      /* Mobile Quicklinks */
      .modern-quick-links {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0,1fr)) !important;
        gap: .6rem !important;
      }

      .modern-quicklink {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: .5rem !important;
        padding: .85rem .9rem !important;
        border-radius: 12px !important;
        text-decoration: none !important;
        color: var(--mobile-secondary-color) !important;
        background: rgba(255,255,255,.9) !important;
        border: 1px solid rgba(0,0,0,.06) !important;
        box-shadow: var(--mobile-shadow) !important;
        transition: all 0.3s ease !important;
      }

      .quicklink-label {
        font-weight: 700 !important;
        font-size: .95rem !important;
      }

      .quicklink-arrow {
        font-weight: 700 !important;
        font-size: 1.1rem !important;
      }

      /* Mobile List Styles */
      .modern-news-list,
      .list {
        display: grid !important;
        gap: .6rem !important;
      }

      .news-item,
      .item {
        background: #fff !important;
        border: 1px solid rgba(0,0,0,.05) !important;
        border-radius: 10px !important;
        padding: .8rem !important;
        display: grid !important;
        gap: .25rem !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
      }

      .news-item:hover,
      .item:hover {
        box-shadow: var(--mobile-shadow) !important;
        transform: translateY(-1px) !important;
      }

      .news-meta,
      .meta {
        font-size: .8rem !important;
        color: var(--mobile-text-light) !important;
      }

      /* Mobile Button Styles */
      .card-button,
      .btn-inline {
        display: inline-flex !important;
        align-items: center !important;
        gap: .4rem !important;
        padding: .45rem .7rem !important;
        border-radius: 8px !important;
        border: 1px solid rgba(0,0,0,.08) !important;
        background: #fff !important;
        text-decoration: none !important;
        color: var(--mobile-secondary-color) !important;
        font-weight: 600 !important;
        font-size: .9rem !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
      }

      .card-button.primary,
      .btn-inline.primary {
        background: var(--mobile-secondary-color) !important;
        color: #fff !important;
        border-color: transparent !important;
      }

      /* Mobile Responsive Grid */
      .grid-2 {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: .9rem !important;
      }

      /* Desktop grid for larger screens */
      @media (min-width: 900px) {
        .grid-2 { 
          grid-template-columns: 1fr 1fr !important; 
        }
        .modern-quick-links { 
          grid-template-columns: repeat(3, minmax(0,1fr)) !important; 
        }
      }

      /* Back to top FAB */
      .fab {
        position: fixed !important;
        right: 16px !important;
        bottom: 16px !important;
        z-index: 40 !important;
        border: none !important;
        border-radius: 999px !important;
        padding: .9rem !important;
        box-shadow: var(--mobile-shadow) !important;
        background: var(--mobile-secondary-color) !important;
        color: #fff !important;
        display: none !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
      }

      .fab.show {
        display: inline-flex !important;
      }

      .fab:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(0,0,0,.15) !important;
      }

      /* Hide desktop-specific elements on mobile */
      .sidebar-overlay,
      #sidebar-container {
        display: none !important;
      }

      #header-container {
        display: none !important;
      }

      /* Mobile-specific utility classes */
      .divider {
        height: 1px !important;
        background: rgba(0,0,0,.06) !important;
        margin: .75rem 0 !important;
      }

      /* Ensure proper spacing and scrolling */
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        height: 100% !important;
      }

      /* Smooth scrolling */
      html {
        scroll-behavior: smooth !important;
      }

      /* Touch-friendly tap targets */
      .modern-quicklink,
      .news-item,
      .item,
      .card-button,
      .btn-inline,
      .tab-button {
        min-height: 44px !important;
      }

      /* Mobile Checklist Layout Modifications */
      .checklist-item {
        display: block !important; /* Override flex to stack items vertically */
      }

      .checklist-item > div:first-child {
        margin-bottom: 1rem !important; /* Space between question and pass/fail buttons */
      }

      /* Move pass/fail buttons to bottom and make them wider */
      .checklist-item > div:last-child {
        order: 2 !important;
        display: flex !important;
        gap: 0.75rem !important;
        margin-top: 1rem !important;
        width: 100% !important;
      }

      .checklist-item > div:last-child > div {
        flex: 1 !important; /* Make buttons equal width */
        width: auto !important;
        min-height: 50px !important; /* Taller buttons for better touch */
        font-size: 1rem !important;
        font-weight: 700 !important;
      }

      /* Make header elements stack vertically and take full width */
      .checklist-header {
        flex-direction: column !important;
        gap: 1rem !important;
        align-items: stretch !important;
      }

      .checklist-header > div:first-child {
        flex-direction: column !important;
        gap: 1rem !important;
        align-items: center !important;
      }

      .checklist-header > div:first-child h2 {
        text-align: center !important;
        font-size: 1.5rem !important;
      }

      .checklist-header > div:last-child {
        flex-direction: column !important;
        gap: 0.75rem !important;
        align-items: stretch !important;
      }

      .checklist-header > div:last-child > * {
        width: 100% !important;
        padding: 1rem !important;
        font-size: 1rem !important;
        text-align: center !important;
        min-height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Make the pass percentage display wider */
      #gallery-score {
        padding: 1rem 1.5rem !important;
        font-size: 1.2rem !important;
        min-height: 60px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Make back button wider */
      .checklist-header button[onclick*="showChecklistOverview"] {
        width: 100% !important;
        min-height: 50px !important;
        font-size: 1rem !important;
      }

      /* Mobile Header Styles */
      /* Hide desktop header on mobile */
      .desktop-header,
      .modern-header:not(.mobile-header) {
        display: none !important;
      }
      
      /* Show mobile header */
      .mobile-header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 50 !important;
        background: rgba(255,255,255,.95) !important;
        backdrop-filter: blur(12px) !important;
        border-bottom: 1px solid rgba(0,0,0,.08) !important;
        height: 60px !important;
      }
      
      .mobile-header-content {
        display: flex !important;
        align-items: center !important;
        height: 100% !important;
        padding: 0 1rem !important;
        box-sizing: border-box !important;
      }
      
      .mobile-header-left {
        flex: 0 0 auto !important;
        margin-right: auto !important;
      }
      
      .mobile-header-center {
        flex: 1 1 auto !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 1rem !important;
      }
      
      .mobile-header-right {
        flex: 0 0 auto !important;
        margin-left: auto !important;
      }
      
      /* Hamburger Menu Button */
      .mobile-hamburger-btn {
        width: 44px !important;
        height: 44px !important;
        border: none !important;
        background: transparent !important;
        cursor: pointer !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 4px !important;
        padding: 10px !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        box-sizing: border-box !important;
      }
      
      .mobile-hamburger-btn:hover {
        background: rgba(0,0,0,.05) !important;
      }
      
      .hamburger-line {
        width: 20px !important;
        height: 2px !important;
        background: #45494e !important;
        border-radius: 1px !important;
        transition: all 0.3s ease !important;
      }
      
      .mobile-hamburger-btn.active .hamburger-line:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px) !important;
      }
      
      .mobile-hamburger-btn.active .hamburger-line:nth-child(2) {
        opacity: 0 !important;
      }
      
      .mobile-hamburger-btn.active .hamburger-line:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -6px) !important;
      }
      
      .mobile-brand-text {
        font-weight: 700 !important;
        font-size: 1.1rem !important;
        color: #45494e !important;
        letter-spacing: .3px !important;
        white-space: nowrap !important;
      }
      
      /* Mobile User Profile Button */
      .mobile-user-profile-btn {
        width: 44px !important;
        height: 44px !important;
        border-radius: 50% !important;
        border: 2px solid rgba(0,0,0,.08) !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: 600 !important;
        font-size: .9rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2) !important;
        overflow: hidden !important;
        position: relative !important;
        box-sizing: border-box !important;
      }
      
      .mobile-user-profile-btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
      }
      
      .mobile-profile-image {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        border-radius: 50% !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
      }
      
      .mobile-user-initials {
        position: relative !important;
        z-index: 1 !important;
      }
      
      /* Mobile Dropdown Menu */
      .mobile-user-profile-dropdown {
        position: relative !important;
      }
      
      .mobile-profile-dropdown-menu {
        position: absolute !important;
        right: 0 !important;
        top: calc(100% + 8px) !important;
        background: white !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,.12) !important;
        border: 1px solid rgba(0,0,0,.08) !important;
        min-width: 280px !important;
        max-height: 80vh !important;
        overflow-y: auto !important;
        transform: translateY(-8px) !important;
        opacity: 0 !important;
        visibility: hidden !important;
        transition: all 0.3s ease !important;
        z-index: 100 !important;
      }
      
      .mobile-profile-dropdown-menu.active {
        transform: translateY(0) !important;
        opacity: 1 !important;
        visibility: visible !important;
      }
      
      /* Mobile Dropdown Header */
      .mobile-dropdown-header {
        padding: 1rem !important;
        display: flex !important;
        align-items: center !important;
        gap: .75rem !important;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
        border-radius: 12px 12px 0 0 !important;
      }
      
      .mobile-dropdown-user-avatar {
        width: 48px !important;
        height: 48px !important;
        border-radius: 50% !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: white !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
        flex-shrink: 0 !important;
        overflow: hidden !important;
        position: relative !important;
      }
      
      .mobile-dropdown-user-image {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        border-radius: 50% !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
      }
      
      .mobile-dropdown-user-initials {
        position: relative !important;
        z-index: 1 !important;
      }
      
      .mobile-dropdown-user-info {
        display: flex !important;
        flex-direction: column !important;
        gap: .25rem !important;
      }
      
      .mobile-dropdown-user-name {
        font-weight: 600 !important;
        color: #1e293b !important;
        font-size: 1rem !important;
      }
      
      .mobile-dropdown-user-email {
        font-size: .85rem !important;
        color: #64748b !important;
      }
      
      /* Mobile Dropdown Sections */
      .mobile-dropdown-section {
        padding: .5rem 0 !important;
      }
      
      .mobile-dropdown-section-title {
        padding: .5rem 1rem !important;
        font-size: .75rem !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: .5px !important;
        color: #64748b !important;
      }
      
      .mobile-dropdown-divider {
        height: 1px !important;
        background: rgba(0,0,0,.08) !important;
        margin: .5rem 0 !important;
      }
      
      
      /* Mobile Dropdown Items */
      .mobile-dropdown-item {
        display: flex !important;
        align-items: center !important;
        gap: .75rem !important;
        padding: .75rem 1rem !important;
        width: 100% !important;
        background: none !important;
        border: none !important;
        color: #334155 !important;
        text-align: left !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
      }
      
      .mobile-dropdown-item:hover {
        background: rgba(102, 126, 234, 0.08) !important;
        color: #667eea !important;
      }
      
      .mobile-dropdown-signout {
        color: #dc2626 !important;
      }
      
      .mobile-dropdown-signout:hover {
        background: rgba(220, 38, 38, 0.08) !important;
        color: #dc2626 !important;
      }
      
      /* Adjust body padding for mobile header */
      body {
        padding-top: 60px !important;
      }

      /* Hide desktop header on mobile but allow sidebar to show */
      #header-container {
        display: none !important;
      }

      /* Allow sidebar and overlay to work on mobile */
      #sidebar-container,
      .sidebar-overlay {
        display: block !important;
      }
    }

    /* Desktop styles remain unchanged */
    @media (min-width: 769px) {
      .mobile-header {
        display: none !important;
      }
      
      .desktop-header,
      .modern-header:not(.mobile-header) {
        display: block !important;
      }
      
      body {
        padding-top: 0 !important;
      }

      #header-container {
        display: block !important;
      }

      .sidebar-overlay,
      #sidebar-container {
        display: block !important;
      }
    }
  </style>
</head>
<body>
<script>
console.log('🚀 CACHE BUSTED: Glass Morphism HTML loaded - Version 2025-08-12!');
console.log('🎨 If you still see old styling, try hard refresh (Ctrl+F5 or Cmd+Shift+R)');
</script>

<!-- Mobile Header (visible only on mobile) -->
<header class="mobile-header">
  <div class="mobile-header-content">
    <div class="mobile-header-left">
      <button class="mobile-hamburger-btn" id="mobile-hamburger-btn" aria-label="Open menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
    <div class="mobile-header-center">
      <div class="mobile-brand-text">Castle Comms</div>
    </div>
    <div class="mobile-header-right">
      <div class="mobile-user-profile-dropdown">
        <button class="mobile-user-profile-btn" id="mobile-user-profile-btn">
          <img class="mobile-profile-image" id="mobile-profile-image" style="display: none;" alt="Profile">
          <span class="mobile-user-initials" id="mobile-user-initials">MD</span>
        </button>
        <div class="mobile-profile-dropdown-menu" id="mobile-profile-dropdown-menu">
          <!-- User Info Section -->
          <div class="mobile-dropdown-header">
            <div class="mobile-dropdown-user-avatar">
              <img class="mobile-dropdown-user-image" id="mobile-dropdown-user-image" style="display: none;" alt="Profile">
              <span class="mobile-dropdown-user-initials" id="mobile-dropdown-user-initials">MD</span>
            </div>
            <div class="mobile-dropdown-user-info">
              <span class="mobile-dropdown-user-name" id="mobile-dropdown-user-name">Loading...</span>
              <span class="mobile-dropdown-user-email" id="mobile-dropdown-user-email">Loading...</span>
            </div>
          </div>
          
          <!-- Account Section -->
          <div class="mobile-dropdown-divider"></div>
          <div class="mobile-dropdown-section">
            <button class="mobile-dropdown-item" id="mobile-account-settings-btn">
              <span>Account Settings</span>
            </button>
            <button class="mobile-dropdown-item" id="mobile-change-password-btn">
              <span>Change Password</span>
            </button>
            <button class="mobile-dropdown-item mobile-dark-mode-toggle" onclick="toggleDarkMode()">
              <span>Dark Mode: Off</span>
            </button>
            <button class="mobile-dropdown-item mobile-dropdown-signout" id="mobile-profile-signout-btn">
              <span>Sign Out</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
  
<div id="header-container"></div>

<div id="sidebar-container"></div>
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<main id="main" class="modern-main">
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-button active" data-tab="home">Home</button>
    <button class="tab-button" data-tab="tasks">Tasks</button>
    <button class="tab-button" data-tab="forms">Forms</button>
    <button class="tab-button" data-tab="communications">Communications</button>
    <button class="tab-button" data-tab="checklists">Checklists</button>
  </div>

  <!-- Home Tab Content (Original home page) -->
  <div class="tab-content active" id="home-tab">
    <!-- Quicklinks Section -->
    <section class="quicklinks-section">
      <h2 class="section-title">Quicklinks</h2>
      <div class="modern-quick-links">
      <a href="http://192.168.28.246/CGNET2024/rptLeagueTable.aspx" target="_blank" title="Target League Table" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">League Table</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="https://secure.workforceready.eu/ta/6164422.home?rnd=FRX&showAdmin=1&Ext=clock&sft=YLYWTXGNBA&ActiveSessionId=5177576674#home" target="_blank" title="Kronos" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Kronos</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="http://192.168.28.246/cgnet2024/login.aspx" target="_blank" title="CGNet" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">CGNet</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="http://www.castlefineart.com/" target="_blank" title="CFA Website" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">CFA Website</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="https://castlefineart.storiq.net/files?expandedFolder=%2FCompliance%2F&bucket_key=castlefineart-storiq-net" target="_blank" title="Anti Money Laundering" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Anti Money Laundering</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="https://washingtongreen.pagetiger.com/bimunif" target="_blank" title="Gallery Technician Manual" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Technician Manual</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="https://washingtongreen.pagetiger.com/ibmxza" target="_blank" title="Gallery Manual" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Gallery Manual</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
      <a href="https://app.powerbi.com/reportEmbed?reportId=5a5e361e-661c-41c9-90ae-821b46de10ae&autoAuth=true&ctid=61920045-21d7-47e7-a0c1-3a915893488a" target="_blank" title="YTD Sales Report 2025" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Sales YTD</span>
          <span class="quicklink-arrow">→</span>
        </div>
      </a>
    </div>
    </section>

    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
      <div class="dashboard-card" id="newsfeed-card">
        <h3>Newsfeed Posts</h3>
        <div class="card-content" id="newsfeed-content">
          <div class="loading">Loading recent posts...</div>
        </div>
        <div class="card-button-container">
          <a href="newsfeed.html" class="card-button">View Newsfeed</a>
        </div>
      </div>
      
      <div class="dashboard-card" id="messages-card">
        <h3>Messages</h3>
        <div class="card-content" id="messages-content">
          <div class="loading">Loading latest messages...</div>
        </div>
        <div class="card-button-container">
          <a href="messages.html" class="card-button">View Messages</a>
        </div>
      </div>
      
      <div class="dashboard-card" id="tickets-card">
        <h3>Tickets</h3>
        <div class="card-content" id="tickets-content">
          <div class="loading">Loading latest tickets...</div>
        </div>
        <div class="card-button-container">
          <a href="tickets.html" class="card-button">View/Add Tickets</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Tab Content -->
  <div class="tab-content" id="tasks-tab">
    <div class="tasks-container" style="max-width: 1200px; margin: 0 auto; padding: 2rem; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius, 12px); box-shadow: var(--shadow-medium, 0 4px 20px rgba(0,0,0,0.1)); backdrop-filter: blur(10px);">
      <div class="tasks-header" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="margin: 0; font-size: 2.5rem; font-weight: 600; background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">📋 Tasks</h1>
      </div>
      
      <!-- Task Filters -->
      <div class="task-filters" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: center;">
        <button class="task-filter-button active" data-filter="all" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">All Tasks</button>
        <button class="task-filter-button" data-filter="in-progress" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">In Progress</button>
        <button class="task-filter-button" data-filter="completed" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Completed</button>
        <button class="task-filter-button" data-filter="overdue" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Overdue</button>
      </div>
      
      <!-- Tasks List -->
      <div class="tasks-list" id="tasks-list" style="display: grid; gap: 1rem;">
        <!-- Tasks will be populated by JavaScript -->
        <div id="no-tasks-message" style="text-align: center; padding: 3rem; color: #6c757d; background: white; border-radius: 12px; border: 1px solid #e9ecef;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
          <h3 style="margin: 0 0 0.5rem 0; color: #495057;">No Tasks Yet</h3>
          <p style="margin: 0; color: #6c757d;">Tasks will appear here when you mark checklist items as failed and choose to create tasks from them.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Forms Tab Content -->
  <div class="tab-content" id="forms-tab">
    <div style="text-align: center; padding: 4rem 2rem; color: #666;">
      <h2>Forms</h2>
      <p>Form management coming soon...</p>
    </div>
  </div>

  <!-- Communications Tab Content -->
  <div class="tab-content" id="communications-tab">
    <div class="communications-container" style="max-width: 1000px; margin: 0 auto; padding: 2rem; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius, 12px); box-shadow: var(--shadow-medium, 0 4px 20px rgba(0,0,0,0.1)); backdrop-filter: blur(10px);">
      <div class="communications-header" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="margin: 0; font-size: 2.5rem; font-weight: 600; background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">📢 Communications</h1>
      </div>
      
      <!-- Communications Admin Section (only visible to admins and communications admins) -->
      <div class="admin-section" data-communications-admin style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; display: none;">
        <h3 style="color: #856404; margin: 0 0 1rem 0; font-size: 1.3rem;">📢 Communications Admin</h3>
        <p style="color: #856404; margin: 0 0 1rem 0; font-size: 0.9rem;">
          Create and manage company-wide communications, announcements, and updates.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-start; flex-wrap: wrap;">
          <a href="communications-admin.html" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
            ✏️ Create New Communication
          </a>
          <a href="news-mentions.html" style="background: #28a745; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
            📰 Manage News & Media
          </a>
        </div>
      </div>
      
      <!-- News and Media Mentions Section -->
      <div class="news-mentions-section" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
        <h3 style="color: #495057; margin: 0 0 1rem 0; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem;">📰 News and Media Mentions</h3>
        <p style="color: #6c757d; margin: 0 0 1rem 0; font-size: 0.9rem;">
          View and manage news articles, media mentions, and press coverage.
        </p>
        <a href="news-mentions.html" style="background: #45494e; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
          📰 View News & Media
        </a>
      </div>
      
      <div class="communications-filters" id="comm-filters" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="comm-filter-button active" data-filter="all" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">All</button>
        <button class="comm-filter-button" data-filter="unread" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Unread</button>
        <button class="comm-filter-button" data-filter="urgent" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Urgent</button>
        <button class="comm-filter-button" data-filter="documents" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">With Documents</button>
        <button class="comm-filter-button" data-filter="powerbi" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">With Data</button>
        <button class="comm-filter-button" data-filter="tasks" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">With Tasks</button>
      </div>
      
      <div class="communications-list" id="communications-list">
        <div class="loading" style="text-align: center; padding: 3rem; color: #6c757d;">Loading communications...</div>
      </div>
    </div>
  </div>

  <!-- Checklists Tab Content -->
  <div class="tab-content" id="checklists-tab">
    <div class="checklists-container" style="max-width: 1200px; margin: 0 auto; padding: 2rem; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius, 12px); box-shadow: var(--shadow-medium, 0 4px 20px rgba(0,0,0,0.1)); backdrop-filter: blur(10px);">
      <div class="checklists-header" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="margin: 0; font-size: 2.5rem; font-weight: 600; background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">📋 Checklists</h1>
      </div>
      
      <div class="checklist-navigation" style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center; flex-wrap: wrap;">
        <button class="checklist-nav-button active" data-checklist="gallery" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s;">Gallery Checklist</button>
      </div>
      
      <!-- Checklist Overview Page -->
      <div class="checklist-content active" id="checklist-overview">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h2 style="margin: 0; font-size: 1.8rem; color: #2c3e50;">Available Checklists</h2>
          <div style="display: flex; gap: 1rem;">
            <button onclick="showCreateChecklist()" style="background: #28a745; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+ Create Checklist</button>
            <button onclick="showChecklistHistory()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">View History</button>
          </div>
        </div>
        
        <div class="checklist-cards" id="checklist-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
          <!-- Checklists will be populated by JavaScript -->
        </div>
      </div>

      <!-- Checklist History Page -->
      <div class="checklist-content" id="checklist-history" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h2 style="margin: 0; font-size: 1.8rem; color: #2c3e50;">Checklist History</h2>
          <button onclick="showChecklistOverview()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">← Back to Checklists</button>
        </div>
        
        <div class="history-section">
          <h3 style="color: #2c3e50; margin-bottom: 1rem;">Gallery Weekly Checklist</h3>
          <div id="gallery-history-list" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <!-- History items will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Create Checklist Page -->
      <div class="checklist-content" id="create-checklist" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h2 style="margin: 0; font-size: 1.8rem; color: #2c3e50;">Create New Checklist</h2>
          <button onclick="showChecklistOverview()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">← Back to Checklists</button>
        </div>
        
        <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <!-- Basic Info -->
          <div style="margin-bottom: 2rem;">
            <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">Checklist Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Checklist Name</label>
                <input type="text" id="new-checklist-name" placeholder="e.g. Monthly Safety Checklist" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Category</label>
                <select id="new-checklist-category" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                  <option value="gallery">Gallery</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="safety">Safety</option>
                  <option value="security">Security</option>
                  <option value="admin">Administrative</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Description</label>
              <textarea id="new-checklist-description" placeholder="Brief description of what this checklist covers..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; min-height: 80px; resize: vertical;"></textarea>
            </div>
          </div>
          
          <!-- Checklist Items -->
          <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0; color: #2c3e50;">Checklist Items</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="addChecklistItem('text')" style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">+ Text Item</button>
                <button onclick="addChecklistItem('photo')" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">+ Photo Item</button>
                <button onclick="addChecklistItem('number')" style="background: #ffc107; color: black; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">+ Number Item</button>
                <button onclick="addChecklistItem('comment')" style="background: #6f42c1; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">+ Comment Item</button>
              </div>
            </div>
            
            <div id="checklist-items-builder" style="background: #f8f9fa; border-radius: 8px; padding: 1rem; min-height: 200px;">
              <div style="text-align: center; color: #6c757d; padding: 2rem;">
                Click the buttons above to add items to your checklist
              </div>
            </div>
          </div>
          
          <!-- Save Button -->
          <div style="text-align: right;">
            <button onclick="saveNewChecklist()" style="background: #28a745; color: white; border: none; padding: 1rem 2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1.1rem;">Save Checklist</button>
          </div>
        </div>
      </div>

      <!-- Gallery Checklist Form -->
      <div class="checklist-content" id="gallery-checklist-form" style="display: none;">
        <div class="checklist-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="showChecklistOverview()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">← Back</button>
            <h2 style="margin: 0; font-size: 1.8rem; color: #2c3e50;">WEEKLY GALLERY CHECKLIST</h2>
          </div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <div class="checklist-score" id="gallery-score" style="background: #6c757d; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 1.1rem;">0/11 Pass (0%)</div>
            <button onclick="saveChecklist()" style="background: #28a745; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">Save Checklist</button>
            <button onclick="exportToPDF('gallery')" style="background: #dc3545; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">PDF</button>
          </div>
        </div>
        
        <!-- Photo Upload Section -->
        <div class="photo-upload-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
          <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">📸 Upload All Photos</h3>
          <p style="margin: 0 0 1rem 0; color: #6c757d;">Upload all photos for this checklist (overview photos of windows, viewing room, stockroom, gallery, etc.)</p>
          <input type="file" id="all-photos-upload" accept="image/*" multiple style="margin-bottom: 1rem;">
          <div id="all-photos-display" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
        </div>

        <div class="checklist-items" id="gallery-items">
          <!-- Items will be populated by JavaScript -->
        </div>
        
        <div class="signature-section" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
          <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">Reviewer signature</h3>
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <input type="text" id="signature-name" placeholder="Enter your name" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; min-width: 200px;">
            <button onclick="addSignature()" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">Add Signature</button>
            <button onclick="clearSignature()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">Clear</button>
          </div>
          <div id="signature-display" style="margin-top: 1rem; padding: 1rem; background: #e9ecef; border-radius: 8px; min-height: 60px; display: flex; align-items: center; font-size: 1.2rem; font-style: italic; color: #495057;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Background Slideshow -->
  <div class="background-slideshow" id="background-slideshow">
    <!-- Images will be injected by JavaScript -->
  </div>

  <!-- Commented Out Gallery for Testing -->
  <!--
  <section class="gallery-section">
    <h2 class="gallery-title">Inside Spitfire</h2>
    
    <div class="gallery-container">
      <div class="gallery-main">
        <div class="gallery-viewer">
          <img id="gallery-main-image" src="images/web-optimized/1.jpg" alt="Gallery Image" loading="lazy">
          <div class="gallery-nav">
            <button class="gallery-btn gallery-prev" id="gallery-prev">‹</button>
            <button class="gallery-btn gallery-next" id="gallery-next">›</button>
          </div>
          <div class="gallery-counter">
            <span id="gallery-current">1</span> / <span id="gallery-total">21</span>
          </div>
        </div>
      </div>
      
      <div class="gallery-thumbnails" id="gallery-thumbnails">
      </div>
    </div>
  </section>
  -->
</main>

<!-- jsPDF Library for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<!-- Site scripts -->
<script src="script.js"></script>

<!-- Notification system -->

<script>

// Tab Functionality
function initializeTabs() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabId = button.getAttribute('data-tab');
      
      // Remove active class from all buttons and contents
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked button and corresponding content
      button.classList.add('active');
      document.getElementById(`${tabId}-tab`).classList.add('active');
      
      // Initialize checklists when checklists tab is clicked
      if (tabId === 'checklists') {
        setTimeout(async () => {
          console.log('Checklists tab clicked - initializing...');
          await initializeChecklists();
        }, 100);
      }
    });
  });
}

// Communications Functionality
let db;
let currentUser;
let currentCommFilter = 'all';

function initializeCommunications() {
  // Check authentication first
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.log('User not authenticated for communications');
      return;
    }

    currentUser = user;
    
    // Show/hide admin sections based on permissions
    if (window.authUtils) {
      const isCommunicationsAdmin = await window.authUtils.isCommunicationsAdmin(user);
      const adminSection = document.querySelector('[data-communications-admin]');
      if (adminSection) {
        adminSection.style.display = isCommunicationsAdmin ? 'block' : 'none';
      }
    }
    
    // Initialize Firebase Firestore
    if (firebase.apps.length > 0) {
      db = firebase.firestore();
      setupCommunicationsFilters();
      loadCommunications();
    } else {
      console.error('Firebase not initialized for communications');
    }
  });
}

// Setup communications filter buttons
function setupCommunicationsFilters() {
  const filterButtons = document.querySelectorAll('.comm-filter-button');
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Update active state
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#6c757d';
        btn.style.border = '1px solid #e1e5e9';
      });
      button.classList.add('active');
      button.style.background = 'var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%))';
      button.style.color = 'white';
      button.style.border = 'none';
      
      // Update current filter
      currentCommFilter = button.dataset.filter;
      
      // Reload communications with filter
      loadCommunications();
    });
  });
}

// Load communications
async function loadCommunications() {
  const communicationsList = document.getElementById('communications-list');
  
  if (!db || !currentUser) {
    communicationsList.innerHTML = '<div class="loading">Please log in to view communications.</div>';
    return;
  }
  
  try {
    const communications = await db.collection('communications')
      .orderBy('createdAt', 'desc')
      .get();
    
    if (communications.empty) {
      communicationsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">No communications yet.</div>';
      return;
    }
    
    let filteredCommunications = communications.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Apply filter
    filteredCommunications = applyCommFilter(filteredCommunications);
    
    if (filteredCommunications.length === 0) {
      communicationsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">No communications match the current filter.</div>';
      return;
    }
    
    const communicationItems = await Promise.all(filteredCommunications.map(async (comm) => {
      const isRead = await isUserReadComm(comm.id);
      const documents = comm.documents || [];
      const powerbiItems = comm.powerbi || [];
      const tasks = comm.tasks || [];
      
      // Create badges
      const badges = [];
      if (!isRead) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #667eea; color: white;">New</span>');
      if (comm.urgent) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #ffebee; color: #c62828;">Urgent</span>');
      if (documents.length > 0) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #e3f2fd; color: #1565c0;">📎 Documents</span>');
      if (powerbiItems.length > 0) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #fff3e0; color: #ef6c00;">📊 Data</span>');
      if (tasks.length > 0) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #f3e5f5; color: #7b1fa2;">✓ Tasks</span>');
      
      return `
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; transition: all 0.3s; border-left: 4px solid ${!isRead ? '#667eea' : 'transparent'}; ${comm.urgent ? 'border-left-color: #dc3545;' : ''} margin-bottom: 1.5rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">
          <div style="padding: 1.5rem; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="toggleCommunication('${comm.id}')">
            <div style="font-size: 1.3rem; font-weight: 600; color: #2c3e50; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
              ${comm.title}
              ${comm.urgent ? '🚨' : ''}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #6c757d; margin-bottom: 0.5rem;">
              <span>Published: ${formatCommTimestamp(comm.createdAt?.toDate?.() || new Date())}</span>
              <button style="background: none; border: none; color: #667eea; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" id="expand-btn-${comm.id}">
                <span>View Details</span>
                <span style="transition: transform 0.3s;">▼</span>
              </button>
            </div>
            <div style="color: #495057; line-height: 1.5; margin-bottom: 1rem;">${comm.summary || comm.content.substring(0, 200)}...</div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${badges.join('')}
            </div>
          </div>
          
          <div id="content-${comm.id}" style="display: none; padding: 1.5rem; border-top: 1px solid #f0f0f0;">
            <div style="line-height: 1.6; margin-bottom: 2rem;">${comm.content}</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
              <button onclick="toggleReadStatus('${comm.id}')" style="background: ${isRead ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                ${isRead ? 'Mark as Unread' : 'Mark as Read'}
              </button>
            </div>
          </div>
        </div>
      `;
    }));
    
    communicationsList.innerHTML = communicationItems.join('');
    
  } catch (error) {
    console.error('Error loading communications:', error);
    communicationsList.innerHTML = '<div style="background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">Failed to load communications.</div>';
  }
}

// Apply current filter
function applyCommFilter(communications) {
  if (currentCommFilter === 'all') return communications;
  
  return communications.filter(comm => {
    switch (currentCommFilter) {
      case 'unread':
        return !isUserReadSyncComm(comm.id);
      case 'urgent':
        return comm.urgent;
      case 'documents':
        return comm.documents && comm.documents.length > 0;
      case 'powerbi':
        return comm.powerbi && comm.powerbi.length > 0;
      case 'tasks':
        return comm.tasks && comm.tasks.length > 0;
      default:
        return true;
    }
  });
}

// Toggle communication expanded state
function toggleCommunication(commId) {
  const content = document.getElementById(`content-${commId}`);
  const expandBtn = document.getElementById(`expand-btn-${commId}`);
  
  if (content.style.display === 'none' || !content.style.display) {
    content.style.display = 'block';
    expandBtn.querySelector('span:last-child').style.transform = 'rotate(180deg)';
    expandBtn.querySelector('span:first-child').textContent = 'Hide Details';
  } else {
    content.style.display = 'none';
    expandBtn.querySelector('span:last-child').style.transform = 'rotate(0deg)';
    expandBtn.querySelector('span:first-child').textContent = 'View Details';
  }
}

// Check if user has read a communication
async function isUserReadComm(commId) {
  try {
    const readDoc = await db.collection('communication-reads')
      .where('communicationId', '==', commId)
      .where('userId', '==', currentUser.uid)
      .get();
    
    return !readDoc.empty;
  } catch (error) {
    console.error('Error checking read status:', error);
    return false;
  }
}

// Synchronous version for filtering
function isUserReadSyncComm(commId) {
  return false; // Default to unread for filtering
}

// Toggle read status
async function toggleReadStatus(commId) {
  try {
    const readQuery = db.collection('communication-reads')
      .where('communicationId', '==', commId)
      .where('userId', '==', currentUser.uid);
    
    const readDocs = await readQuery.get();
    
    if (readDocs.empty) {
      // Mark as read
      await db.collection('communication-reads').add({
        communicationId: commId,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        readAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      // Mark as unread
      const batch = db.batch();
      readDocs.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
    }
    
    // Reload communications
    loadCommunications();
    
  } catch (error) {
    console.error('Error toggling read status:', error);
  }
}

// Format timestamp
function formatCommTimestamp(timestamp) {
  if (!timestamp) return 'Just now';
  
  const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  
  return date.toLocaleDateString();
}

// Dashboard Cards Functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tabs
  initializeTabs();
  
  // Initialize communications functionality
  initializeCommunications();
  
  // CSS Debug - Check if new glass morphism styles are loaded
  console.log('✨ GLASS MORPHISM: New design loaded with modern-quick-links!');
  
  const modernQuickLinks = document.querySelector('.modern-quick-links');
  if (modernQuickLinks) {
    const styles = window.getComputedStyle(modernQuickLinks);
    console.log('🔍 NEW: Modern glass morphism quicklinks styles:', {
      display: styles.display,
      gap: styles.gap,
      gridTemplateColumns: styles.gridTemplateColumns,
      background: styles.background,
      backdropFilter: styles.backdropFilter
    });
    
    const allLinks = modernQuickLinks.querySelectorAll('.modern-quicklink');
    console.log(`🔍 Found ${allLinks.length} modern glass morphism buttons`);
    
    allLinks.forEach((link, index) => {
      const linkStyles = window.getComputedStyle(link);
      console.log(`🔍 Glass Button ${index + 1} styles:`, {
        background: linkStyles.background,
        backdropFilter: linkStyles.backdropFilter,
        borderRadius: linkStyles.borderRadius,
        boxShadow: linkStyles.boxShadow
      });
    });
  } else {
    console.log('❌ Modern quicklinks container not found - check HTML structure');
  }
  
  // Load dashboard data when user is authenticated
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      loadDashboardData();
    }
  });

  async function loadDashboardData() {
    loadNewsfeedMentions();
    loadLatestMessages();
    loadLatestTickets();
  }

  async function loadNewsfeedMentions() {
    const container = document.getElementById('newsfeed-content');
    try {
      // Load posts from Firebase Database (same path as script.js uses)
      const postsRef = firebase.database().ref('posts');
      const snapshot = await postsRef.orderByKey().limitToLast(5).once('value');
      const data = snapshot.val();
      
      if (data) {
        const items = Object.values(data).reverse();
        container.innerHTML = items.map(item => `
          <div class="item">
            <div class="item-header">${item.name || 'Anonymous'}</div>
            <div class="item-meta">${formatDate(item.timestamp)}</div>
            <div class="item-content">${item.message || item.content || 'No content available'}</div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="no-data">No recent posts found</div>';
      }
    } catch (error) {
      console.error('Error loading newsfeed:', error);
      container.innerHTML = '<div class="no-data">Error loading posts</div>';
    }
  }

  // Helper function to format message content for preview
  function formatMessagePreview(message) {
    if (!message) return 'No message content';
    
    // Check if message contains .gif anywhere in the URL (case insensitive)
    if (message.toLowerCase().includes('.gif')) {
      return 'GIF';
    }
    
    return message;
  }

  async function loadLatestMessages() {
    const container = document.getElementById('messages-content');
    try {
      // Try Firestore first, then fallback to showing recent post comments as "messages"
      if (firebase.firestore) {
        try {
          const db = firebase.firestore();
          const currentUser = firebase.auth().currentUser;
          
          // First, get chats where the user is a participant
          const chatsSnapshot = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.email)
            .get();
          
          if (!chatsSnapshot.empty) {
            const chatIds = chatsSnapshot.docs.map(doc => doc.id);
            
            // Get recent messages from those chats
            const messagesSnapshot = await db.collection('chat-messages')
              .where('chatId', 'in', chatIds.slice(0, 10)) // Firestore 'in' has limit of 10
              .orderBy('timestamp', 'desc')
              .limit(5)
              .get();
            
            if (!messagesSnapshot.empty) {
              // Get chat names for display
              const chatLookup = {};
              chatsSnapshot.docs.forEach(doc => {
                chatLookup[doc.id] = doc.data().name;
              });
              
              const items = messagesSnapshot.docs.map(doc => doc.data());
              container.innerHTML = items.map(item => `
                <div class="item">
                  <div class="item-header">${chatLookup[item.chatId] || 'Chat'}</div>
                  <div class="item-meta">${item.senderName || 'Unknown'} • ${formatDate(item.timestamp?.toDate?.() || item.timestamp)}</div>
                  <div class="item-content">${formatMessagePreview(item.message)}</div>
                </div>
              `).join('');
              return;
            }
          }
          
          console.log('No chat messages found, trying all messages...');
          // Fallback: try to get any recent messages
          const allMessagesSnapshot = await db.collection('chat-messages')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get();
          
          if (!allMessagesSnapshot.empty) {
            const items = allMessagesSnapshot.docs.map(doc => doc.data());
            container.innerHTML = items.map(item => `
              <div class="item">
                <div class="item-header">Chat Message</div>
                <div class="item-meta">${item.senderName || 'Unknown'} • ${formatDate(item.timestamp?.toDate?.() || item.timestamp)}</div>
                <div class="item-content">${formatMessagePreview(item.message)}</div>
              </div>
            `).join('');
            return;
          }
        } catch (firestoreError) {
          console.log('Firestore not accessible, using fallback...', firestoreError);
        }
      }
      
      // Fallback: Show recent activity from posts (comments as "messages")
      const postsRef = firebase.database().ref('posts');
      const snapshot = await postsRef.orderByKey().limitToLast(10).once('value');
      const data = snapshot.val();
      
      if (data) {
        const recentActivity = [];
        Object.values(data).forEach(post => {
          if (post.comments) {
            Object.values(post.comments).forEach(comment => {
              recentActivity.push({
                type: 'comment',
                postTitle: post.message?.substring(0, 30) + '...' || 'Post',
                author: 'User',
                content: comment.text || comment.content || comment,
                timestamp: comment.timestamp || Date.now()
              });
            });
          }
        });
        
        // Sort by timestamp and get latest 5
        recentActivity.sort((a, b) => b.timestamp - a.timestamp);
        const latest = recentActivity.slice(0, 5);
        
        if (latest.length > 0) {
          container.innerHTML = latest.map(item => `
            <div class="item">
              <div class="item-header">Comment on: ${item.postTitle}</div>
              <div class="item-meta">${item.author} • ${formatDate(item.timestamp)}</div>
              <div class="item-content">${item.content}</div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="no-data">No recent activity found</div>';
        }
      } else {
        container.innerHTML = '<div class="no-data">No recent messages found</div>';
      }
    } catch (error) {
      console.error('Error loading messages:', error);
      container.innerHTML = '<div class="no-data">Error loading messages</div>';
    }
  }

  async function loadLatestTickets() {
    const container = document.getElementById('tickets-content');
    try {
      // Try Firestore first, then fallback to placeholder tickets
      if (firebase.firestore) {
        try {
          const db = firebase.firestore();
          const currentUser = firebase.auth().currentUser;
          
          // Check if user is admin - only admins can see all tickets
          let isFullAdmin = false;
          if (currentUser && window.authUtils) {
            isFullAdmin = await window.authUtils.isAdmin(currentUser);
          }
          
          let allTickets = [];
          
          if (isFullAdmin) {
            // Admins see all tickets
            const query = db.collection('tickets').orderBy('createdAt', 'desc').limit(10);
            const snapshot = await query.get();
            allTickets = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
          } else if (currentUser) {
            // Load user's teams first
            const userTeams = await getUserTeams(currentUser.email);
            
            // Collect tickets from multiple sources
            const queries = [];
            
            // 1. Tickets created by user
            queries.push(
              db.collection('tickets')
                .where('createdBy.email', '==', currentUser.email)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
            );
            
            // 2. Tickets assigned to user individually
            queries.push(
              db.collection('tickets')
                .where('assignedTo.email', '==', currentUser.email)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
            );
            
            // 3. Tickets assigned to user's teams
            userTeams.forEach(team => {
              queries.push(
                db.collection('tickets')
                  .where('assignedTo.teamId', '==', team.id)
                  .orderBy('createdAt', 'desc')
                  .limit(5)
                  .get()
              );
            });
            
            // Execute all queries and combine results
            const results = await Promise.all(queries);
            const ticketMap = new Map(); // Use Map to deduplicate
            
            results.forEach(snapshot => {
              snapshot.docs.forEach(doc => {
                const ticket = {id: doc.id, ...doc.data()};
                // Only add if not already added (deduplication)
                if (!ticketMap.has(ticket.id)) {
                  ticketMap.set(ticket.id, ticket);
                }
              });
            });
            
            allTickets = Array.from(ticketMap.values())
              .sort((a, b) => {
                const aTime = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                const bTime = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                return bTime - aTime; // Most recent first
              })
              .slice(0, 5); // Limit to 5 most recent
          }
          
          if (allTickets.length > 0) {
            container.innerHTML = allTickets.map(item => {
              const assignmentInfo = getTicketAssignmentInfo(item, currentUser);
              return `
                <div class="item" onclick="window.open('tickets.html#ticket-${item.id}', '_blank')">
                  <div class="item-header">#${item.ticketId || 'N/A'} - ${item.title || 'Support Ticket'}</div>
                  <div class="item-meta">${item.status || 'Open'} • ${assignmentInfo} • ${formatDate(item.createdAt?.toDate?.() || item.createdAt)}</div>
                  <div class="item-content">${(item.description || 'No description available').substring(0, 100)}${item.description?.length > 100 ? '...' : ''}</div>
                </div>
              `;
            }).join('');
            return;
          }
        } catch (firestoreError) {
          console.log('Firestore tickets not accessible, using fallback...', firestoreError);
        }
      }
      
      // Fallback: Show getting started information about tickets
      container.innerHTML = `
        <div class="item">
          <div class="item-header">Welcome to Support Tickets</div>
          <div class="item-meta">System • Just now</div>
          <div class="item-content">Create your first support ticket to get started. Tickets help track and resolve issues efficiently.</div>
        </div>
        <div class="item">
          <div class="item-header">Ticket System Ready</div>
          <div class="item-meta">System • Ready</div>
          <div class="item-content">The ticketing system is ready for use. Visit the Tickets page to create and manage support requests.</div>
        </div>
      `;
      
    } catch (error) {
      console.error('Error loading tickets:', error);
      container.innerHTML = '<div class="no-data">Visit the Tickets page to create your first support ticket</div>';
    }
  }

  function formatDate(timestamp) {
    if (!timestamp) return 'Unknown time';
    const date = new Date(timestamp);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
  }

  // Get user's team memberships
  async function getUserTeams(userEmail) {
    try {
      const db = firebase.firestore();
      const teamsSnapshot = await db.collection('teams').get();
      
      const userTeams = [];
      teamsSnapshot.docs.forEach(doc => {
        const teamData = doc.data();
        if (teamData.members && teamData.members.some(member => member.email === userEmail)) {
          userTeams.push({
            id: doc.id,
            name: teamData.name,
            ...teamData
          });
        }
      });
      
      console.log(`Found ${userTeams.length} teams for user ${userEmail}:`, userTeams.map(t => t.name));
      return userTeams;
    } catch (error) {
      console.error('Error loading user teams:', error);
      return [];
    }
  }

  // Get ticket assignment information for display
  function getTicketAssignmentInfo(ticket, currentUser) {
    if (!ticket.assignedTo) return 'Unassigned';
    
    if (ticket.assignedTo.type === 'team') {
      return `Team: ${ticket.assignedTo.teamName}`;
    } else {
      // Individual assignment
      if (ticket.assignedTo.email === currentUser.email) {
        return 'Assigned to: You';
      } else {
        return `Assigned to: ${ticket.assignedTo.name || ticket.assignedTo.email}`;
      }
    }
  }
});

// Checklist functionality
const galleryChecklistItems = [
  { id: 'windows-photos', text: 'Overview photos of your windows taken' },
  { id: 'viewing-room-photos', text: 'Overview photos of your viewing room taken' },
  { id: 'stockroom-photos', text: 'Overview photos of your stockroom taken' },
  { id: 'gallery-photos', text: 'Overview photos of the entire gallery taken (4-6 photos)' },
  { id: 'fire-exits', text: 'All fire exits are clear' },
  { id: 'maintenance-requests', text: 'Maintenance requests sent through Maintenance team' },
  { id: 'kronos-updated', text: 'Kronos updated and submitted by EOD' },
  { id: 'comms-read', text: 'All teams have read through comms and confirmed' },
  { id: 'halcyon-photos', text: 'Pictures of Halcyon artwork/rooms added' },
  { id: 'originals-count', text: 'Number of originals on wall documented' },
  { id: 'sles-count', text: 'Number of SLEs on wall documented' }
];

let checklistState = {
  gallery: {
    items: {}, // pass/fail status for each item
    signature: '',
    allPhotos: [], // all uploaded photos
    comments: {}
  }
};

let savedChecklists = {
  gallery: [] // Array of completed checklists with timestamps
};

let customChecklists = []; // Array of custom checklist definitions
let currentChecklistBuilder = []; // Items being built in create mode
let currentChecklistId = null; // ID of checklist being filled out

// Loading state tracking
let checklistsLoaded = false;
let loadingChecklists = false;

console.log('Checklist variables loaded successfully:', galleryChecklistItems.length, 'items');

async function initializeChecklists() {
  console.log('Initializing checklist system...');
  
  // Wait for Firebase to be ready
  if (!db || !firebase.auth().currentUser) {
    console.log('Firebase not ready - waiting for authentication...');
    // Wait a bit and try again
    setTimeout(async () => {
      await initializeChecklists();
    }, 1000);
    return;
  }
  
  // Only load if not already loaded or loading
  if (!checklistsLoaded && !loadingChecklists) {
    loadingChecklists = true;
    await loadSavedChecklists();
    await loadCustomChecklists();
    checklistsLoaded = true;
    loadingChecklists = false;
  }
  
  await showChecklistOverview();
  console.log('Checklist initialization complete');
}

// Navigation functions
async function showChecklistOverview() {
  hideAllChecklistContent();
  document.getElementById('checklist-overview').style.display = 'block';
  
  // Show loading state
  const container = document.getElementById('checklist-cards');
  if (container) {
    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #6c757d;">Loading checklists...</div>';
  }
  
  // Ensure data is loaded before rendering - only load if not already loaded
  await checkUserAdminStatus(); // Check admin status for UI rendering
  if (!checklistsLoaded && !loadingChecklists) {
    loadingChecklists = true;
    await loadSavedChecklists();
    await loadCustomChecklists();
    checklistsLoaded = true;
    loadingChecklists = false;
  }
  
  renderChecklistOverview();
}

function showCreateChecklist() {
  hideAllChecklistContent();
  document.getElementById('create-checklist').style.display = 'block';
  clearChecklistBuilder();
}

function renderChecklistOverview() {
  const container = document.getElementById('checklist-cards');
  if (!container) return;
  
  let checklistsHTML = '';
  
  // Built-in Gallery checklist
  checklistsHTML += `
    <div class="checklist-card" onclick="startGalleryChecklist()" style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
      <h3 style="margin: 0 0 1rem 0; color: #2c3e50; font-size: 1.4rem;">📋 Gallery Weekly Checklist</h3>
      <p style="margin: 0 0 1rem 0; color: #6c757d;">Complete the weekly gallery inspection checklist including photos, fire exits, maintenance, and documentation.</p>
      <div style="color: #667eea; font-weight: 500;">11 items • Photos required</div>
    </div>
  `;
  
  // Custom checklists
  customChecklists.forEach(checklist => {
    const itemCount = checklist.items.length;
    const hasPhotos = checklist.items.some(item => item.type === 'photo');
    const categoryEmoji = getCategoryEmoji(checklist.category);
    
    checklistsHTML += `
      <div class="checklist-card" onclick="startCustomChecklist('${checklist.id}')" style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; border: 2px solid transparent; transition: all 0.3s;" onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
        <h3 style="margin: 0 0 1rem 0; color: #2c3e50; font-size: 1.4rem;">${categoryEmoji} ${checklist.name}</h3>
        <p style="margin: 0 0 1rem 0; color: #6c757d;">${checklist.description}</p>
        <div style="color: #667eea; font-weight: 500;">${itemCount} items${hasPhotos ? ' • Photos required' : ''}</div>
        ${isCurrentUserAdmin ? `
        <div style="position: absolute; top: 1rem; right: 1rem;">
          <button onclick="event.stopPropagation(); deleteCustomChecklist('${checklist.id}')" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Delete</button>
        </div>
        ` : ''}
      </div>
    `;
  });
  
  container.innerHTML = checklistsHTML;
}

function getCategoryEmoji(category) {
  const emojis = {
    gallery: '📋',
    maintenance: '🔧',
    safety: '⚠️',
    security: '🔒',
    admin: '📊',
    other: '📝'
  };
  return emojis[category] || '📝';
}

async function showChecklistHistory() {
  hideAllChecklistContent();
  document.getElementById('checklist-history').style.display = 'block';
  
  // Show loading state
  const container = document.getElementById('gallery-history-list');
  if (container) {
    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #6c757d;">Loading checklist history...</div>';
  }
  
  // Ensure data is loaded before rendering - only load if not already loaded
  if (!checklistsLoaded && !loadingChecklists) {
    loadingChecklists = true;
    await loadSavedChecklists();
    await loadCustomChecklists();
    checklistsLoaded = true;
    loadingChecklists = false;
  }
  
  renderChecklistHistory();
}

async function startGalleryChecklist() {
  currentChecklistId = null; // Reset to built-in checklist
  hideAllChecklistContent();
  document.getElementById('gallery-checklist-form').style.display = 'block';
  clearCurrentChecklist();
  
  // Load any saved progress for this checklist
  await loadFromFirebase();
  
  renderGalleryChecklist();
  updateScore();
}

function hideAllChecklistContent() {
  document.querySelectorAll('.checklist-content').forEach(el => {
    el.style.display = 'none';
  });
}

function clearCurrentChecklist() {
  checklistState.gallery = {
    items: {},
    signature: '',
    allPhotos: [],
    comments: {}
  };
}

// Checklist Builder Functions
function clearChecklistBuilder() {
  currentChecklistBuilder = [];
  document.getElementById('new-checklist-name').value = '';
  document.getElementById('new-checklist-description').value = '';
  document.getElementById('new-checklist-category').value = 'gallery';
  renderChecklistBuilder();
}

function addChecklistItem(type) {
  const itemId = Date.now();
  const item = {
    id: itemId,
    type: type,
    text: '',
    placeholder: ''
  };
  
  currentChecklistBuilder.push(item);
  renderChecklistBuilder();
}

function renderChecklistBuilder() {
  const container = document.getElementById('checklist-items-builder');
  if (!container) return;
  
  if (currentChecklistBuilder.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">Click the buttons above to add items to your checklist</div>';
    return;
  }
  
  const itemsHTML = currentChecklistBuilder.map((item, index) => {
    const typeInfo = getItemTypeInfo(item.type);
    
    return `
      <div class="builder-item" style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #e9ecef;">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="background: ${typeInfo.color}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
              ${typeInfo.label}
            </div>
            <span style="color: #6c757d; font-size: 0.9rem;">Item ${index + 1}</span>
          </div>
          <button onclick="removeBuilderItem(${item.id})" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Remove</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; color: #2c3e50; font-size: 0.9rem;">Item Text</label>
            <input type="text" 
                   value="${item.text}" 
                   onchange="updateBuilderItem(${item.id}, 'text', this.value)"
                   placeholder="${typeInfo.textPlaceholder}"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
          </div>
          ${item.type === 'number' || item.type === 'comment' ? `
            <div>
              <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; color: #2c3e50; font-size: 0.9rem;">Placeholder Text</label>
              <input type="text" 
                     value="${item.placeholder}" 
                     onchange="updateBuilderItem(${item.id}, 'placeholder', this.value)"
                     placeholder="${typeInfo.placeholderExample}"
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
            </div>
          ` : '<div></div>'}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = itemsHTML;
}

function getItemTypeInfo(type) {
  const typeInfo = {
    text: {
      label: 'Text Item',
      color: '#667eea',
      textPlaceholder: 'e.g. Check fire exits are clear',
      placeholderExample: ''
    },
    photo: {
      label: 'Photo Item', 
      color: '#28a745',
      textPlaceholder: 'e.g. Take photos of all gallery windows',
      placeholderExample: ''
    },
    number: {
      label: 'Number Item',
      color: '#ffc107',
      textPlaceholder: 'e.g. Count number of artworks displayed',
      placeholderExample: 'e.g. Enter number of items'
    },
    comment: {
      label: 'Comment Item',
      color: '#6f42c1', 
      textPlaceholder: 'e.g. Additional notes about gallery condition',
      placeholderExample: 'e.g. Enter your observations...'
    }
  };
  
  return typeInfo[type] || typeInfo.text;
}

function updateBuilderItem(itemId, field, value) {
  const item = currentChecklistBuilder.find(i => i.id === itemId);
  if (item) {
    item[field] = value;
  }
}

function removeBuilderItem(itemId) {
  currentChecklistBuilder = currentChecklistBuilder.filter(i => i.id !== itemId);
  renderChecklistBuilder();
}

async function saveNewChecklist() {
  const name = document.getElementById('new-checklist-name').value.trim();
  const description = document.getElementById('new-checklist-description').value.trim();
  const category = document.getElementById('new-checklist-category').value;
  
  if (!name) {
    alert('Please enter a checklist name');
    return;
  }
  
  if (!description) {
    alert('Please enter a description');
    return;
  }
  
  if (currentChecklistBuilder.length === 0) {
    alert('Please add at least one item to the checklist');
    return;
  }
  
  // Validate all items have text
  const emptyItems = currentChecklistBuilder.filter(item => !item.text.trim());
  if (emptyItems.length > 0) {
    alert('Please fill in text for all checklist items');
    return;
  }
  
  const newChecklist = {
    name: name,
    description: description,
    category: category,
    items: currentChecklistBuilder.map(item => ({
      id: item.id.toString(),
      type: item.type,
      text: item.text.trim(),
      placeholder: item.placeholder ? item.placeholder.trim() : ''
    }))
  };
  
  try {
    await saveCustomChecklist(newChecklist);
    customChecklists.push(newChecklist);
    
    alert(`Checklist "${name}" created successfully!`);
    showChecklistOverview();
  } catch (error) {
    alert('Error creating checklist: ' + error.message);
    console.error('Checklist creation failed:', error);
  }
}

async function deleteCustomChecklist(checklistId) {
  // Check if user is admin
  try {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      alert('Please log in to delete checklists.');
      return;
    }
    
    const isAdmin = window.authUtils ? await window.authUtils.isAdmin(currentUser) : false;
    if (!isAdmin) {
      alert('Only administrators can delete checklists. Please contact an admin if you need this checklist removed.');
      return;
    }
  } catch (error) {
    console.error('Error checking admin status:', error);
    alert('Unable to verify admin permissions. Only administrators can delete checklists.');
    return;
  }
  
  if (!confirm('Are you sure you want to delete this checklist? This action cannot be undone.')) {
    return;
  }
  
  try {
    if (!db || !firebase.auth().currentUser) {
      throw new Error('Firebase not ready or user not authenticated');
    }
    
    await db.collection('custom-checklists').doc(checklistId).delete();
    customChecklists = customChecklists.filter(c => c.id !== checklistId);
    renderChecklistOverview();
    
    console.log('Custom checklist deleted from Firebase:', checklistId);
  } catch (error) {
    alert('Error deleting checklist: ' + error.message);
    console.error('Checklist deletion failed:', error);
  }
}

async function startCustomChecklist(checklistId) {
  const checklist = customChecklists.find(c => c.id === checklistId);
  if (!checklist) return;
  
  currentChecklistId = checklistId;
  hideAllChecklistContent();
  document.getElementById('gallery-checklist-form').style.display = 'block';
  
  // Clear current state
  clearCurrentChecklist();
  
  // Load any saved progress for this checklist
  await loadFromFirebase();
  
  // Render the custom checklist
  renderCustomChecklist(checklist);
  updateScore();
}

// Save custom checklist to Firebase Firestore
async function saveCustomChecklist(checklist) {
  try {
    if (!db || !firebase.auth().currentUser) {
      throw new Error('Firebase not ready or user not authenticated');
    }
    
    const checklistData = {
      ...checklist,
      userId: firebase.auth().currentUser.uid,
      userEmail: firebase.auth().currentUser.email,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    if (checklist.id) {
      // Update existing checklist
      await db.collection('custom-checklists').doc(checklist.id).update(checklistData);
      console.log('Custom checklist updated in Firebase:', checklist.id);
    } else {
      // Create new checklist
      checklistData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      const docRef = await db.collection('custom-checklists').add(checklistData);
      checklist.id = docRef.id;
      console.log('Custom checklist saved to Firebase:', docRef.id);
    }
  } catch (error) {
    console.error('Error saving custom checklist to Firebase:', error);
    throw error;
  }
}

async function loadCustomChecklists() {
  try {
    if (!db || !firebase.auth().currentUser) {
      console.log('Firebase not ready or user not authenticated');
      return;
    }
    
    const checklistsSnapshot = await db.collection('custom-checklists')
      .where('userId', '==', firebase.auth().currentUser.uid)
      .orderBy('createdAt', 'desc')
      .get();
    
    customChecklists = checklistsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    console.log('Custom checklists loaded from Firebase:', customChecklists.length);
  } catch (error) {
    console.error('Error loading custom checklists from Firebase:', error);
    customChecklists = [];
  }
}

function renderCustomChecklist(checklist) {
  const container = document.getElementById('gallery-items');
  if (!container) return;
  
  // Update the header title
  const headerTitle = document.querySelector('#gallery-checklist-form h2');
  if (headerTitle) {
    headerTitle.textContent = checklist.name.toUpperCase();
  }
  
  const itemsHTML = checklist.items.map((item, index) => {
    const status = checklistState.gallery.items[item.id]; // 'pass', 'fail', or undefined
    const comment = checklistState.gallery.comments[item.id] || '';
    
    let extraInputHTML = '';
    if (item.type === 'number' || item.type === 'comment') {
      const value = checklistState.gallery.items[item.id + '_value'] || '';
      const inputType = item.type === 'number' ? 'number' : 'text';
      const placeholder = item.placeholder || (item.type === 'number' ? 'Enter number' : 'Enter value');
      
      extraInputHTML = `
        <div style="margin-left: 30px; margin-bottom: 0.5rem;">
          <input type="${inputType}" 
                 id="value-${item.id}" 
                 placeholder="${placeholder}"
                 value="${value}"
                 onchange="updateItemValue('${item.id}', this.value)"
                 style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
        </div>
      `;
    }
    
    return `
      <div class="checklist-item" style="display: flex; align-items: flex-start; padding: 1rem; margin-bottom: 1rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
        <div style="flex: 1; margin-right: 1rem;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
            <span style="color: #6c757d; font-weight: 500; min-width: 20px;">${index + 1}.</span>
            <span style="flex: 1; color: #2c3e50;">${item.text}</span>
            ${item.type !== 'text' ? `<span style="background: ${getItemTypeInfo(item.type).color}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${getItemTypeInfo(item.type).label}</span>` : ''}
          </div>
          
          ${extraInputHTML}
          
          <div style="margin-left: 30px;">
            <textarea 
              id="comment-${item.id}"
              placeholder="Add a comment about this item..."
              onchange="updateComment('${item.id}', this.value)"
              style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 60px;">${comment}</textarea>
          </div>
        </div>
        
        <div style="display: flex; gap: 0.5rem;">
          <div style="background: ${status === 'pass' ? '#28a745' : '#f8f9fa'}; color: ${status === 'pass' ? 'white' : '#666'}; width: 60px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 600; user-select: none; border: 2px solid ${status === 'pass' ? '#28a745' : '#ddd'};" 
               onclick="setItemStatus('${item.id}', 'pass')">
            PASS
          </div>
          <div style="background: ${status === 'fail' ? '#dc3545' : '#f8f9fa'}; color: ${status === 'fail' ? 'white' : '#666'}; width: 60px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 600; user-select: none; border: 2px solid ${status === 'fail' ? '#dc3545' : '#ddd'};" 
               onclick="setItemStatus('${item.id}', 'fail')">
            FAIL
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = itemsHTML;
  
  // Setup photo upload for photo items
  setupPhotoUpload();
}

function updateItemValue(itemId, value) {
  checklistState.gallery.items[itemId + '_value'] = value;
  saveToLocalStorage();
}

function renderGalleryChecklist() {
  const container = document.getElementById('gallery-items');
  console.log('Rendering checklist to container:', container);
  
  if (!container) {
    console.error('Gallery items container not found!');
    return;
  }
  
  // Update the header title
  const headerTitle = document.querySelector('#gallery-checklist-form h2');
  if (headerTitle) {
    headerTitle.textContent = 'WEEKLY GALLERY CHECKLIST';
  }
  
  const itemsHTML = galleryChecklistItems.map((item, index) => {
    const status = checklistState.gallery.items[item.id]; // 'pass', 'fail', or undefined
    const comment = checklistState.gallery.comments[item.id] || '';
    
    return `
      <div class="checklist-item" style="display: flex; align-items: flex-start; padding: 1rem; margin-bottom: 1rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
        <div style="flex: 1; margin-right: 1rem;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
            <span style="color: #6c757d; font-weight: 500; min-width: 20px;">${index + 1}.</span>
            <span style="flex: 1; color: #2c3e50;">${item.text}</span>
          </div>
          
          <div style="margin-left: 30px;">
            <textarea 
              id="comment-${item.id}"
              placeholder="Add a comment about this item..."
              onchange="updateComment('${item.id}', this.value)"
              style="width: 100%; max-width: 400px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 60px;">${comment}</textarea>
          </div>
        </div>
        
        <div style="display: flex; gap: 0.5rem;">
          <div style="background: ${status === 'pass' ? '#28a745' : '#f8f9fa'}; color: ${status === 'pass' ? 'white' : '#666'}; width: 60px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 600; user-select: none; border: 2px solid ${status === 'pass' ? '#28a745' : '#ddd'};" 
               onclick="setItemStatus('${item.id}', 'pass')">
            PASS
          </div>
          <div style="background: ${status === 'fail' ? '#dc3545' : '#f8f9fa'}; color: ${status === 'fail' ? 'white' : '#666'}; width: 60px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: 600; user-select: none; border: 2px solid ${status === 'fail' ? '#dc3545' : '#ddd'};" 
               onclick="setItemStatus('${item.id}', 'fail')">
            FAIL
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  console.log('Generated HTML length:', itemsHTML.length);
  console.log('Setting innerHTML...');
  container.innerHTML = itemsHTML;
  console.log('Checklist rendered successfully, container now has:', container.children.length, 'items');
  
  // Initialize photo upload
  setupPhotoUpload();
}

function setItemStatus(itemId, status) {
  checklistState.gallery.items[itemId] = status;
  
  // If status is 'fail', show task creation modal
  if (status === 'fail') {
    showTaskCreationModal(itemId);
  }
  
  // Re-render the appropriate checklist type
  if (currentChecklistId) {
    const checklist = customChecklists.find(c => c.id === currentChecklistId);
    if (checklist) {
      renderCustomChecklist(checklist);
    }
  } else {
    renderGalleryChecklist();
  }
  
  updateScore();
  saveToLocalStorage();
}

function updateComment(itemId, comment) {
  checklistState.gallery.comments[itemId] = comment;
  saveToLocalStorage();
}

function setupPhotoUpload() {
  const fileInput = document.getElementById('all-photos-upload');
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      handleAllPhotosUpload(e.target.files);
    });
  }
  displayAllPhotos();
}

function handleAllPhotosUpload(files) {
  Array.from(files).forEach(file => {
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        checklistState.gallery.allPhotos.push({
          name: file.name,
          data: e.target.result,
          uploadDate: new Date().toISOString()
        });
        displayAllPhotos();
        saveToLocalStorage();
      };
      reader.readAsDataURL(file);
    }
  });
}

function displayAllPhotos() {
  const container = document.getElementById('all-photos-display');
  if (!container) return;
  
  const photos = checklistState.gallery.allPhotos || [];
  
  container.innerHTML = photos.map((photo, index) => `
    <div style="position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <img src="${photo.data}" 
           style="width: 100%; height: 150px; object-fit: cover;">
      <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; font-size: 0.8rem;">
        ${photo.name}
      </div>
      <button onclick="removeAllPhoto(${index})" 
              style="position: absolute; top: 8px; right: 8px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; font-weight: bold;">×</button>
    </div>
  `).join('');
}

function removeAllPhoto(photoIndex) {
  checklistState.gallery.allPhotos.splice(photoIndex, 1);
  displayAllPhotos();
  saveToLocalStorage();
}

function updateScore() {
  const items = checklistState.gallery.items;
  const passed = Object.values(items).filter(status => status === 'pass').length;
  const failed = Object.values(items).filter(status => status === 'fail').length;
  
  // Get total items count based on current checklist type
  let total;
  if (currentChecklistId) {
    const checklist = customChecklists.find(c => c.id === currentChecklistId);
    total = checklist ? checklist.items.length : 0;
  } else {
    total = galleryChecklistItems.length;
  }
  
  const completed = passed + failed;
  const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;
  
  const scoreElement = document.getElementById('gallery-score');
  if (scoreElement) {
    scoreElement.textContent = `${passed}/${total} Pass (${passRate}%)`;
    
    // Color based on pass rate
    if (passRate === 100) {
      scoreElement.style.background = '#28a745'; // Green for 100%
      scoreElement.style.color = 'white';
    } else if (passRate >= 80) {
      scoreElement.style.background = '#ffc107'; // Yellow for 80%+
      scoreElement.style.color = 'black';
    } else {
      scoreElement.style.background = '#dc3545'; // Red for less than 80%
      scoreElement.style.color = 'white';
    }
  }
}

// ==============================================================================
// TASK MANAGEMENT SYSTEM
// ==============================================================================

let tasks = []; // Array to store all tasks
let currentTaskModal = null; // Store current task creation context
let isCurrentUserAdmin = false; // Cache admin status for UI rendering

// Helper function to check if current user is admin
async function checkUserAdminStatus() {
  try {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      isCurrentUserAdmin = false;
      return false;
    }
    
    const adminStatus = window.authUtils ? await window.authUtils.isAdmin(currentUser) : false;
    isCurrentUserAdmin = adminStatus;
    return adminStatus;
  } catch (error) {
    console.error('Error checking admin status:', error);
    isCurrentUserAdmin = false;
    return false;
  }
}

// Load tasks from Firebase Firestore
async function loadTasks() {
  try {
    if (!db || !firebase.auth().currentUser) {
      console.log('Firebase not ready or user not authenticated');
      return;
    }
    
    const tasksSnapshot = await db.collection('tasks')
      .where('userId', '==', firebase.auth().currentUser.uid)
      .orderBy('createdAt', 'desc')
      .get();
    
    tasks = tasksSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    console.log('Tasks loaded from Firebase:', tasks.length);
  } catch (error) {
    console.error('Error loading tasks from Firebase:', error);
    tasks = [];
  }
}

// Save task to Firebase Firestore
async function saveTask(task) {
  try {
    if (!db || !firebase.auth().currentUser) {
      throw new Error('Firebase not ready or user not authenticated');
    }
    
    const taskData = {
      ...task,
      userId: firebase.auth().currentUser.uid,
      userEmail: firebase.auth().currentUser.email,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    if (task.id) {
      // Update existing task
      await db.collection('tasks').doc(task.id).update(taskData);
      console.log('Task updated in Firebase:', task.id);
    } else {
      // Create new task
      taskData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      const docRef = await db.collection('tasks').add(taskData);
      task.id = docRef.id;
      console.log('Task saved to Firebase:', docRef.id);
    }
  } catch (error) {
    console.error('Error saving task to Firebase:', error);
    throw error;
  }
}

// Show task creation modal when an item is marked as failed
function showTaskCreationModal(itemId) {
  const modal = document.getElementById('task-creation-modal');
  const failedItemText = document.getElementById('failed-item-text');
  const taskDescription = document.getElementById('task-description');
  const taskDueDate = document.getElementById('task-due-date');
  const taskRequiresPhotos = document.getElementById('task-requires-photos');
  
  // Get the item text from current checklist
  let itemText = '';
  if (currentChecklistId) {
    const checklist = customChecklists.find(c => c.id === currentChecklistId);
    if (checklist) {
      const item = checklist.items.find(i => i.id === itemId);
      itemText = item ? item.text : 'Unknown item';
    }
  } else {
    const item = galleryChecklistItems.find(i => i.id === itemId);
    itemText = item ? item.text : 'Unknown item';
  }
  
  failedItemText.textContent = itemText;
  taskDescription.value = '';
  taskDueDate.value = '';
  taskRequiresPhotos.checked = false;
  
  // Set default due date to one week from now
  const nextWeek = new Date();
  nextWeek.setDate(nextWeek.getDate() + 7);
  taskDueDate.value = nextWeek.toISOString().split('T')[0];
  
  // Store context for task creation
  currentTaskModal = {
    itemId: itemId,
    itemText: itemText,
    checklistId: currentChecklistId,
    checklistName: currentChecklistId ? 
      customChecklists.find(c => c.id === currentChecklistId)?.name : 
      'Gallery Weekly Checklist'
  };
  
  modal.style.display = 'block';
  taskDescription.focus();
}

// Close task creation modal
function closeTaskModal() {
  const modal = document.getElementById('task-creation-modal');
  modal.style.display = 'none';
  currentTaskModal = null;
}

// Create task from modal
async function createTaskFromModal() {
  const taskDescription = document.getElementById('task-description').value.trim();
  const taskDueDate = document.getElementById('task-due-date').value;
  const taskRequiresPhotos = document.getElementById('task-requires-photos').checked;
  
  if (!taskDescription) {
    alert('Please enter a task description');
    return;
  }
  
  if (!taskDueDate) {
    alert('Please select a due date');
    return;
  }
  
  const newTask = {
    title: taskDescription,
    description: `Task created from failed checklist item: "${currentTaskModal.itemText}"`,
    status: 'in-progress',
    priority: 'medium',
    dueDate: taskDueDate,
    requiresPhotos: taskRequiresPhotos,
    photos: [],
    completedAt: null,
    source: {
      type: 'checklist',
      checklistId: currentTaskModal.checklistId,
      checklistName: currentTaskModal.checklistName,
      itemId: currentTaskModal.itemId,
      itemText: currentTaskModal.itemText
    }
  };
  
  try {
    await saveTask(newTask);
    tasks.push(newTask);
    
    closeTaskModal();
    
    // Show success message and option to view tasks
    if (confirm(`Task "${taskDescription}" created successfully!\n\nWould you like to view the Tasks tab?`)) {
      // Switch to tasks tab
      const tasksTab = document.querySelector('[data-tab="tasks"]');
      if (tasksTab) {
        tasksTab.click();
        await renderTasksList();
      }
    }
  } catch (error) {
    alert('Error creating task: ' + error.message);
    console.error('Task creation failed:', error);
  }
}

// Initialize tasks tab when clicked
async function initializeTasksTab() {
  await checkUserAdminStatus(); // Check admin status for UI rendering
  await loadTasks();
  renderTasksList();
  setupTaskFilters();
}

// Render tasks list
async function renderTasksList(filter = 'all') {
  const container = document.getElementById('tasks-list');
  const noTasksMessage = document.getElementById('no-tasks-message');
  
  // Only render if the tasks tab is active and container exists
  if (!container) {
    console.log('Tasks list container not found - probably not on Tasks tab');
    return;
  }
  
  // Check if tasks tab is currently active
  const tasksTab = document.getElementById('tasks-tab');
  if (!tasksTab || !tasksTab.classList.contains('active')) {
    console.log('Tasks tab not active - skipping render');
    return;
  }
  
  let filteredTasks = tasks;
  
  // Apply filters
  if (filter !== 'all') {
    const today = new Date().toISOString().split('T')[0];
    
    switch (filter) {
      case 'in-progress':
        filteredTasks = tasks.filter(task => task.status === 'in-progress');
        break;
      case 'completed':
        filteredTasks = tasks.filter(task => task.status === 'completed');
        break;
      case 'overdue':
        filteredTasks = tasks.filter(task => {
          const timeRemaining = calculateHoursRemaining(task.dueDate);
          return task.status !== 'completed' && timeRemaining.isOverdue;
        });
        break;
    }
  }
  
  if (filteredTasks.length === 0) {
    if (noTasksMessage) {
      noTasksMessage.style.display = 'block';
      container.innerHTML = '';
      container.appendChild(noTasksMessage);
    } else {
      container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #6c757d; background: white; border-radius: 12px; border: 1px solid #e9ecef;"><div style="font-size: 3rem; margin-bottom: 1rem;">✅</div><h3 style="margin: 0 0 0.5rem 0; color: #495057;">No Tasks</h3><p style="margin: 0; color: #6c757d;">No tasks match the current filter.</p></div>';
    }
    return;
  }
  
  if (noTasksMessage) {
    noTasksMessage.style.display = 'none';
  }
  
  // Sort tasks by due date and status
  filteredTasks.sort((a, b) => {
    if (a.status !== b.status) {
      const statusOrder = { 'overdue': 0, 'in-progress': 1, 'completed': 2 };
      return statusOrder[a.status] - statusOrder[b.status];
    }
    return new Date(a.dueDate) - new Date(b.dueDate);
  });
  
  const tasksHTML = filteredTasks.map(task => {
    const timeRemaining = calculateHoursRemaining(task.dueDate);
    const statusColor = getTaskStatusColor(task.status, timeRemaining.isOverdue);
    const statusText = timeRemaining.isOverdue ? 'OVERDUE' : task.status.toUpperCase().replace('-', ' ');
    
    return `
      <div class="task-card" style="background: white; border-radius: 12px; padding: 1rem; border: 1px solid #e9ecef; ${timeRemaining.isOverdue ? 'border-left: 4px solid #dc3545;' : ''} cursor: pointer; transition: all 0.2s ease;" onclick="toggleTaskDetails('${task.id}')">
        <!-- Task Header (Always Visible) -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1; min-width: 0;">
            <h4 style="margin: 0; color: #2c3e50; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${(task.title || '').replace(/`/g, '&#96;').replace(/\$/g, '&#36;')}</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
              <span style="background: ${statusColor}; color: white; padding: 0.2rem 0.4rem; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>
              <span style="background: ${timeRemaining.color}; color: white; padding: 0.2rem 0.4rem; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">${timeRemaining.text}</span>
              ${task.requiresPhotos ? '<span style="background: #28a745; color: white; padding: 0.2rem 0.4rem; border-radius: 10px; font-size: 0.75rem;">📸</span>' : ''}
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
            <button onclick="event.stopPropagation(); toggleTaskDetails('${task.id}')" style="background: #f8f9fa; border: 1px solid #e9ecef; padding: 0.25rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; color: #6c757d;">
              <span id="expand-icon-${task.id}">▼</span>
            </button>
          </div>
        </div>
        
        <!-- Task Details (Collapsible) -->
        <div id="task-details-${task.id}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
          <p style="margin: 0 0 1rem 0; color: #6c757d; font-size: 0.9rem;">${(task.description || '').replace(/`/g, '&#96;').replace(/\$/g, '&#36;')}</p>
          
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
            <span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">From: ${task.source.type === 'communication' ? task.source.communicationTitle : task.source.checklistName}</span>
          </div>
          
          <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 1rem;">
            <div>${task.source.type === 'communication' ? `Original task: "${(task.source.originalTaskText || '').replace(/`/g, '&#96;').replace(/\$/g, '&#36;').replace(/"/g, '&quot;')}"` : `Original item: "${(task.source.itemText || '').replace(/`/g, '&#96;').replace(/\$/g, '&#36;').replace(/"/g, '&quot;')}"`}</div>
            <div>Created: ${new Date(task.createdAt).toLocaleDateString()}</div>
            ${task.completedAt ? `<div>Completed: ${new Date(task.completedAt).toLocaleDateString()}</div>` : ''}
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            ${task.status === 'in-progress' ? `<button onclick="event.stopPropagation(); updateTaskStatus('${task.id}', 'completed')" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;">Complete</button>` : ''}
            ${task.status === 'completed' ? `<button onclick="event.stopPropagation(); updateTaskStatus('${task.id}', 'in-progress')" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;">Reopen</button>` : ''}
            ${isCurrentUserAdmin ? `<button onclick="event.stopPropagation(); deleteTask('${task.id}')" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;">Delete</button>` : ''}
          </div>
          
          <!-- Photo upload section for photo-required tasks -->
          ${task.requiresPhotos ? `
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;" onclick="event.stopPropagation();">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div style="font-size: 0.9rem; font-weight: 500; color: #2c3e50;">📸 Photos Required</div>
                <input type="file" id="task-photo-${task.id}" multiple accept="image/*" style="display: none;" onchange="handleTaskPhotoUpload('${task.id}', this.files)">
                <button onclick="document.getElementById('task-photo-${task.id}').click()" style="background: #28a745; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Add Photos</button>
              </div>
              
              ${task.photos && task.photos.length > 0 ? `
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                  ${task.photos.map((photo, index) => `
                    <div style="position: relative;">
                      <img src="${photo.dataUrl}" alt="${photo.name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">
                      <button onclick="removeTaskPhoto('${task.id}', ${index})" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; cursor: pointer;">×</button>
                    </div>
                  `).join('')}
                </div>
                <div style="font-size: 0.8rem; color: #6c757d;">${task.photos.length} photo(s) uploaded</div>
              ` : `
                <div style="font-size: 0.8rem; color: #dc3545;">No photos uploaded yet</div>
              `}
            </div>
          ` : ''}
          
          <!-- Notes section for all tasks -->
          <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;" onclick="event.stopPropagation();">
            <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; color: #2c3e50;">📝 Notes</div>
            <textarea 
              id="task-notes-${task.id}" 
              placeholder="Add notes, updates, or comments about this task..."
              onchange="updateTaskNotes('${task.id}', this.value)"
              style="width: 100%; min-height: 60px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-size: 0.9rem;">${(task.notes || '').replace(/`/g, '&#96;').replace(/\$/g, '&#36;')}</textarea>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = tasksHTML;
}

function getTaskStatusColor(status, isOverdue) {
  if (isOverdue) return '#dc3545';
  
  const colors = {
    'in-progress': '#ffc107', 
    'completed': '#28a745'
  };
  return colors[status] || '#6c757d';
}

// Toggle task details visibility
function toggleTaskDetails(taskId) {
  const detailsElement = document.getElementById(`task-details-${taskId}`);
  const expandIcon = document.getElementById(`expand-icon-${taskId}`);
  
  if (detailsElement && expandIcon) {
    if (detailsElement.style.display === 'none') {
      detailsElement.style.display = 'block';
      expandIcon.textContent = '▲';
    } else {
      detailsElement.style.display = 'none';
      expandIcon.textContent = '▼';
    }
  }
}

// Calculate hours remaining until due date
function calculateHoursRemaining(dueDate) {
  const now = new Date();
  const due = new Date(dueDate + 'T23:59:59'); // End of due date
  const diffMs = due - now;
  const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));
  
  if (diffHours < 0) {
    return { text: 'OVERDUE', color: '#dc3545', isOverdue: true };
  } else if (diffHours === 0) {
    return { text: 'Due today', color: '#ffc107', isOverdue: false };
  } else if (diffHours <= 24) {
    return { text: `${diffHours}h left`, color: '#ffc107', isOverdue: false };
  } else {
    const days = Math.floor(diffHours / 24);
    const hours = diffHours % 24;
    if (hours === 0) {
      return { text: `${days}d left`, color: '#28a745', isOverdue: false };
    } else {
      return { text: `${days}d ${hours}h left`, color: '#28a745', isOverdue: false };
    }
  }
}

// Update task status
async function updateTaskStatus(taskId, newStatus) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  // Validate completion requirements
  if (newStatus === 'completed') {
    if (task.requiresPhotos && (!task.photos || task.photos.length === 0)) {
      alert('This task requires photos to be uploaded before it can be marked as completed. Please upload the required photos first.');
      return;
    }
  }
  
  task.status = newStatus;
  
  if (newStatus === 'completed') {
    task.completedAt = firebase.firestore.FieldValue.serverTimestamp();
  } else {
    task.completedAt = null;
  }
  
  try {
    await saveTask(task);
    
    // Only re-render if the tasks tab is currently active
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab && tasksTab.classList.contains('active')) {
      await renderTasksList();
    } else {
      console.log('Task updated successfully - not re-rendering (tasks tab not active)');
    }
  } catch (error) {
    alert('Error updating task: ' + error.message);
    console.error('Task update failed:', error);
  }
}

// Delete task (admin only)
async function deleteTask(taskId) {
  // Check if user is admin
  try {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      alert('Please log in to delete tasks.');
      return;
    }
    
    const isAdmin = window.authUtils ? await window.authUtils.isAdmin(currentUser) : false;
    if (!isAdmin) {
      alert('Only administrators can delete tasks. Please contact an admin if you need this task removed.');
      return;
    }
  } catch (error) {
    console.error('Error checking admin status:', error);
    alert('Unable to verify admin permissions. Only administrators can delete tasks.');
    return;
  }
  
  if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
    return;
  }
  
  try {
    if (!db || !firebase.auth().currentUser) {
      throw new Error('Firebase not ready or user not authenticated');
    }
    
    await db.collection('tasks').doc(taskId).delete();
    tasks = tasks.filter(t => t.id !== taskId);
    
    // Only re-render if the tasks tab is currently active
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab && tasksTab.classList.contains('active')) {
      await renderTasksList();
    } else {
      console.log('Task deleted successfully - not re-rendering (tasks tab not active)');
    }
    
    console.log('Task deleted from Firebase:', taskId);
  } catch (error) {
    alert('Error deleting task: ' + error.message);
    console.error('Task deletion failed:', error);
  }
}

// Setup task filters
function setupTaskFilters() {
  const filterButtons = document.querySelectorAll('.task-filter-button');
  
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Remove active class from all buttons
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#6c757d';
      });
      
      // Add active class to clicked button
      button.classList.add('active');
      button.style.background = 'var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%))';
      button.style.color = 'white';
      
      // Filter tasks
      const filter = button.getAttribute('data-filter');
      renderTasksList(filter);
    });
  });
}

// Initialize tasks when tasks tab is activated
document.addEventListener('DOMContentLoaded', function() {
  // Add event listener for tasks tab activation
  const tasksTabButton = document.querySelector('[data-tab="tasks"]');
  if (tasksTabButton) {
    tasksTabButton.addEventListener('click', function() {
      setTimeout(() => {
        initializeTasksTab();
      }, 100);
    });
  }
});

function addSignature() {
  const name = document.getElementById('signature-name').value.trim();
  if (!name) {
    alert('Please enter your name');
    return;
  }
  
  checklistState.gallery.signature = name;
  const display = document.getElementById('signature-display');
  display.innerHTML = `<strong>${name}</strong> - ${new Date().toLocaleDateString()}`;
  document.getElementById('signature-name').value = '';
  saveToLocalStorage();
}

function clearSignature() {
  checklistState.gallery.signature = '';
  document.getElementById('signature-display').innerHTML = '';
  saveToLocalStorage();
}

async function saveChecklist() {
  if (!checklistState.gallery.signature) {
    alert('Please add a signature before saving the checklist.');
    return;
  }
  
  const items = checklistState.gallery.items;
  const passed = Object.values(items).filter(status => status === 'pass').length;
  const failed = Object.values(items).filter(status => status === 'fail').length;
  const total = galleryChecklistItems.length;
  const completed = passed + failed;
  
  if (completed === 0) {
    alert('Please complete at least one checklist item before saving.');
    return;
  }
  
  const savedChecklist = {
    id: Date.now(),
    date: new Date().toISOString(),
    dateDisplay: new Date().toLocaleDateString(),
    items: { ...checklistState.gallery.items },
    signature: checklistState.gallery.signature,
    allPhotos: [...checklistState.gallery.allPhotos],
    comments: { ...checklistState.gallery.comments },
    passed: passed,
    failed: failed,
    total: total,
    passRate: Math.round((passed / total) * 100)
  };
  
  try {
    await saveCompletedChecklist('gallery', savedChecklist);
    savedChecklists.gallery.push(savedChecklist);
    
    // Clear the saved progress since checklist is now completed
    await clearChecklistProgress();
    
    alert(`Checklist saved successfully! Pass rate: ${savedChecklist.passRate}%`);
    showChecklistHistory();
  } catch (error) {
    alert('Error saving checklist: ' + error.message);
    console.error('Checklist save failed:', error);
  }
}

// Save completed checklist to Firebase Firestore
async function saveCompletedChecklist(checklistType, checklistData) {
  try {
    if (!db || !firebase.auth().currentUser) {
      throw new Error('Firebase not ready or user not authenticated');
    }
    
    // Serialize the checklist data properly for Firestore
    const serializedChecklistData = {
      ...checklistData,
      // Serialize allPhotos array properly
      allPhotos: (checklistData.allPhotos || []).map(photo => {
        const serializedPhoto = {};
        if (photo.name !== undefined) serializedPhoto.name = photo.name;
        if (photo.dataUrl !== undefined) serializedPhoto.dataUrl = photo.dataUrl;
        if (photo.size !== undefined) serializedPhoto.size = photo.size;
        if (photo.type !== undefined) serializedPhoto.type = photo.type;
        return serializedPhoto;
      }).filter(photo => Object.keys(photo).length > 0)
    };
    
    const cleanCompletedChecklistData = {
      ...serializedChecklistData,
      checklistType: checklistType,
      userId: firebase.auth().currentUser.uid,
      userEmail: firebase.auth().currentUser.email,
      completedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Remove any undefined values
    const completedChecklistData = removeUndefinedValues(cleanCompletedChecklistData);
    
    const docRef = await db.collection('completed-checklists').add(completedChecklistData);
    
    console.log('Completed checklist saved to Firebase:', docRef.id);
    return docRef.id;
  } catch (error) {
    console.error('Error saving completed checklist to Firebase:', error);
    throw error;
  }
}

async function loadSavedChecklists() {
  try {
    if (!db || !firebase.auth().currentUser) {
      console.log('Firebase not ready or user not authenticated');
      return;
    }
    
    const checklistsSnapshot = await db.collection('completed-checklists')
      .where('userId', '==', firebase.auth().currentUser.uid)
      .orderBy('completedAt', 'desc')
      .get();
    
    // Organize by checklist type for backward compatibility
    savedChecklists = { gallery: [] };
    
    checklistsSnapshot.docs.forEach(doc => {
      const data = { id: doc.id, ...doc.data() };
      const type = data.checklistType || 'gallery';
      
      if (!savedChecklists[type]) {
        savedChecklists[type] = [];
      }
      
      savedChecklists[type].push(data);
    });
    
    console.log('Saved checklists loaded from Firebase:', Object.keys(savedChecklists).reduce((total, key) => total + savedChecklists[key].length, 0));
  } catch (error) {
    console.error('Error loading saved checklists from Firebase:', error);
    savedChecklists = { gallery: [] };
  }
}

function renderChecklistHistory() {
  const container = document.getElementById('gallery-history-list');
  if (!container) return;
  
  const history = savedChecklists.gallery || [];
  
  if (history.length === 0) {
    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #6c757d;">No completed checklists yet.</div>';
    return;
  }
  
  // Sort by date (newest first)
  const sortedHistory = history.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  container.innerHTML = sortedHistory.map(checklist => {
    const statusColor = checklist.passRate >= 80 ? '#28a745' : '#dc3545';
    const statusText = checklist.passRate >= 80 ? 'PASS' : 'FAIL';
    
    return `
      <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background-color 0.2s;" 
           onclick="viewSavedChecklist(${checklist.id})"
           onmouseover="this.style.backgroundColor='#f8f9fa'" 
           onmouseout="this.style.backgroundColor='white'">
        <div>
          <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">${checklist.dateDisplay}</div>
          <div style="font-size: 0.9rem; color: #6c757d;">Completed by ${checklist.signature}</div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="text-align: right;">
            <div style="font-weight: 600; color: ${statusColor};">${checklist.passed}/${checklist.total} Pass (${checklist.passRate}%)</div>
            <div style="font-size: 0.9rem; color: #6c757d;">${checklist.allPhotos.length} photos</div>
          </div>
          <div style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
            ${statusText}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function viewSavedChecklist(checklistId) {
  const checklist = savedChecklists.gallery.find(c => c.id === checklistId);
  if (!checklist) return;
  
  // Load the saved checklist data
  checklistState.gallery = {
    items: { ...checklist.items },
    signature: checklist.signature,
    allPhotos: [...checklist.allPhotos],
    comments: { ...checklist.comments }
  };
  
  // Show the form in read-only mode
  hideAllChecklistContent();
  document.getElementById('gallery-checklist-form').style.display = 'block';
  renderGalleryChecklist();
  updateScore();
  
  // Update signature display
  const signatureDisplay = document.getElementById('signature-display');
  if (signatureDisplay && checklist.signature) {
    signatureDisplay.innerHTML = `<strong>${checklist.signature}</strong> - ${checklist.dateDisplay}`;
  }
  
  // Make form read-only by disabling buttons and inputs
  makeFormReadOnly();
}

function makeFormReadOnly() {
  // Disable all pass/fail buttons
  document.querySelectorAll('.checklist-item').forEach(item => {
    const buttons = item.querySelectorAll('[onclick*="setItemStatus"]');
    buttons.forEach(btn => {
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '0.7';
    });
  });
  
  // Disable photo upload
  const photoInput = document.getElementById('all-photos-upload');
  if (photoInput) {
    photoInput.disabled = true;
  }
  
  // Disable comment inputs
  document.querySelectorAll('textarea[id^="comment-"]').forEach(textarea => {
    textarea.disabled = true;
  });
  
  // Disable signature inputs
  const signatureInput = document.getElementById('signature-name');
  if (signatureInput) {
    signatureInput.disabled = true;
  }
}

// Helper function to remove undefined values from objects recursively
function removeUndefinedValues(obj) {
  if (obj === null || obj === undefined) return obj;
  if (typeof obj !== 'object') return obj;
  if (Array.isArray(obj)) {
    return obj.map(removeUndefinedValues).filter(item => item !== undefined);
  }
  
  const cleaned = {};
  for (const [key, value] of Object.entries(obj)) {
    if (value !== undefined) {
      cleaned[key] = removeUndefinedValues(value);
    }
  }
  return cleaned;
}

// Auto-save current checklist state to Firebase for persistence across sessions
async function saveToFirebase() {
  try {
    if (!db || !firebase.auth().currentUser) {
      console.log('Firebase not ready or user not authenticated - skipping save');
      return;
    }
    
    const userId = firebase.auth().currentUser.uid;
    const checklistType = currentChecklistId ? 'custom' : 'gallery';
    const checklistId = currentChecklistId || 'gallery-weekly';
    
    // Serialize the checklist state properly for Firestore
    const serializedState = {
      gallery: {
        items: checklistState.gallery.items || {},
        signature: checklistState.gallery.signature || '',
        comments: checklistState.gallery.comments || {},
        // Convert photo objects to serializable data, filtering out undefined values
        allPhotos: (checklistState.gallery.allPhotos || []).map(photo => {
          const serializedPhoto = {};
          if (photo.name !== undefined) serializedPhoto.name = photo.name;
          if (photo.dataUrl !== undefined) serializedPhoto.dataUrl = photo.dataUrl;
          if (photo.size !== undefined) serializedPhoto.size = photo.size;
          if (photo.type !== undefined) serializedPhoto.type = photo.type;
          return serializedPhoto;
        }).filter(photo => Object.keys(photo).length > 0)
      }
    };
    
    // Clean any undefined values from the state data
    const cleanStateData = {
      ...serializedState,
      userId: userId,
      userEmail: firebase.auth().currentUser.email,
      checklistType: checklistType,
      checklistId: checklistId,
      lastSaved: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Remove any undefined values recursively
    const stateData = removeUndefinedValues(cleanStateData);
    
    // Use a consistent document ID based on user and checklist
    const docId = `${userId}_${checklistId}`;
    
    // Use set with merge to handle both create and update cases
    await db.collection('checklist-progress').doc(docId).set(stateData, { merge: true });
    console.log('Checklist progress auto-saved to Firebase');
  } catch (error) {
    console.error('Error auto-saving checklist progress:', error);
  }
}

async function loadFromFirebase() {
  try {
    if (!db || !firebase.auth().currentUser) {
      console.log('Firebase not ready or user not authenticated - using default state');
      return;
    }
    
    const userId = firebase.auth().currentUser.uid;
    const checklistType = currentChecklistId ? 'custom' : 'gallery';
    const checklistId = currentChecklistId || 'gallery-weekly';
    const docId = `${userId}_${checklistId}`;
    
    const doc = await db.collection('checklist-progress').doc(docId).get();
    
    if (doc.exists) {
      const savedState = doc.data();
      
      // Merge saved state with current state, excluding Firebase-specific fields
      const { userId: _, userEmail: __, lastSaved: ___, updatedAt: ____, ...cleanState } = savedState;
      checklistState = { ...checklistState, ...cleanState };
      
      // Restore UI elements
      if (checklistState.gallery.signature) {
        const display = document.getElementById('signature-display');
        if (display) {
          display.innerHTML = `<strong>${checklistState.gallery.signature}</strong> - ${new Date().toLocaleDateString()}`;
        }
      }
      
      // Restore photos
      displayAllPhotos();
      
      // Re-render the current checklist to show restored state
      if (currentChecklistId) {
        const checklist = customChecklists.find(c => c.id === currentChecklistId);
        if (checklist) {
          renderCustomChecklist(checklist);
        }
      } else {
        renderGalleryChecklist();
      }
      
      updateScore();
      
      console.log('Checklist progress restored from Firebase');
    } else {
      console.log('No saved progress found for this checklist');
    }
  } catch (error) {
    console.error('Error loading checklist progress from Firebase:', error);
  }
}

// Replace the old localStorage function calls
function saveToLocalStorage() {
  saveToFirebase();
}

function loadFromLocalStorage() {
  loadFromFirebase();
}

// Clear saved checklist progress when checklist is completed
async function clearChecklistProgress() {
  try {
    if (!db || !firebase.auth().currentUser) {
      return;
    }
    
    const userId = firebase.auth().currentUser.uid;
    const checklistType = currentChecklistId ? 'custom' : 'gallery';
    const checklistId = currentChecklistId || 'gallery-weekly';
    const docId = `${userId}_${checklistId}`;
    
    await db.collection('checklist-progress').doc(docId).delete();
    console.log('Checklist progress cleared from Firebase');
  } catch (error) {
    console.error('Error clearing checklist progress:', error);
  }
}

// Task photo upload functionality
async function handleTaskPhotoUpload(taskId, files) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  if (!task.photos) {
    task.photos = [];
  }
  
  // Convert files to base64 for storage
  const photoPromises = Array.from(files).map(file => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve({
          name: file.name,
          dataUrl: e.target.result,
          uploadDate: new Date().toISOString(),
          size: file.size
        });
      };
      reader.readAsDataURL(file);
    });
  });
  
  try {
    const newPhotos = await Promise.all(photoPromises);
    task.photos.push(...newPhotos);
    
    // Save to Firebase
    await saveTask(task);
    
    // Re-render if on tasks tab
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab && tasksTab.classList.contains('active')) {
      await renderTasksList();
    }
    
    console.log(`${newPhotos.length} photos added to task ${taskId}`);
  } catch (error) {
    console.error('Error uploading task photos:', error);
    alert('Error uploading photos. Please try again.');
  }
}

// Remove task photo
async function removeTaskPhoto(taskId, photoIndex) {
  const task = tasks.find(t => t.id === taskId);
  if (!task || !task.photos) return;
  
  task.photos.splice(photoIndex, 1);
  
  try {
    // Save to Firebase
    await saveTask(task);
    
    // Re-render if on tasks tab
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab && tasksTab.classList.contains('active')) {
      await renderTasksList();
    }
    
    console.log(`Photo removed from task ${taskId}`);
  } catch (error) {
    console.error('Error removing task photo:', error);
    alert('Error removing photo. Please try again.');
  }
}

// Update task notes
async function updateTaskNotes(taskId, notes) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  task.notes = notes;
  
  try {
    // Save to Firebase
    await saveTask(task);
    console.log(`Notes updated for task ${taskId}`);
  } catch (error) {
    console.error('Error updating task notes:', error);
  }
}

async function exportToPDF(checklistType) {
  try {
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Calculate statistics
    const items = checklistState.gallery.items;
    const passed = Object.values(items).filter(status => status === 'pass').length;
    const failed = Object.values(items).filter(status => status === 'fail').length;
    const total = galleryChecklistItems.length;
    const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;
    
    let y = 20; // Current Y position
    
    // Header
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('WEEKLY GALLERY CHECKLIST REPORT', 20, y);
    y += 10;
    
    // Date and basic info
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated: ${new Date().toLocaleString()}`, 20, y);
    y += 8;
    doc.text(`Pass Rate: ${passed}/${total} (${passRate}%)`, 20, y);
    y += 8;
    
    // Status with color
    doc.setFont('helvetica', 'bold');
    if (passRate >= 80) {
      doc.setTextColor(0, 128, 0); // Green
      doc.text('Status: ACCEPTABLE', 20, y);
    } else {
      doc.setTextColor(220, 53, 69); // Red
      doc.text('Status: NEEDS ATTENTION', 20, y);
    }
    doc.setTextColor(0, 0, 0); // Reset to black
    y += 15;
    
    // Summary section
    doc.setFont('helvetica', 'bold');
    doc.text('SUMMARY:', 20, y);
    y += 8;
    doc.setFont('helvetica', 'normal');
    doc.text(`• Passed: ${passed} items`, 25, y);
    y += 6;
    doc.text(`• Failed: ${failed} items`, 25, y);
    y += 6;
    doc.text(`• Not assessed: ${total - passed - failed} items`, 25, y);
    y += 6;
    doc.text(`• Photos uploaded: ${checklistState.gallery.allPhotos.length}`, 25, y);
    y += 15;
    
    // Detailed results section
    doc.setFont('helvetica', 'bold');
    doc.text('DETAILED RESULTS:', 20, y);
    y += 10;
    
    galleryChecklistItems.forEach((item, index) => {
      // Check if we need a new page
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      
      const status = checklistState.gallery.items[item.id];
      const comment = checklistState.gallery.comments[item.id] || 'No comment provided';
      
      // Item number and text
      doc.setFont('helvetica', 'bold');
      doc.text(`${index + 1}. ${item.text}`, 20, y);
      y += 6;
      
      // Status with color
      doc.setFont('helvetica', 'bold');
      if (status === 'pass') {
        doc.setTextColor(0, 128, 0); // Green
        doc.text('   Status: ✓ PASS', 20, y);
      } else if (status === 'fail') {
        doc.setTextColor(220, 53, 69); // Red
        doc.text('   Status: ✗ FAIL', 20, y);
      } else {
        doc.setTextColor(108, 117, 125); // Gray
        doc.text('   Status: ? NOT ASSESSED', 20, y);
      }
      doc.setTextColor(0, 0, 0); // Reset to black
      y += 6;
      
      // Comment
      doc.setFont('helvetica', 'normal');
      doc.text('   Comment: ' + comment, 20, y);
      y += 10;
    });
    
    // Photos section
    if (checklistState.gallery.allPhotos.length > 0) {
      if (y > 200) {
        doc.addPage();
        y = 20;
      }
      
      doc.setFont('helvetica', 'bold');
      doc.text('PHOTOS ATTACHED:', 20, y);
      y += 8;
      
      checklistState.gallery.allPhotos.forEach((photo, index) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.setFont('helvetica', 'normal');
        doc.text(`${index + 1}. ${photo.name}`, 25, y);
        y += 6;
        doc.text(`   Uploaded: ${new Date(photo.uploadDate).toLocaleString()}`, 25, y);
        y += 8;
      });
    }
    
    // Signature section
    if (checklistState.gallery.signature) {
      if (y > 240) {
        doc.addPage();
        y = 20;
      }
      
      y += 10;
      doc.setFont('helvetica', 'bold');
      doc.text('REVIEWER SIGNATURE:', 20, y);
      y += 8;
      doc.setFont('helvetica', 'normal');
      doc.text(`Reviewer: ${checklistState.gallery.signature}`, 20, y);
      y += 6;
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y);
    }
    
    // Save the PDF
    const filename = `gallery-checklist-report-${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    
    console.log('PDF exported successfully:', filename);
    
  } catch (error) {
    console.error('Error creating PDF:', error);
    alert('Error creating PDF. Please try again.');
  }
}

// Test function to manually initialize checklists (can be called from browser console)
function testChecklistInit() {
  console.log('Manual checklist test triggered');
  const container = document.getElementById('gallery-items');
  console.log('Container found:', !!container);
  if (container) {
    container.innerHTML = '<div>Manual test - container found!</div>';
    initializeChecklists();
  } else {
    console.error('Container not found - check if checklists tab is active');
  }
}

// Also try to initialize on window load as backup
window.addEventListener('load', function() {
  console.log('Window loaded - checking for active checklists tab');
  setTimeout(() => {
    const checklistTab = document.getElementById('checklists-tab');
    if (checklistTab && checklistTab.classList.contains('active')) {
      console.log('Checklists tab is active on load - initializing');
      initializeChecklists();
    }
  }, 500);
});

</script>

<!-- Notification Badge System -->
<script src="notification-badges.js"></script>

<!-- Contact Chatbot -->
<style>
  /* Chatbot styles */
  .cc-launcher {
    position: fixed; 
    right: 20px; 
    bottom: 20px; 
    z-index: 999999;
    border: none; 
    border-radius: 25px; 
    cursor: pointer;
    background: #45494e;
    color: #ffffff;
    box-shadow: 0 24px 60px rgba(22,25,28,0.16);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 600;
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .cc-launcher:hover { 
    transform: translateY(-2px); 
    filter: brightness(1.05); 
  }
  .cc-launcher-icon {
    font-size: 20px;
  }

  /* Widget panel */
  .cc-widget {
    position: fixed; 
    right: 20px; 
    bottom: 90px; 
    z-index: 999999; 
    display: none;
    width: 380px; 
    max-height: 74vh; 
    background: #ffffff;
    border: 1px solid rgba(69,73,78,0.15); 
    border-radius: 16px;
    box-shadow: 0 24px 60px rgba(22,25,28,0.16); 
    overflow: hidden; 
    flex-direction: column;
  }
  .cc-widget.open { 
    display: flex; 
  }

  .cc-header {
    background: linear-gradient(180deg, #d8d1c5, #ece7de);
    padding: 12px 16px; 
    border-bottom: 1px solid rgba(69,73,78,0.12);
    display: flex; 
    align-items: center; 
    gap: 10px; 
    color: #2b2f33;
  }
  .cc-mark {
    width: 36px; 
    height: 36px; 
    border-radius: 10px;
    background: #45494e;
    display: grid; 
    place-items: center; 
    color: #ffffff; 
    font-weight: 700;
    box-shadow: 0 4px 14px rgba(69,73,78,.25);
  }
  .cc-header h3 { 
    margin: 0; 
    font-size: 15px; 
    line-height: 1.2; 
    font-weight: 700; 
  }
  .cc-header small { 
    display: block; 
    color: #72777d; 
    font-weight: 500; 
  }
  .cc-close { 
    margin-left: auto; 
    border: none; 
    background: transparent; 
    color: #363a3f; 
    cursor: pointer; 
    width: 34px; 
    height: 34px; 
    border-radius: 8px; 
  }
  .cc-close:hover { 
    background: rgba(69,73,78,0.08); 
  }

  .cc-messages { 
    flex: 1; 
    overflow-y: auto; 
    padding: 14px 14px 0 14px; 
    background: linear-gradient(180deg, rgba(216,209,197,0.16), rgba(216,209,197,0));
  }

  .cc-bubble { 
    max-width: 82%; 
    margin: 10px 0; 
    padding: 10px 12px; 
    border-radius: 12px; 
    line-height: 1.45; 
    font-size: 14px; 
  }
  .cc-bubble.user { 
    margin-left: auto; 
    color: #ffffff; 
    background: #45494e; 
    border-top-right-radius: 6px; 
  }
  .cc-bubble.bot { 
    margin-right: auto; 
    background: #f6f4f1; 
    border: 1px solid rgba(69,73,78,0.12); 
    border-top-left-radius: 6px; 
  }

  .cc-typing { 
    display: none; 
    text-align: center; 
    padding: 8px 0 4px; 
  }
  .cc-dot { 
    width: 8px; 
    height: 8px; 
    display: inline-block; 
    border-radius: 50%; 
    background: #c1b9ad; 
    margin: 0 2px; 
    animation: ccDot 1.4s infinite; 
    opacity: .9; 
  }
  .cc-dot:nth-child(2) { animation-delay: .2s; }
  .cc-dot:nth-child(3) { animation-delay: .4s; }
  @keyframes ccDot { 
    0%, 60%, 100% { transform: translateY(0); } 
    30% { transform: translateY(-6px); } 
  }

  .cc-input-area { 
    padding: 12px; 
    border-top: 1px solid rgba(69,73,78,0.12); 
    background: #faf9f7; 
  }
  .cc-row { 
    display: flex; 
    gap: 8px; 
  }
  .cc-input { 
    flex: 1; 
    border: 1px solid rgba(69,73,78,0.25); 
    background: #fff; 
    color: #2b2f33; 
    border-radius: 12px; 
    padding: 10px 12px; 
    outline: none; 
    font-size: 14px; 
  }
  .cc-input:focus { 
    box-shadow: 0 0 0 3px rgba(69,73,78,0.18); 
    border-color: #45494e; 
  }
  .cc-send { 
    background: #45494e; 
    color: #fff; 
    border: none; 
    padding: 0 14px; 
    border-radius: 10px; 
    cursor: pointer; 
    font-weight: 600; 
  }
  .cc-send:hover { 
    filter: brightness(1.05); 
  }

  .cc-suggestions { 
    padding: 8px 0 0; 
    display: flex; 
    gap: 6px; 
    flex-wrap: wrap; 
  }
  .cc-chip { 
    font-size: 12px; 
    padding: 6px 10px; 
    background: #f1efeb; 
    border: 1px solid rgba(69,73,78,0.14); 
    color: #4a4f54; 
    border-radius: 999px; 
    cursor: pointer; 
  }
  .cc-chip:hover { 
    background: #ebe7e0; 
  }

  /* Contact cards */
  .cc-card { 
    background: #fff; 
    border: 1px solid rgba(69,73,78,0.12); 
    border-radius: 12px; 
    padding: 10px; 
    margin-top: 10px; 
  }
  .cc-team { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
    font-weight: 700; 
    color: #2b2f33; 
  }
  .cc-tag { 
    margin-left: auto; 
    font-size: 12px; 
    padding: 2px 8px; 
    border-radius: 999px; 
    background: #f3f2ef; 
    border: 1px solid rgba(69,73,78,0.12); 
    color: #4a4f54; 
  }
  .cc-emails { 
    margin-top: 8px; 
  }
  .cc-email { 
    display: inline-block; 
    font-size: 12px; 
    margin: 4px 6px 0 0; 
    padding: 6px 10px; 
    border-radius: 999px; 
    background: #f6f4f1; 
    border: 1px solid rgba(69,73,78,0.12); 
    text-decoration: none; 
    color: #2b2f33; 
  }
  .cc-email:hover { 
    background: #d8d1c5; 
  }
  .cc-keywords { 
    margin-top: 8px; 
    font-size: 12px; 
    color: #5b6066; 
  }
  .cc-k { 
    background: rgba(216,209,197,.55); 
    color: #1f2327; 
    padding: 0 4px; 
    border-radius: 4px; 
    font-weight: 700; 
  }
  .cc-phone {
    margin-top: 6px; 
    font-size: 13px; 
    color: #4a4f54;
  }
  .cc-phone a {
    color: #2b2f33; 
    text-decoration: underline;
  }

  /* Match borders */
  .match-high { border-left: 4px solid #2f3438; }
  .match-medium { border-left: 4px solid #7f858b; }
  .match-low { border-left: 4px solid #c9c3b8; }

  @media (max-width: 480px) {
    .cc-widget { 
      right: 10px; 
      left: 10px; 
      width: auto; 
    }
    .cc-launcher {
      right: 10px;
    }
  }
</style>

<!-- Launcher Button -->
<button class="cc-launcher" id="cc-launcher" aria-label="Open contact helper" title="Contact Finder">
  <span class="cc-launcher-icon">💬</span>
  <span>Who do I contact?</span>
</button>

<!-- Chatbot Widget -->
<section class="cc-widget" id="cc-widget" aria-live="polite" aria-label="Contact Finder chatbot">
  <header class="cc-header">
    <div class="cc-mark">CC</div>
    <div>
      <h3>Who do I contact?</h3>
      <small>Describe your issue and I'll route you</small>
    </div>
    <button class="cc-close" id="cc-close" title="Close" aria-label="Close">✕</button>
  </header>

  <div class="cc-messages" id="cc-messages"></div>
  <div class="cc-typing" id="cc-typing">
    <span class="cc-dot"></span>
    <span class="cc-dot"></span>
    <span class="cc-dot"></span>
  </div>

  <div class="cc-input-area">
    <div class="cc-row">
      <input id="cc-input" class="cc-input" placeholder="e.g. I need to cancel my order" autocomplete="off" />
      <button id="cc-send" class="cc-send">Send</button>
    </div>
    <div class="cc-suggestions" id="cc-suggestions"></div>
  </div>
</section>

<script>
// Contact Chatbot functionality
(function() {
  let teamContacts = [];

  // Load team contacts from JSON
  async function loadTeamContacts() {
    try {
      const response = await fetch('team_contacts.json');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      teamContacts = await response.json();
      console.log('Team contacts loaded:', teamContacts.length, 'teams');
    } catch (error) {
      console.error('Failed to load team contacts:', error);
      addBot('Sorry, I\'m having trouble loading the team directory. Please try again later or contact Client Services directly.');
    }
  }

  // Matching utilities
  function levenshteinDistance(str1, str2) {
    const len1 = str1.length, len2 = str2.length;
    const dp = Array.from({ length: len2 + 1 }, (_, i) => [i]);
    for (let j = 0; j <= len1; j++) dp[0][j] = j;
    for (let i = 1; i <= len2; i++) {
      for (let j = 1; j <= len1; j++) {
        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
          dp[i][j] = dp[i-1][j-1];
        } else {
          dp[i][j] = Math.min(dp[i-1][j-1] + 1, dp[i][j-1] + 1, dp[i-1][j] + 1);
        }
      }
    }
    return dp[len2][len1];
  }

  function isFuzzyMatch(a, b, max = 2) {
    if (a.length < 4 || b.length < 4) return false;
    if (Math.abs(a.length - b.length) > max) return false;
    return levenshteinDistance(a.toLowerCase(), b.toLowerCase()) <= max;
  }

  function findMatchingTeams(query) {
    if (!query.trim() || teamContacts.length === 0) return [];
    
    const queryWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const matches = [];

    teamContacts.forEach(team => {
      let score = 0;
      const matchedKeywords = [];
      let hasExact = false;
      let hasFuzzy = false;

      // Exact matches
      team.keywords.forEach(kw => {
        const kwWords = kw.toLowerCase().split(/\s+/);
        queryWords.forEach(qw => {
          kwWords.forEach(kwd => {
            if (qw === kwd) {
              score += 100;
              hasExact = true;
              if (!matchedKeywords.includes(kw)) matchedKeywords.push(kw);
            }
          });
        });
      });

      // Fuzzy matches if no exact matches
      if (!hasExact) {
        team.keywords.forEach(kw => {
          const kwWords = kw.toLowerCase().split(/\s+/);
          queryWords.forEach(qw => {
            kwWords.forEach(kwd => {
              if (isFuzzyMatch(qw, kwd)) {
                score += 80;
                hasFuzzy = true;
                if (!matchedKeywords.includes(kw)) {
                  matchedKeywords.push(`${kw} (did you mean "${kwd}")`);
                }
              }
            });
          });
        });
      }

      // Partial matches if no exact or fuzzy matches
      if (!hasExact && !hasFuzzy) {
        team.keywords.forEach(kw => {
          const kwLower = kw.toLowerCase();
          if (query.toLowerCase().includes(kwLower)) {
            score += 50;
            if (!matchedKeywords.includes(kw)) matchedKeywords.push(kw);
            return;
          }
          queryWords.forEach(qw => {
            kwLower.split(/\s+/).forEach(kwd => {
              if (qw.includes(kwd) || kwd.includes(qw)) {
                score += 5;
                if (!matchedKeywords.includes(kw)) matchedKeywords.push(kw);
              }
            });
          });
        });
      }

      if (score > 0) {
        matches.push({ ...team, score, matchedKeywords });
      }
    });

    return matches.sort((a, b) => b.score - a.score);
  }

  // UI elements
  const widget = document.getElementById('cc-widget');
  const launcher = document.getElementById('cc-launcher');
  const closer = document.getElementById('cc-close');
  const messages = document.getElementById('cc-messages');
  const typing = document.getElementById('cc-typing');
  const input = document.getElementById('cc-input');
  const sendBtn = document.getElementById('cc-send');
  const suggestions = document.getElementById('cc-suggestions');

  const chips = [
    'cancel my order', 'damaged artwork', 'order tracking',
    'artist event', 'stock availability', 'installation help',
    'lost shipment', 'returns'
  ];

  function mountChips() {
    suggestions.innerHTML = chips.map(c => 
      `<button class="cc-chip" data-q="${c.replace(/"/g, '&quot;')}">${c}</button>`
    ).join('');
    
    suggestions.querySelectorAll('.cc-chip').forEach(el => {
      el.addEventListener('click', () => {
        input.value = el.dataset.q;
        submitQuery();
      });
    });
  }

  function addBot(html) {
    const b = document.createElement('div');
    b.className = 'cc-bubble bot';
    b.innerHTML = html;
    messages.appendChild(b);
    messages.scrollTop = messages.scrollHeight;
  }

  function addUser(text) {
    const b = document.createElement('div');
    b.className = 'cc-bubble user';
    b.textContent = text;
    messages.appendChild(b);
    messages.scrollTop = messages.scrollHeight;
  }

  function renderCards(matches, query) {
    if (!matches.length) {
      addBot(`No specific team found for "${escapeHtml(query)}".<br/>Try different keywords or contact <strong>Client Services</strong> for general help.`);
      return;
    }

    const html = matches.map((m) => {
      const level = m.score >= 100 ? 'high' : m.score >= 50 ? 'medium' : 'low';
      const pct = Math.min(Math.round((m.score / 100) * 100), 100);
      const emailTags = m.emails.map(e => 
        `<a class="cc-email" href="mailto:${e}?subject=${encodeURIComponent('Who do I contact? - ' + query)}">${e}</a>`
      ).join('');
      const kws = m.matchedKeywords.map(k => `<span class="cc-k">${escapeHtml(k)}</span>`).join(', ');
      const phone = m.phone ? `<div class="cc-phone">📞 <a href="tel:${m.phone}">${m.phone}</a></div>` : '';
      
      return `<div class="cc-card match-${level}">
        <div class="cc-team">💼 ${escapeHtml(m.team)} <span class="cc-tag">${pct}% match</span></div>
        ${phone}
        <div class="cc-emails">${emailTags}</div>
        <div class="cc-keywords">Matched: ${kws}</div>
      </div>`;
    }).join('');

    addBot(html);
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));
  }

  function submitQuery() {
    const q = input.value.trim();
    if (!q) return;
    
    addUser(q);
    input.value = '';
    typing.style.display = 'block';
    
    setTimeout(() => {
      const matches = findMatchingTeams(q);
      typing.style.display = 'none';
      renderCards(matches, q);
    }, 480);
  }

  // Event listeners
  launcher.addEventListener('click', () => {
    widget.classList.add('open');
    input.focus();
    if (!messages.dataset.seeded) {
      seedIntro();
      messages.dataset.seeded = '1';
    }
  });

  closer.addEventListener('click', () => {
    widget.classList.remove('open');
  });

  sendBtn.addEventListener('click', submitQuery);

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') submitQuery();
  });

  function seedIntro() {
    addBot('Hi! 👋 Tell me what you need help with and I\'ll suggest the best team. Try typing something like <em>"I need to cancel my order"</em> or pick a suggestion below.');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    await loadTeamContacts();
    mountChips();
  });
})();
</script>

<!-- Task Creation Modal -->
<div id="task-creation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; backdrop-filter: blur(5px);">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);">
    <h3 style="margin: 0 0 1.5rem 0; color: #2c3e50; font-size: 1.5rem;">Create Task from Failed Item</h3>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Failed Item:</label>
      <div id="failed-item-text" style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; color: #6c757d; border-left: 4px solid #dc3545;"></div>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Task Description:</label>
      <textarea id="task-description" placeholder="Describe what needs to be done to resolve this issue..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; min-height: 100px; resize: vertical;"></textarea>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Due Date:</label>
      <input type="date" id="task-due-date" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #2c3e50; cursor: pointer;">
        <input type="checkbox" id="task-requires-photos" style="margin: 0;">
        Task requires photos for completion
      </label>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button onclick="closeTaskModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
      <button onclick="createTaskFromModal()" style="background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 500;">Create Task</button>
    </div>
  </div>
</div>

<!-- Mobile Back-to-Top FAB -->
<button id="fabTop" class="fab" aria-label="Back to top">↑</button>

<script>
// Mobile-specific enhancements
if (window.innerWidth <= 768) {
  // Back to top FAB functionality
  const fab = document.getElementById('fabTop');
  if (fab) {
    window.addEventListener('scroll', () => {
      fab.classList.toggle('show', window.scrollY > 600);
    });
    fab.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // Enhanced tab navigation for mobile
  const tabButtons = document.querySelectorAll('.tab-button');
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = document.getElementById(button.dataset.tab + '-tab');
      if (targetTab) {
        // Smooth scroll to content
        targetTab.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }
    });
  });

  // Scrollspy for mobile navigation
  const tabMap = new Map([...tabButtons].map(btn => [btn.getAttribute('data-tab') + '-tab', btn]));
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const tab = tabMap.get(entry.target.id);
      if (!tab) return;
      if (entry.isIntersecting) {
        document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }
    });
  }, { 
    rootMargin: '-50% 0px -40% 0px', 
    threshold: 0.01 
  });

  // Observe all tab content sections
  document.querySelectorAll('.tab-content').forEach(section => {
    if (section.id) {
      observer.observe(section);
    }
  });

  // Touch-friendly interactions
  document.addEventListener('touchstart', function() {}, { passive: true });
  
  // Prevent zoom on double-tap for better mobile UX
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  // Mobile Hamburger Menu Functionality
  const mobileHamburgerBtn = document.getElementById('mobile-hamburger-btn');
  
  if (mobileHamburgerBtn) {
    mobileHamburgerBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Mobile hamburger clicked'); // Debug log
      
      // Toggle hamburger animation
      mobileHamburgerBtn.classList.toggle('active');
      
      // Wait for header to load, then try desktop hamburger menu
      setTimeout(() => {
        const desktopMenuToggle = document.getElementById('menu-toggle');
        console.log('Desktop menu toggle found:', desktopMenuToggle); // Debug log
        
        if (desktopMenuToggle) {
          // Make sure sidebar shows on mobile
          const sidebarContainer = document.getElementById('sidebar-container');
          const sidebarOverlay = document.getElementById('sidebar-overlay');
          
          if (sidebarContainer) sidebarContainer.style.display = 'block';
          if (sidebarOverlay) sidebarOverlay.style.display = 'block';
          
          desktopMenuToggle.click();
        } else {
          // Manual sidebar control if desktop menu not found
          console.log('Desktop menu not found, trying manual control');
          
          const sidebar = document.getElementById('sidebar');
          const sidebarOverlay = document.getElementById('sidebar-overlay');
          
          console.log('Manual sidebar elements:', { sidebar, sidebarOverlay });
          
          if (sidebarOverlay) {
            const isOpen = sidebarOverlay.style.display === 'block';
            console.log('Sidebar is currently open:', isOpen);
            
            if (isOpen) {
              // Close sidebar
              sidebarOverlay.style.display = 'none';
              if (sidebar) sidebar.style.transform = 'translateX(-100%)';
            } else {
              // Open sidebar  
              sidebarOverlay.style.display = 'block';
              if (sidebar) sidebar.style.transform = 'translateX(0)';
            }
          }
        }
      }, 100); // Small delay to ensure DOM is ready
    });
  }
  
  // Close sidebar when overlay is clicked
  const sidebarOverlay = document.getElementById('sidebar-overlay');
  if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', function() {
      const mobileHamburgerBtn = document.getElementById('mobile-hamburger-btn');
      const sidebar = document.getElementById('sidebar');
      
      if (sidebar) {
        sidebar.classList.remove('open');
        sidebar.style.transform = 'translateX(-100%)';
        sidebarOverlay.classList.remove('active');
        sidebarOverlay.style.display = 'none';
      }
      
      if (mobileHamburgerBtn) {
        mobileHamburgerBtn.classList.remove('active');
      }
    });
  }

  // Mobile Header Profile Dropdown Functionality
  const mobileProfileBtn = document.getElementById('mobile-user-profile-btn');
  const mobileDropdownMenu = document.getElementById('mobile-profile-dropdown-menu');
  
  if (mobileProfileBtn && mobileDropdownMenu) {
    // Toggle mobile dropdown
    mobileProfileBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      mobileDropdownMenu.classList.toggle('active');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!mobileDropdownMenu.contains(e.target) && !mobileProfileBtn.contains(e.target)) {
        mobileDropdownMenu.classList.remove('active');
      }
    });
    
    // Connect mobile dropdown items to existing desktop functionality
    const mobileAccountSettingsBtn = document.getElementById('mobile-account-settings-btn');
    const mobileChangePasswordBtn = document.getElementById('mobile-change-password-btn');
    const mobileSignoutBtn = document.getElementById('mobile-profile-signout-btn');
    
    // Account settings
    if (mobileAccountSettingsBtn) {
      mobileAccountSettingsBtn.addEventListener('click', function() {
        const desktopAccountBtn = document.getElementById('account-settings-btn');
        if (desktopAccountBtn) {
          desktopAccountBtn.click();
        }
        mobileDropdownMenu.classList.remove('active');
      });
    }
    
    // Change password
    if (mobileChangePasswordBtn) {
      mobileChangePasswordBtn.addEventListener('click', function() {
        const desktopChangePasswordBtn = document.getElementById('change-password-btn');
        if (desktopChangePasswordBtn) {
          desktopChangePasswordBtn.click();
        }
        mobileDropdownMenu.classList.remove('active');
      });
    }
    
    // Sign out
    if (mobileSignoutBtn) {
      mobileSignoutBtn.addEventListener('click', function() {
        const desktopSignoutBtn = document.getElementById('profile-signout-btn');
        if (desktopSignoutBtn) {
          desktopSignoutBtn.click();
        }
        mobileDropdownMenu.classList.remove('active');
      });
    }
    
    // Sync user information from desktop elements
    function syncUserInfo() {
      // Sync user name from desktop dropdown or greeting
      const desktopUserName = document.getElementById('dropdown-user-name') || document.getElementById('user-name-display');
      const mobileUserName = document.getElementById('mobile-dropdown-user-name');
      if (desktopUserName && mobileUserName) {
        mobileUserName.textContent = desktopUserName.textContent;
      }
      
      // Sync user email
      const desktopUserEmail = document.getElementById('dropdown-user-email');
      const mobileUserEmail = document.getElementById('mobile-dropdown-user-email');
      if (desktopUserEmail && mobileUserEmail) {
        mobileUserEmail.textContent = desktopUserEmail.textContent;
      }
      
      // Sync user initials
      const desktopUserInitials = document.getElementById('user-initials');
      const mobileUserInitials = document.getElementById('mobile-user-initials');
      const mobileDropdownInitials = document.getElementById('mobile-dropdown-user-initials');
      if (desktopUserInitials) {
        if (mobileUserInitials) {
          mobileUserInitials.textContent = desktopUserInitials.textContent;
        }
        if (mobileDropdownInitials) {
          mobileDropdownInitials.textContent = desktopUserInitials.textContent;
        }
      }
      
      // Sync profile images
      const desktopProfileBtn = document.getElementById('user-profile-btn');
      const mobileProfileImage = document.getElementById('mobile-profile-image');
      const mobileDropdownImage = document.getElementById('mobile-dropdown-user-image');
      const mobileUserInitialsEl = document.getElementById('mobile-user-initials');
      const mobileDropdownInitialsEl = document.getElementById('mobile-dropdown-user-initials');
      
      if (desktopProfileBtn) {
        const desktopImg = desktopProfileBtn.querySelector('img') || desktopProfileBtn.querySelector('.profile-photo');
        
        if (desktopImg && desktopImg.src && desktopImg.style.display !== 'none') {
          // Show profile images
          if (mobileProfileImage) {
            mobileProfileImage.src = desktopImg.src;
            mobileProfileImage.style.display = 'block';
            if (mobileUserInitialsEl) mobileUserInitialsEl.style.display = 'none';
          }
          if (mobileDropdownImage) {
            mobileDropdownImage.src = desktopImg.src;
            mobileDropdownImage.style.display = 'block';
            if (mobileDropdownInitialsEl) mobileDropdownInitialsEl.style.display = 'none';
          }
        } else {
          // Show initials instead
          if (mobileProfileImage) {
            mobileProfileImage.style.display = 'none';
            if (mobileUserInitialsEl) mobileUserInitialsEl.style.display = 'block';
          }
          if (mobileDropdownImage) {
            mobileDropdownImage.style.display = 'none';
            if (mobileDropdownInitialsEl) mobileDropdownInitialsEl.style.display = 'block';
          }
        }
      }
      
      // Also sync from preview elements (when user changes profile in settings)
      const previewPhoto = document.getElementById('preview-photo');
      if (previewPhoto && previewPhoto.style.display !== 'none' && previewPhoto.src) {
        if (mobileProfileImage) {
          mobileProfileImage.src = previewPhoto.src;
          mobileProfileImage.style.display = 'block';
          if (mobileUserInitialsEl) mobileUserInitialsEl.style.display = 'none';
        }
        if (mobileDropdownImage) {
          mobileDropdownImage.src = previewPhoto.src;
          mobileDropdownImage.style.display = 'block';
          if (mobileDropdownInitialsEl) mobileDropdownInitialsEl.style.display = 'none';
        }
      }
    }
    
    // Initial sync when page loads
    setTimeout(syncUserInfo, 1000);
    
    // Sync when desktop user info changes
    const observer = new MutationObserver(syncUserInfo);
    const desktopUserName = document.getElementById('dropdown-user-name') || document.getElementById('user-name-display');
    const desktopUserEmail = document.getElementById('dropdown-user-email');
    const desktopUserInitials = document.getElementById('user-initials');
    const desktopProfileBtn = document.getElementById('user-profile-btn');
    const previewPhoto = document.getElementById('preview-photo');
    
    if (desktopUserName) observer.observe(desktopUserName, { childList: true, subtree: true });
    if (desktopUserEmail) observer.observe(desktopUserEmail, { childList: true, subtree: true });
    if (desktopUserInitials) observer.observe(desktopUserInitials, { childList: true, subtree: true });
    if (desktopProfileBtn) observer.observe(desktopProfileBtn, { childList: true, subtree: true, attributes: true });
    if (previewPhoto) observer.observe(previewPhoto, { attributes: true, attributeFilter: ['src', 'style'] });
    
  }
}
</script>

</body>
</html>
