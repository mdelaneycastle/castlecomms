
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Castle Comms</title>
  <link rel="stylesheet" href="style.css?v=20250731" />
</head>
<body>
  
<header>
  <button id="menu-toggle" class="hamburger">&#9776;</button>
  <h1>Castle Comms</h1>
</header>
  <div id="notification-bell" class="notification-bell hidden">
  ðŸ”” <span id="notification-count" class="count-badge">0</span>
</div>

<div id="sidebar-container"></div>

<main id="main">
  <div class="welcome-message" id="welcome-message">
    <h2 id="welcome-text">Welcome to Castle Comms</h2>
  </div>
  
  <div class="quick-links">
    <a href="http://192.168.28.246/CGNET2024/rptLeagueTable.aspx" target="_blank" title="Target League Table" class="premium-link target-league">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">TARGETS</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">League Table</div>
        <div class="premium-subtitle">Performance Rankings</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
    <a href="https://secure.workforceready.eu/ta/6164422.home?rnd=FRX&showAdmin=1&Ext=clock&sft=YLYWTXGNBA&ActiveSessionId=5177576674#home" target="_blank" title="Kronos" class="premium-link kronos">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">TIME</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">Kronos</div>
        <div class="premium-subtitle">Workforce Management</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
    <a href="http://192.168.28.246/cgnet2024/login.aspx" target="_blank" title="CGNet" class="premium-link cgnet">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">SYSTEM</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">CGNet</div>
        <div class="premium-subtitle">Core Management</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
    <a href="http://www.castlefineart.com/" target="_blank" title="CFA Website" class="premium-link cfa-website">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">WEBSITE</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">CFA Website</div>
        <div class="premium-subtitle">Public Portal</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
    <a href="https://castlefineart.storiq.net/files?expandedFolder=%2FCompliance%2F&bucket_key=castlefineart-storiq-net" target="_blank" title="Anti Money Laundering" class="premium-link aml">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">COMPLIANCE</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">Anti Money Laundering</div>
        <div class="premium-subtitle">Legal Documentation</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
    <a href="https://washingtongreen.pagetiger.com/bimunif" target="_blank" title="Gallery Technician Manual" class="premium-link tech-manual">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">TECHNICAL</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">Technician Manual</div>
        <div class="premium-subtitle">Technical Reference</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
    <a href="https://washingtongreen.pagetiger.com/ibmxza" target="_blank" title="Gallery Manual" class="gallery-manual-redesign">
      <div class="manual-backdrop"></div>
      <div class="manual-content">
        <div class="manual-header">
          <div class="manual-badge">GUIDE</div>
          <div class="manual-glow"></div>
        </div>
        <div class="premium-title">Gallery Manual</div>
        <div class="premium-subtitle">Complete Reference</div>
        <div class="manual-arrow">â†’</div>
      </div>
    </a>
    <a href="https://app.powerbi.com/reportEmbed?reportId=5a5e361e-661c-41c9-90ae-821b46de10ae&autoAuth=true&ctid=61920045-21d7-47e7-a0c1-3a915893488a" target="_blank" title="YTD Sales Report 2025" class="premium-link sales-ytd">
      <div class="premium-backdrop"></div>
      <div class="premium-content">
        <div class="premium-header">
          <div class="premium-badge">ANALYTICS</div>
          <div class="premium-glow"></div>
        </div>
        <div class="premium-title">Sales YTD</div>
        <div class="premium-subtitle">Performance Data</div>
        <div class="premium-arrow">â†’</div>
      </div>
    </a>
  </div>

  <div style="text-align: center; margin-top: 3rem;">
    <a href="contact-finder.html" class="cta-button">
      ðŸ¤” Who do I contact? - Smart Team Finder
    </a>
  </div>

  <!-- Dashboard Cards -->
  <div class="dashboard-cards">
    <div class="dashboard-card" id="newsfeed-card">
      <h3>Newsfeed Posts</h3>
      <div class="card-content" id="newsfeed-content">
        <div class="loading">Loading recent posts...</div>
      </div>
    </div>
    
    <div class="dashboard-card" id="messages-card">
      <h3>Messages</h3>
      <div class="card-content" id="messages-content">
        <div class="loading">Loading latest messages...</div>
      </div>
    </div>
    
    <div class="dashboard-card" id="tickets-card">
      <h3>Tickets</h3>
      <div class="card-content" id="tickets-content">
        <div class="loading">Loading latest tickets...</div>
      </div>
    </div>
  </div>

  <!-- Background Slideshow -->
  <div class="background-slideshow" id="background-slideshow">
    <!-- Images will be injected by JavaScript -->
  </div>

  <!-- Commented Out Gallery for Testing -->
  <!--
  <section class="gallery-section">
    <h2 class="gallery-title">Inside Spitfire</h2>
    
    <div class="gallery-container">
      <div class="gallery-main">
        <div class="gallery-viewer">
          <img id="gallery-main-image" src="images/web-optimized/1.jpg" alt="Gallery Image" loading="lazy">
          <div class="gallery-nav">
            <button class="gallery-btn gallery-prev" id="gallery-prev">â€¹</button>
            <button class="gallery-btn gallery-next" id="gallery-next">â€º</button>
          </div>
          <div class="gallery-counter">
            <span id="gallery-current">1</span> / <span id="gallery-total">21</span>
          </div>
        </div>
      </div>
      
      <div class="gallery-thumbnails" id="gallery-thumbnails">
      </div>
    </div>
  </section>
  -->
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<!-- Site scripts -->
<script src="script.js"></script>

<!-- Notification system -->
<script src="notifications.js"></script>

<script>
// Personalize welcome message
firebase.auth().onAuthStateChanged(async (user) => {
  if (user) {
    const welcomeText = document.getElementById('welcome-text');
    if (welcomeText && window.sharedComponents) {
      try {
        const displayName = await window.sharedComponents.getUserDisplayName(user);
        welcomeText.textContent = `Hi ${displayName}!`;
      } catch (error) {
        console.error('Error loading display name:', error);
        // Fallback to email extraction
        const emailName = user.email.split('@')[0];
        const fallbackName = emailName
          .replace(/[._-]/g, ' ')
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
        welcomeText.textContent = `Hi ${fallbackName}!`;
      }
    }
  }
});

// Dashboard Cards Functionality
document.addEventListener('DOMContentLoaded', function() {
  // CSS Debug - Check if styles are loaded
  console.log('ðŸŽ¨ FIXED: Dashboard CSS loaded - Quick links should have 16px gap and 79px height (10% bigger)');
  
  const quickLinks = document.querySelector('.quick-links');
  if (quickLinks) {
    const styles = window.getComputedStyle(quickLinks);
    console.log('ðŸ” FIXED: Quick-links container styles:', {
      display: styles.display,
      gap: styles.gap,
      gridTemplateColumns: styles.gridTemplateColumns,
      gridTemplateRows: styles.gridTemplateRows,
      justifyItems: styles.justifyItems,
      alignItems: styles.alignItems
    });
    
    const allLinks = quickLinks.querySelectorAll('a, .premium-link');
    console.log(`ðŸ” Found ${allLinks.length} quick-link buttons`);
    
    allLinks.forEach((link, index) => {
      const linkStyles = window.getComputedStyle(link);
      console.log(`ðŸ” Button ${index + 1} styles:`, {
        width: linkStyles.width,
        height: linkStyles.height,
        position: linkStyles.position,
        margin: linkStyles.margin,
        display: linkStyles.display
      });
    });
  }
  
  // Load dashboard data when user is authenticated
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      loadDashboardData();
    }
  });

  async function loadDashboardData() {
    loadNewsfeedMentions();
    loadLatestMessages();
    loadLatestTickets();
  }

  async function loadNewsfeedMentions() {
    const container = document.getElementById('newsfeed-content');
    try {
      // Load posts from Firebase Database (same path as script.js uses)
      const postsRef = firebase.database().ref('posts');
      const snapshot = await postsRef.orderByKey().limitToLast(5).once('value');
      const data = snapshot.val();
      
      if (data) {
        const items = Object.values(data).reverse();
        container.innerHTML = items.map(item => `
          <div class="item">
            <div class="item-header">${item.name || 'Anonymous'}</div>
            <div class="item-meta">${formatDate(item.timestamp)}</div>
            <div class="item-content">${item.message || item.content || 'No content available'}</div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="no-data">No recent posts found</div>';
      }
    } catch (error) {
      console.error('Error loading newsfeed:', error);
      container.innerHTML = '<div class="no-data">Error loading posts</div>';
    }
  }

  async function loadLatestMessages() {
    const container = document.getElementById('messages-content');
    try {
      // Try Firestore first, then fallback to showing recent post comments as "messages"
      if (firebase.firestore) {
        try {
          const db = firebase.firestore();
          const currentUser = firebase.auth().currentUser;
          
          // First, get chats where the user is a participant
          const chatsSnapshot = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.email)
            .get();
          
          if (!chatsSnapshot.empty) {
            const chatIds = chatsSnapshot.docs.map(doc => doc.id);
            
            // Get recent messages from those chats
            const messagesSnapshot = await db.collection('chat-messages')
              .where('chatId', 'in', chatIds.slice(0, 10)) // Firestore 'in' has limit of 10
              .orderBy('timestamp', 'desc')
              .limit(5)
              .get();
            
            if (!messagesSnapshot.empty) {
              // Get chat names for display
              const chatLookup = {};
              chatsSnapshot.docs.forEach(doc => {
                chatLookup[doc.id] = doc.data().name;
              });
              
              const items = messagesSnapshot.docs.map(doc => doc.data());
              container.innerHTML = items.map(item => `
                <div class="item">
                  <div class="item-header">${chatLookup[item.chatId] || 'Chat'}</div>
                  <div class="item-meta">${item.senderName || 'Unknown'} â€¢ ${formatDate(item.timestamp?.toDate?.() || item.timestamp)}</div>
                  <div class="item-content">${item.message || 'No message content'}</div>
                </div>
              `).join('');
              return;
            }
          }
          
          console.log('No chat messages found, trying all messages...');
          // Fallback: try to get any recent messages
          const allMessagesSnapshot = await db.collection('chat-messages')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get();
          
          if (!allMessagesSnapshot.empty) {
            const items = allMessagesSnapshot.docs.map(doc => doc.data());
            container.innerHTML = items.map(item => `
              <div class="item">
                <div class="item-header">Chat Message</div>
                <div class="item-meta">${item.senderName || 'Unknown'} â€¢ ${formatDate(item.timestamp?.toDate?.() || item.timestamp)}</div>
                <div class="item-content">${item.message || 'No message content'}</div>
              </div>
            `).join('');
            return;
          }
        } catch (firestoreError) {
          console.log('Firestore not accessible, using fallback...', firestoreError);
        }
      }
      
      // Fallback: Show recent activity from posts (comments as "messages")
      const postsRef = firebase.database().ref('posts');
      const snapshot = await postsRef.orderByKey().limitToLast(10).once('value');
      const data = snapshot.val();
      
      if (data) {
        const recentActivity = [];
        Object.values(data).forEach(post => {
          if (post.comments) {
            Object.values(post.comments).forEach(comment => {
              recentActivity.push({
                type: 'comment',
                postTitle: post.message?.substring(0, 30) + '...' || 'Post',
                author: 'User',
                content: comment.text || comment.content || comment,
                timestamp: comment.timestamp || Date.now()
              });
            });
          }
        });
        
        // Sort by timestamp and get latest 5
        recentActivity.sort((a, b) => b.timestamp - a.timestamp);
        const latest = recentActivity.slice(0, 5);
        
        if (latest.length > 0) {
          container.innerHTML = latest.map(item => `
            <div class="item">
              <div class="item-header">Comment on: ${item.postTitle}</div>
              <div class="item-meta">${item.author} â€¢ ${formatDate(item.timestamp)}</div>
              <div class="item-content">${item.content}</div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="no-data">No recent activity found</div>';
        }
      } else {
        container.innerHTML = '<div class="no-data">No recent messages found</div>';
      }
    } catch (error) {
      console.error('Error loading messages:', error);
      container.innerHTML = '<div class="no-data">Error loading messages</div>';
    }
  }

  async function loadLatestTickets() {
    const container = document.getElementById('tickets-content');
    try {
      // Try Firestore first, then fallback to placeholder tickets
      if (firebase.firestore) {
        try {
          const db = firebase.firestore();
          const ticketsSnapshot = await db.collection('tickets')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();
          
          if (!ticketsSnapshot.empty) {
            const items = ticketsSnapshot.docs.map(doc => doc.data());
            container.innerHTML = items.map(item => `
              <div class="item">
                <div class="item-header">#${item.ticketId || 'N/A'} - ${item.title || 'Support Ticket'}</div>
                <div class="item-meta">${item.status || 'Open'} â€¢ ${item.priority || 'Normal'} â€¢ ${formatDate(item.createdAt?.toDate?.() || item.createdAt)}</div>
                <div class="item-content">${item.description || 'No description available'}</div>
              </div>
            `).join('');
            return;
          }
        } catch (firestoreError) {
          console.log('Firestore tickets not accessible, using fallback...');
        }
      }
      
      // Fallback: Show getting started information about tickets
      container.innerHTML = `
        <div class="item">
          <div class="item-header">Welcome to Support Tickets</div>
          <div class="item-meta">System â€¢ Just now</div>
          <div class="item-content">Create your first support ticket to get started. Tickets help track and resolve issues efficiently.</div>
        </div>
        <div class="item">
          <div class="item-header">Ticket System Ready</div>
          <div class="item-meta">System â€¢ Ready</div>
          <div class="item-content">The ticketing system is ready for use. Visit the Tickets page to create and manage support requests.</div>
        </div>
      `;
      
    } catch (error) {
      console.error('Error loading tickets:', error);
      container.innerHTML = '<div class="no-data">Visit the Tickets page to create your first support ticket</div>';
    }
  }

  function formatDate(timestamp) {
    if (!timestamp) return 'Unknown time';
    const date = new Date(timestamp);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
  }
});
</script>

</body>
</html>
