
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Castle Comms</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="style.css?v=20250813_din_font_update" />
  <style>
    /* Tab Navigation Styles */
    .tab-navigation {
      display: flex;
      justify-content: center;
      gap: 1rem;
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      margin: 0;
      padding: 0 2rem;
      margin-top: -15px;
    }

    .tab-button {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #333;
      padding: 1rem 1.5rem;
      border-radius: 0 0 20px 20px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-width: 120px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }

    .tab-button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .tab-button.active {
      background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(2px);
    }

    .tab-button.active:hover {
      background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
    }

    /* Tab Content Styles */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Move existing content down to account for tabs */
    .modern-main {
      margin-top: 1rem;
      position: relative;
    }

    @media (max-width: 768px) {
      .tab-navigation {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0 1rem;
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        margin-top: -12px;
      }

      .tab-button {
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
        min-width: 100px;
      }

      .modern-main {
        margin-top: 1.5rem;
      }
    }
  </style>
</head>
<body>
<script>
console.log('üöÄ CACHE BUSTED: Glass Morphism HTML loaded - Version 2025-08-12!');
console.log('üé® If you still see old styling, try hard refresh (Ctrl+F5 or Cmd+Shift+R)');
</script>
  
<div id="header-container"></div>

<div id="sidebar-container"></div>
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<main id="main" class="modern-main">
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-button active" data-tab="home">Home</button>
    <button class="tab-button" data-tab="tasks">Tasks</button>
    <button class="tab-button" data-tab="forms">Forms</button>
    <button class="tab-button" data-tab="communications">Communications</button>
  </div>

  <!-- Home Tab Content (Original home page) -->
  <div class="tab-content active" id="home-tab">
    <!-- Action Buttons -->
    <div class="action-buttons">
      <a href="contact-finder.html" class="pill-button">
        <span>ü§î</span> Who should I contact?
      </a>
      <a href="news-mentions.html" class="pill-button">
        <span>üì∞</span> News and Media mentions
      </a>
    </div>

    <!-- Quicklinks Section -->
    <section class="quicklinks-section">
      <h2 class="section-title">Quicklinks</h2>
      <div class="modern-quick-links">
      <a href="http://192.168.28.246/CGNET2024/rptLeagueTable.aspx" target="_blank" title="Target League Table" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">League Table</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="https://secure.workforceready.eu/ta/6164422.home?rnd=FRX&showAdmin=1&Ext=clock&sft=YLYWTXGNBA&ActiveSessionId=5177576674#home" target="_blank" title="Kronos" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Kronos</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="http://192.168.28.246/cgnet2024/login.aspx" target="_blank" title="CGNet" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">CGNet</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="http://www.castlefineart.com/" target="_blank" title="CFA Website" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">CFA Website</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="https://castlefineart.storiq.net/files?expandedFolder=%2FCompliance%2F&bucket_key=castlefineart-storiq-net" target="_blank" title="Anti Money Laundering" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Anti Money Laundering</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="https://washingtongreen.pagetiger.com/bimunif" target="_blank" title="Gallery Technician Manual" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Technician Manual</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="https://washingtongreen.pagetiger.com/ibmxza" target="_blank" title="Gallery Manual" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Gallery Manual</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
      <a href="https://app.powerbi.com/reportEmbed?reportId=5a5e361e-661c-41c9-90ae-821b46de10ae&autoAuth=true&ctid=61920045-21d7-47e7-a0c1-3a915893488a" target="_blank" title="YTD Sales Report 2025" class="modern-quicklink">
        <div class="quicklink-content">
          <span class="quicklink-label">Sales YTD</span>
          <span class="quicklink-arrow">‚Üí</span>
        </div>
      </a>
    </div>
    </section>

    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
      <div class="dashboard-card" id="newsfeed-card">
        <h3>Newsfeed Posts</h3>
        <div class="card-content" id="newsfeed-content">
          <div class="loading">Loading recent posts...</div>
        </div>
      </div>
      
      <div class="dashboard-card" id="messages-card">
        <h3>Messages</h3>
        <div class="card-content" id="messages-content">
          <div class="loading">Loading latest messages...</div>
        </div>
      </div>
      
      <div class="dashboard-card" id="tickets-card">
        <h3>Tickets</h3>
        <div class="card-content" id="tickets-content">
          <div class="loading">Loading latest tickets...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Tab Content -->
  <div class="tab-content" id="tasks-tab">
    <div style="text-align: center; padding: 4rem 2rem; color: #666;">
      <h2>Tasks</h2>
      <p>Task management coming soon...</p>
    </div>
  </div>

  <!-- Forms Tab Content -->
  <div class="tab-content" id="forms-tab">
    <div style="text-align: center; padding: 4rem 2rem; color: #666;">
      <h2>Forms</h2>
      <p>Form management coming soon...</p>
    </div>
  </div>

  <!-- Communications Tab Content -->
  <div class="tab-content" id="communications-tab">
    <div class="communications-container" style="max-width: 1000px; margin: 0 auto; padding: 2rem; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius, 12px); box-shadow: var(--shadow-medium, 0 4px 20px rgba(0,0,0,0.1)); backdrop-filter: blur(10px);">
      <div class="communications-header" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="margin: 0; font-size: 2.5rem; font-weight: 600; background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üì¢ Communications</h1>
      </div>
      
      <!-- Communications Admin Section (only visible to admins and communications admins) -->
      <div class="admin-section" data-communications-admin style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; display: none;">
        <h3 style="color: #856404; margin: 0 0 1rem 0; font-size: 1.3rem;">üì¢ Communications Admin</h3>
        <p style="color: #856404; margin: 0 0 1rem 0; font-size: 0.9rem;">
          Create and manage company-wide communications, announcements, and updates.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-start; flex-wrap: wrap;">
          <a href="communications-admin.html" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
            ‚úèÔ∏è Create New Communication
          </a>
          <a href="news-mentions.html" style="background: #28a745; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
            üì∞ Manage News & Media
          </a>
        </div>
      </div>
      
      <div class="communications-filters" id="comm-filters" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="comm-filter-button active" data-filter="all" style="background: var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%)); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">All</button>
        <button class="comm-filter-button" data-filter="unread" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Unread</button>
        <button class="comm-filter-button" data-filter="urgent" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Urgent</button>
        <button class="comm-filter-button" data-filter="documents" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">With Documents</button>
        <button class="comm-filter-button" data-filter="powerbi" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">With Data</button>
        <button class="comm-filter-button" data-filter="tasks" style="background: #f8f9fa; border: 1px solid #e1e5e9; color: #6c757d; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">With Tasks</button>
      </div>
      
      <div class="communications-list" id="communications-list">
        <div class="loading" style="text-align: center; padding: 3rem; color: #6c757d;">Loading communications...</div>
      </div>
    </div>
  </div>

  <!-- Background Slideshow -->
  <div class="background-slideshow" id="background-slideshow">
    <!-- Images will be injected by JavaScript -->
  </div>

  <!-- Commented Out Gallery for Testing -->
  <!--
  <section class="gallery-section">
    <h2 class="gallery-title">Inside Spitfire</h2>
    
    <div class="gallery-container">
      <div class="gallery-main">
        <div class="gallery-viewer">
          <img id="gallery-main-image" src="images/web-optimized/1.jpg" alt="Gallery Image" loading="lazy">
          <div class="gallery-nav">
            <button class="gallery-btn gallery-prev" id="gallery-prev">‚Äπ</button>
            <button class="gallery-btn gallery-next" id="gallery-next">‚Ä∫</button>
          </div>
          <div class="gallery-counter">
            <span id="gallery-current">1</span> / <span id="gallery-total">21</span>
          </div>
        </div>
      </div>
      
      <div class="gallery-thumbnails" id="gallery-thumbnails">
      </div>
    </div>
  </section>
  -->
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Firebase config -->
<script src="firebase-init.js"></script>

<!-- Shared components -->
<script src="shared-components.js"></script>

<!-- Site scripts -->
<script src="script.js"></script>

<!-- Notification system -->

<script>

// Tab Functionality
function initializeTabs() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabId = button.getAttribute('data-tab');
      
      // Remove active class from all buttons and contents
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked button and corresponding content
      button.classList.add('active');
      document.getElementById(`${tabId}-tab`).classList.add('active');
    });
  });
}

// Communications Functionality
let db;
let currentUser;
let currentCommFilter = 'all';

function initializeCommunications() {
  // Check authentication first
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.log('User not authenticated for communications');
      return;
    }

    currentUser = user;
    
    // Show/hide admin sections based on permissions
    if (window.authUtils) {
      const isCommunicationsAdmin = await window.authUtils.isCommunicationsAdmin(user);
      const adminSection = document.querySelector('[data-communications-admin]');
      if (adminSection) {
        adminSection.style.display = isCommunicationsAdmin ? 'block' : 'none';
      }
    }
    
    // Initialize Firebase Firestore
    if (firebase.apps.length > 0) {
      db = firebase.firestore();
      setupCommunicationsFilters();
      loadCommunications();
    } else {
      console.error('Firebase not initialized for communications');
    }
  });
}

// Setup communications filter buttons
function setupCommunicationsFilters() {
  const filterButtons = document.querySelectorAll('.comm-filter-button');
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Update active state
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#6c757d';
        btn.style.border = '1px solid #e1e5e9';
      });
      button.classList.add('active');
      button.style.background = 'var(--primary-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%))';
      button.style.color = 'white';
      button.style.border = 'none';
      
      // Update current filter
      currentCommFilter = button.dataset.filter;
      
      // Reload communications with filter
      loadCommunications();
    });
  });
}

// Load communications
async function loadCommunications() {
  const communicationsList = document.getElementById('communications-list');
  
  if (!db || !currentUser) {
    communicationsList.innerHTML = '<div class="loading">Please log in to view communications.</div>';
    return;
  }
  
  try {
    const communications = await db.collection('communications')
      .orderBy('createdAt', 'desc')
      .get();
    
    if (communications.empty) {
      communicationsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">No communications yet.</div>';
      return;
    }
    
    let filteredCommunications = communications.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Apply filter
    filteredCommunications = applyCommFilter(filteredCommunications);
    
    if (filteredCommunications.length === 0) {
      communicationsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">No communications match the current filter.</div>';
      return;
    }
    
    const communicationItems = await Promise.all(filteredCommunications.map(async (comm) => {
      const isRead = await isUserReadComm(comm.id);
      const documents = comm.documents || [];
      const powerbiItems = comm.powerbi || [];
      const tasks = comm.tasks || [];
      
      // Create badges
      const badges = [];
      if (!isRead) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #667eea; color: white;">New</span>');
      if (comm.urgent) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #ffebee; color: #c62828;">Urgent</span>');
      if (documents.length > 0) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #e3f2fd; color: #1565c0;">üìé Documents</span>');
      if (powerbiItems.length > 0) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #fff3e0; color: #ef6c00;">üìä Data</span>');
      if (tasks.length > 0) badges.push('<span style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: #f3e5f5; color: #7b1fa2;">‚úì Tasks</span>');
      
      return `
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; transition: all 0.3s; border-left: 4px solid ${!isRead ? '#667eea' : 'transparent'}; ${comm.urgent ? 'border-left-color: #dc3545;' : ''} margin-bottom: 1.5rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">
          <div style="padding: 1.5rem; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="toggleCommunication('${comm.id}')">
            <div style="font-size: 1.3rem; font-weight: 600; color: #2c3e50; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
              ${comm.title}
              ${comm.urgent ? 'üö®' : ''}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #6c757d; margin-bottom: 0.5rem;">
              <span>Published: ${formatCommTimestamp(comm.createdAt?.toDate?.() || new Date())}</span>
              <button style="background: none; border: none; color: #667eea; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" id="expand-btn-${comm.id}">
                <span>View Details</span>
                <span style="transition: transform 0.3s;">‚ñº</span>
              </button>
            </div>
            <div style="color: #495057; line-height: 1.5; margin-bottom: 1rem;">${comm.summary || comm.content.substring(0, 200)}...</div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${badges.join('')}
            </div>
          </div>
          
          <div id="content-${comm.id}" style="display: none; padding: 1.5rem; border-top: 1px solid #f0f0f0;">
            <div style="line-height: 1.6; margin-bottom: 2rem;">${comm.content}</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
              <button onclick="toggleReadStatus('${comm.id}')" style="background: ${isRead ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                ${isRead ? 'Mark as Unread' : 'Mark as Read'}
              </button>
            </div>
          </div>
        </div>
      `;
    }));
    
    communicationsList.innerHTML = communicationItems.join('');
    
  } catch (error) {
    console.error('Error loading communications:', error);
    communicationsList.innerHTML = '<div style="background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">Failed to load communications.</div>';
  }
}

// Apply current filter
function applyCommFilter(communications) {
  if (currentCommFilter === 'all') return communications;
  
  return communications.filter(comm => {
    switch (currentCommFilter) {
      case 'unread':
        return !isUserReadSyncComm(comm.id);
      case 'urgent':
        return comm.urgent;
      case 'documents':
        return comm.documents && comm.documents.length > 0;
      case 'powerbi':
        return comm.powerbi && comm.powerbi.length > 0;
      case 'tasks':
        return comm.tasks && comm.tasks.length > 0;
      default:
        return true;
    }
  });
}

// Toggle communication expanded state
function toggleCommunication(commId) {
  const content = document.getElementById(`content-${commId}`);
  const expandBtn = document.getElementById(`expand-btn-${commId}`);
  
  if (content.style.display === 'none' || !content.style.display) {
    content.style.display = 'block';
    expandBtn.querySelector('span:last-child').style.transform = 'rotate(180deg)';
    expandBtn.querySelector('span:first-child').textContent = 'Hide Details';
  } else {
    content.style.display = 'none';
    expandBtn.querySelector('span:last-child').style.transform = 'rotate(0deg)';
    expandBtn.querySelector('span:first-child').textContent = 'View Details';
  }
}

// Check if user has read a communication
async function isUserReadComm(commId) {
  try {
    const readDoc = await db.collection('communication-reads')
      .where('communicationId', '==', commId)
      .where('userId', '==', currentUser.uid)
      .get();
    
    return !readDoc.empty;
  } catch (error) {
    console.error('Error checking read status:', error);
    return false;
  }
}

// Synchronous version for filtering
function isUserReadSyncComm(commId) {
  return false; // Default to unread for filtering
}

// Toggle read status
async function toggleReadStatus(commId) {
  try {
    const readQuery = db.collection('communication-reads')
      .where('communicationId', '==', commId)
      .where('userId', '==', currentUser.uid);
    
    const readDocs = await readQuery.get();
    
    if (readDocs.empty) {
      // Mark as read
      await db.collection('communication-reads').add({
        communicationId: commId,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        readAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      // Mark as unread
      const batch = db.batch();
      readDocs.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
    }
    
    // Reload communications
    loadCommunications();
    
  } catch (error) {
    console.error('Error toggling read status:', error);
  }
}

// Format timestamp
function formatCommTimestamp(timestamp) {
  if (!timestamp) return 'Just now';
  
  const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  
  return date.toLocaleDateString();
}

// Dashboard Cards Functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tabs
  initializeTabs();
  
  // Initialize communications functionality
  initializeCommunications();
  
  // CSS Debug - Check if new glass morphism styles are loaded
  console.log('‚ú® GLASS MORPHISM: New design loaded with modern-quick-links!');
  
  const modernQuickLinks = document.querySelector('.modern-quick-links');
  if (modernQuickLinks) {
    const styles = window.getComputedStyle(modernQuickLinks);
    console.log('üîç NEW: Modern glass morphism quicklinks styles:', {
      display: styles.display,
      gap: styles.gap,
      gridTemplateColumns: styles.gridTemplateColumns,
      background: styles.background,
      backdropFilter: styles.backdropFilter
    });
    
    const allLinks = modernQuickLinks.querySelectorAll('.modern-quicklink');
    console.log(`üîç Found ${allLinks.length} modern glass morphism buttons`);
    
    allLinks.forEach((link, index) => {
      const linkStyles = window.getComputedStyle(link);
      console.log(`üîç Glass Button ${index + 1} styles:`, {
        background: linkStyles.background,
        backdropFilter: linkStyles.backdropFilter,
        borderRadius: linkStyles.borderRadius,
        boxShadow: linkStyles.boxShadow
      });
    });
  } else {
    console.log('‚ùå Modern quicklinks container not found - check HTML structure');
  }
  
  // Load dashboard data when user is authenticated
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      loadDashboardData();
    }
  });

  async function loadDashboardData() {
    loadNewsfeedMentions();
    loadLatestMessages();
    loadLatestTickets();
  }

  async function loadNewsfeedMentions() {
    const container = document.getElementById('newsfeed-content');
    try {
      // Load posts from Firebase Database (same path as script.js uses)
      const postsRef = firebase.database().ref('posts');
      const snapshot = await postsRef.orderByKey().limitToLast(5).once('value');
      const data = snapshot.val();
      
      if (data) {
        const items = Object.values(data).reverse();
        container.innerHTML = items.map(item => `
          <div class="item">
            <div class="item-header">${item.name || 'Anonymous'}</div>
            <div class="item-meta">${formatDate(item.timestamp)}</div>
            <div class="item-content">${item.message || item.content || 'No content available'}</div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="no-data">No recent posts found</div>';
      }
    } catch (error) {
      console.error('Error loading newsfeed:', error);
      container.innerHTML = '<div class="no-data">Error loading posts</div>';
    }
  }

  // Helper function to format message content for preview
  function formatMessagePreview(message) {
    if (!message) return 'No message content';
    
    // Check if message contains .gif anywhere in the URL (case insensitive)
    if (message.toLowerCase().includes('.gif')) {
      return 'GIF';
    }
    
    return message;
  }

  async function loadLatestMessages() {
    const container = document.getElementById('messages-content');
    try {
      // Try Firestore first, then fallback to showing recent post comments as "messages"
      if (firebase.firestore) {
        try {
          const db = firebase.firestore();
          const currentUser = firebase.auth().currentUser;
          
          // First, get chats where the user is a participant
          const chatsSnapshot = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.email)
            .get();
          
          if (!chatsSnapshot.empty) {
            const chatIds = chatsSnapshot.docs.map(doc => doc.id);
            
            // Get recent messages from those chats
            const messagesSnapshot = await db.collection('chat-messages')
              .where('chatId', 'in', chatIds.slice(0, 10)) // Firestore 'in' has limit of 10
              .orderBy('timestamp', 'desc')
              .limit(5)
              .get();
            
            if (!messagesSnapshot.empty) {
              // Get chat names for display
              const chatLookup = {};
              chatsSnapshot.docs.forEach(doc => {
                chatLookup[doc.id] = doc.data().name;
              });
              
              const items = messagesSnapshot.docs.map(doc => doc.data());
              container.innerHTML = items.map(item => `
                <div class="item">
                  <div class="item-header">${chatLookup[item.chatId] || 'Chat'}</div>
                  <div class="item-meta">${item.senderName || 'Unknown'} ‚Ä¢ ${formatDate(item.timestamp?.toDate?.() || item.timestamp)}</div>
                  <div class="item-content">${formatMessagePreview(item.message)}</div>
                </div>
              `).join('');
              return;
            }
          }
          
          console.log('No chat messages found, trying all messages...');
          // Fallback: try to get any recent messages
          const allMessagesSnapshot = await db.collection('chat-messages')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get();
          
          if (!allMessagesSnapshot.empty) {
            const items = allMessagesSnapshot.docs.map(doc => doc.data());
            container.innerHTML = items.map(item => `
              <div class="item">
                <div class="item-header">Chat Message</div>
                <div class="item-meta">${item.senderName || 'Unknown'} ‚Ä¢ ${formatDate(item.timestamp?.toDate?.() || item.timestamp)}</div>
                <div class="item-content">${formatMessagePreview(item.message)}</div>
              </div>
            `).join('');
            return;
          }
        } catch (firestoreError) {
          console.log('Firestore not accessible, using fallback...', firestoreError);
        }
      }
      
      // Fallback: Show recent activity from posts (comments as "messages")
      const postsRef = firebase.database().ref('posts');
      const snapshot = await postsRef.orderByKey().limitToLast(10).once('value');
      const data = snapshot.val();
      
      if (data) {
        const recentActivity = [];
        Object.values(data).forEach(post => {
          if (post.comments) {
            Object.values(post.comments).forEach(comment => {
              recentActivity.push({
                type: 'comment',
                postTitle: post.message?.substring(0, 30) + '...' || 'Post',
                author: 'User',
                content: comment.text || comment.content || comment,
                timestamp: comment.timestamp || Date.now()
              });
            });
          }
        });
        
        // Sort by timestamp and get latest 5
        recentActivity.sort((a, b) => b.timestamp - a.timestamp);
        const latest = recentActivity.slice(0, 5);
        
        if (latest.length > 0) {
          container.innerHTML = latest.map(item => `
            <div class="item">
              <div class="item-header">Comment on: ${item.postTitle}</div>
              <div class="item-meta">${item.author} ‚Ä¢ ${formatDate(item.timestamp)}</div>
              <div class="item-content">${item.content}</div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="no-data">No recent activity found</div>';
        }
      } else {
        container.innerHTML = '<div class="no-data">No recent messages found</div>';
      }
    } catch (error) {
      console.error('Error loading messages:', error);
      container.innerHTML = '<div class="no-data">Error loading messages</div>';
    }
  }

  async function loadLatestTickets() {
    const container = document.getElementById('tickets-content');
    try {
      // Try Firestore first, then fallback to placeholder tickets
      if (firebase.firestore) {
        try {
          const db = firebase.firestore();
          const currentUser = firebase.auth().currentUser;
          
          // Check if user is admin - only admins can see all tickets
          let isFullAdmin = false;
          if (currentUser && window.authUtils) {
            isFullAdmin = await window.authUtils.isAdmin(currentUser);
          }
          
          let allTickets = [];
          
          if (isFullAdmin) {
            // Admins see all tickets
            const query = db.collection('tickets').orderBy('createdAt', 'desc').limit(10);
            const snapshot = await query.get();
            allTickets = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
          } else if (currentUser) {
            // Load user's teams first
            const userTeams = await getUserTeams(currentUser.email);
            
            // Collect tickets from multiple sources
            const queries = [];
            
            // 1. Tickets created by user
            queries.push(
              db.collection('tickets')
                .where('createdBy.email', '==', currentUser.email)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
            );
            
            // 2. Tickets assigned to user individually
            queries.push(
              db.collection('tickets')
                .where('assignedTo.email', '==', currentUser.email)
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
            );
            
            // 3. Tickets assigned to user's teams
            userTeams.forEach(team => {
              queries.push(
                db.collection('tickets')
                  .where('assignedTo.teamId', '==', team.id)
                  .orderBy('createdAt', 'desc')
                  .limit(5)
                  .get()
              );
            });
            
            // Execute all queries and combine results
            const results = await Promise.all(queries);
            const ticketMap = new Map(); // Use Map to deduplicate
            
            results.forEach(snapshot => {
              snapshot.docs.forEach(doc => {
                const ticket = {id: doc.id, ...doc.data()};
                // Only add if not already added (deduplication)
                if (!ticketMap.has(ticket.id)) {
                  ticketMap.set(ticket.id, ticket);
                }
              });
            });
            
            allTickets = Array.from(ticketMap.values())
              .sort((a, b) => {
                const aTime = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                const bTime = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                return bTime - aTime; // Most recent first
              })
              .slice(0, 5); // Limit to 5 most recent
          }
          
          if (allTickets.length > 0) {
            container.innerHTML = allTickets.map(item => {
              const assignmentInfo = getTicketAssignmentInfo(item, currentUser);
              return `
                <div class="item" onclick="window.open('tickets.html#ticket-${item.id}', '_blank')">
                  <div class="item-header">#${item.ticketId || 'N/A'} - ${item.title || 'Support Ticket'}</div>
                  <div class="item-meta">${item.status || 'Open'} ‚Ä¢ ${assignmentInfo} ‚Ä¢ ${formatDate(item.createdAt?.toDate?.() || item.createdAt)}</div>
                  <div class="item-content">${(item.description || 'No description available').substring(0, 100)}${item.description?.length > 100 ? '...' : ''}</div>
                </div>
              `;
            }).join('');
            return;
          }
        } catch (firestoreError) {
          console.log('Firestore tickets not accessible, using fallback...', firestoreError);
        }
      }
      
      // Fallback: Show getting started information about tickets
      container.innerHTML = `
        <div class="item">
          <div class="item-header">Welcome to Support Tickets</div>
          <div class="item-meta">System ‚Ä¢ Just now</div>
          <div class="item-content">Create your first support ticket to get started. Tickets help track and resolve issues efficiently.</div>
        </div>
        <div class="item">
          <div class="item-header">Ticket System Ready</div>
          <div class="item-meta">System ‚Ä¢ Ready</div>
          <div class="item-content">The ticketing system is ready for use. Visit the Tickets page to create and manage support requests.</div>
        </div>
      `;
      
    } catch (error) {
      console.error('Error loading tickets:', error);
      container.innerHTML = '<div class="no-data">Visit the Tickets page to create your first support ticket</div>';
    }
  }

  function formatDate(timestamp) {
    if (!timestamp) return 'Unknown time';
    const date = new Date(timestamp);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
  }

  // Get user's team memberships
  async function getUserTeams(userEmail) {
    try {
      const db = firebase.firestore();
      const teamsSnapshot = await db.collection('teams').get();
      
      const userTeams = [];
      teamsSnapshot.docs.forEach(doc => {
        const teamData = doc.data();
        if (teamData.members && teamData.members.some(member => member.email === userEmail)) {
          userTeams.push({
            id: doc.id,
            name: teamData.name,
            ...teamData
          });
        }
      });
      
      console.log(`Found ${userTeams.length} teams for user ${userEmail}:`, userTeams.map(t => t.name));
      return userTeams;
    } catch (error) {
      console.error('Error loading user teams:', error);
      return [];
    }
  }

  // Get ticket assignment information for display
  function getTicketAssignmentInfo(ticket, currentUser) {
    if (!ticket.assignedTo) return 'Unassigned';
    
    if (ticket.assignedTo.type === 'team') {
      return `Team: ${ticket.assignedTo.teamName}`;
    } else {
      // Individual assignment
      if (ticket.assignedTo.email === currentUser.email) {
        return 'Assigned to: You';
      } else {
        return `Assigned to: ${ticket.assignedTo.name || ticket.assignedTo.email}`;
      }
    }
  }
});
</script>

<!-- Notification Badge System -->
<script src="notification-badges.js"></script>

</body>
</html>
