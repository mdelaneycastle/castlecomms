<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your World, Our Art - Visualize Art in Your Space</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Import DIN Font */
        @font-face {
            font-family: 'DIN Light Alternate';
            src: url('DIN LightAlternate.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --primary-color: #d8d1c5;
            --secondary-color: #45494e;
            --tertiary-color: #6a6e73;
            --accent-color: #c5bdb1;
            --text-dark: #45494e;
            --text-light: #6a6e73;
            --text-muted: #999ea3;
            --background-overlay: rgba(216, 209, 197, 0.95);
            --card-background: #F0EDE9;
            --shadow-subtle: 0 2px 8px rgba(69, 73, 78, 0.08);
            --shadow-light: 0 4px 12px rgba(69, 73, 78, 0.12);
            --shadow-medium: 0 8px 20px rgba(69, 73, 78, 0.15);
            --shadow-heavy: 0 12px 30px rgba(69, 73, 78, 0.2);
            --border-radius: 8px;
            --border-radius-large: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-primary: 'DIN Light Alternate', 'DIN 2014', 'DIN', 'Helvetica Neue', Arial, sans-serif;
            --letter-spacing-headers: 0.025em;
            --letter-spacing-normal: 0;
            --primary-gradient: linear-gradient(135deg, #45494e 0%, #6a6e73 100%);
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--primary-color) 0%, #e5ded2 100%);
            min-height: 100vh;
            padding: 20px;
            font-weight: 300;
            color: var(--text-dark);
            letter-spacing: var(--letter-spacing-normal);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 500;
            font-family: var(--font-primary);
            letter-spacing: var(--letter-spacing-headers);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: flex;
            min-height: 700px;
        }

        .controls {
            width: 350px;
            background: var(--card-background);
            padding: 30px;
            border-right: 1px solid rgba(216, 209, 197, 0.3);
        }

        .control-group {
            margin-bottom: 30px;
        }

        .control-group h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-family: var(--font-primary);
            font-weight: 500;
            letter-spacing: var(--letter-spacing-headers);
        }

        .upload-area {
            border: 2px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            background: white;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            box-shadow: var(--shadow-subtle);
        }

        .upload-area:hover {
            border-color: var(--secondary-color);
            background: var(--card-background);
            box-shadow: var(--shadow-light);
        }

        .upload-area.dragover {
            border-color: var(--tertiary-color);
            background: var(--background-overlay);
        }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-preview {
            max-width: 100%;
            max-height: 80px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .measurement-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .measurement-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--accent-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: var(--font-primary);
            background: white;
        }

        .measurement-input select {
            padding: 10px;
            border: 1px solid var(--accent-color);
            border-radius: var(--border-radius);
            background: white;
            font-family: var(--font-primary);
        }

        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-family: var(--font-primary);
            font-weight: 400;
            transition: var(--transition);
            width: 100%;
            margin-top: 10px;
            box-shadow: var(--shadow-light);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-subtle);
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: var(--card-background);
            overflow: hidden;
        }

        #mainCanvas {
            cursor: crosshair;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(69, 73, 78, 0.9);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            max-width: 300px;
            font-size: 14px;
            line-height: 1.4;
            font-family: var(--font-primary);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
        }

        .point-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--secondary-color);
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: var(--shadow-light);
        }

        .measurement-line {
            position: absolute;
            height: 2px;
            background: var(--secondary-color);
            transform-origin: left center;
            z-index: 9;
        }

        .measurement-text {
            position: absolute;
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font-primary);
            transform: translate(-50%, -50%);
            z-index: 11;
        }

        .artwork-container {
            position: absolute;
            cursor: move;
            z-index: 8;
        }

        .artwork-shadow {
            position: absolute;
            background: rgba(0, 0, 0, 0.3);
            filter: blur(3px);
            transform: skewX(-5deg) translateX(3px) translateY(3px);
            z-index: 7;
        }

        .export-section {
            padding: 20px 30px;
            background: var(--card-background);
            border-top: 1px solid rgba(216, 209, 197, 0.3);
        }

        .export-options {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }

        .status.success {
            background: rgba(216, 209, 197, 0.2);
            color: var(--secondary-color);
            border: 1px solid var(--accent-color);
        }

        .status.error {
            background: rgba(106, 110, 115, 0.1);
            color: var(--secondary-color);
            border: 1px solid var(--tertiary-color);
        }

        .status.info {
            background: var(--background-overlay);
            color: var(--text-dark);
            border: 1px solid var(--accent-color);
        }

        .rotation-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rotation-control input[type="range"] {
            flex: 1;
            height: 6px;
            background: var(--accent-color);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .rotation-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--secondary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-light);
        }

        .rotation-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--secondary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-light);
        }

        .rotation-control span {
            min-width: 35px;
            text-align: center;
            font-weight: 500;
            color: var(--secondary-color);
            font-family: var(--font-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Your World, Our Art</h1>
            <p>Visualize artwork in your space with realistic scaling and positioning</p>
        </div>

        <div class="main-content">
            <div class="controls">
                <div class="control-group">
                    <h3>1. Upload Room Image</h3>
                    <div class="upload-area" id="roomUpload">
                        <input type="file" id="roomFile" accept="image/*">
                        <p>📸 Drop room image here or click to browse</p>
                        <img id="roomPreview" class="upload-preview" style="display: none;">
                    </div>
                </div>

                <div class="control-group">
                    <h3>2. Upload Artwork</h3>
                    <div class="upload-area" id="artworkUpload">
                        <input type="file" id="artworkFile" accept="image/*">
                        <p>🎨 Drop artwork image here or click to browse</p>
                        <img id="artworkPreview" class="upload-preview" style="display: none;">
                    </div>
                </div>

                <div class="control-group">
                    <h3>3. Set Room Scale</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Click two points in your room image and enter the real distance between them
                    </p>
                    <div class="measurement-input">
                        <input type="number" id="realDistance" placeholder="Distance" step="0.1" min="0">
                        <select id="distanceUnit">
                            <option value="ft">ft</option>
                            <option value="m">m</option>
                            <option value="cm">cm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                    <button class="btn" id="clearPoints">Clear Points</button>
                </div>

                <div class="control-group">
                    <h3>4. Artwork Size</h3>
                    <div class="measurement-input">
                        <input type="number" id="artworkWidth" placeholder="Width" step="0.1" min="0">
                        <select id="artworkUnit">
                            <option value="ft">ft</option>
                            <option value="m">m</option>
                            <option value="cm">cm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>5. Artwork Angle</h3>
                    <div class="rotation-control">
                        <input type="range" id="rotationSlider" min="-80" max="80" value="0" step="1">
                        <span id="rotationValue">0°</span>
                    </div>
                    <button class="btn" id="resetRotation">Reset Angle</button>
                </div>

                <div id="statusMessages"></div>
            </div>

            <div class="canvas-container">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>

        <div class="export-section">
            <div class="export-options">
                <button class="btn" id="exportJPG">📸 Export as JPG</button>
                <button class="btn" id="exportPNG">🖼️ Export as PNG</button>
                <button class="btn" id="shareImage">📤 Share Image</button>
            </div>
        </div>
    </div>

    <script>
        class YWOAApp {
            constructor() {
                this.canvas = document.getElementById('mainCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.roomImage = null;
                this.artworkImage = null;
                this.roomImageDisplayed = null;
                this.scalePoints = [];
                this.realDistance = 0;
                this.distanceUnit = 'ft';
                this.artworkWidth = 0;
                this.artworkUnit = 'ft';
                this.artworkPosition = { x: 0, y: 0 };
                this.artworkSize = { width: 0, height: 0 };
                this.artworkRotation = 0; // Rotation in degrees
                this.perspective = 600; // 3D perspective distance
                this.pixelsPerUnit = 1;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };

                this.initializeCanvas();
                this.bindEvents();
                this.showStatus('Welcome! Start by uploading a room image.', 'info');
            }

            initializeCanvas() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                // Set canvas internal resolution
                this.canvas.width = containerWidth;
                this.canvas.height = containerHeight;
                
                // Set canvas display size to match internal resolution
                this.canvas.style.width = containerWidth + 'px';
                this.canvas.style.height = containerHeight + 'px';
                
                this.redraw();
            }

            bindEvents() {
                // File uploads
                document.getElementById('roomFile').addEventListener('change', (e) => this.handleRoomUpload(e));
                document.getElementById('artworkFile').addEventListener('change', (e) => this.handleArtworkUpload(e));

                // Drag and drop
                this.setupDragDrop('roomUpload', 'roomFile');
                this.setupDragDrop('artworkUpload', 'artworkFile');

                // Canvas interactions
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));

                // Controls
                document.getElementById('realDistance').addEventListener('input', (e) => this.updateScale());
                document.getElementById('distanceUnit').addEventListener('change', (e) => this.updateScale());
                document.getElementById('artworkWidth').addEventListener('input', (e) => this.updateArtworkSize());
                document.getElementById('artworkUnit').addEventListener('change', (e) => this.updateArtworkSize());
                document.getElementById('clearPoints').addEventListener('click', () => this.clearScalePoints());
                document.getElementById('rotationSlider').addEventListener('input', (e) => this.updateRotation(e));
                document.getElementById('resetRotation').addEventListener('click', () => this.resetRotation());

                // Export
                document.getElementById('exportJPG').addEventListener('click', () => this.exportImage('jpg'));
                document.getElementById('exportPNG').addEventListener('click', () => this.exportImage('png'));
                document.getElementById('shareImage').addEventListener('click', () => this.shareImage());
            }

            setupDragDrop(uploadAreaId, fileInputId) {
                const uploadArea = document.getElementById(uploadAreaId);
                const fileInput = document.getElementById(fileInputId);

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        fileInput.dispatchEvent(new Event('change'));
                    }
                });
            }

            handleRoomUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.roomImage = img;
                        document.getElementById('roomPreview').src = e.target.result;
                        document.getElementById('roomPreview').style.display = 'block';
                        this.scalePoints = [];
                        this.redraw();
                        this.showStatus('Room image loaded! Now click two points to set the scale.', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            handleArtworkUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.artworkImage = img;
                        document.getElementById('artworkPreview').src = e.target.result;
                        document.getElementById('artworkPreview').style.display = 'block';
                        this.updateArtworkSize();
                        this.redraw();
                        this.showStatus('Artwork loaded! Set the artwork width to scale it properly.', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            handleCanvasClick(e) {
                if (!this.roomImage) {
                    this.showStatus('Please upload a room image first.', 'error');
                    return;
                }

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (this.scalePoints.length < 2) {
                    this.scalePoints.push({ x, y });
                    this.redraw();
                    
                    if (this.scalePoints.length === 2) {
                        this.showStatus('Two points set! Enter the real distance between them.', 'info');
                    } else {
                        this.showStatus('Click a second point to set the scale reference.', 'info');
                    }
                }
            }

            handleMouseDown(e) {
                if (!this.artworkImage) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check if click is on artwork (using 3D projected quad bounds)
                const centerX = this.artworkPosition.x + this.artworkSize.width / 2;
                const centerY = this.artworkPosition.y + this.artworkSize.height / 2;
                
                // Get the 3D projected quad
                const quad = this.projectRotateY(this.artworkSize.width, this.artworkSize.height, centerX, centerY, this.artworkRotation, this.perspective);
                
                // Simple bounding box check for the quad
                const minX = Math.min(quad.tl.x, quad.tr.x, quad.br.x, quad.bl.x);
                const maxX = Math.max(quad.tl.x, quad.tr.x, quad.br.x, quad.bl.x);
                const minY = Math.min(quad.tl.y, quad.tr.y, quad.br.y, quad.bl.y);
                const maxY = Math.max(quad.tl.y, quad.tr.y, quad.br.y, quad.bl.y);
                
                // Check if click is within the projected artwork bounds
                if (x >= minX && x <= maxX && y >= minY && y <= maxY) {
                    this.isDragging = true;
                    this.dragOffset.x = x - this.artworkPosition.x;
                    this.dragOffset.y = y - this.artworkPosition.y;
                    this.canvas.style.cursor = 'grabbing';
                }
            }

            handleMouseMove(e) {
                if (!this.isDragging) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                this.artworkPosition.x = x - this.dragOffset.x;
                this.artworkPosition.y = y - this.dragOffset.y;

                this.redraw();
            }

            handleMouseUp(e) {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.canvas.style.cursor = 'default';
                }
            }

            updateScale() {
                this.realDistance = parseFloat(document.getElementById('realDistance').value) || 0;
                this.distanceUnit = document.getElementById('distanceUnit').value;

                if (this.scalePoints.length === 2 && this.realDistance > 0) {
                    const pixelDistance = this.calculateDistance(this.scalePoints[0], this.scalePoints[1]);
                    this.pixelsPerUnit = pixelDistance / this.realDistance;
                    this.updateArtworkSize();
                    this.showStatus('Scale updated! Artwork will now be sized correctly.', 'success');
                }
            }

            updateArtworkSize() {
                this.artworkWidth = parseFloat(document.getElementById('artworkWidth').value) || 0;
                this.artworkUnit = document.getElementById('artworkUnit').value;

                if (this.artworkImage && this.artworkWidth > 0 && this.pixelsPerUnit > 0) {
                    // Convert artwork width to same unit as scale
                    const widthInScaleUnits = this.convertUnits(this.artworkWidth, this.artworkUnit, this.distanceUnit);
                    const pixelWidth = widthInScaleUnits * this.pixelsPerUnit;
                    
                    // Calculate height maintaining original image aspect ratio
                    const originalAspectRatio = this.artworkImage.width / this.artworkImage.height;
                    const pixelHeight = pixelWidth / originalAspectRatio;
                    
                    this.artworkSize.width = pixelWidth;
                    this.artworkSize.height = pixelHeight;

                    // Center artwork initially
                    if (this.artworkPosition.x === 0 && this.artworkPosition.y === 0) {
                        this.artworkPosition.x = (this.canvas.width - this.artworkSize.width) / 2;
                        this.artworkPosition.y = (this.canvas.height - this.artworkSize.height) / 2;
                    }

                    this.redraw();
                }
            }

            convertUnits(value, fromUnit, toUnit) {
                const toMeters = {
                    'm': 1,
                    'ft': 0.3048,
                    'cm': 0.01,
                    'in': 0.0254
                };

                const meters = value * toMeters[fromUnit];
                return meters / toMeters[toUnit];
            }

            calculateDistance(point1, point2) {
                const dx = point2.x - point1.x;
                const dy = point2.y - point1.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            clearScalePoints() {
                this.scalePoints = [];
                this.pixelsPerUnit = 1;
                this.redraw();
                this.showStatus('Scale points cleared. Click two new points to set scale.', 'info');
            }

            updateRotation(e) {
                this.artworkRotation = parseInt(e.target.value);
                document.getElementById('rotationValue').textContent = this.artworkRotation + '°';
                this.redraw();
            }

            resetRotation() {
                this.artworkRotation = 0;
                document.getElementById('rotationSlider').value = 0;
                document.getElementById('rotationValue').textContent = '0°';
                this.redraw();
            }

            // 3D rotateY projection function (from the demo)
            projectRotateY(w, h, cx, cy, deg, persp) {
                const a = deg * Math.PI / 180;
                const pts = [
                    {x: -w/2, y: -h/2, z: 0},
                    {x:  w/2, y: -h/2, z: 0},
                    {x:  w/2, y:  h/2, z: 0},
                    {x: -w/2, y:  h/2, z: 0},
                ].map(p => {
                    const xr = p.x * Math.cos(a) + p.z * Math.sin(a);
                    const zr = -p.x * Math.sin(a) + p.z * Math.cos(a);
                    const s = persp / (persp + zr);
                    return {x: cx + xr * s, y: cy + p.y * s};
                });
                return {tl: pts[0], tr: pts[1], br: pts[2], bl: pts[3]};
            }

            redraw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw room image - maintain aspect ratio and store dimensions
                if (this.roomImage) {
                    const scale = Math.min(
                        this.canvas.width / this.roomImage.width,
                        this.canvas.height / this.roomImage.height
                    );
                    this.roomImageDisplayed = {
                        width: this.roomImage.width * scale,
                        height: this.roomImage.height * scale,
                        x: (this.canvas.width - this.roomImage.width * scale) / 2,
                        y: (this.canvas.height - this.roomImage.height * scale) / 2,
                        scale: scale
                    };

                    this.ctx.drawImage(this.roomImage, 
                        this.roomImageDisplayed.x, 
                        this.roomImageDisplayed.y, 
                        this.roomImageDisplayed.width, 
                        this.roomImageDisplayed.height);
                }

                // Draw scale points
                this.scalePoints.forEach((point, index) => {
                    this.ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                    this.ctx.beginPath();
                    this.ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                    this.ctx.fill();

                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px DIN Light Alternate, Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(index + 1, point.x, point.y + 4);
                });

                // Draw measurement line
                if (this.scalePoints.length === 2) {
                    this.ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.scalePoints[0].x, this.scalePoints[0].y);
                    this.ctx.lineTo(this.scalePoints[1].x, this.scalePoints[1].y);
                    this.ctx.stroke();

                    if (this.realDistance > 0) {
                        const midX = (this.scalePoints[0].x + this.scalePoints[1].x) / 2;
                        const midY = (this.scalePoints[0].y + this.scalePoints[1].y) / 2;
                        
                        this.ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                        this.ctx.fillRect(midX - 30, midY - 10, 60, 20);
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = '12px DIN Light Alternate, Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(`${this.realDistance} ${this.distanceUnit}`, midX, midY + 4);
                    }
                }

                // Draw artwork shadow and artwork - proper 3D rotateY projection
                if (this.artworkImage && this.artworkSize.width > 0) {
                    // Use the already calculated dimensions that maintain original aspect ratio
                    const displayWidth = this.artworkSize.width;
                    const displayHeight = this.artworkSize.height;
                    const centerX = this.artworkPosition.x + displayWidth / 2;
                    const centerY = this.artworkPosition.y + displayHeight / 2;
                    
                    // Get 3D projected quad points using the demo method
                    const quad = this.projectRotateY(displayWidth, displayHeight, centerX, centerY, this.artworkRotation, this.perspective);
                    
                    // Shadow calculation based on rotation
                    const rotationAngle = (this.artworkRotation * Math.PI) / 180;
                    const sinAngle = Math.sin(rotationAngle);
                    const shadowOffsetX = sinAngle * 8;
                    const shadowOffsetY = 4;
                    const shadowBlur = Math.max(2, displayWidth * 0.008);
                    const shadowOpacity = 0.15 + Math.abs(sinAngle) * 0.15;
                    
                    // Draw shadow quad
                    this.ctx.save();
                    this.ctx.globalAlpha = shadowOpacity;
                    this.ctx.fillStyle = '#000';
                    this.ctx.filter = `blur(${shadowBlur}px)`;
                    this.ctx.beginPath();
                    this.ctx.moveTo(quad.tl.x + shadowOffsetX, quad.tl.y + shadowOffsetY);
                    this.ctx.lineTo(quad.tr.x + shadowOffsetX, quad.tr.y + shadowOffsetY);
                    this.ctx.lineTo(quad.br.x + shadowOffsetX, quad.br.y + shadowOffsetY);
                    this.ctx.lineTo(quad.bl.x + shadowOffsetX, quad.bl.y + shadowOffsetY);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.restore();

                    // Draw 3D projected artwork using transform and drawImage
                    this.ctx.save();
                    
                    // Calculate transform matrix from quad points
                    const dx1 = quad.tr.x - quad.tl.x;
                    const dy1 = quad.tr.y - quad.tl.y;
                    const dx2 = quad.bl.x - quad.tl.x;
                    const dy2 = quad.bl.y - quad.tl.y;
                    
                    this.ctx.setTransform(
                        dx1 / displayWidth, dy1 / displayWidth,
                        dx2 / displayHeight, dy2 / displayHeight,
                        quad.tl.x, quad.tl.y
                    );
                    
                    this.ctx.drawImage(this.artworkImage, 0, 0, displayWidth, displayHeight);
                    this.ctx.restore();
                }
            }

            exportImage(format) {
                if (!this.roomImage) {
                    this.showStatus('No room image to export.', 'error');
                    return;
                }

                const dataURL = this.canvas.toDataURL(`image/${format}`, 0.9);
                const link = document.createElement('a');
                link.download = `your-world-our-art.${format}`;
                link.href = dataURL;
                link.click();
                
                this.showStatus(`Image exported as ${format.toUpperCase()}!`, 'success');
            }

            shareImage() {
                if (!this.roomImage) {
                    this.showStatus('No room image to share.', 'error');
                    return;
                }

                this.canvas.toBlob((blob) => {
                    if (navigator.share && navigator.canShare({ files: [blob] })) {
                        const file = new File([blob], 'your-world-our-art.png', { type: 'image/png' });
                        navigator.share({
                            title: 'Your World, Our Art',
                            text: 'Check out how this artwork looks in my space!',
                            files: [file]
                        });
                    } else {
                        // Fallback: copy to clipboard
                        navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]).then(() => {
                            this.showStatus('Image copied to clipboard!', 'success');
                        }).catch(() => {
                            this.showStatus('Sharing not supported. Use export instead.', 'error');
                        });
                    }
                });
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('statusMessages');
                statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
                setTimeout(() => {
                    if (statusDiv.innerHTML.includes(message)) {
                        statusDiv.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new YWOAApp();
        });
    </script>
</body>
</html>